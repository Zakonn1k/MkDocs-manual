<!DOCTYPE html><html lang="ru" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Support Vadim">
      
      
        <link rel="canonical" href="https://Zakonn1k.github.io/MkDocs-manual/SQL/bazy-dannykh-neskolko-shagov-do-sereznogo-obsluzhivaniia/">
      
      
        <link rel="prev" href="../2389984/">
      
      
        <link rel="next" href="../rezervnoe-kopirovanie-i-vosstanovlenie-bazy-dannykh-v-ms-sql-server/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Обслуживания базы данных - Support Vadim Manual</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Перейти к содержанию
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Верхний колонтитул">
    <a href="../.." title="Support Vadim Manual" class="md-header__button md-logo" aria-label="Support Vadim Manual" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Support Vadim Manual
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Обслуживания базы данных
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo" aria-label="Switch to light mode" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo" aria-label="Switch to dark mode" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo" aria-label="Switch to system preference" type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Поиск" placeholder="Поиск" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Поиск">
        
        <button type="reset" class="md-search__icon md-icon" title="Очистить" aria-label="Очистить" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Инициализация поиска
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Навигация" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Support Vadim Manual" class="md-nav__button md-logo" aria-label="Support Vadim Manual" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    Support Vadim Manual
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Welcome to Support Vadim
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2">
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Cisco
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Cisco
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Cisco/firmware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Прошивка Cisco Catalyst 3850
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3">
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Linux
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Linux
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux/NFS%20%D0%B2%20Linux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NFS в Linux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux/access-rights/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Добавления ключа SSH
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux/audio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Установка Debian 12.10.0 (Netinst, XFCE)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux/kak-ustanovit-aktualnye-versii-docker-i-docker-compose-na-ubuntu-i-debian/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Как установить актуальные версии Docker и Docker Compose на Ubuntu и Debian
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux/prometheus-grafana/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Установка и настройка Prometheus и Grafana (Docker)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4">
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    MikroTik
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    MikroTik
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../MikroTik/instruktsii-po-nastroike-mikrotik/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Инструкции по настройке MikroTik
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../MikroTik/mikrotik-capsman-nastroika-capsman-v-mikrotik-routeros-713-i-vyshe/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Настройка CAPsMAN в Mikrotik RouterOS 7
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    SQL
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    SQL
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2389984/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Как установить SQL Server 2019 для работы с 1С
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Обслуживания базы данных
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Обслуживания базы данных
  

    
  </span>
  
  

      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Об этом много сказано
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Общие слова
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        Примеры, примеры, примеры
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Примеры, примеры, примеры">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        Типичное обслуживание
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        Первые проблемы
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        Большой шаг
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        А вот и полная модель
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      
        Разделяй и властвуй
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      
        Слишком большие объекты
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alwayson" class="md-nav__link">
    <span class="md-ellipsis">
      
        Да здравствует AlwaysOn
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      
        Комбо!
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      
        Как отслеживать качество обслуживания
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      
        Это еще не конец
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rezervnoe-kopirovanie-i-vosstanovlenie-bazy-dannykh-v-ms-sql-server/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Резервное копирование и восстановление базы данных в MS SQL Server
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6">
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../blog/sell/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Page 2 test
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3">
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Архив
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Архив
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2023
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7">
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Виртуалки
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Виртуалки
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%D0%92%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D0%BA%D0%B8/Install-Proxmox-KVM/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Устнавка образа Proxmox VE на rescue system Hetzner с виртуальным KVM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%D0%92%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D0%BA%D0%B8/MikrotikCHR-Proxmox/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Установка Mikrotik CHR на Proxmox
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%D0%92%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D0%BA%D0%B8/Proxmox/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Установка Proxmox VE на голый on Debian 12
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%D0%92%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D0%BA%D0%B8/Settings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Настройка сети Proxmox
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Об этом много сказано
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Общие слова
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        Примеры, примеры, примеры
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Примеры, примеры, примеры">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        Типичное обслуживание
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        Первые проблемы
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        Большой шаг
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        А вот и полная модель
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      
        Разделяй и властвуй
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      
        Слишком большие объекты
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alwayson" class="md-nav__link">
    <span class="md-ellipsis">
      
        Да здравствует AlwaysOn
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      
        Комбо!
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      
        Как отслеживать качество обслуживания
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      
        Это еще не конец
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="_1">Обслуживания базы данных<a class="headerlink" href="#_1" title="Permanent link">¶</a></h1>
<h2 id="_2">Об этом много сказано<a class="headerlink" href="#_2" title="Permanent link">¶</a></h2>
<p>Тема обслуживания баз данных (индексов и статистик)&nbsp;поднимается достаточно часто в разных статьях, официальной документации, на форумах и так далее. Обычно дается описание процессов обслуживания, зачем они нужны и какие бывают, на что влияют. И, конечно же, как сделать настройку обслуживания. Последнее обычно преподносится на базовом уровне, но, конечно, не всегда.</p>
<p>Сегодня мы снова коснемся этой темы, но несколько в ином ключе. Мы на практических примерах посмотрим на настройку обслуживания от простого случая до более продвинутого. Так можно будет проследить как меняется обслуживание при изменении требований к работе информационной системы.</p>
<p>Мы сосредоточимся на решении именно практических задач. Теорию Вы можете найти по ссылкам в конце статьи.</p>
<h2 id="_3">Общие слова<a class="headerlink" href="#_3" title="Permanent link">¶</a></h2>
<p>Прежде чем мы перейдем к примерам, определимся с тем, что будем делать.</p>
<p>Обслуживание подразумевает две больших части:</p>
<ol>
<li>Поддержание фрагментации индексов на приемлемом уровне. В идеале процент фрагментации у каждого индекса должен быть равен 0 или близок к этому значению.</li>
<li>Состояние статистики должно быть в максимально в актуальном состоянии. При изменении строк в таблице,&nbsp;объекты статистики должны иметь гистограмму распределения значений, которая отражает состояние объектов базы наиболее актуальным образом.</li>
</ol>
<p>Все это влияет на формируемые планы запросов. В самых общих чертах, если индекс имеет высокую фрагментацию или статистика знатно устарела, то оптимизатор SQL Server даже не будет пытаться использовать индекс и выполнит полное сканирование таблицы. Последнее, как Вы понимаете, не самая быстрая и оптимальная ситуация.&nbsp;Есть и другие последствия отсутствия обслуживания, но это совсем другая история.</p>
<p>Также сразу отметим, что никаких сторонних программ для настройки обслуживания мы использовать не будем. Чистый TSQL, возможно, в готовых скриптах и/или хранимых процедурах. Но никакого стороннего софта.</p>
<p>Итак, настало время первого примера!</p>
<h2 id="_4">Примеры, примеры, примеры<a class="headerlink" href="#_4" title="Permanent link">¶</a></h2>
<p>На старт, внимание, марш!</p>
<h3 id="_5">Типичное обслуживание<a class="headerlink" href="#_5" title="Permanent link">¶</a></h3>
<p>Когда речь заходит об обслуживании, то обычно начинают с создания плана обслуживания, где используют готовые компоненты. Для этого создаем план обслуживания через SQL Server Managment Studio в разделе "Managment -&gt; Maintenance Plans" с субпланом "FullMaintenance".</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../img/d4cef60ac717f45a738e5ce7aeabd20b.png" data-desc-position="bottom"><img alt="" src="../img/d4cef60ac717f45a738e5ce7aeabd20b.png"></a>Механизм планов обслуживания базируется на "обрезанной" версии <a href="https://learn.microsoft.com/ru-ru/sql/integration-services/sql-server-integration-services?view=sql-server-ver15"><strong>SSIS</strong></a>, если так можно выразиться. Для использования готовых компонентов нужно использовать именно его.</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../img/8725438f0fe48fe5e7cf5e07373431f1.png" data-desc-position="bottom"><img alt="" src="../img/8725438f0fe48fe5e7cf5e07373431f1.png"></a></p>
<p>Альтернативным вариантом является использование заданий (job'ов) агента SQL Server, просто указывая явно скрипты TSQL для выполнения.</p>
<p>В созданный субплан добавляем три компонента. Выше Вы уже&nbsp;могли видеть схему субплана обслуживания.</p>
<p>Rebuild Index Task</p>
<p>Компонент перестроения индексов <strong>"Rebuild Index Task"</strong> имеет в себе большинство необходимых настроек для запуска простого обслуживания. <a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/maintenance-plans/rebuild-index-task-maintenance-plan?view=sql-server-ver15"><strong>В официальной документации он достаточно подробно описан.</strong></a></p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../img/aea12746d23e4c58ec7466be475440b6.png" data-desc-position="bottom"><img alt="" src="../img/aea12746d23e4c58ec7466be475440b6.png"></a></p>
<ul>
<li><strong>Connection</strong> - указываем параметры соединения с базой данных, сервером СУБД. Обычно здесь остается стандартная настройка, останавливаться подробней не будем.</li>
<li><strong>Database(s)</strong> - указываем для какой базы (или списка баз) нужно выполнять обслуживание. Обычный фильтр.</li>
<li><strong>Object</strong> - здесь мы можем выбрать для каких объектов базы данных нужно выполнять обслуживание.</li>
<li><strong>Tables and Views</strong> - все объекты базы.</li>
<li><strong>Tables</strong> - таблицы базы, можно указать все или выбрать конкретные.</li>
<li><strong>Views</strong> - представления базы, можно указать все или выбрать конкретные.</li>
<li><strong>Free space options</strong> - параметр отвечает за то, сколько процентов свободного места нужно оставлять в каждой странице. По умолчанию используются стандартные параметры сервера, но это значение можно переопределить. <strong><a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/indexes/specify-fill-factor-for-an-index?view=sql-server-ver15">Подробнее об этом параметре читайте здесь.</a></strong>&nbsp;Если оставлять некоторое место на страницах свободным, то можно уменьшить рост фрагментации индексов, т.к. изменения будут дописываться в существующие страницы и связанные данные меньше будут "раскидываться" между отдельными страницами. Подробнее читайте в документации, рассматривать это сегодня более детально не будем.</li>
<li><strong>Advaned options</strong> - это различные дополнительные настройки для более тонкого управления обслуживанием индексов.</li>
<li><strong>Sort results in tempdb</strong> - этот флаг включает хранение промежуточных результатов сортировки при формировании индекса. По умолчанию они хранятся в памяти или целевой файловой группе. <strong><a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/indexes/sort-in-tempdb-option-for-indexes?view=sql-server-ver15">Подробнее читать здесь.</a></strong> По умолчанию он установлен в ЛОЖЬ.</li>
<li><strong>Keep index online</strong> - SQL Server поддерживает <a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/indexes/perform-index-operations-online?view=sql-server-ver15"><strong>перестроение индексов в онлайн режиме</strong></a>, при котором работа с таблицей и индексом не блокируется во время выполнения обслуживания. По завершению перестроения выполняется переключение старого индекса на новый, что позволяет исключить блокирование работы запросов и выполнять обслуживание при минимальном размере технологического окна. Или при его полном отсутствии. Дополнительно к этому режиму указывают варианты действия для тех индексов, которые не поддерживают онлайн-обслуживание (например, если содержат типы text, ntext, image, filestream. Первые 3 считаются устаревшими, но все еще поддерживаются для совместимости). В момент переключения, конечно же, кратковременно создается блокировка на уровне схемы данных и есть различные сценарии обработки этой блокировки. Об этом подробней мы поговорим ниже.<ul>
<li><strong>Do not rebuild</strong> - индексы без поддержки онлайн перестроения будут пропущены.</li>
<li><strong>Rebuild indexes offline</strong> - индекс без поддержки онлайн перестроения&nbsp;будет обслужен в обычном режиме с блокировкой работы с ним.</li>
</ul>
</li>
<li><strong>Pad index</strong> - указать заполнение индекса. Определяет разреженность индекса. По умолчанию выключен. При включении настройка fillfactor применяется к страницам промежуточного индекса.</li>
<li><strong>MAXDOP</strong> - указываем степень параллелизма для операций обслуживания. Таким образом можно указать параметр, отличный от значения параметра всего сервера.</li>
<li><strong>Index Stats Options</strong> - параметры анализа индексов перед обслуживанием. Фактически это режимы просмотра для системной DMV&nbsp;<a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/system-dynamic-management-views/sys-dm-db-index-physical-stats-transact-sql?view=sql-server-ver15"><strong>sys.dm_db_index_physical_stats</strong></a>, которые&nbsp;влияют на работу некоторых фильтров и точность результатов анализа. Но зато поверхностный анализ позволяет ускорить запросы перед началом обслуживания. Детальный анализ потребует больше времени и создаст дополнительную нагрузку на сервер.</li>
<li>Fast</li>
<li>Sampled</li>
<li>Detailed</li>
<li><strong>Oprimize index only if</strong> - дополнительные фильтры для обслуживаемых индексов.</li>
<li><strong>Fragmnetation &gt;</strong> - фрагментация должна быть больше определенного процента. Общепринятым правилом считается, что перестроение нужно выполнять, если фрагментация выше 30%.</li>
<li><strong>Page Count</strong>&nbsp;- фильтр по размеру индекса. Указывается в количестве страниц. Каждая страница = 8 КБ.</li>
</ul>
<p>Базовые настройки именно такие.</p>
<p>Reorganize Index Task</p>
<p><a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/maintenance-plans/reorganize-index-task-maintenance-plan?view=sql-server-ver15"><strong>Компонент реорганизации индексов "Reorganize Index Task"</strong></a>. Позволяет выполнять операции реорганизации, которые требуют меньше ресурсов, чем перестроение. Также этот процесс выполняется без долгосрочных блокировок объекта и минимально влияет на текущую работу запросов. Обычно дефрагментация при таком способе выполняется для страниц конечного уровня, что делает такую операцию не всегда оптимальным вариантом.</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../img/8977403e279523ece781ab05881a201a.png" data-desc-position="bottom"><img alt="" src="../img/8977403e279523ece781ab05881a201a.png"></a></p>
<ul>
<li><strong>Connection</strong> - указываем параметры соединения с базой данных, сервером СУБД. Обычно здесь остается стандартная настройка, останавливаться подробней не будем.</li>
<li><strong>Database(s)</strong> - указываем для какой базы (или списка баз) нужно выполнять обслуживание. Обычный фильтр.</li>
<li><strong>Object</strong> - здесь мы можем выбрать для каких объектов базы данных нужно выполнять обслуживание.</li>
<li><strong>Tables and Views</strong> - все объекты базы.</li>
<li><strong>Tables</strong> - таблицы базы, можно указать все или выбрать конкретные.</li>
<li><strong>Views</strong> - представления базы, можно указать все или выбрать конкретные.</li>
<li><strong>Compact large objects</strong> - освобождение пространства для таблиц и индексов, если возможно.</li>
<li><strong>Index Stats Options</strong> - параметры анализа индексов перед обслуживанием. Фактически это режимы просмотра для системной DMV&nbsp;<a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/system-dynamic-management-views/sys-dm-db-index-physical-stats-transact-sql?view=sql-server-ver15"><strong>sys.dm_db_index_physical_stats</strong></a>, которые&nbsp;влияют на работу некоторых фильтров и точность результатов анализа. Но зато поверхностный анализ позволяет ускорить запросы перед началом обслуживания. Детальный анализ потребует больше времени и создаст дополнительную нагрузку на сервер.</li>
<li>Fast</li>
<li>Sampled</li>
<li>Detailed</li>
<li><strong>Oprimize index only if</strong> - дополнительные фильтры для обслуживаемых индексов.</li>
<li><strong>Framnetation &gt;</strong> - фрагментация должна быть больше определенного процента. Общепринятым правилом считается, что реорганизацию нужно выполнять, если процент фрагментации находится между 15 и 30%.</li>
<li><strong>Page Count</strong>&nbsp;- фильтр по размеру индекса. Указывается в количестве страниц. Каждая страница = 8 КБ.</li>
<li><strong>Used in last</strong> - фильтр позволяет указать, что индекс должен был использоваться за последние дни (кол. дней).</li>
</ul>
<p>Настройки похожи&nbsp;на перестроение. Убраны параметры, которые для реорганизации просто не используются. Например MAXDOP, ведь операция реорганизации не распараллеливается как перестроение.</p>
<p>Update Statistics Task</p>
<p><a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/maintenance-plans/update-statistics-task-maintenance-plan?view=sql-server-ver15"><strong>Компонент обслуживания статистики "Update Statistics task".</strong></a>&nbsp;Позволяет настроить обслуживание статистики в базе данных.</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../img/f75ddf640e0f6bc55074339dc3a7d67e.png" data-desc-position="bottom"><img alt="" src="../img/f75ddf640e0f6bc55074339dc3a7d67e.png"></a></p>
<ul>
<li><strong>Connection</strong> - указываем параметры соединения с базой данных, сервером СУБД. Обычно здесь остается стандартная настройка, останавливаться подробней не будем.</li>
<li><strong>Database(s)</strong> - указываем для какой базы (или списка баз) нужно выполнять обслуживание. Обычный фильтр.</li>
<li><strong>Object</strong> - здесь мы можем выбрать для каких объектов базы данных нужно выполнять обслуживание.</li>
<li><strong>Tables and Views</strong> - все объекты базы.</li>
<li><strong>Tables</strong> - таблицы базы, можно указать все или выбрать конкретные.</li>
<li><strong>Views</strong> - представления базы, можно указать все или выбрать конкретные.</li>
<li><strong>Update</strong> - режим обновления объектов статистики.</li>
<li><strong>All existing statistics</strong> - будут обновлены все объекты статистики.</li>
<li><strong>Column statistics only</strong> - обновление только статистики столбцов.</li>
<li><strong>Index statictis only</strong> - только статистику индексов.</li>
<li><strong>Scan type</strong> - тип сканирования данных таблицы для актуализации гистограммы распределения значений статистики.</li>
<li><strong>Full scan</strong> - полное сканирование всех значений.</li>
<li><strong>Sample by</strong> - для анализа будет использован только некоторый процент данных из таблицы, что позволит ускорить процесс обновления, но снизит точность.</li>
</ul>
<p>На скриншоте ниже можно увидеть объекты статистики разных типов. Зеленым обведены объекты статистики, которые связаны с индексами. А объекты статистики с именем "_WA_Sys_*", обведенные красным, это как раз служебные статистики столбцов, которые СУБД создает автоматически. Конечно, никто не мешает создать свой объект статистики, если в этом есть необходимость.</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../img/c982ce19838735d2e079e84b269d7a6f.png" data-desc-position="bottom"><img alt="" src="../img/c982ce19838735d2e079e84b269d7a6f.png"></a></p>
<p>Чаще всего оставляют обновление всех объектов статистики, а не только тех, которые относятся к индексам. Также в абсолютном большинстве случаев достаточно оставить обновление статистики через анализ ограниченной выборки данных. Полное сканирование конечно хорошо, но на больших базах оно может выполняться много часов. Если база небольшая, то можно оставлять и полное сканирование, но нужно учитывать, что обновление статистики таким образом в некоторых случаях может <a href="https://www.brentozar.com/archive/2014/01/update-statistics-the-secret-io-explosion/"><strong>создавать проблемы ввода-вывода</strong></a>, но опять же для больших баз.</p>
<p>Мы пробежались по основным настройкам каждого доступного компонента.</p>
<p>Предположим, что у нас типичная задача - небольшая база на SQL Server, работ ночью не ведется и в качестве технологического окна у нас время с 21:00 до 06:00. Идеально! Тогда настроим запуск обслуживания как на схеме выше, чередуя операции следующим образом:</p>
<ol>
<li>Перестроение индексов с указанием нужной базы и выбрав все таблицы и представления. При этом не используем онлайн-перестроение, оставляем отключенной сортировку в TempDB и так далее. В общем все настройки стандартные как на скрине выше,&nbsp;разве что MAXDOP можно поставить максимальный, пусть все ресурсы сервера будут выделены под перестроение.</li>
<li>Вторым шагом реорганизация индексов. Также оставляем все настройки по умолчанию. Реорганизацию оставляем именно вторым шагом, т.к. в первую очередь нужно выполнить обслуживание индексов, у которых фрагментация выше 30%.</li>
<li>И последней операцией устанавливаем обновление статистики. Пусть выполняется для всех объектов статистики и методом полного сканирования.</li>
</ol>
<p>Также рекомендую добавить еще один субплан обслуживания для обновления статистики в дневное время, чтобы сгладить изменения в базе и помочь оптимизатору запросов актуальной статистикой. Например, установить запуск операции ежедневно в 13:00 (например, сориентироваться на обеденное время сотрудников). Настройки такие же, как и у обновления статистики в ночное время.</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../img/6b0fc5ee422249f0e6766387110ee7b5.png" data-desc-position="bottom"><img alt="" src="../img/6b0fc5ee422249f0e6766387110ee7b5.png"></a></p>
<p>Так как база небольшая, то, скорее всего, весь процесс обслуживания завершится за 30-60 минут ночью и за 5-15 минут днем, а может и еще быстрее.</p>
<p>Подведем небольшой итог.</p>
<p>Плюсы:</p>
<ul>
<li>Простота настройки</li>
</ul>
<p>Минусы:</p>
<ul>
<li>Отсутствие контроля выполнения</li>
<li>Блокирование работы запросов в момент обслуживания</li>
<li>Нет возможности проанализировать результаты выполнения обслуживания в динамике, нет истории работы обслуживания</li>
</ul>
<p>Но если база небольшая, то все перечисленные минусы несущественны. Что такое небольшая база? Понятие относительное :). Главное, что нужно понять, так это если такое обслуживание Вас полностью устраивает, то делать что-то более сложное нет смысла.</p>
<h3 id="_6">Первые проблемы<a class="headerlink" href="#_6" title="Permanent link">¶</a></h3>
<p>Какое-то время все шло хорошо, но от бизнеса появилось новое требование: в ночное время обслуживание не должно мешать работе информационной системы. Например, могли появиться важные регламентные задания по интеграции, расчетам и так далее.</p>
<p>Выше мы уже говорили, что SQL Server поддерживает онлайн-перестроение индексов и мы можем его использовать для тех объектов, которые это поддерживают. Те объекты, для которых онлайн-перестроение нельзя выполнить из-за использования legacy-типов в полях (text, ntext, image), будут обслужены обычным образом с блокировкой работы с ними. Так что от всех проблем мы не избавимся, но других настроек в стандартном компоненте нет. Поэтому следует выполнить следующие изменения:</p>
<ul>
<li>В шаге перестроения индексов, который выполняется в ночное время, установить использование онлайн перестроения. По сравнению с обычной операцией обслуживания онлайн перестроение требует больше ресурсов по CPU и по использованному месту, да и лог транзакций при полной модели восстановления будет заполнен больше. Такова цена беспрерывной работы запросов.</li>
</ul>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../img/2b0a72b7940dc0f0f2279f3c4a4e62ff.png" data-desc-position="bottom"><img alt="" src="../img/2b0a72b7940dc0f0f2279f3c4a4e62ff.png"></a></p>
<ul>
<li>Степень параллелизма желательно установить ограниченным значением, чтобы CPU не был загружен на 100% во время обслуживания. Ведь блокировки не единственная проблема, которая может помешать работе информационной системе. Высокая нагрузка от обслуживания тоже может остановить работу. Общая рекомендация поставить MAXDOP = 30% от общего количества ядер. Например, если на сервере 24 ядра, то под перестроение индексов выделить только 8.</li>
<li>Остальные настройки оставляем как есть.</li>
</ul>
<p>Тут также подведем небольшой итог.</p>
<p>Плюсы:</p>
<ol>
<li>Простота настройки</li>
<li>Минимальное влияние на работу системы во время обслуживания</li>
</ol>
<p>Минусы:</p>
<ol>
<li>Отсутствие контроля выполнения</li>
<li>Блокирование работы запросов в момент обслуживания для тех объектов, в которых онлайн перестроение невозможно</li>
<li>Нет возможности проанализировать результаты выполнения обслуживания в динамике, нет истории работы обслуживания</li>
</ol>
<p>Опять же, если последние 3 причины не критичны, то все отлично!</p>
<h3 id="_7">Большой шаг<a class="headerlink" href="#_7" title="Permanent link">¶</a></h3>
<p>Компания развивается, и информационная база растет. У нас появились большие таблицы и много, а технологическое окно уменьшилось: с 21:00 до 23:00. Появились склады, которые работают 24/7. Кроме этого остается старая проблема с объектами, которые не поддерживают онлайн перестроение. Мы должны их обслуживать так, чтобы они минимально создавали блокировки. Кроме этого, нужно гарантировать, что обслуживание не выйдет за пределы установленного технологического окна с 21:00 до 23:00.</p>
<p>К сожалению, стандартными компонентами обслуживания, которыми пользовались до этого момента, данную задачу решить уже нельзя. Поэтому мы пойдем другим путем. Мы создадим служебную базу обслуживания и мониторинга с именем <strong>"SQLServerMaintenance"</strong>, а далее наполним ее объектами следующим скриптом.</p>
<p>Скрипт создания служебной базы мониторинга и обслуживания</p>
<p>Этот скрипт <a href="https://github.com/YPermitin/SQLServerTools/tree/master/SQL-Server-Maintenance/Service-Database"><strong>взят отсюда</strong></a>. Там же есть примеры использования, описания процедур и их параметров, а также другая связанная информация.</p>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">USE</span><span class="w"> </span><span class="p">[</span><span class="n">SQLServerMaintenance</span><span class="p">]</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="k">GO</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MaintenanceActionsLog</span><span class="p">](</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">    </span><span class="p">[</span><span class="n">Id</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">IDENTITY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">    </span><span class="p">[</span><span class="k">Period</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">datetime2</span><span class="p">](</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">    </span><span class="p">[</span><span class="n">TableName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">    </span><span class="p">[</span><span class="n">IndexName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">    </span><span class="p">[</span><span class="k">Operation</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w">    </span><span class="p">[</span><span class="n">RunDate</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">datetime2</span><span class="p">](</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">    </span><span class="p">[</span><span class="n">StartDate</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">datetime2</span><span class="p">](</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="w">    </span><span class="p">[</span><span class="n">FinishDate</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">datetime2</span><span class="p">](</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="w">    </span><span class="p">[</span><span class="n">DatabaseName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">500</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="w">    </span><span class="p">[</span><span class="n">UseOnlineRebuild</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bit</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="w">    </span><span class="p">[</span><span class="k">Comment</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="w">    </span><span class="p">[</span><span class="n">IndexFragmentation</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="w">    </span><span class="p">[</span><span class="n">RowModCtr</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="w">    </span><span class="p">[</span><span class="n">SQLCommand</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="k">max</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="k">CONSTRAINT</span><span class="w"> </span><span class="p">[</span><span class="n">PK__Maintena__3214EC074E078F4E</span><span class="p">]</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">CLUSTERED</span><span class="w"> </span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="p">(</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="w">    </span><span class="p">[</span><span class="n">Id</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="p">)</span><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">PAD_INDEX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">STATISTICS_NORECOMPUTE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">IGNORE_DUP_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">ALLOW_ROW_LOCKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">,</span><span class="w"> </span><span class="n">ALLOW_PAGE_LOCKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">,</span><span class="w"> </span><span class="n">FILLFACTOR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span><span class="w"> </span><span class="n">TEXTIMAGE_ON</span><span class="w"> </span><span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a><span class="k">GO</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">v_CommonStatsByDay</span><span class="p">]</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a><span class="k">AS</span>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a><span class="w">    </span><span class="k">CAST</span><span class="p">([</span><span class="n">RunDate</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">DATE</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"День"</span><span class="p">,</span>
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="p">[</span><span class="n">TableName</span><span class="p">])</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"Кол-во таблиц, для объектов которых выполнено обслуживание"</span><span class="p">,</span>
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a><span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="p">[</span><span class="n">IndexName</span><span class="p">])</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"Количество индексов, для объектов которых выполнено обслуживание"</span><span class="p">,</span>
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span>
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>
</span><span id="__span-0-65"><a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="p">[</span><span class="k">Operation</span><span class="p">]</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">'%STAT%'</span>
</span><span id="__span-0-66"><a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>
</span><span id="__span-0-67"><a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a><span class="w">        </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-0-68"><a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>
</span><span id="__span-0-69"><a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a><span class="w">        </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-70"><a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>
</span><span id="__span-0-71"><a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a><span class="w">    </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"Обновлено статистик"</span><span class="p">,</span>
</span><span id="__span-0-72"><a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>
</span><span id="__span-0-73"><a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a><span class="w">    </span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span>
</span><span id="__span-0-74"><a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>
</span><span id="__span-0-75"><a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="p">[</span><span class="k">Operation</span><span class="p">]</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">'%INDEX%'</span>
</span><span id="__span-0-76"><a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>
</span><span id="__span-0-77"><a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a><span class="w">        </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-0-78"><a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>
</span><span id="__span-0-79"><a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a><span class="w">        </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-80"><a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>
</span><span id="__span-0-81"><a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a><span class="w">    </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"Обслужено индексов"</span><span class="w">      </span>
</span><span id="__span-0-82"><a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>
</span><span id="__span-0-83"><a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">SQLServerMaintenance</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MaintenanceActionsLog</span><span class="p">]</span>
</span><span id="__span-0-84"><a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>
</span><span id="__span-0-85"><a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">CAST</span><span class="p">([</span><span class="n">RunDate</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">DATE</span><span class="p">)</span>
</span><span id="__span-0-86"><a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>
</span><span id="__span-0-87"><a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a><span class="k">GO</span>
</span><span id="__span-0-88"><a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>
</span><span id="__span-0-89"><a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>
</span><span id="__span-0-90"><a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>
</span><span id="__span-0-91"><a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ConnectionsStatistic</span><span class="p">](</span>
</span><span id="__span-0-92"><a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>
</span><span id="__span-0-93"><a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a><span class="w">    </span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">IDENTITY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-94"><a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>
</span><span id="__span-0-95"><a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a><span class="w">    </span><span class="p">[</span><span class="k">Period</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">datetime2</span><span class="p">](</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-96"><a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>
</span><span id="__span-0-97"><a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a><span class="w">    </span><span class="p">[</span><span class="n">InstanceName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-98"><a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>
</span><span id="__span-0-99"><a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a><span class="w">    </span><span class="p">[</span><span class="n">QueryText</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="k">max</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-100"><a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>
</span><span id="__span-0-101"><a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a><span class="w">    </span><span class="p">[</span><span class="n">RowCountSize</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-102"><a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>
</span><span id="__span-0-103"><a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a><span class="w">    </span><span class="p">[</span><span class="n">SessionId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-104"><a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>
</span><span id="__span-0-105"><a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a><span class="w">    </span><span class="p">[</span><span class="n">Status</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-106"><a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>
</span><span id="__span-0-107"><a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a><span class="w">    </span><span class="p">[</span><span class="n">Command</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-108"><a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>
</span><span id="__span-0-109"><a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a><span class="w">    </span><span class="p">[</span><span class="n">CPU</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-110"><a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>
</span><span id="__span-0-111"><a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a><span class="w">    </span><span class="p">[</span><span class="n">TotalElapsedTime</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-112"><a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>
</span><span id="__span-0-113"><a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a><span class="w">    </span><span class="p">[</span><span class="n">StartTime</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">datetime2</span><span class="p">](</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-114"><a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>
</span><span id="__span-0-115"><a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a><span class="w">    </span><span class="p">[</span><span class="n">DatabaseName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-116"><a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>
</span><span id="__span-0-117"><a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a><span class="w">    </span><span class="p">[</span><span class="n">BlockingSessionId</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-118"><a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>
</span><span id="__span-0-119"><a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a><span class="w">    </span><span class="p">[</span><span class="n">WaitType</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-120"><a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a>
</span><span id="__span-0-121"><a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a><span class="w">    </span><span class="p">[</span><span class="n">WaitTime</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-122"><a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>
</span><span id="__span-0-123"><a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a><span class="w">    </span><span class="p">[</span><span class="n">WaitResource</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-124"><a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>
</span><span id="__span-0-125"><a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a><span class="w">    </span><span class="p">[</span><span class="n">OpenTransactionCount</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-126"><a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a>
</span><span id="__span-0-127"><a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a><span class="w">    </span><span class="p">[</span><span class="k">Reads</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-128"><a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>
</span><span id="__span-0-129"><a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a><span class="w">    </span><span class="p">[</span><span class="n">Writes</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-130"><a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a>
</span><span id="__span-0-131"><a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a><span class="w">    </span><span class="p">[</span><span class="n">LogicalReads</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-132"><a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a>
</span><span id="__span-0-133"><a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a><span class="w">    </span><span class="p">[</span><span class="n">GrantedQueryMemory</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-134"><a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a>
</span><span id="__span-0-135"><a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a><span class="w">    </span><span class="p">[</span><span class="n">UserName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-136"><a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a>
</span><span id="__span-0-137"><a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a><span class="k">CONSTRAINT</span><span class="w"> </span><span class="p">[</span><span class="n">PK_ConnectionsStatistic</span><span class="p">]</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">CLUSTERED</span><span class="w"> </span>
</span><span id="__span-0-138"><a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a>
</span><span id="__span-0-139"><a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a><span class="p">(</span>
</span><span id="__span-0-140"><a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a>
</span><span id="__span-0-141"><a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a><span class="w">    </span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span>
</span><span id="__span-0-142"><a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a>
</span><span id="__span-0-143"><a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a><span class="w">    </span><span class="p">[</span><span class="k">Period</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span>
</span><span id="__span-0-144"><a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a>
</span><span id="__span-0-145"><a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a><span class="p">)</span><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">PAD_INDEX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">STATISTICS_NORECOMPUTE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">IGNORE_DUP_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">ALLOW_ROW_LOCKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">,</span><span class="w"> </span><span class="n">ALLOW_PAGE_LOCKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">,</span><span class="w"> </span><span class="n">FILLFACTOR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>
</span><span id="__span-0-146"><a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a>
</span><span id="__span-0-147"><a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span><span class="w"> </span><span class="n">TEXTIMAGE_ON</span><span class="w"> </span><span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>
</span><span id="__span-0-148"><a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a>
</span><span id="__span-0-149"><a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a><span class="k">GO</span>
</span><span id="__span-0-150"><a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a>
</span><span id="__span-0-151"><a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a>
</span><span id="__span-0-152"><a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a>
</span><span id="__span-0-153"><a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">DatabaseObjectsState</span><span class="p">](</span>
</span><span id="__span-0-154"><a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a>
</span><span id="__span-0-155"><a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a><span class="w">    </span><span class="p">[</span><span class="n">Id</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">IDENTITY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-156"><a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a>
</span><span id="__span-0-157"><a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a><span class="w">    </span><span class="p">[</span><span class="k">Period</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">datetime2</span><span class="p">](</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-158"><a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a>
</span><span id="__span-0-159"><a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a><span class="w">    </span><span class="p">[</span><span class="n">DatabaseName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">150</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-160"><a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a>
</span><span id="__span-0-161"><a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a><span class="w">    </span><span class="p">[</span><span class="n">TableName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">250</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-162"><a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a>
</span><span id="__span-0-163"><a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a><span class="w">    </span><span class="p">[</span><span class="k">Object</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">250</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-164"><a id="__codelineno-0-164" name="__codelineno-0-164" href="#__codelineno-0-164"></a>
</span><span id="__span-0-165"><a id="__codelineno-0-165" name="__codelineno-0-165" href="#__codelineno-0-165"></a><span class="w">    </span><span class="p">[</span><span class="n">PageCount</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-166"><a id="__codelineno-0-166" name="__codelineno-0-166" href="#__codelineno-0-166"></a>
</span><span id="__span-0-167"><a id="__codelineno-0-167" name="__codelineno-0-167" href="#__codelineno-0-167"></a><span class="w">    </span><span class="p">[</span><span class="n">Rowmodctr</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-168"><a id="__codelineno-0-168" name="__codelineno-0-168" href="#__codelineno-0-168"></a>
</span><span id="__span-0-169"><a id="__codelineno-0-169" name="__codelineno-0-169" href="#__codelineno-0-169"></a><span class="w">    </span><span class="p">[</span><span class="n">AvgFragmentationPercent</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-170"><a id="__codelineno-0-170" name="__codelineno-0-170" href="#__codelineno-0-170"></a>
</span><span id="__span-0-171"><a id="__codelineno-0-171" name="__codelineno-0-171" href="#__codelineno-0-171"></a><span class="w">    </span><span class="p">[</span><span class="n">OnlineRebuildSupport</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-172"><a id="__codelineno-0-172" name="__codelineno-0-172" href="#__codelineno-0-172"></a>
</span><span id="__span-0-173"><a id="__codelineno-0-173" name="__codelineno-0-173" href="#__codelineno-0-173"></a><span class="w">    </span><span class="p">[</span><span class="n">Compression</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-174"><a id="__codelineno-0-174" name="__codelineno-0-174" href="#__codelineno-0-174"></a>
</span><span id="__span-0-175"><a id="__codelineno-0-175" name="__codelineno-0-175" href="#__codelineno-0-175"></a><span class="w">    </span><span class="p">[</span><span class="n">PartitionCount</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-176"><a id="__codelineno-0-176" name="__codelineno-0-176" href="#__codelineno-0-176"></a>
</span><span id="__span-0-177"><a id="__codelineno-0-177" name="__codelineno-0-177" href="#__codelineno-0-177"></a><span class="k">CONSTRAINT</span><span class="w"> </span><span class="p">[</span><span class="n">PK__DatabaseObjectsState__3214EC074E078F4E</span><span class="p">]</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">CLUSTERED</span><span class="w"> </span>
</span><span id="__span-0-178"><a id="__codelineno-0-178" name="__codelineno-0-178" href="#__codelineno-0-178"></a>
</span><span id="__span-0-179"><a id="__codelineno-0-179" name="__codelineno-0-179" href="#__codelineno-0-179"></a><span class="p">(</span>
</span><span id="__span-0-180"><a id="__codelineno-0-180" name="__codelineno-0-180" href="#__codelineno-0-180"></a>
</span><span id="__span-0-181"><a id="__codelineno-0-181" name="__codelineno-0-181" href="#__codelineno-0-181"></a><span class="w">    </span><span class="p">[</span><span class="n">Id</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span>
</span><span id="__span-0-182"><a id="__codelineno-0-182" name="__codelineno-0-182" href="#__codelineno-0-182"></a>
</span><span id="__span-0-183"><a id="__codelineno-0-183" name="__codelineno-0-183" href="#__codelineno-0-183"></a><span class="p">)</span><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">PAD_INDEX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">STATISTICS_NORECOMPUTE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">IGNORE_DUP_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">ALLOW_ROW_LOCKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">,</span><span class="w"> </span><span class="n">ALLOW_PAGE_LOCKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">,</span><span class="w"> </span><span class="n">FILLFACTOR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>
</span><span id="__span-0-184"><a id="__codelineno-0-184" name="__codelineno-0-184" href="#__codelineno-0-184"></a>
</span><span id="__span-0-185"><a id="__codelineno-0-185" name="__codelineno-0-185" href="#__codelineno-0-185"></a><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>
</span><span id="__span-0-186"><a id="__codelineno-0-186" name="__codelineno-0-186" href="#__codelineno-0-186"></a>
</span><span id="__span-0-187"><a id="__codelineno-0-187" name="__codelineno-0-187" href="#__codelineno-0-187"></a><span class="k">GO</span>
</span><span id="__span-0-188"><a id="__codelineno-0-188" name="__codelineno-0-188" href="#__codelineno-0-188"></a>
</span><span id="__span-0-189"><a id="__codelineno-0-189" name="__codelineno-0-189" href="#__codelineno-0-189"></a>
</span><span id="__span-0-190"><a id="__codelineno-0-190" name="__codelineno-0-190" href="#__codelineno-0-190"></a>
</span><span id="__span-0-191"><a id="__codelineno-0-191" name="__codelineno-0-191" href="#__codelineno-0-191"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">DatabasesTablesStatistic</span><span class="p">](</span>
</span><span id="__span-0-192"><a id="__codelineno-0-192" name="__codelineno-0-192" href="#__codelineno-0-192"></a>
</span><span id="__span-0-193"><a id="__codelineno-0-193" name="__codelineno-0-193" href="#__codelineno-0-193"></a><span class="w">    </span><span class="p">[</span><span class="k">Period</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">datetime2</span><span class="p">](</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-194"><a id="__codelineno-0-194" name="__codelineno-0-194" href="#__codelineno-0-194"></a>
</span><span id="__span-0-195"><a id="__codelineno-0-195" name="__codelineno-0-195" href="#__codelineno-0-195"></a><span class="w">    </span><span class="p">[</span><span class="n">DatabaseName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-196"><a id="__codelineno-0-196" name="__codelineno-0-196" href="#__codelineno-0-196"></a>
</span><span id="__span-0-197"><a id="__codelineno-0-197" name="__codelineno-0-197" href="#__codelineno-0-197"></a><span class="w">    </span><span class="p">[</span><span class="n">SchemaName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-198"><a id="__codelineno-0-198" name="__codelineno-0-198" href="#__codelineno-0-198"></a>
</span><span id="__span-0-199"><a id="__codelineno-0-199" name="__codelineno-0-199" href="#__codelineno-0-199"></a><span class="w">    </span><span class="p">[</span><span class="n">TableName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-200"><a id="__codelineno-0-200" name="__codelineno-0-200" href="#__codelineno-0-200"></a>
</span><span id="__span-0-201"><a id="__codelineno-0-201" name="__codelineno-0-201" href="#__codelineno-0-201"></a><span class="w">    </span><span class="p">[</span><span class="n">RowCnt</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-202"><a id="__codelineno-0-202" name="__codelineno-0-202" href="#__codelineno-0-202"></a>
</span><span id="__span-0-203"><a id="__codelineno-0-203" name="__codelineno-0-203" href="#__codelineno-0-203"></a><span class="w">    </span><span class="p">[</span><span class="n">Reserved</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-204"><a id="__codelineno-0-204" name="__codelineno-0-204" href="#__codelineno-0-204"></a>
</span><span id="__span-0-205"><a id="__codelineno-0-205" name="__codelineno-0-205" href="#__codelineno-0-205"></a><span class="w">    </span><span class="p">[</span><span class="k">Data</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-206"><a id="__codelineno-0-206" name="__codelineno-0-206" href="#__codelineno-0-206"></a>
</span><span id="__span-0-207"><a id="__codelineno-0-207" name="__codelineno-0-207" href="#__codelineno-0-207"></a><span class="w">    </span><span class="p">[</span><span class="n">IndexSize</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-208"><a id="__codelineno-0-208" name="__codelineno-0-208" href="#__codelineno-0-208"></a>
</span><span id="__span-0-209"><a id="__codelineno-0-209" name="__codelineno-0-209" href="#__codelineno-0-209"></a><span class="w">    </span><span class="p">[</span><span class="n">Unused</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bigint</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-0-210"><a id="__codelineno-0-210" name="__codelineno-0-210" href="#__codelineno-0-210"></a>
</span><span id="__span-0-211"><a id="__codelineno-0-211" name="__codelineno-0-211" href="#__codelineno-0-211"></a><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>
</span><span id="__span-0-212"><a id="__codelineno-0-212" name="__codelineno-0-212" href="#__codelineno-0-212"></a>
</span><span id="__span-0-213"><a id="__codelineno-0-213" name="__codelineno-0-213" href="#__codelineno-0-213"></a><span class="k">GO</span>
</span><span id="__span-0-214"><a id="__codelineno-0-214" name="__codelineno-0-214" href="#__codelineno-0-214"></a>
</span><span id="__span-0-215"><a id="__codelineno-0-215" name="__codelineno-0-215" href="#__codelineno-0-215"></a>
</span><span id="__span-0-216"><a id="__codelineno-0-216" name="__codelineno-0-216" href="#__codelineno-0-216"></a>
</span><span id="__span-0-217"><a id="__codelineno-0-217" name="__codelineno-0-217" href="#__codelineno-0-217"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="n">CLUSTERED</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="p">[</span><span class="n">UK_DatabasesTablesStatistic_Period_DatabaseName_TableName</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">DatabasesTablesStatistic</span><span class="p">]</span>
</span><span id="__span-0-218"><a id="__codelineno-0-218" name="__codelineno-0-218" href="#__codelineno-0-218"></a>
</span><span id="__span-0-219"><a id="__codelineno-0-219" name="__codelineno-0-219" href="#__codelineno-0-219"></a><span class="p">(</span>
</span><span id="__span-0-220"><a id="__codelineno-0-220" name="__codelineno-0-220" href="#__codelineno-0-220"></a>
</span><span id="__span-0-221"><a id="__codelineno-0-221" name="__codelineno-0-221" href="#__codelineno-0-221"></a><span class="w">    </span><span class="p">[</span><span class="k">Period</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span>
</span><span id="__span-0-222"><a id="__codelineno-0-222" name="__codelineno-0-222" href="#__codelineno-0-222"></a>
</span><span id="__span-0-223"><a id="__codelineno-0-223" name="__codelineno-0-223" href="#__codelineno-0-223"></a><span class="w">    </span><span class="p">[</span><span class="n">DatabaseName</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span>
</span><span id="__span-0-224"><a id="__codelineno-0-224" name="__codelineno-0-224" href="#__codelineno-0-224"></a>
</span><span id="__span-0-225"><a id="__codelineno-0-225" name="__codelineno-0-225" href="#__codelineno-0-225"></a><span class="w">    </span><span class="p">[</span><span class="n">SchemaName</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span>
</span><span id="__span-0-226"><a id="__codelineno-0-226" name="__codelineno-0-226" href="#__codelineno-0-226"></a>
</span><span id="__span-0-227"><a id="__codelineno-0-227" name="__codelineno-0-227" href="#__codelineno-0-227"></a><span class="w">    </span><span class="p">[</span><span class="n">TableName</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span>
</span><span id="__span-0-228"><a id="__codelineno-0-228" name="__codelineno-0-228" href="#__codelineno-0-228"></a>
</span><span id="__span-0-229"><a id="__codelineno-0-229" name="__codelineno-0-229" href="#__codelineno-0-229"></a><span class="p">)</span><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">PAD_INDEX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">STATISTICS_NORECOMPUTE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">SORT_IN_TEMPDB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">IGNORE_DUP_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">DROP_EXISTING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">ONLINE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">ALLOW_ROW_LOCKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">,</span><span class="w"> </span><span class="n">ALLOW_PAGE_LOCKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">,</span><span class="w"> </span><span class="n">FILLFACTOR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>
</span><span id="__span-0-230"><a id="__codelineno-0-230" name="__codelineno-0-230" href="#__codelineno-0-230"></a>
</span><span id="__span-0-231"><a id="__codelineno-0-231" name="__codelineno-0-231" href="#__codelineno-0-231"></a><span class="k">GO</span>
</span><span id="__span-0-232"><a id="__codelineno-0-232" name="__codelineno-0-232" href="#__codelineno-0-232"></a>
</span><span id="__span-0-233"><a id="__codelineno-0-233" name="__codelineno-0-233" href="#__codelineno-0-233"></a>
</span><span id="__span-0-234"><a id="__codelineno-0-234" name="__codelineno-0-234" href="#__codelineno-0-234"></a>
</span><span id="__span-0-235"><a id="__codelineno-0-235" name="__codelineno-0-235" href="#__codelineno-0-235"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MaintenanceIndexPriority</span><span class="p">](</span>
</span><span id="__span-0-236"><a id="__codelineno-0-236" name="__codelineno-0-236" href="#__codelineno-0-236"></a>
</span><span id="__span-0-237"><a id="__codelineno-0-237" name="__codelineno-0-237" href="#__codelineno-0-237"></a><span class="w">    </span><span class="p">[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">IDENTITY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-238"><a id="__codelineno-0-238" name="__codelineno-0-238" href="#__codelineno-0-238"></a>
</span><span id="__span-0-239"><a id="__codelineno-0-239" name="__codelineno-0-239" href="#__codelineno-0-239"></a><span class="w">    </span><span class="p">[</span><span class="n">DatabaseName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-240"><a id="__codelineno-0-240" name="__codelineno-0-240" href="#__codelineno-0-240"></a>
</span><span id="__span-0-241"><a id="__codelineno-0-241" name="__codelineno-0-241" href="#__codelineno-0-241"></a><span class="w">    </span><span class="p">[</span><span class="n">TableName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-242"><a id="__codelineno-0-242" name="__codelineno-0-242" href="#__codelineno-0-242"></a>
</span><span id="__span-0-243"><a id="__codelineno-0-243" name="__codelineno-0-243" href="#__codelineno-0-243"></a><span class="w">    </span><span class="p">[</span><span class="n">IndexName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-244"><a id="__codelineno-0-244" name="__codelineno-0-244" href="#__codelineno-0-244"></a>
</span><span id="__span-0-245"><a id="__codelineno-0-245" name="__codelineno-0-245" href="#__codelineno-0-245"></a><span class="w">    </span><span class="p">[</span><span class="n">Priority</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-246"><a id="__codelineno-0-246" name="__codelineno-0-246" href="#__codelineno-0-246"></a>
</span><span id="__span-0-247"><a id="__codelineno-0-247" name="__codelineno-0-247" href="#__codelineno-0-247"></a><span class="w">    </span><span class="p">[</span><span class="n">Exclude</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nb">bit</span><span class="p">]</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-0-248"><a id="__codelineno-0-248" name="__codelineno-0-248" href="#__codelineno-0-248"></a>
</span><span id="__span-0-249"><a id="__codelineno-0-249" name="__codelineno-0-249" href="#__codelineno-0-249"></a><span class="k">CONSTRAINT</span><span class="w"> </span><span class="p">[</span><span class="n">PK_MaintenanceIndexPriority</span><span class="p">]</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">CLUSTERED</span><span class="w"> </span>
</span><span id="__span-0-250"><a id="__codelineno-0-250" name="__codelineno-0-250" href="#__codelineno-0-250"></a>
</span><span id="__span-0-251"><a id="__codelineno-0-251" name="__codelineno-0-251" href="#__codelineno-0-251"></a><span class="p">(</span>
</span><span id="__span-0-252"><a id="__codelineno-0-252" name="__codelineno-0-252" href="#__codelineno-0-252"></a>
</span><span id="__span-0-253"><a id="__codelineno-0-253" name="__codelineno-0-253" href="#__codelineno-0-253"></a><span class="w">    </span><span class="p">[</span><span class="n">ID</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span>
</span><span id="__span-0-254"><a id="__codelineno-0-254" name="__codelineno-0-254" href="#__codelineno-0-254"></a>
</span><span id="__span-0-255"><a id="__codelineno-0-255" name="__codelineno-0-255" href="#__codelineno-0-255"></a><span class="p">)</span><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">PAD_INDEX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">STATISTICS_NORECOMPUTE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">IGNORE_DUP_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">ALLOW_ROW_LOCKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">,</span><span class="w"> </span><span class="n">ALLOW_PAGE_LOCKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">,</span><span class="w"> </span><span class="n">FILLFACTOR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>
</span><span id="__span-0-256"><a id="__codelineno-0-256" name="__codelineno-0-256" href="#__codelineno-0-256"></a>
</span><span id="__span-0-257"><a id="__codelineno-0-257" name="__codelineno-0-257" href="#__codelineno-0-257"></a><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>
</span><span id="__span-0-258"><a id="__codelineno-0-258" name="__codelineno-0-258" href="#__codelineno-0-258"></a>
</span><span id="__span-0-259"><a id="__codelineno-0-259" name="__codelineno-0-259" href="#__codelineno-0-259"></a><span class="k">GO</span>
</span><span id="__span-0-260"><a id="__codelineno-0-260" name="__codelineno-0-260" href="#__codelineno-0-260"></a>
</span><span id="__span-0-261"><a id="__codelineno-0-261" name="__codelineno-0-261" href="#__codelineno-0-261"></a>
</span><span id="__span-0-262"><a id="__codelineno-0-262" name="__codelineno-0-262" href="#__codelineno-0-262"></a>
</span><span id="__span-0-263"><a id="__codelineno-0-263" name="__codelineno-0-263" href="#__codelineno-0-263"></a><span class="k">CREATE</span><span class="w"> </span><span class="n">NONCLUSTERED</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="p">[</span><span class="n">UK_Table_Object_Period</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">DatabaseObjectsState</span><span class="p">]</span>
</span><span id="__span-0-264"><a id="__codelineno-0-264" name="__codelineno-0-264" href="#__codelineno-0-264"></a>
</span><span id="__span-0-265"><a id="__codelineno-0-265" name="__codelineno-0-265" href="#__codelineno-0-265"></a><span class="p">(</span>
</span><span id="__span-0-266"><a id="__codelineno-0-266" name="__codelineno-0-266" href="#__codelineno-0-266"></a>
</span><span id="__span-0-267"><a id="__codelineno-0-267" name="__codelineno-0-267" href="#__codelineno-0-267"></a><span class="w">    </span><span class="p">[</span><span class="n">DatabaseName</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span>
</span><span id="__span-0-268"><a id="__codelineno-0-268" name="__codelineno-0-268" href="#__codelineno-0-268"></a>
</span><span id="__span-0-269"><a id="__codelineno-0-269" name="__codelineno-0-269" href="#__codelineno-0-269"></a><span class="w">    </span><span class="p">[</span><span class="n">TableName</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span>
</span><span id="__span-0-270"><a id="__codelineno-0-270" name="__codelineno-0-270" href="#__codelineno-0-270"></a>
</span><span id="__span-0-271"><a id="__codelineno-0-271" name="__codelineno-0-271" href="#__codelineno-0-271"></a><span class="w">    </span><span class="p">[</span><span class="k">Object</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span>
</span><span id="__span-0-272"><a id="__codelineno-0-272" name="__codelineno-0-272" href="#__codelineno-0-272"></a>
</span><span id="__span-0-273"><a id="__codelineno-0-273" name="__codelineno-0-273" href="#__codelineno-0-273"></a><span class="w">    </span><span class="p">[</span><span class="k">Period</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span>
</span><span id="__span-0-274"><a id="__codelineno-0-274" name="__codelineno-0-274" href="#__codelineno-0-274"></a>
</span><span id="__span-0-275"><a id="__codelineno-0-275" name="__codelineno-0-275" href="#__codelineno-0-275"></a><span class="p">)</span><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">PAD_INDEX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">STATISTICS_NORECOMPUTE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">SORT_IN_TEMPDB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">DROP_EXISTING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">ONLINE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">ALLOW_ROW_LOCKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">,</span><span class="w"> </span><span class="n">ALLOW_PAGE_LOCKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">,</span><span class="w"> </span><span class="n">FILLFACTOR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>
</span><span id="__span-0-276"><a id="__codelineno-0-276" name="__codelineno-0-276" href="#__codelineno-0-276"></a>
</span><span id="__span-0-277"><a id="__codelineno-0-277" name="__codelineno-0-277" href="#__codelineno-0-277"></a><span class="k">GO</span>
</span><span id="__span-0-278"><a id="__codelineno-0-278" name="__codelineno-0-278" href="#__codelineno-0-278"></a>
</span><span id="__span-0-279"><a id="__codelineno-0-279" name="__codelineno-0-279" href="#__codelineno-0-279"></a>
</span><span id="__span-0-280"><a id="__codelineno-0-280" name="__codelineno-0-280" href="#__codelineno-0-280"></a>
</span><span id="__span-0-281"><a id="__codelineno-0-281" name="__codelineno-0-281" href="#__codelineno-0-281"></a><span class="k">CREATE</span><span class="w"> </span><span class="n">NONCLUSTERED</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="p">[</span><span class="n">UK_RunDate_Table_Index_Period_Operation</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MaintenanceActionsLog</span><span class="p">]</span>
</span><span id="__span-0-282"><a id="__codelineno-0-282" name="__codelineno-0-282" href="#__codelineno-0-282"></a>
</span><span id="__span-0-283"><a id="__codelineno-0-283" name="__codelineno-0-283" href="#__codelineno-0-283"></a><span class="p">(</span>
</span><span id="__span-0-284"><a id="__codelineno-0-284" name="__codelineno-0-284" href="#__codelineno-0-284"></a>
</span><span id="__span-0-285"><a id="__codelineno-0-285" name="__codelineno-0-285" href="#__codelineno-0-285"></a><span class="w">    </span><span class="p">[</span><span class="n">RunDate</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span>
</span><span id="__span-0-286"><a id="__codelineno-0-286" name="__codelineno-0-286" href="#__codelineno-0-286"></a>
</span><span id="__span-0-287"><a id="__codelineno-0-287" name="__codelineno-0-287" href="#__codelineno-0-287"></a><span class="w">    </span><span class="p">[</span><span class="n">DatabaseName</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span>
</span><span id="__span-0-288"><a id="__codelineno-0-288" name="__codelineno-0-288" href="#__codelineno-0-288"></a>
</span><span id="__span-0-289"><a id="__codelineno-0-289" name="__codelineno-0-289" href="#__codelineno-0-289"></a><span class="w">    </span><span class="p">[</span><span class="n">TableName</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span>
</span><span id="__span-0-290"><a id="__codelineno-0-290" name="__codelineno-0-290" href="#__codelineno-0-290"></a>
</span><span id="__span-0-291"><a id="__codelineno-0-291" name="__codelineno-0-291" href="#__codelineno-0-291"></a><span class="w">    </span><span class="p">[</span><span class="n">IndexName</span><span class="p">]</span><span class="w"> </span><span class="k">ASC</span>
</span><span id="__span-0-292"><a id="__codelineno-0-292" name="__codelineno-0-292" href="#__codelineno-0-292"></a>
</span><span id="__span-0-293"><a id="__codelineno-0-293" name="__codelineno-0-293" href="#__codelineno-0-293"></a><span class="p">)</span><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">PAD_INDEX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">STATISTICS_NORECOMPUTE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">SORT_IN_TEMPDB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">DROP_EXISTING</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">ONLINE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">OFF</span><span class="p">,</span><span class="w"> </span><span class="n">ALLOW_ROW_LOCKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">,</span><span class="w"> </span><span class="n">ALLOW_PAGE_LOCKS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">,</span><span class="w"> </span><span class="n">FILLFACTOR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="k">PRIMARY</span><span class="p">]</span>
</span><span id="__span-0-294"><a id="__codelineno-0-294" name="__codelineno-0-294" href="#__codelineno-0-294"></a>
</span><span id="__span-0-295"><a id="__codelineno-0-295" name="__codelineno-0-295" href="#__codelineno-0-295"></a><span class="k">GO</span>
</span><span id="__span-0-296"><a id="__codelineno-0-296" name="__codelineno-0-296" href="#__codelineno-0-296"></a>
</span><span id="__span-0-297"><a id="__codelineno-0-297" name="__codelineno-0-297" href="#__codelineno-0-297"></a>
</span><span id="__span-0-298"><a id="__codelineno-0-298" name="__codelineno-0-298" href="#__codelineno-0-298"></a>
</span><span id="__span-0-299"><a id="__codelineno-0-299" name="__codelineno-0-299" href="#__codelineno-0-299"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_ResumableIndexMaintenanceAvailiable</span><span class="p">]()</span>
</span><span id="__span-0-300"><a id="__codelineno-0-300" name="__codelineno-0-300" href="#__codelineno-0-300"></a>
</span><span id="__span-0-301"><a id="__codelineno-0-301" name="__codelineno-0-301" href="#__codelineno-0-301"></a><span class="k">RETURNS</span><span class="w"> </span><span class="nb">bit</span>
</span><span id="__span-0-302"><a id="__codelineno-0-302" name="__codelineno-0-302" href="#__codelineno-0-302"></a>
</span><span id="__span-0-303"><a id="__codelineno-0-303" name="__codelineno-0-303" href="#__codelineno-0-303"></a><span class="k">AS</span>
</span><span id="__span-0-304"><a id="__codelineno-0-304" name="__codelineno-0-304" href="#__codelineno-0-304"></a>
</span><span id="__span-0-305"><a id="__codelineno-0-305" name="__codelineno-0-305" href="#__codelineno-0-305"></a><span class="k">BEGIN</span>
</span><span id="__span-0-306"><a id="__codelineno-0-306" name="__codelineno-0-306" href="#__codelineno-0-306"></a>
</span><span id="__span-0-307"><a id="__codelineno-0-307" name="__codelineno-0-307" href="#__codelineno-0-307"></a><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">checkResult</span><span class="w"> </span><span class="nb">bit</span><span class="p">;</span>
</span><span id="__span-0-308"><a id="__codelineno-0-308" name="__codelineno-0-308" href="#__codelineno-0-308"></a>
</span><span id="__span-0-309"><a id="__codelineno-0-309" name="__codelineno-0-309" href="#__codelineno-0-309"></a>
</span><span id="__span-0-310"><a id="__codelineno-0-310" name="__codelineno-0-310" href="#__codelineno-0-310"></a>
</span><span id="__span-0-311"><a id="__codelineno-0-311" name="__codelineno-0-311" href="#__codelineno-0-311"></a><span class="w">    </span><span class="k">SELECT</span>
</span><span id="__span-0-312"><a id="__codelineno-0-312" name="__codelineno-0-312" href="#__codelineno-0-312"></a>
</span><span id="__span-0-313"><a id="__codelineno-0-313" name="__codelineno-0-313" href="#__codelineno-0-313"></a><span class="w">    </span><span class="c1">-- Возобновляемые операции обслуживания индексов доступны со SQL Server 2017</span>
</span><span id="__span-0-314"><a id="__codelineno-0-314" name="__codelineno-0-314" href="#__codelineno-0-314"></a>
</span><span id="__span-0-315"><a id="__codelineno-0-315" name="__codelineno-0-315" href="#__codelineno-0-315"></a><span class="w">    </span><span class="o">@</span><span class="n">checkResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">CASE</span>
</span><span id="__span-0-316"><a id="__codelineno-0-316" name="__codelineno-0-316" href="#__codelineno-0-316"></a>
</span><span id="__span-0-317"><a id="__codelineno-0-317" name="__codelineno-0-317" href="#__codelineno-0-317"></a><span class="w">                        </span><span class="k">WHEN</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="k">SUBSTRING</span><span class="p">(</span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span><span class="w"> </span><span class="n">SERVERPROPERTY</span><span class="p">(</span><span class="s1">'productversion'</span><span class="p">)),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">  </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">INT</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">13</span>
</span><span id="__span-0-318"><a id="__codelineno-0-318" name="__codelineno-0-318" href="#__codelineno-0-318"></a>
</span><span id="__span-0-319"><a id="__codelineno-0-319" name="__codelineno-0-319" href="#__codelineno-0-319"></a><span class="w">                        </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-0-320"><a id="__codelineno-0-320" name="__codelineno-0-320" href="#__codelineno-0-320"></a>
</span><span id="__span-0-321"><a id="__codelineno-0-321" name="__codelineno-0-321" href="#__codelineno-0-321"></a><span class="w">                        </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-322"><a id="__codelineno-0-322" name="__codelineno-0-322" href="#__codelineno-0-322"></a>
</span><span id="__span-0-323"><a id="__codelineno-0-323" name="__codelineno-0-323" href="#__codelineno-0-323"></a><span class="w">                    </span><span class="k">END</span>
</span><span id="__span-0-324"><a id="__codelineno-0-324" name="__codelineno-0-324" href="#__codelineno-0-324"></a>
</span><span id="__span-0-325"><a id="__codelineno-0-325" name="__codelineno-0-325" href="#__codelineno-0-325"></a>
</span><span id="__span-0-326"><a id="__codelineno-0-326" name="__codelineno-0-326" href="#__codelineno-0-326"></a>
</span><span id="__span-0-327"><a id="__codelineno-0-327" name="__codelineno-0-327" href="#__codelineno-0-327"></a><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="o">@</span><span class="n">checkResult</span>
</span><span id="__span-0-328"><a id="__codelineno-0-328" name="__codelineno-0-328" href="#__codelineno-0-328"></a>
</span><span id="__span-0-329"><a id="__codelineno-0-329" name="__codelineno-0-329" href="#__codelineno-0-329"></a>
</span><span id="__span-0-330"><a id="__codelineno-0-330" name="__codelineno-0-330" href="#__codelineno-0-330"></a>
</span><span id="__span-0-331"><a id="__codelineno-0-331" name="__codelineno-0-331" href="#__codelineno-0-331"></a><span class="k">END</span>
</span><span id="__span-0-332"><a id="__codelineno-0-332" name="__codelineno-0-332" href="#__codelineno-0-332"></a>
</span><span id="__span-0-333"><a id="__codelineno-0-333" name="__codelineno-0-333" href="#__codelineno-0-333"></a><span class="k">GO</span>
</span><span id="__span-0-334"><a id="__codelineno-0-334" name="__codelineno-0-334" href="#__codelineno-0-334"></a>
</span><span id="__span-0-335"><a id="__codelineno-0-335" name="__codelineno-0-335" href="#__codelineno-0-335"></a>
</span><span id="__span-0-336"><a id="__codelineno-0-336" name="__codelineno-0-336" href="#__codelineno-0-336"></a>
</span><span id="__span-0-337"><a id="__codelineno-0-337" name="__codelineno-0-337" href="#__codelineno-0-337"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_AdvancedPrint</span><span class="p">]</span>
</span><span id="__span-0-338"><a id="__codelineno-0-338" name="__codelineno-0-338" href="#__codelineno-0-338"></a>
</span><span id="__span-0-339"><a id="__codelineno-0-339" name="__codelineno-0-339" href="#__codelineno-0-339"></a><span class="w">    </span><span class="o">@</span><span class="k">sql</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span>
</span><span id="__span-0-340"><a id="__codelineno-0-340" name="__codelineno-0-340" href="#__codelineno-0-340"></a>
</span><span id="__span-0-341"><a id="__codelineno-0-341" name="__codelineno-0-341" href="#__codelineno-0-341"></a><span class="k">AS</span>
</span><span id="__span-0-342"><a id="__codelineno-0-342" name="__codelineno-0-342" href="#__codelineno-0-342"></a>
</span><span id="__span-0-343"><a id="__codelineno-0-343" name="__codelineno-0-343" href="#__codelineno-0-343"></a><span class="k">BEGIN</span>
</span><span id="__span-0-344"><a id="__codelineno-0-344" name="__codelineno-0-344" href="#__codelineno-0-344"></a>
</span><span id="__span-0-345"><a id="__codelineno-0-345" name="__codelineno-0-345" href="#__codelineno-0-345"></a><span class="w">    </span><span class="k">declare</span>
</span><span id="__span-0-346"><a id="__codelineno-0-346" name="__codelineno-0-346" href="#__codelineno-0-346"></a>
</span><span id="__span-0-347"><a id="__codelineno-0-347" name="__codelineno-0-347" href="#__codelineno-0-347"></a><span class="w">        </span><span class="o">@</span><span class="n">n</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span>
</span><span id="__span-0-348"><a id="__codelineno-0-348" name="__codelineno-0-348" href="#__codelineno-0-348"></a>
</span><span id="__span-0-349"><a id="__codelineno-0-349" name="__codelineno-0-349" href="#__codelineno-0-349"></a><span class="w">        </span><span class="o">@</span><span class="n">i</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-0-350"><a id="__codelineno-0-350" name="__codelineno-0-350" href="#__codelineno-0-350"></a>
</span><span id="__span-0-351"><a id="__codelineno-0-351" name="__codelineno-0-351" href="#__codelineno-0-351"></a><span class="w">        </span><span class="o">@</span><span class="n">s</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-0-352"><a id="__codelineno-0-352" name="__codelineno-0-352" href="#__codelineno-0-352"></a>
</span><span id="__span-0-353"><a id="__codelineno-0-353" name="__codelineno-0-353" href="#__codelineno-0-353"></a><span class="w">        </span><span class="o">@</span><span class="n">l</span><span class="w"> </span><span class="nb">int</span><span class="p">;</span>
</span><span id="__span-0-354"><a id="__codelineno-0-354" name="__codelineno-0-354" href="#__codelineno-0-354"></a>
</span><span id="__span-0-355"><a id="__codelineno-0-355" name="__codelineno-0-355" href="#__codelineno-0-355"></a>
</span><span id="__span-0-356"><a id="__codelineno-0-356" name="__codelineno-0-356" href="#__codelineno-0-356"></a>
</span><span id="__span-0-357"><a id="__codelineno-0-357" name="__codelineno-0-357" href="#__codelineno-0-357"></a><span class="w">    </span><span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ceiling</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="o">@</span><span class="k">sql</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8000</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-0-358"><a id="__codelineno-0-358" name="__codelineno-0-358" href="#__codelineno-0-358"></a>
</span><span id="__span-0-359"><a id="__codelineno-0-359" name="__codelineno-0-359" href="#__codelineno-0-359"></a>
</span><span id="__span-0-360"><a id="__codelineno-0-360" name="__codelineno-0-360" href="#__codelineno-0-360"></a>
</span><span id="__span-0-361"><a id="__codelineno-0-361" name="__codelineno-0-361" href="#__codelineno-0-361"></a><span class="w">    </span><span class="n">while</span><span class="w"> </span><span class="o">@</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">@</span><span class="n">n</span>
</span><span id="__span-0-362"><a id="__codelineno-0-362" name="__codelineno-0-362" href="#__codelineno-0-362"></a>
</span><span id="__span-0-363"><a id="__codelineno-0-363" name="__codelineno-0-363" href="#__codelineno-0-363"></a><span class="w">    </span><span class="k">begin</span>
</span><span id="__span-0-364"><a id="__codelineno-0-364" name="__codelineno-0-364" href="#__codelineno-0-364"></a>
</span><span id="__span-0-365"><a id="__codelineno-0-365" name="__codelineno-0-365" href="#__codelineno-0-365"></a><span class="w">        </span><span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">charindex</span><span class="p">(</span><span class="nb">char</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span><span class="w"> </span><span class="n">reverse</span><span class="p">(</span><span class="k">substring</span><span class="p">(</span><span class="o">@</span><span class="k">sql</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mi">8000</span><span class="p">)));</span>
</span><span id="__span-0-366"><a id="__codelineno-0-366" name="__codelineno-0-366" href="#__codelineno-0-366"></a>
</span><span id="__span-0-367"><a id="__codelineno-0-367" name="__codelineno-0-367" href="#__codelineno-0-367"></a><span class="w">        </span><span class="n">print</span><span class="w"> </span><span class="k">substring</span><span class="p">(</span><span class="o">@</span><span class="k">sql</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">l</span><span class="p">);</span>
</span><span id="__span-0-368"><a id="__codelineno-0-368" name="__codelineno-0-368" href="#__codelineno-0-368"></a>
</span><span id="__span-0-369"><a id="__codelineno-0-369" name="__codelineno-0-369" href="#__codelineno-0-369"></a><span class="w">        </span><span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-370"><a id="__codelineno-0-370" name="__codelineno-0-370" href="#__codelineno-0-370"></a>
</span><span id="__span-0-371"><a id="__codelineno-0-371" name="__codelineno-0-371" href="#__codelineno-0-371"></a><span class="w">        </span><span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">s</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">l</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
</span><span id="__span-0-372"><a id="__codelineno-0-372" name="__codelineno-0-372" href="#__codelineno-0-372"></a>
</span><span id="__span-0-373"><a id="__codelineno-0-373" name="__codelineno-0-373" href="#__codelineno-0-373"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-0-374"><a id="__codelineno-0-374" name="__codelineno-0-374" href="#__codelineno-0-374"></a>
</span><span id="__span-0-375"><a id="__codelineno-0-375" name="__codelineno-0-375" href="#__codelineno-0-375"></a>
</span><span id="__span-0-376"><a id="__codelineno-0-376" name="__codelineno-0-376" href="#__codelineno-0-376"></a>
</span><span id="__span-0-377"><a id="__codelineno-0-377" name="__codelineno-0-377" href="#__codelineno-0-377"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-378"><a id="__codelineno-0-378" name="__codelineno-0-378" href="#__codelineno-0-378"></a>
</span><span id="__span-0-379"><a id="__codelineno-0-379" name="__codelineno-0-379" href="#__codelineno-0-379"></a><span class="k">END</span>
</span><span id="__span-0-380"><a id="__codelineno-0-380" name="__codelineno-0-380" href="#__codelineno-0-380"></a>
</span><span id="__span-0-381"><a id="__codelineno-0-381" name="__codelineno-0-381" href="#__codelineno-0-381"></a><span class="k">GO</span>
</span><span id="__span-0-382"><a id="__codelineno-0-382" name="__codelineno-0-382" href="#__codelineno-0-382"></a>
</span><span id="__span-0-383"><a id="__codelineno-0-383" name="__codelineno-0-383" href="#__codelineno-0-383"></a>
</span><span id="__span-0-384"><a id="__codelineno-0-384" name="__codelineno-0-384" href="#__codelineno-0-384"></a>
</span><span id="__span-0-385"><a id="__codelineno-0-385" name="__codelineno-0-385" href="#__codelineno-0-385"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_add_maintenance_action_log</span><span class="p">]</span>
</span><span id="__span-0-386"><a id="__codelineno-0-386" name="__codelineno-0-386" href="#__codelineno-0-386"></a>
</span><span id="__span-0-387"><a id="__codelineno-0-387" name="__codelineno-0-387" href="#__codelineno-0-387"></a><span class="w">    </span><span class="o">@</span><span class="n">TableName</span><span class="w"> </span><span class="n">sysname</span><span class="p">,</span>
</span><span id="__span-0-388"><a id="__codelineno-0-388" name="__codelineno-0-388" href="#__codelineno-0-388"></a>
</span><span id="__span-0-389"><a id="__codelineno-0-389" name="__codelineno-0-389" href="#__codelineno-0-389"></a><span class="w">    </span><span class="o">@</span><span class="n">IndexName</span><span class="w"> </span><span class="n">sysname</span><span class="p">,</span>
</span><span id="__span-0-390"><a id="__codelineno-0-390" name="__codelineno-0-390" href="#__codelineno-0-390"></a>
</span><span id="__span-0-391"><a id="__codelineno-0-391" name="__codelineno-0-391" href="#__codelineno-0-391"></a><span class="w">    </span><span class="o">@</span><span class="k">Operation</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
</span><span id="__span-0-392"><a id="__codelineno-0-392" name="__codelineno-0-392" href="#__codelineno-0-392"></a>
</span><span id="__span-0-393"><a id="__codelineno-0-393" name="__codelineno-0-393" href="#__codelineno-0-393"></a><span class="w">    </span><span class="o">@</span><span class="n">RunDate</span><span class="w"> </span><span class="n">datetime2</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span id="__span-0-394"><a id="__codelineno-0-394" name="__codelineno-0-394" href="#__codelineno-0-394"></a>
</span><span id="__span-0-395"><a id="__codelineno-0-395" name="__codelineno-0-395" href="#__codelineno-0-395"></a><span class="w">    </span><span class="o">@</span><span class="n">StartDate</span><span class="w"> </span><span class="n">datetime2</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span id="__span-0-396"><a id="__codelineno-0-396" name="__codelineno-0-396" href="#__codelineno-0-396"></a>
</span><span id="__span-0-397"><a id="__codelineno-0-397" name="__codelineno-0-397" href="#__codelineno-0-397"></a><span class="w">    </span><span class="o">@</span><span class="n">FinishDate</span><span class="w"> </span><span class="n">datetime2</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span id="__span-0-398"><a id="__codelineno-0-398" name="__codelineno-0-398" href="#__codelineno-0-398"></a>
</span><span id="__span-0-399"><a id="__codelineno-0-399" name="__codelineno-0-399" href="#__codelineno-0-399"></a><span class="w">    </span><span class="o">@</span><span class="n">DatabaseName</span><span class="w"> </span><span class="n">sysname</span><span class="p">,</span>
</span><span id="__span-0-400"><a id="__codelineno-0-400" name="__codelineno-0-400" href="#__codelineno-0-400"></a>
</span><span id="__span-0-401"><a id="__codelineno-0-401" name="__codelineno-0-401" href="#__codelineno-0-401"></a><span class="w">    </span><span class="o">@</span><span class="n">UseOnlineRebuild</span><span class="w"> </span><span class="nb">bit</span><span class="p">,</span>
</span><span id="__span-0-402"><a id="__codelineno-0-402" name="__codelineno-0-402" href="#__codelineno-0-402"></a>
</span><span id="__span-0-403"><a id="__codelineno-0-403" name="__codelineno-0-403" href="#__codelineno-0-403"></a><span class="w">    </span><span class="o">@</span><span class="k">Comment</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
</span><span id="__span-0-404"><a id="__codelineno-0-404" name="__codelineno-0-404" href="#__codelineno-0-404"></a>
</span><span id="__span-0-405"><a id="__codelineno-0-405" name="__codelineno-0-405" href="#__codelineno-0-405"></a><span class="w">    </span><span class="o">@</span><span class="n">IndexFragmentation</span><span class="w"> </span><span class="nb">float</span><span class="p">,</span>
</span><span id="__span-0-406"><a id="__codelineno-0-406" name="__codelineno-0-406" href="#__codelineno-0-406"></a>
</span><span id="__span-0-407"><a id="__codelineno-0-407" name="__codelineno-0-407" href="#__codelineno-0-407"></a><span class="w">    </span><span class="o">@</span><span class="n">RowModCtr</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
</span><span id="__span-0-408"><a id="__codelineno-0-408" name="__codelineno-0-408" href="#__codelineno-0-408"></a>
</span><span id="__span-0-409"><a id="__codelineno-0-409" name="__codelineno-0-409" href="#__codelineno-0-409"></a><span class="w">    </span><span class="o">@</span><span class="n">SQLCommand</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">),</span>
</span><span id="__span-0-410"><a id="__codelineno-0-410" name="__codelineno-0-410" href="#__codelineno-0-410"></a>
</span><span id="__span-0-411"><a id="__codelineno-0-411" name="__codelineno-0-411" href="#__codelineno-0-411"></a><span class="w">    </span><span class="o">@</span><span class="n">MaintenanceActionLogId</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="k">OUTPUT</span>
</span><span id="__span-0-412"><a id="__codelineno-0-412" name="__codelineno-0-412" href="#__codelineno-0-412"></a>
</span><span id="__span-0-413"><a id="__codelineno-0-413" name="__codelineno-0-413" href="#__codelineno-0-413"></a><span class="k">AS</span>
</span><span id="__span-0-414"><a id="__codelineno-0-414" name="__codelineno-0-414" href="#__codelineno-0-414"></a>
</span><span id="__span-0-415"><a id="__codelineno-0-415" name="__codelineno-0-415" href="#__codelineno-0-415"></a><span class="k">BEGIN</span>
</span><span id="__span-0-416"><a id="__codelineno-0-416" name="__codelineno-0-416" href="#__codelineno-0-416"></a>
</span><span id="__span-0-417"><a id="__codelineno-0-417" name="__codelineno-0-417" href="#__codelineno-0-417"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">NOCOUNT</span><span class="w"> </span><span class="k">ON</span><span class="p">;</span>
</span><span id="__span-0-418"><a id="__codelineno-0-418" name="__codelineno-0-418" href="#__codelineno-0-418"></a>
</span><span id="__span-0-419"><a id="__codelineno-0-419" name="__codelineno-0-419" href="#__codelineno-0-419"></a>
</span><span id="__span-0-420"><a id="__codelineno-0-420" name="__codelineno-0-420" href="#__codelineno-0-420"></a>
</span><span id="__span-0-421"><a id="__codelineno-0-421" name="__codelineno-0-421" href="#__codelineno-0-421"></a><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">IdentityOutput</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-0-422"><a id="__codelineno-0-422" name="__codelineno-0-422" href="#__codelineno-0-422"></a>
</span><span id="__span-0-423"><a id="__codelineno-0-423" name="__codelineno-0-423" href="#__codelineno-0-423"></a>
</span><span id="__span-0-424"><a id="__codelineno-0-424" name="__codelineno-0-424" href="#__codelineno-0-424"></a>
</span><span id="__span-0-425"><a id="__codelineno-0-425" name="__codelineno-0-425" href="#__codelineno-0-425"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">TableName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">REPLACE</span><span class="p">(</span><span class="o">@</span><span class="n">TableName</span><span class="p">,</span><span class="w"> </span><span class="s1">'['</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span>
</span><span id="__span-0-426"><a id="__codelineno-0-426" name="__codelineno-0-426" href="#__codelineno-0-426"></a>
</span><span id="__span-0-427"><a id="__codelineno-0-427" name="__codelineno-0-427" href="#__codelineno-0-427"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">TableName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">REPLACE</span><span class="p">(</span><span class="o">@</span><span class="n">TableName</span><span class="p">,</span><span class="w"> </span><span class="s1">']'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span>
</span><span id="__span-0-428"><a id="__codelineno-0-428" name="__codelineno-0-428" href="#__codelineno-0-428"></a>
</span><span id="__span-0-429"><a id="__codelineno-0-429" name="__codelineno-0-429" href="#__codelineno-0-429"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">IndexName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">REPLACE</span><span class="p">(</span><span class="o">@</span><span class="n">IndexName</span><span class="p">,</span><span class="w"> </span><span class="s1">'['</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span>
</span><span id="__span-0-430"><a id="__codelineno-0-430" name="__codelineno-0-430" href="#__codelineno-0-430"></a>
</span><span id="__span-0-431"><a id="__codelineno-0-431" name="__codelineno-0-431" href="#__codelineno-0-431"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">IndexName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">REPLACE</span><span class="p">(</span><span class="o">@</span><span class="n">IndexName</span><span class="p">,</span><span class="w"> </span><span class="s1">']'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span>
</span><span id="__span-0-432"><a id="__codelineno-0-432" name="__codelineno-0-432" href="#__codelineno-0-432"></a>
</span><span id="__span-0-433"><a id="__codelineno-0-433" name="__codelineno-0-433" href="#__codelineno-0-433"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">DatabaseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">REPLACE</span><span class="p">(</span><span class="o">@</span><span class="n">DatabaseName</span><span class="p">,</span><span class="w"> </span><span class="s1">'['</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span>
</span><span id="__span-0-434"><a id="__codelineno-0-434" name="__codelineno-0-434" href="#__codelineno-0-434"></a>
</span><span id="__span-0-435"><a id="__codelineno-0-435" name="__codelineno-0-435" href="#__codelineno-0-435"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">DatabaseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">REPLACE</span><span class="p">(</span><span class="o">@</span><span class="n">DatabaseName</span><span class="p">,</span><span class="w"> </span><span class="s1">']'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span>
</span><span id="__span-0-436"><a id="__codelineno-0-436" name="__codelineno-0-436" href="#__codelineno-0-436"></a>
</span><span id="__span-0-437"><a id="__codelineno-0-437" name="__codelineno-0-437" href="#__codelineno-0-437"></a>
</span><span id="__span-0-438"><a id="__codelineno-0-438" name="__codelineno-0-438" href="#__codelineno-0-438"></a>
</span><span id="__span-0-439"><a id="__codelineno-0-439" name="__codelineno-0-439" href="#__codelineno-0-439"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">RowModCtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ISNULL</span><span class="p">(</span><span class="o">@</span><span class="n">RowModCtr</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-0-440"><a id="__codelineno-0-440" name="__codelineno-0-440" href="#__codelineno-0-440"></a>
</span><span id="__span-0-441"><a id="__codelineno-0-441" name="__codelineno-0-441" href="#__codelineno-0-441"></a>
</span><span id="__span-0-442"><a id="__codelineno-0-442" name="__codelineno-0-442" href="#__codelineno-0-442"></a>
</span><span id="__span-0-443"><a id="__codelineno-0-443" name="__codelineno-0-443" href="#__codelineno-0-443"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">SQLCommand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LTRIM</span><span class="p">(</span><span class="n">RTRIM</span><span class="p">((</span><span class="k">REPLACE</span><span class="p">(</span><span class="k">REPLACE</span><span class="p">(</span><span class="o">@</span><span class="n">SQLCommand</span><span class="p">,</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span><span class="w"> </span><span class="s1">''</span><span class="p">),</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="s1">''</span><span class="p">))));</span>
</span><span id="__span-0-444"><a id="__codelineno-0-444" name="__codelineno-0-444" href="#__codelineno-0-444"></a>
</span><span id="__span-0-445"><a id="__codelineno-0-445" name="__codelineno-0-445" href="#__codelineno-0-445"></a>
</span><span id="__span-0-446"><a id="__codelineno-0-446" name="__codelineno-0-446" href="#__codelineno-0-446"></a>
</span><span id="__span-0-447"><a id="__codelineno-0-447" name="__codelineno-0-447" href="#__codelineno-0-447"></a><span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MaintenanceActionsLog</span><span class="p">]</span>
</span><span id="__span-0-448"><a id="__codelineno-0-448" name="__codelineno-0-448" href="#__codelineno-0-448"></a>
</span><span id="__span-0-449"><a id="__codelineno-0-449" name="__codelineno-0-449" href="#__codelineno-0-449"></a><span class="w">    </span><span class="p">(</span>
</span><span id="__span-0-450"><a id="__codelineno-0-450" name="__codelineno-0-450" href="#__codelineno-0-450"></a>
</span><span id="__span-0-451"><a id="__codelineno-0-451" name="__codelineno-0-451" href="#__codelineno-0-451"></a><span class="w">        </span><span class="p">[</span><span class="k">Period</span><span class="p">]</span>
</span><span id="__span-0-452"><a id="__codelineno-0-452" name="__codelineno-0-452" href="#__codelineno-0-452"></a>
</span><span id="__span-0-453"><a id="__codelineno-0-453" name="__codelineno-0-453" href="#__codelineno-0-453"></a><span class="w">        </span><span class="p">,[</span><span class="n">TableName</span><span class="p">]</span>
</span><span id="__span-0-454"><a id="__codelineno-0-454" name="__codelineno-0-454" href="#__codelineno-0-454"></a>
</span><span id="__span-0-455"><a id="__codelineno-0-455" name="__codelineno-0-455" href="#__codelineno-0-455"></a><span class="w">        </span><span class="p">,[</span><span class="n">IndexName</span><span class="p">]</span>
</span><span id="__span-0-456"><a id="__codelineno-0-456" name="__codelineno-0-456" href="#__codelineno-0-456"></a>
</span><span id="__span-0-457"><a id="__codelineno-0-457" name="__codelineno-0-457" href="#__codelineno-0-457"></a><span class="w">        </span><span class="p">,[</span><span class="k">Operation</span><span class="p">]</span>
</span><span id="__span-0-458"><a id="__codelineno-0-458" name="__codelineno-0-458" href="#__codelineno-0-458"></a>
</span><span id="__span-0-459"><a id="__codelineno-0-459" name="__codelineno-0-459" href="#__codelineno-0-459"></a><span class="w">        </span><span class="p">,[</span><span class="n">RunDate</span><span class="p">]</span>
</span><span id="__span-0-460"><a id="__codelineno-0-460" name="__codelineno-0-460" href="#__codelineno-0-460"></a>
</span><span id="__span-0-461"><a id="__codelineno-0-461" name="__codelineno-0-461" href="#__codelineno-0-461"></a><span class="w">        </span><span class="p">,[</span><span class="n">StartDate</span><span class="p">]</span>
</span><span id="__span-0-462"><a id="__codelineno-0-462" name="__codelineno-0-462" href="#__codelineno-0-462"></a>
</span><span id="__span-0-463"><a id="__codelineno-0-463" name="__codelineno-0-463" href="#__codelineno-0-463"></a><span class="w">        </span><span class="p">,[</span><span class="n">FinishDate</span><span class="p">]</span>
</span><span id="__span-0-464"><a id="__codelineno-0-464" name="__codelineno-0-464" href="#__codelineno-0-464"></a>
</span><span id="__span-0-465"><a id="__codelineno-0-465" name="__codelineno-0-465" href="#__codelineno-0-465"></a><span class="w">        </span><span class="p">,[</span><span class="n">DatabaseName</span><span class="p">]</span>
</span><span id="__span-0-466"><a id="__codelineno-0-466" name="__codelineno-0-466" href="#__codelineno-0-466"></a>
</span><span id="__span-0-467"><a id="__codelineno-0-467" name="__codelineno-0-467" href="#__codelineno-0-467"></a><span class="w">        </span><span class="p">,[</span><span class="n">UseOnlineRebuild</span><span class="p">]</span>
</span><span id="__span-0-468"><a id="__codelineno-0-468" name="__codelineno-0-468" href="#__codelineno-0-468"></a>
</span><span id="__span-0-469"><a id="__codelineno-0-469" name="__codelineno-0-469" href="#__codelineno-0-469"></a><span class="w">        </span><span class="p">,[</span><span class="k">Comment</span><span class="p">]</span>
</span><span id="__span-0-470"><a id="__codelineno-0-470" name="__codelineno-0-470" href="#__codelineno-0-470"></a>
</span><span id="__span-0-471"><a id="__codelineno-0-471" name="__codelineno-0-471" href="#__codelineno-0-471"></a><span class="w">        </span><span class="p">,[</span><span class="n">IndexFragmentation</span><span class="p">]</span>
</span><span id="__span-0-472"><a id="__codelineno-0-472" name="__codelineno-0-472" href="#__codelineno-0-472"></a>
</span><span id="__span-0-473"><a id="__codelineno-0-473" name="__codelineno-0-473" href="#__codelineno-0-473"></a><span class="w">        </span><span class="p">,[</span><span class="n">RowModCtr</span><span class="p">]</span>
</span><span id="__span-0-474"><a id="__codelineno-0-474" name="__codelineno-0-474" href="#__codelineno-0-474"></a>
</span><span id="__span-0-475"><a id="__codelineno-0-475" name="__codelineno-0-475" href="#__codelineno-0-475"></a><span class="w">        </span><span class="p">,[</span><span class="n">SQLCommand</span><span class="p">]</span>
</span><span id="__span-0-476"><a id="__codelineno-0-476" name="__codelineno-0-476" href="#__codelineno-0-476"></a>
</span><span id="__span-0-477"><a id="__codelineno-0-477" name="__codelineno-0-477" href="#__codelineno-0-477"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-0-478"><a id="__codelineno-0-478" name="__codelineno-0-478" href="#__codelineno-0-478"></a>
</span><span id="__span-0-479"><a id="__codelineno-0-479" name="__codelineno-0-479" href="#__codelineno-0-479"></a><span class="w">    </span><span class="k">OUTPUT</span><span class="w"> </span><span class="n">inserted</span><span class="p">.</span><span class="n">Id</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="o">@</span><span class="n">IdentityOutput</span>
</span><span id="__span-0-480"><a id="__codelineno-0-480" name="__codelineno-0-480" href="#__codelineno-0-480"></a>
</span><span id="__span-0-481"><a id="__codelineno-0-481" name="__codelineno-0-481" href="#__codelineno-0-481"></a><span class="w">    </span><span class="k">VALUES</span>
</span><span id="__span-0-482"><a id="__codelineno-0-482" name="__codelineno-0-482" href="#__codelineno-0-482"></a>
</span><span id="__span-0-483"><a id="__codelineno-0-483" name="__codelineno-0-483" href="#__codelineno-0-483"></a><span class="w">    </span><span class="p">(</span>
</span><span id="__span-0-484"><a id="__codelineno-0-484" name="__codelineno-0-484" href="#__codelineno-0-484"></a>
</span><span id="__span-0-485"><a id="__codelineno-0-485" name="__codelineno-0-485" href="#__codelineno-0-485"></a><span class="w">        </span><span class="n">GETDATE</span><span class="p">()</span>
</span><span id="__span-0-486"><a id="__codelineno-0-486" name="__codelineno-0-486" href="#__codelineno-0-486"></a>
</span><span id="__span-0-487"><a id="__codelineno-0-487" name="__codelineno-0-487" href="#__codelineno-0-487"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">TableName</span>
</span><span id="__span-0-488"><a id="__codelineno-0-488" name="__codelineno-0-488" href="#__codelineno-0-488"></a>
</span><span id="__span-0-489"><a id="__codelineno-0-489" name="__codelineno-0-489" href="#__codelineno-0-489"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">IndexName</span>
</span><span id="__span-0-490"><a id="__codelineno-0-490" name="__codelineno-0-490" href="#__codelineno-0-490"></a>
</span><span id="__span-0-491"><a id="__codelineno-0-491" name="__codelineno-0-491" href="#__codelineno-0-491"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="k">Operation</span>
</span><span id="__span-0-492"><a id="__codelineno-0-492" name="__codelineno-0-492" href="#__codelineno-0-492"></a>
</span><span id="__span-0-493"><a id="__codelineno-0-493" name="__codelineno-0-493" href="#__codelineno-0-493"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">RunDate</span>
</span><span id="__span-0-494"><a id="__codelineno-0-494" name="__codelineno-0-494" href="#__codelineno-0-494"></a>
</span><span id="__span-0-495"><a id="__codelineno-0-495" name="__codelineno-0-495" href="#__codelineno-0-495"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">StartDate</span>
</span><span id="__span-0-496"><a id="__codelineno-0-496" name="__codelineno-0-496" href="#__codelineno-0-496"></a>
</span><span id="__span-0-497"><a id="__codelineno-0-497" name="__codelineno-0-497" href="#__codelineno-0-497"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">FinishDate</span>
</span><span id="__span-0-498"><a id="__codelineno-0-498" name="__codelineno-0-498" href="#__codelineno-0-498"></a>
</span><span id="__span-0-499"><a id="__codelineno-0-499" name="__codelineno-0-499" href="#__codelineno-0-499"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">DatabaseName</span>
</span><span id="__span-0-500"><a id="__codelineno-0-500" name="__codelineno-0-500" href="#__codelineno-0-500"></a>
</span><span id="__span-0-501"><a id="__codelineno-0-501" name="__codelineno-0-501" href="#__codelineno-0-501"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">UseOnlineRebuild</span>
</span><span id="__span-0-502"><a id="__codelineno-0-502" name="__codelineno-0-502" href="#__codelineno-0-502"></a>
</span><span id="__span-0-503"><a id="__codelineno-0-503" name="__codelineno-0-503" href="#__codelineno-0-503"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="k">Comment</span>
</span><span id="__span-0-504"><a id="__codelineno-0-504" name="__codelineno-0-504" href="#__codelineno-0-504"></a>
</span><span id="__span-0-505"><a id="__codelineno-0-505" name="__codelineno-0-505" href="#__codelineno-0-505"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">IndexFragmentation</span>
</span><span id="__span-0-506"><a id="__codelineno-0-506" name="__codelineno-0-506" href="#__codelineno-0-506"></a>
</span><span id="__span-0-507"><a id="__codelineno-0-507" name="__codelineno-0-507" href="#__codelineno-0-507"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">RowModCtr</span>
</span><span id="__span-0-508"><a id="__codelineno-0-508" name="__codelineno-0-508" href="#__codelineno-0-508"></a>
</span><span id="__span-0-509"><a id="__codelineno-0-509" name="__codelineno-0-509" href="#__codelineno-0-509"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">SQLCommand</span>
</span><span id="__span-0-510"><a id="__codelineno-0-510" name="__codelineno-0-510" href="#__codelineno-0-510"></a>
</span><span id="__span-0-511"><a id="__codelineno-0-511" name="__codelineno-0-511" href="#__codelineno-0-511"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-0-512"><a id="__codelineno-0-512" name="__codelineno-0-512" href="#__codelineno-0-512"></a>
</span><span id="__span-0-513"><a id="__codelineno-0-513" name="__codelineno-0-513" href="#__codelineno-0-513"></a>
</span><span id="__span-0-514"><a id="__codelineno-0-514" name="__codelineno-0-514" href="#__codelineno-0-514"></a>
</span><span id="__span-0-515"><a id="__codelineno-0-515" name="__codelineno-0-515" href="#__codelineno-0-515"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">MaintenanceActionLogId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">Id</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">IdentityOutput</span><span class="p">)</span>
</span><span id="__span-0-516"><a id="__codelineno-0-516" name="__codelineno-0-516" href="#__codelineno-0-516"></a>
</span><span id="__span-0-517"><a id="__codelineno-0-517" name="__codelineno-0-517" href="#__codelineno-0-517"></a>
</span><span id="__span-0-518"><a id="__codelineno-0-518" name="__codelineno-0-518" href="#__codelineno-0-518"></a>
</span><span id="__span-0-519"><a id="__codelineno-0-519" name="__codelineno-0-519" href="#__codelineno-0-519"></a><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-520"><a id="__codelineno-0-520" name="__codelineno-0-520" href="#__codelineno-0-520"></a>
</span><span id="__span-0-521"><a id="__codelineno-0-521" name="__codelineno-0-521" href="#__codelineno-0-521"></a><span class="k">END</span>
</span><span id="__span-0-522"><a id="__codelineno-0-522" name="__codelineno-0-522" href="#__codelineno-0-522"></a>
</span><span id="__span-0-523"><a id="__codelineno-0-523" name="__codelineno-0-523" href="#__codelineno-0-523"></a><span class="k">GO</span>
</span><span id="__span-0-524"><a id="__codelineno-0-524" name="__codelineno-0-524" href="#__codelineno-0-524"></a>
</span><span id="__span-0-525"><a id="__codelineno-0-525" name="__codelineno-0-525" href="#__codelineno-0-525"></a>
</span><span id="__span-0-526"><a id="__codelineno-0-526" name="__codelineno-0-526" href="#__codelineno-0-526"></a>
</span><span id="__span-0-527"><a id="__codelineno-0-527" name="__codelineno-0-527" href="#__codelineno-0-527"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_FillConnectionsStatistic</span><span class="p">]</span>
</span><span id="__span-0-528"><a id="__codelineno-0-528" name="__codelineno-0-528" href="#__codelineno-0-528"></a>
</span><span id="__span-0-529"><a id="__codelineno-0-529" name="__codelineno-0-529" href="#__codelineno-0-529"></a><span class="w">    </span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w"> </span><span class="n">sysname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'SQLServerMaintenance'</span>
</span><span id="__span-0-530"><a id="__codelineno-0-530" name="__codelineno-0-530" href="#__codelineno-0-530"></a>
</span><span id="__span-0-531"><a id="__codelineno-0-531" name="__codelineno-0-531" href="#__codelineno-0-531"></a><span class="k">AS</span>
</span><span id="__span-0-532"><a id="__codelineno-0-532" name="__codelineno-0-532" href="#__codelineno-0-532"></a>
</span><span id="__span-0-533"><a id="__codelineno-0-533" name="__codelineno-0-533" href="#__codelineno-0-533"></a><span class="k">BEGIN</span>
</span><span id="__span-0-534"><a id="__codelineno-0-534" name="__codelineno-0-534" href="#__codelineno-0-534"></a>
</span><span id="__span-0-535"><a id="__codelineno-0-535" name="__codelineno-0-535" href="#__codelineno-0-535"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">NOCOUNT</span><span class="w"> </span><span class="k">ON</span><span class="p">;</span>
</span><span id="__span-0-536"><a id="__codelineno-0-536" name="__codelineno-0-536" href="#__codelineno-0-536"></a>
</span><span id="__span-0-537"><a id="__codelineno-0-537" name="__codelineno-0-537" href="#__codelineno-0-537"></a>
</span><span id="__span-0-538"><a id="__codelineno-0-538" name="__codelineno-0-538" href="#__codelineno-0-538"></a>
</span><span id="__span-0-539"><a id="__codelineno-0-539" name="__codelineno-0-539" href="#__codelineno-0-539"></a><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
</span><span id="__span-0-540"><a id="__codelineno-0-540" name="__codelineno-0-540" href="#__codelineno-0-540"></a>
</span><span id="__span-0-541"><a id="__codelineno-0-541" name="__codelineno-0-541" href="#__codelineno-0-541"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
</span><span id="__span-0-542"><a id="__codelineno-0-542" name="__codelineno-0-542" href="#__codelineno-0-542"></a>
</span><span id="__span-0-543"><a id="__codelineno-0-543" name="__codelineno-0-543" href="#__codelineno-0-543"></a><span class="k">CAST</span><span class="p">(</span><span class="s1">'</span>
</span><span id="__span-0-544"><a id="__codelineno-0-544" name="__codelineno-0-544" href="#__codelineno-0-544"></a>
</span><span id="__span-0-545"><a id="__codelineno-0-545" name="__codelineno-0-545" href="#__codelineno-0-545"></a><span class="s1">SET NOCOUNT ON;</span>
</span><span id="__span-0-546"><a id="__codelineno-0-546" name="__codelineno-0-546" href="#__codelineno-0-546"></a>
</span><span id="__span-0-547"><a id="__codelineno-0-547" name="__codelineno-0-547" href="#__codelineno-0-547"></a><span class="s1">INSERT INTO ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'].[dbo].[ConnectionsStatistic]</span>
</span><span id="__span-0-548"><a id="__codelineno-0-548" name="__codelineno-0-548" href="#__codelineno-0-548"></a>
</span><span id="__span-0-549"><a id="__codelineno-0-549" name="__codelineno-0-549" href="#__codelineno-0-549"></a><span class="s1">        ([Period]</span>
</span><span id="__span-0-550"><a id="__codelineno-0-550" name="__codelineno-0-550" href="#__codelineno-0-550"></a>
</span><span id="__span-0-551"><a id="__codelineno-0-551" name="__codelineno-0-551" href="#__codelineno-0-551"></a><span class="s1">        ,[InstanceName]</span>
</span><span id="__span-0-552"><a id="__codelineno-0-552" name="__codelineno-0-552" href="#__codelineno-0-552"></a>
</span><span id="__span-0-553"><a id="__codelineno-0-553" name="__codelineno-0-553" href="#__codelineno-0-553"></a><span class="s1">        ,[QueryText]</span>
</span><span id="__span-0-554"><a id="__codelineno-0-554" name="__codelineno-0-554" href="#__codelineno-0-554"></a>
</span><span id="__span-0-555"><a id="__codelineno-0-555" name="__codelineno-0-555" href="#__codelineno-0-555"></a><span class="s1">        ,[RowCountSize]</span>
</span><span id="__span-0-556"><a id="__codelineno-0-556" name="__codelineno-0-556" href="#__codelineno-0-556"></a>
</span><span id="__span-0-557"><a id="__codelineno-0-557" name="__codelineno-0-557" href="#__codelineno-0-557"></a><span class="s1">        ,[SessionId]</span>
</span><span id="__span-0-558"><a id="__codelineno-0-558" name="__codelineno-0-558" href="#__codelineno-0-558"></a>
</span><span id="__span-0-559"><a id="__codelineno-0-559" name="__codelineno-0-559" href="#__codelineno-0-559"></a><span class="s1">        ,[Status]</span>
</span><span id="__span-0-560"><a id="__codelineno-0-560" name="__codelineno-0-560" href="#__codelineno-0-560"></a>
</span><span id="__span-0-561"><a id="__codelineno-0-561" name="__codelineno-0-561" href="#__codelineno-0-561"></a><span class="s1">        ,[Command]</span>
</span><span id="__span-0-562"><a id="__codelineno-0-562" name="__codelineno-0-562" href="#__codelineno-0-562"></a>
</span><span id="__span-0-563"><a id="__codelineno-0-563" name="__codelineno-0-563" href="#__codelineno-0-563"></a><span class="s1">        ,[CPU]</span>
</span><span id="__span-0-564"><a id="__codelineno-0-564" name="__codelineno-0-564" href="#__codelineno-0-564"></a>
</span><span id="__span-0-565"><a id="__codelineno-0-565" name="__codelineno-0-565" href="#__codelineno-0-565"></a><span class="s1">        ,[TotalElapsedTime]</span>
</span><span id="__span-0-566"><a id="__codelineno-0-566" name="__codelineno-0-566" href="#__codelineno-0-566"></a>
</span><span id="__span-0-567"><a id="__codelineno-0-567" name="__codelineno-0-567" href="#__codelineno-0-567"></a><span class="s1">        ,[StartTime]</span>
</span><span id="__span-0-568"><a id="__codelineno-0-568" name="__codelineno-0-568" href="#__codelineno-0-568"></a>
</span><span id="__span-0-569"><a id="__codelineno-0-569" name="__codelineno-0-569" href="#__codelineno-0-569"></a><span class="s1">        ,[DatabaseName]</span>
</span><span id="__span-0-570"><a id="__codelineno-0-570" name="__codelineno-0-570" href="#__codelineno-0-570"></a>
</span><span id="__span-0-571"><a id="__codelineno-0-571" name="__codelineno-0-571" href="#__codelineno-0-571"></a><span class="s1">        ,[BlockingSessionId]</span>
</span><span id="__span-0-572"><a id="__codelineno-0-572" name="__codelineno-0-572" href="#__codelineno-0-572"></a>
</span><span id="__span-0-573"><a id="__codelineno-0-573" name="__codelineno-0-573" href="#__codelineno-0-573"></a><span class="s1">        ,[WaitType]</span>
</span><span id="__span-0-574"><a id="__codelineno-0-574" name="__codelineno-0-574" href="#__codelineno-0-574"></a>
</span><span id="__span-0-575"><a id="__codelineno-0-575" name="__codelineno-0-575" href="#__codelineno-0-575"></a><span class="s1">        ,[WaitTime]</span>
</span><span id="__span-0-576"><a id="__codelineno-0-576" name="__codelineno-0-576" href="#__codelineno-0-576"></a>
</span><span id="__span-0-577"><a id="__codelineno-0-577" name="__codelineno-0-577" href="#__codelineno-0-577"></a><span class="s1">        ,[WaitResource]</span>
</span><span id="__span-0-578"><a id="__codelineno-0-578" name="__codelineno-0-578" href="#__codelineno-0-578"></a>
</span><span id="__span-0-579"><a id="__codelineno-0-579" name="__codelineno-0-579" href="#__codelineno-0-579"></a><span class="s1">        ,[OpenTransactionCount]</span>
</span><span id="__span-0-580"><a id="__codelineno-0-580" name="__codelineno-0-580" href="#__codelineno-0-580"></a>
</span><span id="__span-0-581"><a id="__codelineno-0-581" name="__codelineno-0-581" href="#__codelineno-0-581"></a><span class="s1">        ,[Reads]</span>
</span><span id="__span-0-582"><a id="__codelineno-0-582" name="__codelineno-0-582" href="#__codelineno-0-582"></a>
</span><span id="__span-0-583"><a id="__codelineno-0-583" name="__codelineno-0-583" href="#__codelineno-0-583"></a><span class="s1">        ,[Writes]</span>
</span><span id="__span-0-584"><a id="__codelineno-0-584" name="__codelineno-0-584" href="#__codelineno-0-584"></a>
</span><span id="__span-0-585"><a id="__codelineno-0-585" name="__codelineno-0-585" href="#__codelineno-0-585"></a><span class="s1">        ,[LogicalReads]</span>
</span><span id="__span-0-586"><a id="__codelineno-0-586" name="__codelineno-0-586" href="#__codelineno-0-586"></a>
</span><span id="__span-0-587"><a id="__codelineno-0-587" name="__codelineno-0-587" href="#__codelineno-0-587"></a><span class="s1">        ,[GrantedQueryMemory]</span>
</span><span id="__span-0-588"><a id="__codelineno-0-588" name="__codelineno-0-588" href="#__codelineno-0-588"></a>
</span><span id="__span-0-589"><a id="__codelineno-0-589" name="__codelineno-0-589" href="#__codelineno-0-589"></a><span class="s1">        ,[UserName]</span>
</span><span id="__span-0-590"><a id="__codelineno-0-590" name="__codelineno-0-590" href="#__codelineno-0-590"></a>
</span><span id="__span-0-591"><a id="__codelineno-0-591" name="__codelineno-0-591" href="#__codelineno-0-591"></a><span class="s1">)</span>
</span><span id="__span-0-592"><a id="__codelineno-0-592" name="__codelineno-0-592" href="#__codelineno-0-592"></a>
</span><span id="__span-0-593"><a id="__codelineno-0-593" name="__codelineno-0-593" href="#__codelineno-0-593"></a><span class="s1">SELECT </span>
</span><span id="__span-0-594"><a id="__codelineno-0-594" name="__codelineno-0-594" href="#__codelineno-0-594"></a>
</span><span id="__span-0-595"><a id="__codelineno-0-595" name="__codelineno-0-595" href="#__codelineno-0-595"></a><span class="s1">    GetDate() AS [Period],</span>
</span><span id="__span-0-596"><a id="__codelineno-0-596" name="__codelineno-0-596" href="#__codelineno-0-596"></a>
</span><span id="__span-0-597"><a id="__codelineno-0-597" name="__codelineno-0-597" href="#__codelineno-0-597"></a><span class="s1">    @@servername AS [HostName],</span>
</span><span id="__span-0-598"><a id="__codelineno-0-598" name="__codelineno-0-598" href="#__codelineno-0-598"></a>
</span><span id="__span-0-599"><a id="__codelineno-0-599" name="__codelineno-0-599" href="#__codelineno-0-599"></a><span class="s1">    sqltext.TEXT AS [QueryText],</span>
</span><span id="__span-0-600"><a id="__codelineno-0-600" name="__codelineno-0-600" href="#__codelineno-0-600"></a>
</span><span id="__span-0-601"><a id="__codelineno-0-601" name="__codelineno-0-601" href="#__codelineno-0-601"></a><span class="s1">    req.row_count AS [RowCountSize],</span>
</span><span id="__span-0-602"><a id="__codelineno-0-602" name="__codelineno-0-602" href="#__codelineno-0-602"></a>
</span><span id="__span-0-603"><a id="__codelineno-0-603" name="__codelineno-0-603" href="#__codelineno-0-603"></a><span class="s1">    req.session_id AS [SessionId],</span>
</span><span id="__span-0-604"><a id="__codelineno-0-604" name="__codelineno-0-604" href="#__codelineno-0-604"></a>
</span><span id="__span-0-605"><a id="__codelineno-0-605" name="__codelineno-0-605" href="#__codelineno-0-605"></a><span class="s1">    req.status AS [Status],</span>
</span><span id="__span-0-606"><a id="__codelineno-0-606" name="__codelineno-0-606" href="#__codelineno-0-606"></a>
</span><span id="__span-0-607"><a id="__codelineno-0-607" name="__codelineno-0-607" href="#__codelineno-0-607"></a><span class="s1">    req.command AS [Command],</span>
</span><span id="__span-0-608"><a id="__codelineno-0-608" name="__codelineno-0-608" href="#__codelineno-0-608"></a>
</span><span id="__span-0-609"><a id="__codelineno-0-609" name="__codelineno-0-609" href="#__codelineno-0-609"></a><span class="s1">    req.cpu_time AS [CPU],</span>
</span><span id="__span-0-610"><a id="__codelineno-0-610" name="__codelineno-0-610" href="#__codelineno-0-610"></a>
</span><span id="__span-0-611"><a id="__codelineno-0-611" name="__codelineno-0-611" href="#__codelineno-0-611"></a><span class="s1">    req.total_elapsed_time AS [TotalElapsedTime],</span>
</span><span id="__span-0-612"><a id="__codelineno-0-612" name="__codelineno-0-612" href="#__codelineno-0-612"></a>
</span><span id="__span-0-613"><a id="__codelineno-0-613" name="__codelineno-0-613" href="#__codelineno-0-613"></a><span class="s1">    req.start_time AS [StartTime],</span>
</span><span id="__span-0-614"><a id="__codelineno-0-614" name="__codelineno-0-614" href="#__codelineno-0-614"></a>
</span><span id="__span-0-615"><a id="__codelineno-0-615" name="__codelineno-0-615" href="#__codelineno-0-615"></a><span class="s1">    DB_NAME(req.database_id) AS [DatabaseName],</span>
</span><span id="__span-0-616"><a id="__codelineno-0-616" name="__codelineno-0-616" href="#__codelineno-0-616"></a>
</span><span id="__span-0-617"><a id="__codelineno-0-617" name="__codelineno-0-617" href="#__codelineno-0-617"></a><span class="s1">    req.blocking_session_id AS [BlockingSessionId],</span>
</span><span id="__span-0-618"><a id="__codelineno-0-618" name="__codelineno-0-618" href="#__codelineno-0-618"></a>
</span><span id="__span-0-619"><a id="__codelineno-0-619" name="__codelineno-0-619" href="#__codelineno-0-619"></a><span class="s1">    req.wait_type AS [WaitType],</span>
</span><span id="__span-0-620"><a id="__codelineno-0-620" name="__codelineno-0-620" href="#__codelineno-0-620"></a>
</span><span id="__span-0-621"><a id="__codelineno-0-621" name="__codelineno-0-621" href="#__codelineno-0-621"></a><span class="s1">    req.wait_time AS [WaitTime],</span>
</span><span id="__span-0-622"><a id="__codelineno-0-622" name="__codelineno-0-622" href="#__codelineno-0-622"></a>
</span><span id="__span-0-623"><a id="__codelineno-0-623" name="__codelineno-0-623" href="#__codelineno-0-623"></a><span class="s1">    req.wait_resource AS [WaitResource],</span>
</span><span id="__span-0-624"><a id="__codelineno-0-624" name="__codelineno-0-624" href="#__codelineno-0-624"></a>
</span><span id="__span-0-625"><a id="__codelineno-0-625" name="__codelineno-0-625" href="#__codelineno-0-625"></a><span class="s1">    req.open_transaction_count AS [OpenTransactionCount],</span>
</span><span id="__span-0-626"><a id="__codelineno-0-626" name="__codelineno-0-626" href="#__codelineno-0-626"></a>
</span><span id="__span-0-627"><a id="__codelineno-0-627" name="__codelineno-0-627" href="#__codelineno-0-627"></a><span class="s1">    req.reads as [Reads],</span>
</span><span id="__span-0-628"><a id="__codelineno-0-628" name="__codelineno-0-628" href="#__codelineno-0-628"></a>
</span><span id="__span-0-629"><a id="__codelineno-0-629" name="__codelineno-0-629" href="#__codelineno-0-629"></a><span class="s1">    req.reads as [Writes],</span>
</span><span id="__span-0-630"><a id="__codelineno-0-630" name="__codelineno-0-630" href="#__codelineno-0-630"></a>
</span><span id="__span-0-631"><a id="__codelineno-0-631" name="__codelineno-0-631" href="#__codelineno-0-631"></a><span class="s1">    req.logical_reads as [LogicalReads],</span>
</span><span id="__span-0-632"><a id="__codelineno-0-632" name="__codelineno-0-632" href="#__codelineno-0-632"></a>
</span><span id="__span-0-633"><a id="__codelineno-0-633" name="__codelineno-0-633" href="#__codelineno-0-633"></a><span class="s1">    req.granted_query_memory as [GrantedQueryMemory],</span>
</span><span id="__span-0-634"><a id="__codelineno-0-634" name="__codelineno-0-634" href="#__codelineno-0-634"></a>
</span><span id="__span-0-635"><a id="__codelineno-0-635" name="__codelineno-0-635" href="#__codelineno-0-635"></a><span class="s1">    SUSER_NAME(user_id) AS [UserName]</span>
</span><span id="__span-0-636"><a id="__codelineno-0-636" name="__codelineno-0-636" href="#__codelineno-0-636"></a>
</span><span id="__span-0-637"><a id="__codelineno-0-637" name="__codelineno-0-637" href="#__codelineno-0-637"></a><span class="s1">FROM sys.dm_exec_requests req</span>
</span><span id="__span-0-638"><a id="__codelineno-0-638" name="__codelineno-0-638" href="#__codelineno-0-638"></a>
</span><span id="__span-0-639"><a id="__codelineno-0-639" name="__codelineno-0-639" href="#__codelineno-0-639"></a><span class="s1">    OUTER APPLY sys.dm_exec_sql_text(sql_handle) AS sqltext</span>
</span><span id="__span-0-640"><a id="__codelineno-0-640" name="__codelineno-0-640" href="#__codelineno-0-640"></a>
</span><span id="__span-0-641"><a id="__codelineno-0-641" name="__codelineno-0-641" href="#__codelineno-0-641"></a><span class="s1">'</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">));</span>
</span><span id="__span-0-642"><a id="__codelineno-0-642" name="__codelineno-0-642" href="#__codelineno-0-642"></a>
</span><span id="__span-0-643"><a id="__codelineno-0-643" name="__codelineno-0-643" href="#__codelineno-0-643"></a>
</span><span id="__span-0-644"><a id="__codelineno-0-644" name="__codelineno-0-644" href="#__codelineno-0-644"></a>
</span><span id="__span-0-645"><a id="__codelineno-0-645" name="__codelineno-0-645" href="#__codelineno-0-645"></a><span class="w">    </span><span class="k">EXECUTE</span><span class="w"> </span><span class="n">sp_executesql</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="p">;</span>
</span><span id="__span-0-646"><a id="__codelineno-0-646" name="__codelineno-0-646" href="#__codelineno-0-646"></a>
</span><span id="__span-0-647"><a id="__codelineno-0-647" name="__codelineno-0-647" href="#__codelineno-0-647"></a>
</span><span id="__span-0-648"><a id="__codelineno-0-648" name="__codelineno-0-648" href="#__codelineno-0-648"></a>
</span><span id="__span-0-649"><a id="__codelineno-0-649" name="__codelineno-0-649" href="#__codelineno-0-649"></a><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-650"><a id="__codelineno-0-650" name="__codelineno-0-650" href="#__codelineno-0-650"></a>
</span><span id="__span-0-651"><a id="__codelineno-0-651" name="__codelineno-0-651" href="#__codelineno-0-651"></a><span class="k">END</span>
</span><span id="__span-0-652"><a id="__codelineno-0-652" name="__codelineno-0-652" href="#__codelineno-0-652"></a>
</span><span id="__span-0-653"><a id="__codelineno-0-653" name="__codelineno-0-653" href="#__codelineno-0-653"></a><span class="k">GO</span>
</span><span id="__span-0-654"><a id="__codelineno-0-654" name="__codelineno-0-654" href="#__codelineno-0-654"></a>
</span><span id="__span-0-655"><a id="__codelineno-0-655" name="__codelineno-0-655" href="#__codelineno-0-655"></a>
</span><span id="__span-0-656"><a id="__codelineno-0-656" name="__codelineno-0-656" href="#__codelineno-0-656"></a>
</span><span id="__span-0-657"><a id="__codelineno-0-657" name="__codelineno-0-657" href="#__codelineno-0-657"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_FillDatabaseObjectsState</span><span class="p">]</span>
</span><span id="__span-0-658"><a id="__codelineno-0-658" name="__codelineno-0-658" href="#__codelineno-0-658"></a>
</span><span id="__span-0-659"><a id="__codelineno-0-659" name="__codelineno-0-659" href="#__codelineno-0-659"></a><span class="w">    </span><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="n">sysname</span><span class="p">,</span>
</span><span id="__span-0-660"><a id="__codelineno-0-660" name="__codelineno-0-660" href="#__codelineno-0-660"></a>
</span><span id="__span-0-661"><a id="__codelineno-0-661" name="__codelineno-0-661" href="#__codelineno-0-661"></a><span class="w">    </span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w"> </span><span class="n">sysname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'SQLServerMaintenance'</span>
</span><span id="__span-0-662"><a id="__codelineno-0-662" name="__codelineno-0-662" href="#__codelineno-0-662"></a>
</span><span id="__span-0-663"><a id="__codelineno-0-663" name="__codelineno-0-663" href="#__codelineno-0-663"></a><span class="k">AS</span>
</span><span id="__span-0-664"><a id="__codelineno-0-664" name="__codelineno-0-664" href="#__codelineno-0-664"></a>
</span><span id="__span-0-665"><a id="__codelineno-0-665" name="__codelineno-0-665" href="#__codelineno-0-665"></a><span class="k">BEGIN</span>
</span><span id="__span-0-666"><a id="__codelineno-0-666" name="__codelineno-0-666" href="#__codelineno-0-666"></a>
</span><span id="__span-0-667"><a id="__codelineno-0-667" name="__codelineno-0-667" href="#__codelineno-0-667"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">NOCOUNT</span><span class="w"> </span><span class="k">ON</span><span class="p">;</span>
</span><span id="__span-0-668"><a id="__codelineno-0-668" name="__codelineno-0-668" href="#__codelineno-0-668"></a>
</span><span id="__span-0-669"><a id="__codelineno-0-669" name="__codelineno-0-669" href="#__codelineno-0-669"></a>
</span><span id="__span-0-670"><a id="__codelineno-0-670" name="__codelineno-0-670" href="#__codelineno-0-670"></a>
</span><span id="__span-0-671"><a id="__codelineno-0-671" name="__codelineno-0-671" href="#__codelineno-0-671"></a><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">msg</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
</span><span id="__span-0-672"><a id="__codelineno-0-672" name="__codelineno-0-672" href="#__codelineno-0-672"></a>
</span><span id="__span-0-673"><a id="__codelineno-0-673" name="__codelineno-0-673" href="#__codelineno-0-673"></a>
</span><span id="__span-0-674"><a id="__codelineno-0-674" name="__codelineno-0-674" href="#__codelineno-0-674"></a>
</span><span id="__span-0-675"><a id="__codelineno-0-675" name="__codelineno-0-675" href="#__codelineno-0-675"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">DB_ID</span><span class="p">(</span><span class="o">@</span><span class="n">databaseName</span><span class="p">)</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-0-676"><a id="__codelineno-0-676" name="__codelineno-0-676" href="#__codelineno-0-676"></a>
</span><span id="__span-0-677"><a id="__codelineno-0-677" name="__codelineno-0-677" href="#__codelineno-0-677"></a><span class="w">    </span><span class="k">BEGIN</span>
</span><span id="__span-0-678"><a id="__codelineno-0-678" name="__codelineno-0-678" href="#__codelineno-0-678"></a>
</span><span id="__span-0-679"><a id="__codelineno-0-679" name="__codelineno-0-679" href="#__codelineno-0-679"></a><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Database '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">' is not exists.'</span><span class="p">;</span>
</span><span id="__span-0-680"><a id="__codelineno-0-680" name="__codelineno-0-680" href="#__codelineno-0-680"></a>
</span><span id="__span-0-681"><a id="__codelineno-0-681" name="__codelineno-0-681" href="#__codelineno-0-681"></a><span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="mi">51000</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-682"><a id="__codelineno-0-682" name="__codelineno-0-682" href="#__codelineno-0-682"></a>
</span><span id="__span-0-683"><a id="__codelineno-0-683" name="__codelineno-0-683" href="#__codelineno-0-683"></a><span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-684"><a id="__codelineno-0-684" name="__codelineno-0-684" href="#__codelineno-0-684"></a>
</span><span id="__span-0-685"><a id="__codelineno-0-685" name="__codelineno-0-685" href="#__codelineno-0-685"></a><span class="w">    </span><span class="k">END</span>
</span><span id="__span-0-686"><a id="__codelineno-0-686" name="__codelineno-0-686" href="#__codelineno-0-686"></a>
</span><span id="__span-0-687"><a id="__codelineno-0-687" name="__codelineno-0-687" href="#__codelineno-0-687"></a>
</span><span id="__span-0-688"><a id="__codelineno-0-688" name="__codelineno-0-688" href="#__codelineno-0-688"></a>
</span><span id="__span-0-689"><a id="__codelineno-0-689" name="__codelineno-0-689" href="#__codelineno-0-689"></a><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
</span><span id="__span-0-690"><a id="__codelineno-0-690" name="__codelineno-0-690" href="#__codelineno-0-690"></a>
</span><span id="__span-0-691"><a id="__codelineno-0-691" name="__codelineno-0-691" href="#__codelineno-0-691"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
</span><span id="__span-0-692"><a id="__codelineno-0-692" name="__codelineno-0-692" href="#__codelineno-0-692"></a>
</span><span id="__span-0-693"><a id="__codelineno-0-693" name="__codelineno-0-693" href="#__codelineno-0-693"></a><span class="k">CAST</span><span class="p">(</span><span class="s1">'USE ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">databasename</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">']</span>
</span><span id="__span-0-694"><a id="__codelineno-0-694" name="__codelineno-0-694" href="#__codelineno-0-694"></a>
</span><span id="__span-0-695"><a id="__codelineno-0-695" name="__codelineno-0-695" href="#__codelineno-0-695"></a><span class="s1">SET NOCOUNT ON;</span>
</span><span id="__span-0-696"><a id="__codelineno-0-696" name="__codelineno-0-696" href="#__codelineno-0-696"></a>
</span><span id="__span-0-697"><a id="__codelineno-0-697" name="__codelineno-0-697" href="#__codelineno-0-697"></a><span class="s1">INSERT INTO ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'].[dbo].[DatabaseObjectsState](</span>
</span><span id="__span-0-698"><a id="__codelineno-0-698" name="__codelineno-0-698" href="#__codelineno-0-698"></a>
</span><span id="__span-0-699"><a id="__codelineno-0-699" name="__codelineno-0-699" href="#__codelineno-0-699"></a><span class="s1">    [Period]</span>
</span><span id="__span-0-700"><a id="__codelineno-0-700" name="__codelineno-0-700" href="#__codelineno-0-700"></a>
</span><span id="__span-0-701"><a id="__codelineno-0-701" name="__codelineno-0-701" href="#__codelineno-0-701"></a><span class="s1">    ,[DatabaseName]</span>
</span><span id="__span-0-702"><a id="__codelineno-0-702" name="__codelineno-0-702" href="#__codelineno-0-702"></a>
</span><span id="__span-0-703"><a id="__codelineno-0-703" name="__codelineno-0-703" href="#__codelineno-0-703"></a><span class="s1">    ,[TableName]</span>
</span><span id="__span-0-704"><a id="__codelineno-0-704" name="__codelineno-0-704" href="#__codelineno-0-704"></a>
</span><span id="__span-0-705"><a id="__codelineno-0-705" name="__codelineno-0-705" href="#__codelineno-0-705"></a><span class="s1">    ,[Object]</span>
</span><span id="__span-0-706"><a id="__codelineno-0-706" name="__codelineno-0-706" href="#__codelineno-0-706"></a>
</span><span id="__span-0-707"><a id="__codelineno-0-707" name="__codelineno-0-707" href="#__codelineno-0-707"></a><span class="s1">    ,[PageCount]</span>
</span><span id="__span-0-708"><a id="__codelineno-0-708" name="__codelineno-0-708" href="#__codelineno-0-708"></a>
</span><span id="__span-0-709"><a id="__codelineno-0-709" name="__codelineno-0-709" href="#__codelineno-0-709"></a><span class="s1">    ,[Rowmodctr]</span>
</span><span id="__span-0-710"><a id="__codelineno-0-710" name="__codelineno-0-710" href="#__codelineno-0-710"></a>
</span><span id="__span-0-711"><a id="__codelineno-0-711" name="__codelineno-0-711" href="#__codelineno-0-711"></a><span class="s1">    ,[AvgFragmentationPercent]</span>
</span><span id="__span-0-712"><a id="__codelineno-0-712" name="__codelineno-0-712" href="#__codelineno-0-712"></a>
</span><span id="__span-0-713"><a id="__codelineno-0-713" name="__codelineno-0-713" href="#__codelineno-0-713"></a><span class="s1">    ,[OnlineRebuildSupport]</span>
</span><span id="__span-0-714"><a id="__codelineno-0-714" name="__codelineno-0-714" href="#__codelineno-0-714"></a>
</span><span id="__span-0-715"><a id="__codelineno-0-715" name="__codelineno-0-715" href="#__codelineno-0-715"></a><span class="s1">    ,[Compression]</span>
</span><span id="__span-0-716"><a id="__codelineno-0-716" name="__codelineno-0-716" href="#__codelineno-0-716"></a>
</span><span id="__span-0-717"><a id="__codelineno-0-717" name="__codelineno-0-717" href="#__codelineno-0-717"></a><span class="s1">    ,[PartitionCount]</span>
</span><span id="__span-0-718"><a id="__codelineno-0-718" name="__codelineno-0-718" href="#__codelineno-0-718"></a>
</span><span id="__span-0-719"><a id="__codelineno-0-719" name="__codelineno-0-719" href="#__codelineno-0-719"></a><span class="s1">)</span>
</span><span id="__span-0-720"><a id="__codelineno-0-720" name="__codelineno-0-720" href="#__codelineno-0-720"></a>
</span><span id="__span-0-721"><a id="__codelineno-0-721" name="__codelineno-0-721" href="#__codelineno-0-721"></a><span class="s1">SELECT</span>
</span><span id="__span-0-722"><a id="__codelineno-0-722" name="__codelineno-0-722" href="#__codelineno-0-722"></a>
</span><span id="__span-0-723"><a id="__codelineno-0-723" name="__codelineno-0-723" href="#__codelineno-0-723"></a><span class="s1">GETDATE() AS [Period],</span>
</span><span id="__span-0-724"><a id="__codelineno-0-724" name="__codelineno-0-724" href="#__codelineno-0-724"></a>
</span><span id="__span-0-725"><a id="__codelineno-0-725" name="__codelineno-0-725" href="#__codelineno-0-725"></a><span class="s1">'''</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">databasename</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">''' AS [DatabaseName],</span>
</span><span id="__span-0-726"><a id="__codelineno-0-726" name="__codelineno-0-726" href="#__codelineno-0-726"></a>
</span><span id="__span-0-727"><a id="__codelineno-0-727" name="__codelineno-0-727" href="#__codelineno-0-727"></a><span class="s1">OBJECT_NAME(dt.[object_id]) AS [Table], </span>
</span><span id="__span-0-728"><a id="__codelineno-0-728" name="__codelineno-0-728" href="#__codelineno-0-728"></a>
</span><span id="__span-0-729"><a id="__codelineno-0-729" name="__codelineno-0-729" href="#__codelineno-0-729"></a><span class="s1">ind.name AS [Object],</span>
</span><span id="__span-0-730"><a id="__codelineno-0-730" name="__codelineno-0-730" href="#__codelineno-0-730"></a>
</span><span id="__span-0-731"><a id="__codelineno-0-731" name="__codelineno-0-731" href="#__codelineno-0-731"></a><span class="s1">MAX(CAST([page_count] AS BIGINT)) AS [page_count], </span>
</span><span id="__span-0-732"><a id="__codelineno-0-732" name="__codelineno-0-732" href="#__codelineno-0-732"></a>
</span><span id="__span-0-733"><a id="__codelineno-0-733" name="__codelineno-0-733" href="#__codelineno-0-733"></a><span class="s1">SUM(CAST([si].[rowmodctr] AS BIGINT)) AS [rowmodctr],</span>
</span><span id="__span-0-734"><a id="__codelineno-0-734" name="__codelineno-0-734" href="#__codelineno-0-734"></a>
</span><span id="__span-0-735"><a id="__codelineno-0-735" name="__codelineno-0-735" href="#__codelineno-0-735"></a><span class="s1">MAX([avg_fragmentation_in_percent]) AS [frag], </span>
</span><span id="__span-0-736"><a id="__codelineno-0-736" name="__codelineno-0-736" href="#__codelineno-0-736"></a>
</span><span id="__span-0-737"><a id="__codelineno-0-737" name="__codelineno-0-737" href="#__codelineno-0-737"></a><span class="s1">MIN(CASE WHEN objBadTypes.IndexObjectId IS NULL THEN 1 ELSE 0 END) AS [OnlineRebuildSupport],</span>
</span><span id="__span-0-738"><a id="__codelineno-0-738" name="__codelineno-0-738" href="#__codelineno-0-738"></a>
</span><span id="__span-0-739"><a id="__codelineno-0-739" name="__codelineno-0-739" href="#__codelineno-0-739"></a><span class="s1">MAX(p.data_compression_desc) AS [Compression],</span>
</span><span id="__span-0-740"><a id="__codelineno-0-740" name="__codelineno-0-740" href="#__codelineno-0-740"></a>
</span><span id="__span-0-741"><a id="__codelineno-0-741" name="__codelineno-0-741" href="#__codelineno-0-741"></a><span class="s1">MAX(p_count.[PartitionCount]) AS [PartitionCount]</span>
</span><span id="__span-0-742"><a id="__codelineno-0-742" name="__codelineno-0-742" href="#__codelineno-0-742"></a>
</span><span id="__span-0-743"><a id="__codelineno-0-743" name="__codelineno-0-743" href="#__codelineno-0-743"></a><span class="s1">FROM </span>
</span><span id="__span-0-744"><a id="__codelineno-0-744" name="__codelineno-0-744" href="#__codelineno-0-744"></a>
</span><span id="__span-0-745"><a id="__codelineno-0-745" name="__codelineno-0-745" href="#__codelineno-0-745"></a><span class="s1">sys.dm_db_index_physical_stats (</span>
</span><span id="__span-0-746"><a id="__codelineno-0-746" name="__codelineno-0-746" href="#__codelineno-0-746"></a>
</span><span id="__span-0-747"><a id="__codelineno-0-747" name="__codelineno-0-747" href="#__codelineno-0-747"></a><span class="s1">    DB_ID(), </span>
</span><span id="__span-0-748"><a id="__codelineno-0-748" name="__codelineno-0-748" href="#__codelineno-0-748"></a>
</span><span id="__span-0-749"><a id="__codelineno-0-749" name="__codelineno-0-749" href="#__codelineno-0-749"></a><span class="s1">    NULL, </span>
</span><span id="__span-0-750"><a id="__codelineno-0-750" name="__codelineno-0-750" href="#__codelineno-0-750"></a>
</span><span id="__span-0-751"><a id="__codelineno-0-751" name="__codelineno-0-751" href="#__codelineno-0-751"></a><span class="s1">    NULL, </span>
</span><span id="__span-0-752"><a id="__codelineno-0-752" name="__codelineno-0-752" href="#__codelineno-0-752"></a>
</span><span id="__span-0-753"><a id="__codelineno-0-753" name="__codelineno-0-753" href="#__codelineno-0-753"></a><span class="s1">    NULL, </span>
</span><span id="__span-0-754"><a id="__codelineno-0-754" name="__codelineno-0-754" href="#__codelineno-0-754"></a>
</span><span id="__span-0-755"><a id="__codelineno-0-755" name="__codelineno-0-755" href="#__codelineno-0-755"></a><span class="s1">    N''LIMITED''</span>
</span><span id="__span-0-756"><a id="__codelineno-0-756" name="__codelineno-0-756" href="#__codelineno-0-756"></a>
</span><span id="__span-0-757"><a id="__codelineno-0-757" name="__codelineno-0-757" href="#__codelineno-0-757"></a><span class="s1">) dt </span>
</span><span id="__span-0-758"><a id="__codelineno-0-758" name="__codelineno-0-758" href="#__codelineno-0-758"></a>
</span><span id="__span-0-759"><a id="__codelineno-0-759" name="__codelineno-0-759" href="#__codelineno-0-759"></a><span class="s1">LEFT JOIN sys.partitions p</span>
</span><span id="__span-0-760"><a id="__codelineno-0-760" name="__codelineno-0-760" href="#__codelineno-0-760"></a>
</span><span id="__span-0-761"><a id="__codelineno-0-761" name="__codelineno-0-761" href="#__codelineno-0-761"></a><span class="s1">    ON dt.object_id = p.object_id and p.partition_number = 1</span>
</span><span id="__span-0-762"><a id="__codelineno-0-762" name="__codelineno-0-762" href="#__codelineno-0-762"></a>
</span><span id="__span-0-763"><a id="__codelineno-0-763" name="__codelineno-0-763" href="#__codelineno-0-763"></a><span class="s1">LEFT JOIN sys.sysindexes si ON dt.object_id = si.id </span>
</span><span id="__span-0-764"><a id="__codelineno-0-764" name="__codelineno-0-764" href="#__codelineno-0-764"></a>
</span><span id="__span-0-765"><a id="__codelineno-0-765" name="__codelineno-0-765" href="#__codelineno-0-765"></a><span class="s1">LEFT JOIN (</span>
</span><span id="__span-0-766"><a id="__codelineno-0-766" name="__codelineno-0-766" href="#__codelineno-0-766"></a>
</span><span id="__span-0-767"><a id="__codelineno-0-767" name="__codelineno-0-767" href="#__codelineno-0-767"></a><span class="s1">        SELECT </span>
</span><span id="__span-0-768"><a id="__codelineno-0-768" name="__codelineno-0-768" href="#__codelineno-0-768"></a>
</span><span id="__span-0-769"><a id="__codelineno-0-769" name="__codelineno-0-769" href="#__codelineno-0-769"></a><span class="s1">        t.object_id AS [TableObjectId], </span>
</span><span id="__span-0-770"><a id="__codelineno-0-770" name="__codelineno-0-770" href="#__codelineno-0-770"></a>
</span><span id="__span-0-771"><a id="__codelineno-0-771" name="__codelineno-0-771" href="#__codelineno-0-771"></a><span class="s1">        ind.index_id AS [IndexObjectId]</span>
</span><span id="__span-0-772"><a id="__codelineno-0-772" name="__codelineno-0-772" href="#__codelineno-0-772"></a>
</span><span id="__span-0-773"><a id="__codelineno-0-773" name="__codelineno-0-773" href="#__codelineno-0-773"></a><span class="s1">        FROM </span>
</span><span id="__span-0-774"><a id="__codelineno-0-774" name="__codelineno-0-774" href="#__codelineno-0-774"></a>
</span><span id="__span-0-775"><a id="__codelineno-0-775" name="__codelineno-0-775" href="#__codelineno-0-775"></a><span class="s1">        sys.indexes ind </span>
</span><span id="__span-0-776"><a id="__codelineno-0-776" name="__codelineno-0-776" href="#__codelineno-0-776"></a>
</span><span id="__span-0-777"><a id="__codelineno-0-777" name="__codelineno-0-777" href="#__codelineno-0-777"></a><span class="s1">        INNER JOIN sys.index_columns ic ON ind.object_id = ic.object_id </span>
</span><span id="__span-0-778"><a id="__codelineno-0-778" name="__codelineno-0-778" href="#__codelineno-0-778"></a>
</span><span id="__span-0-779"><a id="__codelineno-0-779" name="__codelineno-0-779" href="#__codelineno-0-779"></a><span class="s1">        and ind.index_id = ic.index_id </span>
</span><span id="__span-0-780"><a id="__codelineno-0-780" name="__codelineno-0-780" href="#__codelineno-0-780"></a>
</span><span id="__span-0-781"><a id="__codelineno-0-781" name="__codelineno-0-781" href="#__codelineno-0-781"></a><span class="s1">        INNER JOIN sys.columns col ON ic.object_id = col.object_id </span>
</span><span id="__span-0-782"><a id="__codelineno-0-782" name="__codelineno-0-782" href="#__codelineno-0-782"></a>
</span><span id="__span-0-783"><a id="__codelineno-0-783" name="__codelineno-0-783" href="#__codelineno-0-783"></a><span class="s1">        and ic.column_id = col.column_id </span>
</span><span id="__span-0-784"><a id="__codelineno-0-784" name="__codelineno-0-784" href="#__codelineno-0-784"></a>
</span><span id="__span-0-785"><a id="__codelineno-0-785" name="__codelineno-0-785" href="#__codelineno-0-785"></a><span class="s1">        INNER JOIN sys.tables t ON ind.object_id = t.object_id </span>
</span><span id="__span-0-786"><a id="__codelineno-0-786" name="__codelineno-0-786" href="#__codelineno-0-786"></a>
</span><span id="__span-0-787"><a id="__codelineno-0-787" name="__codelineno-0-787" href="#__codelineno-0-787"></a><span class="s1">        LEFT JOIN INFORMATION_SCHEMA.COLUMNS tbsc ON t.schema_id = SCHEMA_ID(tbsc.TABLE_SCHEMA) </span>
</span><span id="__span-0-788"><a id="__codelineno-0-788" name="__codelineno-0-788" href="#__codelineno-0-788"></a>
</span><span id="__span-0-789"><a id="__codelineno-0-789" name="__codelineno-0-789" href="#__codelineno-0-789"></a><span class="s1">        AND t.name = tbsc.TABLE_NAME </span>
</span><span id="__span-0-790"><a id="__codelineno-0-790" name="__codelineno-0-790" href="#__codelineno-0-790"></a>
</span><span id="__span-0-791"><a id="__codelineno-0-791" name="__codelineno-0-791" href="#__codelineno-0-791"></a><span class="s1">        LEFT JOIN sys.types tps ON col.system_type_id = tps.system_type_id </span>
</span><span id="__span-0-792"><a id="__codelineno-0-792" name="__codelineno-0-792" href="#__codelineno-0-792"></a>
</span><span id="__span-0-793"><a id="__codelineno-0-793" name="__codelineno-0-793" href="#__codelineno-0-793"></a><span class="s1">        AND col.user_type_id = tps.user_type_id </span>
</span><span id="__span-0-794"><a id="__codelineno-0-794" name="__codelineno-0-794" href="#__codelineno-0-794"></a>
</span><span id="__span-0-795"><a id="__codelineno-0-795" name="__codelineno-0-795" href="#__codelineno-0-795"></a><span class="s1">        WHERE </span>
</span><span id="__span-0-796"><a id="__codelineno-0-796" name="__codelineno-0-796" href="#__codelineno-0-796"></a>
</span><span id="__span-0-797"><a id="__codelineno-0-797" name="__codelineno-0-797" href="#__codelineno-0-797"></a><span class="s1">        t.is_ms_shipped = 0 </span>
</span><span id="__span-0-798"><a id="__codelineno-0-798" name="__codelineno-0-798" href="#__codelineno-0-798"></a>
</span><span id="__span-0-799"><a id="__codelineno-0-799" name="__codelineno-0-799" href="#__codelineno-0-799"></a><span class="s1">        AND CASE WHEN ind.type_desc = ''CLUSTERED'' THEN CASE WHEN tbsc.DATA_TYPE IN (</span>
</span><span id="__span-0-800"><a id="__codelineno-0-800" name="__codelineno-0-800" href="#__codelineno-0-800"></a>
</span><span id="__span-0-801"><a id="__codelineno-0-801" name="__codelineno-0-801" href="#__codelineno-0-801"></a><span class="s1">            ''text'', ''ntext'', ''image'', ''FILESTREAM''</span>
</span><span id="__span-0-802"><a id="__codelineno-0-802" name="__codelineno-0-802" href="#__codelineno-0-802"></a>
</span><span id="__span-0-803"><a id="__codelineno-0-803" name="__codelineno-0-803" href="#__codelineno-0-803"></a><span class="s1">        ) THEN 1 ELSE 0 END ELSE CASE WHEN tps.[name] IN (</span>
</span><span id="__span-0-804"><a id="__codelineno-0-804" name="__codelineno-0-804" href="#__codelineno-0-804"></a>
</span><span id="__span-0-805"><a id="__codelineno-0-805" name="__codelineno-0-805" href="#__codelineno-0-805"></a><span class="s1">            ''text'', ''ntext'', ''image'', ''FILESTREAM''</span>
</span><span id="__span-0-806"><a id="__codelineno-0-806" name="__codelineno-0-806" href="#__codelineno-0-806"></a>
</span><span id="__span-0-807"><a id="__codelineno-0-807" name="__codelineno-0-807" href="#__codelineno-0-807"></a><span class="s1">        ) THEN 1 ELSE 0 END END &gt; 0 </span>
</span><span id="__span-0-808"><a id="__codelineno-0-808" name="__codelineno-0-808" href="#__codelineno-0-808"></a>
</span><span id="__span-0-809"><a id="__codelineno-0-809" name="__codelineno-0-809" href="#__codelineno-0-809"></a><span class="s1">        GROUP BY </span>
</span><span id="__span-0-810"><a id="__codelineno-0-810" name="__codelineno-0-810" href="#__codelineno-0-810"></a>
</span><span id="__span-0-811"><a id="__codelineno-0-811" name="__codelineno-0-811" href="#__codelineno-0-811"></a><span class="s1">        t.object_id, </span>
</span><span id="__span-0-812"><a id="__codelineno-0-812" name="__codelineno-0-812" href="#__codelineno-0-812"></a>
</span><span id="__span-0-813"><a id="__codelineno-0-813" name="__codelineno-0-813" href="#__codelineno-0-813"></a><span class="s1">        ind.index_id</span>
</span><span id="__span-0-814"><a id="__codelineno-0-814" name="__codelineno-0-814" href="#__codelineno-0-814"></a>
</span><span id="__span-0-815"><a id="__codelineno-0-815" name="__codelineno-0-815" href="#__codelineno-0-815"></a><span class="s1">    ) AS objBadTypes ON objBadTypes.TableObjectId = dt.object_id </span>
</span><span id="__span-0-816"><a id="__codelineno-0-816" name="__codelineno-0-816" href="#__codelineno-0-816"></a>
</span><span id="__span-0-817"><a id="__codelineno-0-817" name="__codelineno-0-817" href="#__codelineno-0-817"></a><span class="s1">    AND objBadTypes.IndexObjectId = dt.index_id</span>
</span><span id="__span-0-818"><a id="__codelineno-0-818" name="__codelineno-0-818" href="#__codelineno-0-818"></a>
</span><span id="__span-0-819"><a id="__codelineno-0-819" name="__codelineno-0-819" href="#__codelineno-0-819"></a><span class="s1">    LEFT JOIN sys.indexes AS [ind]</span>
</span><span id="__span-0-820"><a id="__codelineno-0-820" name="__codelineno-0-820" href="#__codelineno-0-820"></a>
</span><span id="__span-0-821"><a id="__codelineno-0-821" name="__codelineno-0-821" href="#__codelineno-0-821"></a><span class="s1">        ON dt.object_id = [ind].object_id AND dt.index_id = [ind].[index_id]</span>
</span><span id="__span-0-822"><a id="__codelineno-0-822" name="__codelineno-0-822" href="#__codelineno-0-822"></a>
</span><span id="__span-0-823"><a id="__codelineno-0-823" name="__codelineno-0-823" href="#__codelineno-0-823"></a><span class="s1">    LEFT JOIN (</span>
</span><span id="__span-0-824"><a id="__codelineno-0-824" name="__codelineno-0-824" href="#__codelineno-0-824"></a>
</span><span id="__span-0-825"><a id="__codelineno-0-825" name="__codelineno-0-825" href="#__codelineno-0-825"></a><span class="s1">        SELECT</span>
</span><span id="__span-0-826"><a id="__codelineno-0-826" name="__codelineno-0-826" href="#__codelineno-0-826"></a>
</span><span id="__span-0-827"><a id="__codelineno-0-827" name="__codelineno-0-827" href="#__codelineno-0-827"></a><span class="s1">            object_id,</span>
</span><span id="__span-0-828"><a id="__codelineno-0-828" name="__codelineno-0-828" href="#__codelineno-0-828"></a>
</span><span id="__span-0-829"><a id="__codelineno-0-829" name="__codelineno-0-829" href="#__codelineno-0-829"></a><span class="s1">            index_id,</span>
</span><span id="__span-0-830"><a id="__codelineno-0-830" name="__codelineno-0-830" href="#__codelineno-0-830"></a>
</span><span id="__span-0-831"><a id="__codelineno-0-831" name="__codelineno-0-831" href="#__codelineno-0-831"></a><span class="s1">            COUNT(DISTINCT partition_number) AS [PartitionCount]</span>
</span><span id="__span-0-832"><a id="__codelineno-0-832" name="__codelineno-0-832" href="#__codelineno-0-832"></a>
</span><span id="__span-0-833"><a id="__codelineno-0-833" name="__codelineno-0-833" href="#__codelineno-0-833"></a><span class="s1">        FROM sys.partitions p</span>
</span><span id="__span-0-834"><a id="__codelineno-0-834" name="__codelineno-0-834" href="#__codelineno-0-834"></a>
</span><span id="__span-0-835"><a id="__codelineno-0-835" name="__codelineno-0-835" href="#__codelineno-0-835"></a><span class="s1">        GROUP BY object_id, index_id</span>
</span><span id="__span-0-836"><a id="__codelineno-0-836" name="__codelineno-0-836" href="#__codelineno-0-836"></a>
</span><span id="__span-0-837"><a id="__codelineno-0-837" name="__codelineno-0-837" href="#__codelineno-0-837"></a><span class="s1">    ) p_count</span>
</span><span id="__span-0-838"><a id="__codelineno-0-838" name="__codelineno-0-838" href="#__codelineno-0-838"></a>
</span><span id="__span-0-839"><a id="__codelineno-0-839" name="__codelineno-0-839" href="#__codelineno-0-839"></a><span class="s1">    ON dt.object_id = p_count.object_id AND dt.index_id = p_count.index_id</span>
</span><span id="__span-0-840"><a id="__codelineno-0-840" name="__codelineno-0-840" href="#__codelineno-0-840"></a>
</span><span id="__span-0-841"><a id="__codelineno-0-841" name="__codelineno-0-841" href="#__codelineno-0-841"></a><span class="s1">WHERE </span>
</span><span id="__span-0-842"><a id="__codelineno-0-842" name="__codelineno-0-842" href="#__codelineno-0-842"></a>
</span><span id="__span-0-843"><a id="__codelineno-0-843" name="__codelineno-0-843" href="#__codelineno-0-843"></a><span class="s1">[rowmodctr] IS NOT NULL -- Исключаем служебные объекты, по которым нет изменений</span>
</span><span id="__span-0-844"><a id="__codelineno-0-844" name="__codelineno-0-844" href="#__codelineno-0-844"></a>
</span><span id="__span-0-845"><a id="__codelineno-0-845" name="__codelineno-0-845" href="#__codelineno-0-845"></a><span class="s1">AND dt.[index_id] &gt; 0 -- игнорируем кучи (heap)</span>
</span><span id="__span-0-846"><a id="__codelineno-0-846" name="__codelineno-0-846" href="#__codelineno-0-846"></a>
</span><span id="__span-0-847"><a id="__codelineno-0-847" name="__codelineno-0-847" href="#__codelineno-0-847"></a><span class="s1">GROUP BY</span>
</span><span id="__span-0-848"><a id="__codelineno-0-848" name="__codelineno-0-848" href="#__codelineno-0-848"></a>
</span><span id="__span-0-849"><a id="__codelineno-0-849" name="__codelineno-0-849" href="#__codelineno-0-849"></a><span class="s1">    dt.[object_id], </span>
</span><span id="__span-0-850"><a id="__codelineno-0-850" name="__codelineno-0-850" href="#__codelineno-0-850"></a>
</span><span id="__span-0-851"><a id="__codelineno-0-851" name="__codelineno-0-851" href="#__codelineno-0-851"></a><span class="s1">    dt.[index_id],</span>
</span><span id="__span-0-852"><a id="__codelineno-0-852" name="__codelineno-0-852" href="#__codelineno-0-852"></a>
</span><span id="__span-0-853"><a id="__codelineno-0-853" name="__codelineno-0-853" href="#__codelineno-0-853"></a><span class="s1">    ind.[name],</span>
</span><span id="__span-0-854"><a id="__codelineno-0-854" name="__codelineno-0-854" href="#__codelineno-0-854"></a>
</span><span id="__span-0-855"><a id="__codelineno-0-855" name="__codelineno-0-855" href="#__codelineno-0-855"></a><span class="s1">    dt.[partition_number]</span>
</span><span id="__span-0-856"><a id="__codelineno-0-856" name="__codelineno-0-856" href="#__codelineno-0-856"></a>
</span><span id="__span-0-857"><a id="__codelineno-0-857" name="__codelineno-0-857" href="#__codelineno-0-857"></a><span class="s1">'</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">));</span>
</span><span id="__span-0-858"><a id="__codelineno-0-858" name="__codelineno-0-858" href="#__codelineno-0-858"></a>
</span><span id="__span-0-859"><a id="__codelineno-0-859" name="__codelineno-0-859" href="#__codelineno-0-859"></a>
</span><span id="__span-0-860"><a id="__codelineno-0-860" name="__codelineno-0-860" href="#__codelineno-0-860"></a>
</span><span id="__span-0-861"><a id="__codelineno-0-861" name="__codelineno-0-861" href="#__codelineno-0-861"></a><span class="w">    </span><span class="k">EXECUTE</span><span class="w"> </span><span class="n">sp_executesql</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="p">;</span>
</span><span id="__span-0-862"><a id="__codelineno-0-862" name="__codelineno-0-862" href="#__codelineno-0-862"></a>
</span><span id="__span-0-863"><a id="__codelineno-0-863" name="__codelineno-0-863" href="#__codelineno-0-863"></a>
</span><span id="__span-0-864"><a id="__codelineno-0-864" name="__codelineno-0-864" href="#__codelineno-0-864"></a>
</span><span id="__span-0-865"><a id="__codelineno-0-865" name="__codelineno-0-865" href="#__codelineno-0-865"></a><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-866"><a id="__codelineno-0-866" name="__codelineno-0-866" href="#__codelineno-0-866"></a>
</span><span id="__span-0-867"><a id="__codelineno-0-867" name="__codelineno-0-867" href="#__codelineno-0-867"></a><span class="k">END</span>
</span><span id="__span-0-868"><a id="__codelineno-0-868" name="__codelineno-0-868" href="#__codelineno-0-868"></a>
</span><span id="__span-0-869"><a id="__codelineno-0-869" name="__codelineno-0-869" href="#__codelineno-0-869"></a><span class="k">GO</span>
</span><span id="__span-0-870"><a id="__codelineno-0-870" name="__codelineno-0-870" href="#__codelineno-0-870"></a>
</span><span id="__span-0-871"><a id="__codelineno-0-871" name="__codelineno-0-871" href="#__codelineno-0-871"></a>
</span><span id="__span-0-872"><a id="__codelineno-0-872" name="__codelineno-0-872" href="#__codelineno-0-872"></a>
</span><span id="__span-0-873"><a id="__codelineno-0-873" name="__codelineno-0-873" href="#__codelineno-0-873"></a>
</span><span id="__span-0-874"><a id="__codelineno-0-874" name="__codelineno-0-874" href="#__codelineno-0-874"></a>
</span><span id="__span-0-875"><a id="__codelineno-0-875" name="__codelineno-0-875" href="#__codelineno-0-875"></a>
</span><span id="__span-0-876"><a id="__codelineno-0-876" name="__codelineno-0-876" href="#__codelineno-0-876"></a>
</span><span id="__span-0-877"><a id="__codelineno-0-877" name="__codelineno-0-877" href="#__codelineno-0-877"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_GetCurrentResumableIndexRebuilds</span><span class="p">]</span><span class="w"> </span>
</span><span id="__span-0-878"><a id="__codelineno-0-878" name="__codelineno-0-878" href="#__codelineno-0-878"></a>
</span><span id="__span-0-879"><a id="__codelineno-0-879" name="__codelineno-0-879" href="#__codelineno-0-879"></a><span class="w">    </span><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="n">sysname</span>
</span><span id="__span-0-880"><a id="__codelineno-0-880" name="__codelineno-0-880" href="#__codelineno-0-880"></a>
</span><span id="__span-0-881"><a id="__codelineno-0-881" name="__codelineno-0-881" href="#__codelineno-0-881"></a><span class="k">AS</span>
</span><span id="__span-0-882"><a id="__codelineno-0-882" name="__codelineno-0-882" href="#__codelineno-0-882"></a>
</span><span id="__span-0-883"><a id="__codelineno-0-883" name="__codelineno-0-883" href="#__codelineno-0-883"></a><span class="k">BEGIN</span>
</span><span id="__span-0-884"><a id="__codelineno-0-884" name="__codelineno-0-884" href="#__codelineno-0-884"></a>
</span><span id="__span-0-885"><a id="__codelineno-0-885" name="__codelineno-0-885" href="#__codelineno-0-885"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">NOCOUNT</span><span class="w"> </span><span class="k">ON</span><span class="p">;</span>
</span><span id="__span-0-886"><a id="__codelineno-0-886" name="__codelineno-0-886" href="#__codelineno-0-886"></a>
</span><span id="__span-0-887"><a id="__codelineno-0-887" name="__codelineno-0-887" href="#__codelineno-0-887"></a>
</span><span id="__span-0-888"><a id="__codelineno-0-888" name="__codelineno-0-888" href="#__codelineno-0-888"></a>
</span><span id="__span-0-889"><a id="__codelineno-0-889" name="__codelineno-0-889" href="#__codelineno-0-889"></a><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">msg</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
</span><span id="__span-0-890"><a id="__codelineno-0-890" name="__codelineno-0-890" href="#__codelineno-0-890"></a>
</span><span id="__span-0-891"><a id="__codelineno-0-891" name="__codelineno-0-891" href="#__codelineno-0-891"></a>
</span><span id="__span-0-892"><a id="__codelineno-0-892" name="__codelineno-0-892" href="#__codelineno-0-892"></a>
</span><span id="__span-0-893"><a id="__codelineno-0-893" name="__codelineno-0-893" href="#__codelineno-0-893"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">DB_ID</span><span class="p">(</span><span class="o">@</span><span class="n">databaseName</span><span class="p">)</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-0-894"><a id="__codelineno-0-894" name="__codelineno-0-894" href="#__codelineno-0-894"></a>
</span><span id="__span-0-895"><a id="__codelineno-0-895" name="__codelineno-0-895" href="#__codelineno-0-895"></a><span class="w">    </span><span class="k">BEGIN</span>
</span><span id="__span-0-896"><a id="__codelineno-0-896" name="__codelineno-0-896" href="#__codelineno-0-896"></a>
</span><span id="__span-0-897"><a id="__codelineno-0-897" name="__codelineno-0-897" href="#__codelineno-0-897"></a><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Database '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">' is not exists.'</span><span class="p">;</span>
</span><span id="__span-0-898"><a id="__codelineno-0-898" name="__codelineno-0-898" href="#__codelineno-0-898"></a>
</span><span id="__span-0-899"><a id="__codelineno-0-899" name="__codelineno-0-899" href="#__codelineno-0-899"></a><span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="mi">51000</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-900"><a id="__codelineno-0-900" name="__codelineno-0-900" href="#__codelineno-0-900"></a>
</span><span id="__span-0-901"><a id="__codelineno-0-901" name="__codelineno-0-901" href="#__codelineno-0-901"></a><span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-902"><a id="__codelineno-0-902" name="__codelineno-0-902" href="#__codelineno-0-902"></a>
</span><span id="__span-0-903"><a id="__codelineno-0-903" name="__codelineno-0-903" href="#__codelineno-0-903"></a><span class="w">    </span><span class="k">END</span>
</span><span id="__span-0-904"><a id="__codelineno-0-904" name="__codelineno-0-904" href="#__codelineno-0-904"></a>
</span><span id="__span-0-905"><a id="__codelineno-0-905" name="__codelineno-0-905" href="#__codelineno-0-905"></a>
</span><span id="__span-0-906"><a id="__codelineno-0-906" name="__codelineno-0-906" href="#__codelineno-0-906"></a>
</span><span id="__span-0-907"><a id="__codelineno-0-907" name="__codelineno-0-907" href="#__codelineno-0-907"></a><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">LOCAL_ResumableIndexRebuilds</span><span class="w"> </span><span class="k">TABLE</span>
</span><span id="__span-0-908"><a id="__codelineno-0-908" name="__codelineno-0-908" href="#__codelineno-0-908"></a>
</span><span id="__span-0-909"><a id="__codelineno-0-909" name="__codelineno-0-909" href="#__codelineno-0-909"></a><span class="w">    </span><span class="p">(</span>
</span><span id="__span-0-910"><a id="__codelineno-0-910" name="__codelineno-0-910" href="#__codelineno-0-910"></a>
</span><span id="__span-0-911"><a id="__codelineno-0-911" name="__codelineno-0-911" href="#__codelineno-0-911"></a><span class="w">        </span><span class="p">[</span><span class="n">object_id</span><span class="p">]</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-912"><a id="__codelineno-0-912" name="__codelineno-0-912" href="#__codelineno-0-912"></a>
</span><span id="__span-0-913"><a id="__codelineno-0-913" name="__codelineno-0-913" href="#__codelineno-0-913"></a><span class="w">        </span><span class="p">[</span><span class="n">index_id</span><span class="p">]</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-914"><a id="__codelineno-0-914" name="__codelineno-0-914" href="#__codelineno-0-914"></a>
</span><span id="__span-0-915"><a id="__codelineno-0-915" name="__codelineno-0-915" href="#__codelineno-0-915"></a><span class="w">        </span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="w"> </span><span class="n">sysname</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-916"><a id="__codelineno-0-916" name="__codelineno-0-916" href="#__codelineno-0-916"></a>
</span><span id="__span-0-917"><a id="__codelineno-0-917" name="__codelineno-0-917" href="#__codelineno-0-917"></a><span class="w">        </span><span class="p">[</span><span class="n">sql_text</span><span class="p">]</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-0-918"><a id="__codelineno-0-918" name="__codelineno-0-918" href="#__codelineno-0-918"></a>
</span><span id="__span-0-919"><a id="__codelineno-0-919" name="__codelineno-0-919" href="#__codelineno-0-919"></a><span class="w">        </span><span class="p">[</span><span class="n">partition_number</span><span class="p">]</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span>
</span><span id="__span-0-920"><a id="__codelineno-0-920" name="__codelineno-0-920" href="#__codelineno-0-920"></a>
</span><span id="__span-0-921"><a id="__codelineno-0-921" name="__codelineno-0-921" href="#__codelineno-0-921"></a><span class="w">        </span><span class="p">[</span><span class="k">state</span><span class="p">]</span><span class="w"> </span><span class="n">tinyint</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-922"><a id="__codelineno-0-922" name="__codelineno-0-922" href="#__codelineno-0-922"></a>
</span><span id="__span-0-923"><a id="__codelineno-0-923" name="__codelineno-0-923" href="#__codelineno-0-923"></a><span class="w">        </span><span class="p">[</span><span class="n">state_desc</span><span class="p">]</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">60</span><span class="p">),</span>
</span><span id="__span-0-924"><a id="__codelineno-0-924" name="__codelineno-0-924" href="#__codelineno-0-924"></a>
</span><span id="__span-0-925"><a id="__codelineno-0-925" name="__codelineno-0-925" href="#__codelineno-0-925"></a><span class="w">        </span><span class="p">[</span><span class="n">start_time</span><span class="p">]</span><span class="w"> </span><span class="n">datetime</span><span class="p">,</span>
</span><span id="__span-0-926"><a id="__codelineno-0-926" name="__codelineno-0-926" href="#__codelineno-0-926"></a>
</span><span id="__span-0-927"><a id="__codelineno-0-927" name="__codelineno-0-927" href="#__codelineno-0-927"></a><span class="w">        </span><span class="p">[</span><span class="n">last_pause_time</span><span class="p">]</span><span class="w"> </span><span class="n">datetime</span><span class="p">,</span>
</span><span id="__span-0-928"><a id="__codelineno-0-928" name="__codelineno-0-928" href="#__codelineno-0-928"></a>
</span><span id="__span-0-929"><a id="__codelineno-0-929" name="__codelineno-0-929" href="#__codelineno-0-929"></a><span class="w">        </span><span class="p">[</span><span class="n">total_execution_time</span><span class="p">]</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span>
</span><span id="__span-0-930"><a id="__codelineno-0-930" name="__codelineno-0-930" href="#__codelineno-0-930"></a>
</span><span id="__span-0-931"><a id="__codelineno-0-931" name="__codelineno-0-931" href="#__codelineno-0-931"></a><span class="w">        </span><span class="p">[</span><span class="n">percent_complete</span><span class="p">]</span><span class="w"> </span><span class="nb">real</span><span class="p">,</span>
</span><span id="__span-0-932"><a id="__codelineno-0-932" name="__codelineno-0-932" href="#__codelineno-0-932"></a>
</span><span id="__span-0-933"><a id="__codelineno-0-933" name="__codelineno-0-933" href="#__codelineno-0-933"></a><span class="w">        </span><span class="p">[</span><span class="n">page_count</span><span class="p">]</span><span class="w"> </span><span class="nb">bigint</span>
</span><span id="__span-0-934"><a id="__codelineno-0-934" name="__codelineno-0-934" href="#__codelineno-0-934"></a>
</span><span id="__span-0-935"><a id="__codelineno-0-935" name="__codelineno-0-935" href="#__codelineno-0-935"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-0-936"><a id="__codelineno-0-936" name="__codelineno-0-936" href="#__codelineno-0-936"></a>
</span><span id="__span-0-937"><a id="__codelineno-0-937" name="__codelineno-0-937" href="#__codelineno-0-937"></a>
</span><span id="__span-0-938"><a id="__codelineno-0-938" name="__codelineno-0-938" href="#__codelineno-0-938"></a>
</span><span id="__span-0-939"><a id="__codelineno-0-939" name="__codelineno-0-939" href="#__codelineno-0-939"></a><span class="w">    </span><span class="k">IF</span><span class="p">([</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_ResumableIndexMaintenanceAvailiable</span><span class="p">]()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-0-940"><a id="__codelineno-0-940" name="__codelineno-0-940" href="#__codelineno-0-940"></a>
</span><span id="__span-0-941"><a id="__codelineno-0-941" name="__codelineno-0-941" href="#__codelineno-0-941"></a><span class="w">    </span><span class="k">BEGIN</span>
</span><span id="__span-0-942"><a id="__codelineno-0-942" name="__codelineno-0-942" href="#__codelineno-0-942"></a>
</span><span id="__span-0-943"><a id="__codelineno-0-943" name="__codelineno-0-943" href="#__codelineno-0-943"></a><span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
</span><span id="__span-0-944"><a id="__codelineno-0-944" name="__codelineno-0-944" href="#__codelineno-0-944"></a>
</span><span id="__span-0-945"><a id="__codelineno-0-945" name="__codelineno-0-945" href="#__codelineno-0-945"></a><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'</span>
</span><span id="__span-0-946"><a id="__codelineno-0-946" name="__codelineno-0-946" href="#__codelineno-0-946"></a>
</span><span id="__span-0-947"><a id="__codelineno-0-947" name="__codelineno-0-947" href="#__codelineno-0-947"></a><span class="s1">        USE ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">']</span>
</span><span id="__span-0-948"><a id="__codelineno-0-948" name="__codelineno-0-948" href="#__codelineno-0-948"></a>
</span><span id="__span-0-949"><a id="__codelineno-0-949" name="__codelineno-0-949" href="#__codelineno-0-949"></a><span class="s1">        SET NOCOUNT ON;</span>
</span><span id="__span-0-950"><a id="__codelineno-0-950" name="__codelineno-0-950" href="#__codelineno-0-950"></a>
</span><span id="__span-0-951"><a id="__codelineno-0-951" name="__codelineno-0-951" href="#__codelineno-0-951"></a><span class="s1">        SELECT</span>
</span><span id="__span-0-952"><a id="__codelineno-0-952" name="__codelineno-0-952" href="#__codelineno-0-952"></a>
</span><span id="__span-0-953"><a id="__codelineno-0-953" name="__codelineno-0-953" href="#__codelineno-0-953"></a><span class="s1">            [object_id], </span>
</span><span id="__span-0-954"><a id="__codelineno-0-954" name="__codelineno-0-954" href="#__codelineno-0-954"></a>
</span><span id="__span-0-955"><a id="__codelineno-0-955" name="__codelineno-0-955" href="#__codelineno-0-955"></a><span class="s1">            [index_id], </span>
</span><span id="__span-0-956"><a id="__codelineno-0-956" name="__codelineno-0-956" href="#__codelineno-0-956"></a>
</span><span id="__span-0-957"><a id="__codelineno-0-957" name="__codelineno-0-957" href="#__codelineno-0-957"></a><span class="s1">            [name], </span>
</span><span id="__span-0-958"><a id="__codelineno-0-958" name="__codelineno-0-958" href="#__codelineno-0-958"></a>
</span><span id="__span-0-959"><a id="__codelineno-0-959" name="__codelineno-0-959" href="#__codelineno-0-959"></a><span class="s1">            [sql_text], </span>
</span><span id="__span-0-960"><a id="__codelineno-0-960" name="__codelineno-0-960" href="#__codelineno-0-960"></a>
</span><span id="__span-0-961"><a id="__codelineno-0-961" name="__codelineno-0-961" href="#__codelineno-0-961"></a><span class="s1">            [partition_number],</span>
</span><span id="__span-0-962"><a id="__codelineno-0-962" name="__codelineno-0-962" href="#__codelineno-0-962"></a>
</span><span id="__span-0-963"><a id="__codelineno-0-963" name="__codelineno-0-963" href="#__codelineno-0-963"></a><span class="s1">            [state], </span>
</span><span id="__span-0-964"><a id="__codelineno-0-964" name="__codelineno-0-964" href="#__codelineno-0-964"></a>
</span><span id="__span-0-965"><a id="__codelineno-0-965" name="__codelineno-0-965" href="#__codelineno-0-965"></a><span class="s1">            [state_desc],</span>
</span><span id="__span-0-966"><a id="__codelineno-0-966" name="__codelineno-0-966" href="#__codelineno-0-966"></a>
</span><span id="__span-0-967"><a id="__codelineno-0-967" name="__codelineno-0-967" href="#__codelineno-0-967"></a><span class="s1">            [start_time],</span>
</span><span id="__span-0-968"><a id="__codelineno-0-968" name="__codelineno-0-968" href="#__codelineno-0-968"></a>
</span><span id="__span-0-969"><a id="__codelineno-0-969" name="__codelineno-0-969" href="#__codelineno-0-969"></a><span class="s1">            [last_pause_time],</span>
</span><span id="__span-0-970"><a id="__codelineno-0-970" name="__codelineno-0-970" href="#__codelineno-0-970"></a>
</span><span id="__span-0-971"><a id="__codelineno-0-971" name="__codelineno-0-971" href="#__codelineno-0-971"></a><span class="s1">            [total_execution_time],</span>
</span><span id="__span-0-972"><a id="__codelineno-0-972" name="__codelineno-0-972" href="#__codelineno-0-972"></a>
</span><span id="__span-0-973"><a id="__codelineno-0-973" name="__codelineno-0-973" href="#__codelineno-0-973"></a><span class="s1">            [percent_complete],</span>
</span><span id="__span-0-974"><a id="__codelineno-0-974" name="__codelineno-0-974" href="#__codelineno-0-974"></a>
</span><span id="__span-0-975"><a id="__codelineno-0-975" name="__codelineno-0-975" href="#__codelineno-0-975"></a><span class="s1">            [page_count]</span>
</span><span id="__span-0-976"><a id="__codelineno-0-976" name="__codelineno-0-976" href="#__codelineno-0-976"></a>
</span><span id="__span-0-977"><a id="__codelineno-0-977" name="__codelineno-0-977" href="#__codelineno-0-977"></a><span class="s1">        FROM sys.index_resumable_operations;</span>
</span><span id="__span-0-978"><a id="__codelineno-0-978" name="__codelineno-0-978" href="#__codelineno-0-978"></a>
</span><span id="__span-0-979"><a id="__codelineno-0-979" name="__codelineno-0-979" href="#__codelineno-0-979"></a><span class="s1">        '</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">));</span>
</span><span id="__span-0-980"><a id="__codelineno-0-980" name="__codelineno-0-980" href="#__codelineno-0-980"></a>
</span><span id="__span-0-981"><a id="__codelineno-0-981" name="__codelineno-0-981" href="#__codelineno-0-981"></a><span class="w">        </span><span class="k">INSERT</span><span class="w"> </span><span class="o">@</span><span class="n">LOCAL_ResumableIndexRebuilds</span>
</span><span id="__span-0-982"><a id="__codelineno-0-982" name="__codelineno-0-982" href="#__codelineno-0-982"></a>
</span><span id="__span-0-983"><a id="__codelineno-0-983" name="__codelineno-0-983" href="#__codelineno-0-983"></a><span class="w">        </span><span class="k">EXECUTE</span><span class="w"> </span><span class="n">sp_executesql</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="p">;</span>
</span><span id="__span-0-984"><a id="__codelineno-0-984" name="__codelineno-0-984" href="#__codelineno-0-984"></a>
</span><span id="__span-0-985"><a id="__codelineno-0-985" name="__codelineno-0-985" href="#__codelineno-0-985"></a><span class="w">    </span><span class="k">END</span>
</span><span id="__span-0-986"><a id="__codelineno-0-986" name="__codelineno-0-986" href="#__codelineno-0-986"></a>
</span><span id="__span-0-987"><a id="__codelineno-0-987" name="__codelineno-0-987" href="#__codelineno-0-987"></a>
</span><span id="__span-0-988"><a id="__codelineno-0-988" name="__codelineno-0-988" href="#__codelineno-0-988"></a>
</span><span id="__span-0-989"><a id="__codelineno-0-989" name="__codelineno-0-989" href="#__codelineno-0-989"></a><span class="w">    </span><span class="k">SELECT</span>
</span><span id="__span-0-990"><a id="__codelineno-0-990" name="__codelineno-0-990" href="#__codelineno-0-990"></a>
</span><span id="__span-0-991"><a id="__codelineno-0-991" name="__codelineno-0-991" href="#__codelineno-0-991"></a><span class="w">        </span><span class="p">[</span><span class="n">object_id</span><span class="p">],</span><span class="w"> </span>
</span><span id="__span-0-992"><a id="__codelineno-0-992" name="__codelineno-0-992" href="#__codelineno-0-992"></a>
</span><span id="__span-0-993"><a id="__codelineno-0-993" name="__codelineno-0-993" href="#__codelineno-0-993"></a><span class="w">        </span><span class="p">[</span><span class="n">index_id</span><span class="p">],</span><span class="w"> </span>
</span><span id="__span-0-994"><a id="__codelineno-0-994" name="__codelineno-0-994" href="#__codelineno-0-994"></a>
</span><span id="__span-0-995"><a id="__codelineno-0-995" name="__codelineno-0-995" href="#__codelineno-0-995"></a><span class="w">        </span><span class="p">[</span><span class="n">name</span><span class="p">],</span><span class="w"> </span>
</span><span id="__span-0-996"><a id="__codelineno-0-996" name="__codelineno-0-996" href="#__codelineno-0-996"></a>
</span><span id="__span-0-997"><a id="__codelineno-0-997" name="__codelineno-0-997" href="#__codelineno-0-997"></a><span class="w">        </span><span class="p">[</span><span class="n">sql_text</span><span class="p">],</span><span class="w"> </span>
</span><span id="__span-0-998"><a id="__codelineno-0-998" name="__codelineno-0-998" href="#__codelineno-0-998"></a>
</span><span id="__span-0-999"><a id="__codelineno-0-999" name="__codelineno-0-999" href="#__codelineno-0-999"></a><span class="w">        </span><span class="p">[</span><span class="n">partition_number</span><span class="p">],</span>
</span><span id="__span-0-1000"><a id="__codelineno-0-1000" name="__codelineno-0-1000" href="#__codelineno-0-1000"></a>
</span><span id="__span-0-1001"><a id="__codelineno-0-1001" name="__codelineno-0-1001" href="#__codelineno-0-1001"></a><span class="w">        </span><span class="p">[</span><span class="k">state</span><span class="p">],</span><span class="w"> </span>
</span><span id="__span-0-1002"><a id="__codelineno-0-1002" name="__codelineno-0-1002" href="#__codelineno-0-1002"></a>
</span><span id="__span-0-1003"><a id="__codelineno-0-1003" name="__codelineno-0-1003" href="#__codelineno-0-1003"></a><span class="w">        </span><span class="p">[</span><span class="n">state_desc</span><span class="p">],</span>
</span><span id="__span-0-1004"><a id="__codelineno-0-1004" name="__codelineno-0-1004" href="#__codelineno-0-1004"></a>
</span><span id="__span-0-1005"><a id="__codelineno-0-1005" name="__codelineno-0-1005" href="#__codelineno-0-1005"></a><span class="w">        </span><span class="p">[</span><span class="n">start_time</span><span class="p">],</span>
</span><span id="__span-0-1006"><a id="__codelineno-0-1006" name="__codelineno-0-1006" href="#__codelineno-0-1006"></a>
</span><span id="__span-0-1007"><a id="__codelineno-0-1007" name="__codelineno-0-1007" href="#__codelineno-0-1007"></a><span class="w">        </span><span class="p">[</span><span class="n">last_pause_time</span><span class="p">],</span>
</span><span id="__span-0-1008"><a id="__codelineno-0-1008" name="__codelineno-0-1008" href="#__codelineno-0-1008"></a>
</span><span id="__span-0-1009"><a id="__codelineno-0-1009" name="__codelineno-0-1009" href="#__codelineno-0-1009"></a><span class="w">        </span><span class="p">[</span><span class="n">total_execution_time</span><span class="p">],</span>
</span><span id="__span-0-1010"><a id="__codelineno-0-1010" name="__codelineno-0-1010" href="#__codelineno-0-1010"></a>
</span><span id="__span-0-1011"><a id="__codelineno-0-1011" name="__codelineno-0-1011" href="#__codelineno-0-1011"></a><span class="w">        </span><span class="p">[</span><span class="n">percent_complete</span><span class="p">],</span>
</span><span id="__span-0-1012"><a id="__codelineno-0-1012" name="__codelineno-0-1012" href="#__codelineno-0-1012"></a>
</span><span id="__span-0-1013"><a id="__codelineno-0-1013" name="__codelineno-0-1013" href="#__codelineno-0-1013"></a><span class="w">        </span><span class="p">[</span><span class="n">page_count</span><span class="p">]</span>
</span><span id="__span-0-1014"><a id="__codelineno-0-1014" name="__codelineno-0-1014" href="#__codelineno-0-1014"></a>
</span><span id="__span-0-1015"><a id="__codelineno-0-1015" name="__codelineno-0-1015" href="#__codelineno-0-1015"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">LOCAL_ResumableIndexRebuilds</span>
</span><span id="__span-0-1016"><a id="__codelineno-0-1016" name="__codelineno-0-1016" href="#__codelineno-0-1016"></a>
</span><span id="__span-0-1017"><a id="__codelineno-0-1017" name="__codelineno-0-1017" href="#__codelineno-0-1017"></a><span class="k">END</span>
</span><span id="__span-0-1018"><a id="__codelineno-0-1018" name="__codelineno-0-1018" href="#__codelineno-0-1018"></a>
</span><span id="__span-0-1019"><a id="__codelineno-0-1019" name="__codelineno-0-1019" href="#__codelineno-0-1019"></a><span class="k">GO</span>
</span><span id="__span-0-1020"><a id="__codelineno-0-1020" name="__codelineno-0-1020" href="#__codelineno-0-1020"></a>
</span><span id="__span-0-1021"><a id="__codelineno-0-1021" name="__codelineno-0-1021" href="#__codelineno-0-1021"></a>
</span><span id="__span-0-1022"><a id="__codelineno-0-1022" name="__codelineno-0-1022" href="#__codelineno-0-1022"></a>
</span><span id="__span-0-1023"><a id="__codelineno-0-1023" name="__codelineno-0-1023" href="#__codelineno-0-1023"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_IndexMaintenance</span><span class="p">]</span>
</span><span id="__span-0-1024"><a id="__codelineno-0-1024" name="__codelineno-0-1024" href="#__codelineno-0-1024"></a>
</span><span id="__span-0-1025"><a id="__codelineno-0-1025" name="__codelineno-0-1025" href="#__codelineno-0-1025"></a><span class="w">    </span><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="n">sysname</span><span class="p">,</span>
</span><span id="__span-0-1026"><a id="__codelineno-0-1026" name="__codelineno-0-1026" href="#__codelineno-0-1026"></a>
</span><span id="__span-0-1027"><a id="__codelineno-0-1027" name="__codelineno-0-1027" href="#__codelineno-0-1027"></a><span class="w">    </span><span class="o">@</span><span class="n">timeFrom</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'00:00:00'</span><span class="p">,</span>
</span><span id="__span-0-1028"><a id="__codelineno-0-1028" name="__codelineno-0-1028" href="#__codelineno-0-1028"></a>
</span><span id="__span-0-1029"><a id="__codelineno-0-1029" name="__codelineno-0-1029" href="#__codelineno-0-1029"></a><span class="w">    </span><span class="o">@</span><span class="n">timeTo</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'23:59:59'</span><span class="p">,</span>
</span><span id="__span-0-1030"><a id="__codelineno-0-1030" name="__codelineno-0-1030" href="#__codelineno-0-1030"></a>
</span><span id="__span-0-1031"><a id="__codelineno-0-1031" name="__codelineno-0-1031" href="#__codelineno-0-1031"></a><span class="w">    </span><span class="o">@</span><span class="n">fragmentationPercentMinForMaintenance</span><span class="w"> </span><span class="nb">FLOAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-0-1032"><a id="__codelineno-0-1032" name="__codelineno-0-1032" href="#__codelineno-0-1032"></a>
</span><span id="__span-0-1033"><a id="__codelineno-0-1033" name="__codelineno-0-1033" href="#__codelineno-0-1033"></a><span class="w">    </span><span class="o">@</span><span class="n">fragmentationPercentForRebuild</span><span class="w"> </span><span class="nb">FLOAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-0-1034"><a id="__codelineno-0-1034" name="__codelineno-0-1034" href="#__codelineno-0-1034"></a>
</span><span id="__span-0-1035"><a id="__codelineno-0-1035" name="__codelineno-0-1035" href="#__codelineno-0-1035"></a><span class="w">    </span><span class="o">@</span><span class="n">maxDop</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span>
</span><span id="__span-0-1036"><a id="__codelineno-0-1036" name="__codelineno-0-1036" href="#__codelineno-0-1036"></a>
</span><span id="__span-0-1037"><a id="__codelineno-0-1037" name="__codelineno-0-1037" href="#__codelineno-0-1037"></a><span class="w">    </span><span class="o">@</span><span class="n">minIndexSizePages</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-0-1038"><a id="__codelineno-0-1038" name="__codelineno-0-1038" href="#__codelineno-0-1038"></a>
</span><span id="__span-0-1039"><a id="__codelineno-0-1039" name="__codelineno-0-1039" href="#__codelineno-0-1039"></a><span class="w">    </span><span class="o">@</span><span class="n">maxIndexSizePages</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-0-1040"><a id="__codelineno-0-1040" name="__codelineno-0-1040" href="#__codelineno-0-1040"></a>
</span><span id="__span-0-1041"><a id="__codelineno-0-1041" name="__codelineno-0-1041" href="#__codelineno-0-1041"></a><span class="w">    </span><span class="o">@</span><span class="n">useOnlineIndexRebuild</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-0-1042"><a id="__codelineno-0-1042" name="__codelineno-0-1042" href="#__codelineno-0-1042"></a>
</span><span id="__span-0-1043"><a id="__codelineno-0-1043" name="__codelineno-0-1043" href="#__codelineno-0-1043"></a><span class="w">    </span><span class="o">@</span><span class="n">useResumableIndexRebuildIfAvailable</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-0-1044"><a id="__codelineno-0-1044" name="__codelineno-0-1044" href="#__codelineno-0-1044"></a>
</span><span id="__span-0-1045"><a id="__codelineno-0-1045" name="__codelineno-0-1045" href="#__codelineno-0-1045"></a><span class="w">    </span><span class="o">@</span><span class="n">maxIndexSizeForReorganizingPages</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6553600</span><span class="p">,</span>
</span><span id="__span-0-1046"><a id="__codelineno-0-1046" name="__codelineno-0-1046" href="#__codelineno-0-1046"></a>
</span><span id="__span-0-1047"><a id="__codelineno-0-1047" name="__codelineno-0-1047" href="#__codelineno-0-1047"></a><span class="w">    </span><span class="o">@</span><span class="n">useMonitoringDatabase</span><span class="w"> </span><span class="nb">bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-0-1048"><a id="__codelineno-0-1048" name="__codelineno-0-1048" href="#__codelineno-0-1048"></a>
</span><span id="__span-0-1049"><a id="__codelineno-0-1049" name="__codelineno-0-1049" href="#__codelineno-0-1049"></a><span class="w">    </span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w"> </span><span class="n">sysname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'SQLServerMaintenance'</span><span class="p">,</span>
</span><span id="__span-0-1050"><a id="__codelineno-0-1050" name="__codelineno-0-1050" href="#__codelineno-0-1050"></a>
</span><span id="__span-0-1051"><a id="__codelineno-0-1051" name="__codelineno-0-1051" href="#__codelineno-0-1051"></a><span class="w">    </span><span class="o">@</span><span class="n">usePreparedInformationAboutObjectsStateIfExists</span><span class="w"> </span><span class="nb">bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-0-1052"><a id="__codelineno-0-1052" name="__codelineno-0-1052" href="#__codelineno-0-1052"></a>
</span><span id="__span-0-1053"><a id="__codelineno-0-1053" name="__codelineno-0-1053" href="#__codelineno-0-1053"></a><span class="w">    </span><span class="o">@</span><span class="n">ConditionTableName</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'LIKE ''%'''</span><span class="p">,</span>
</span><span id="__span-0-1054"><a id="__codelineno-0-1054" name="__codelineno-0-1054" href="#__codelineno-0-1054"></a>
</span><span id="__span-0-1055"><a id="__codelineno-0-1055" name="__codelineno-0-1055" href="#__codelineno-0-1055"></a><span class="w">    </span><span class="o">@</span><span class="n">ConditionIndexName</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'LIKE ''%'''</span><span class="p">,</span>
</span><span id="__span-0-1056"><a id="__codelineno-0-1056" name="__codelineno-0-1056" href="#__codelineno-0-1056"></a>
</span><span id="__span-0-1057"><a id="__codelineno-0-1057" name="__codelineno-0-1057" href="#__codelineno-0-1057"></a><span class="w">    </span><span class="o">@</span><span class="n">onlineRebuildAbortAfterWaitMode</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-0-1058"><a id="__codelineno-0-1058" name="__codelineno-0-1058" href="#__codelineno-0-1058"></a>
</span><span id="__span-0-1059"><a id="__codelineno-0-1059" name="__codelineno-0-1059" href="#__codelineno-0-1059"></a><span class="w">    </span><span class="o">@</span><span class="n">onlineRebuildWaitMinutes</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
</span><span id="__span-0-1060"><a id="__codelineno-0-1060" name="__codelineno-0-1060" href="#__codelineno-0-1060"></a>
</span><span id="__span-0-1061"><a id="__codelineno-0-1061" name="__codelineno-0-1061" href="#__codelineno-0-1061"></a><span class="w">    </span><span class="o">@</span><span class="n">maxTransactionLogSizeUsagePercent</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w">  </span>
</span><span id="__span-0-1062"><a id="__codelineno-0-1062" name="__codelineno-0-1062" href="#__codelineno-0-1062"></a>
</span><span id="__span-0-1063"><a id="__codelineno-0-1063" name="__codelineno-0-1063" href="#__codelineno-0-1063"></a><span class="w">    </span><span class="o">@</span><span class="n">maxTransactionLogSizeMB</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-1064"><a id="__codelineno-0-1064" name="__codelineno-0-1064" href="#__codelineno-0-1064"></a>
</span><span id="__span-0-1065"><a id="__codelineno-0-1065" name="__codelineno-0-1065" href="#__codelineno-0-1065"></a><span class="k">AS</span>
</span><span id="__span-0-1066"><a id="__codelineno-0-1066" name="__codelineno-0-1066" href="#__codelineno-0-1066"></a>
</span><span id="__span-0-1067"><a id="__codelineno-0-1067" name="__codelineno-0-1067" href="#__codelineno-0-1067"></a><span class="k">BEGIN</span>
</span><span id="__span-0-1068"><a id="__codelineno-0-1068" name="__codelineno-0-1068" href="#__codelineno-0-1068"></a>
</span><span id="__span-0-1069"><a id="__codelineno-0-1069" name="__codelineno-0-1069" href="#__codelineno-0-1069"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">NOCOUNT</span><span class="w"> </span><span class="k">ON</span><span class="p">;</span>
</span><span id="__span-0-1070"><a id="__codelineno-0-1070" name="__codelineno-0-1070" href="#__codelineno-0-1070"></a>
</span><span id="__span-0-1071"><a id="__codelineno-0-1071" name="__codelineno-0-1071" href="#__codelineno-0-1071"></a>
</span><span id="__span-0-1072"><a id="__codelineno-0-1072" name="__codelineno-0-1072" href="#__codelineno-0-1072"></a>
</span><span id="__span-0-1073"><a id="__codelineno-0-1073" name="__codelineno-0-1073" href="#__codelineno-0-1073"></a><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">msg</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">),</span>
</span><span id="__span-0-1074"><a id="__codelineno-0-1074" name="__codelineno-0-1074" href="#__codelineno-0-1074"></a>
</span><span id="__span-0-1075"><a id="__codelineno-0-1075" name="__codelineno-0-1075" href="#__codelineno-0-1075"></a><span class="w">            </span><span class="o">@</span><span class="n">abortAfterWaitOnlineRebuil</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
</span><span id="__span-0-1076"><a id="__codelineno-0-1076" name="__codelineno-0-1076" href="#__codelineno-0-1076"></a>
</span><span id="__span-0-1077"><a id="__codelineno-0-1077" name="__codelineno-0-1077" href="#__codelineno-0-1077"></a><span class="w">            </span><span class="o">@</span><span class="n">currentTransactionLogSizeUsagePercent</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span>
</span><span id="__span-0-1078"><a id="__codelineno-0-1078" name="__codelineno-0-1078" href="#__codelineno-0-1078"></a>
</span><span id="__span-0-1079"><a id="__codelineno-0-1079" name="__codelineno-0-1079" href="#__codelineno-0-1079"></a><span class="w">            </span><span class="o">@</span><span class="n">currentTransactionLogSizeMB</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span>
</span><span id="__span-0-1080"><a id="__codelineno-0-1080" name="__codelineno-0-1080" href="#__codelineno-0-1080"></a>
</span><span id="__span-0-1081"><a id="__codelineno-0-1081" name="__codelineno-0-1081" href="#__codelineno-0-1081"></a><span class="w">            </span><span class="o">@</span><span class="n">timeNow</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">GETDATE</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">TIME</span><span class="p">),</span>
</span><span id="__span-0-1082"><a id="__codelineno-0-1082" name="__codelineno-0-1082" href="#__codelineno-0-1082"></a>
</span><span id="__span-0-1083"><a id="__codelineno-0-1083" name="__codelineno-0-1083" href="#__codelineno-0-1083"></a><span class="w">            </span><span class="o">@</span><span class="n">useResumableIndexRebuild</span><span class="w"> </span><span class="nb">bit</span><span class="p">,</span>
</span><span id="__span-0-1084"><a id="__codelineno-0-1084" name="__codelineno-0-1084" href="#__codelineno-0-1084"></a>
</span><span id="__span-0-1085"><a id="__codelineno-0-1085" name="__codelineno-0-1085" href="#__codelineno-0-1085"></a><span class="w">            </span><span class="o">@</span><span class="n">RunDate</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">(),</span>
</span><span id="__span-0-1086"><a id="__codelineno-0-1086" name="__codelineno-0-1086" href="#__codelineno-0-1086"></a>
</span><span id="__span-0-1087"><a id="__codelineno-0-1087" name="__codelineno-0-1087" href="#__codelineno-0-1087"></a><span class="w">            </span><span class="o">@</span><span class="n">StartDate</span><span class="w"> </span><span class="n">datetime</span><span class="p">,</span>
</span><span id="__span-0-1088"><a id="__codelineno-0-1088" name="__codelineno-0-1088" href="#__codelineno-0-1088"></a>
</span><span id="__span-0-1089"><a id="__codelineno-0-1089" name="__codelineno-0-1089" href="#__codelineno-0-1089"></a><span class="w">            </span><span class="o">@</span><span class="n">FinishDate</span><span class="w"> </span><span class="n">datetime</span><span class="p">,</span>
</span><span id="__span-0-1090"><a id="__codelineno-0-1090" name="__codelineno-0-1090" href="#__codelineno-0-1090"></a>
</span><span id="__span-0-1091"><a id="__codelineno-0-1091" name="__codelineno-0-1091" href="#__codelineno-0-1091"></a><span class="w">            </span><span class="o">@</span><span class="n">MaintenanceActionLogId</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
</span><span id="__span-0-1092"><a id="__codelineno-0-1092" name="__codelineno-0-1092" href="#__codelineno-0-1092"></a>
</span><span id="__span-0-1093"><a id="__codelineno-0-1093" name="__codelineno-0-1093" href="#__codelineno-0-1093"></a><span class="w">            </span><span class="c1">-- Список исключенных из обслуживания индексов.</span>
</span><span id="__span-0-1094"><a id="__codelineno-0-1094" name="__codelineno-0-1094" href="#__codelineno-0-1094"></a>
</span><span id="__span-0-1095"><a id="__codelineno-0-1095" name="__codelineno-0-1095" href="#__codelineno-0-1095"></a><span class="w">            </span><span class="c1">-- Например, если они были обслужены через механизм возобновляемых перестроений,</span>
</span><span id="__span-0-1096"><a id="__codelineno-0-1096" name="__codelineno-0-1096" href="#__codelineno-0-1096"></a>
</span><span id="__span-0-1097"><a id="__codelineno-0-1097" name="__codelineno-0-1097" href="#__codelineno-0-1097"></a><span class="w">            </span><span class="c1">-- еще до запуска основного обслуживания</span>
</span><span id="__span-0-1098"><a id="__codelineno-0-1098" name="__codelineno-0-1098" href="#__codelineno-0-1098"></a>
</span><span id="__span-0-1099"><a id="__codelineno-0-1099" name="__codelineno-0-1099" href="#__codelineno-0-1099"></a><span class="w">            </span><span class="o">@</span><span class="n">excludeIndexes</span><span class="w"> </span><span class="n">XML</span><span class="p">;</span>
</span><span id="__span-0-1100"><a id="__codelineno-0-1100" name="__codelineno-0-1100" href="#__codelineno-0-1100"></a>
</span><span id="__span-0-1101"><a id="__codelineno-0-1101" name="__codelineno-0-1101" href="#__codelineno-0-1101"></a>
</span><span id="__span-0-1102"><a id="__codelineno-0-1102" name="__codelineno-0-1102" href="#__codelineno-0-1102"></a>
</span><span id="__span-0-1103"><a id="__codelineno-0-1103" name="__codelineno-0-1103" href="#__codelineno-0-1103"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="o">@</span><span class="n">onlineRebuildAbortAfterWaitMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-0-1104"><a id="__codelineno-0-1104" name="__codelineno-0-1104" href="#__codelineno-0-1104"></a>
</span><span id="__span-0-1105"><a id="__codelineno-0-1105" name="__codelineno-0-1105" href="#__codelineno-0-1105"></a><span class="w">    </span><span class="k">BEGIN</span>
</span><span id="__span-0-1106"><a id="__codelineno-0-1106" name="__codelineno-0-1106" href="#__codelineno-0-1106"></a>
</span><span id="__span-0-1107"><a id="__codelineno-0-1107" name="__codelineno-0-1107" href="#__codelineno-0-1107"></a><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">abortAfterWaitOnlineRebuil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'NONE'</span>
</span><span id="__span-0-1108"><a id="__codelineno-0-1108" name="__codelineno-0-1108" href="#__codelineno-0-1108"></a>
</span><span id="__span-0-1109"><a id="__codelineno-0-1109" name="__codelineno-0-1109" href="#__codelineno-0-1109"></a><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="k">IF</span><span class="p">(</span><span class="o">@</span><span class="n">onlineRebuildAbortAfterWaitMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-0-1110"><a id="__codelineno-0-1110" name="__codelineno-0-1110" href="#__codelineno-0-1110"></a>
</span><span id="__span-0-1111"><a id="__codelineno-0-1111" name="__codelineno-0-1111" href="#__codelineno-0-1111"></a><span class="w">    </span><span class="k">BEGIN</span>
</span><span id="__span-0-1112"><a id="__codelineno-0-1112" name="__codelineno-0-1112" href="#__codelineno-0-1112"></a>
</span><span id="__span-0-1113"><a id="__codelineno-0-1113" name="__codelineno-0-1113" href="#__codelineno-0-1113"></a><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">abortAfterWaitOnlineRebuil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'SELF'</span>
</span><span id="__span-0-1114"><a id="__codelineno-0-1114" name="__codelineno-0-1114" href="#__codelineno-0-1114"></a>
</span><span id="__span-0-1115"><a id="__codelineno-0-1115" name="__codelineno-0-1115" href="#__codelineno-0-1115"></a><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="k">IF</span><span class="p">(</span><span class="o">@</span><span class="n">onlineRebuildAbortAfterWaitMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-0-1116"><a id="__codelineno-0-1116" name="__codelineno-0-1116" href="#__codelineno-0-1116"></a>
</span><span id="__span-0-1117"><a id="__codelineno-0-1117" name="__codelineno-0-1117" href="#__codelineno-0-1117"></a><span class="w">    </span><span class="k">BEGIN</span>
</span><span id="__span-0-1118"><a id="__codelineno-0-1118" name="__codelineno-0-1118" href="#__codelineno-0-1118"></a>
</span><span id="__span-0-1119"><a id="__codelineno-0-1119" name="__codelineno-0-1119" href="#__codelineno-0-1119"></a><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">abortAfterWaitOnlineRebuil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'BLOCKERS'</span>
</span><span id="__span-0-1120"><a id="__codelineno-0-1120" name="__codelineno-0-1120" href="#__codelineno-0-1120"></a>
</span><span id="__span-0-1121"><a id="__codelineno-0-1121" name="__codelineno-0-1121" href="#__codelineno-0-1121"></a><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">ELSE</span>
</span><span id="__span-0-1122"><a id="__codelineno-0-1122" name="__codelineno-0-1122" href="#__codelineno-0-1122"></a>
</span><span id="__span-0-1123"><a id="__codelineno-0-1123" name="__codelineno-0-1123" href="#__codelineno-0-1123"></a><span class="w">    </span><span class="k">BEGIN</span>
</span><span id="__span-0-1124"><a id="__codelineno-0-1124" name="__codelineno-0-1124" href="#__codelineno-0-1124"></a>
</span><span id="__span-0-1125"><a id="__codelineno-0-1125" name="__codelineno-0-1125" href="#__codelineno-0-1125"></a><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">abortAfterWaitOnlineRebuil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'NONE'</span>
</span><span id="__span-0-1126"><a id="__codelineno-0-1126" name="__codelineno-0-1126" href="#__codelineno-0-1126"></a>
</span><span id="__span-0-1127"><a id="__codelineno-0-1127" name="__codelineno-0-1127" href="#__codelineno-0-1127"></a><span class="w">    </span><span class="k">END</span>
</span><span id="__span-0-1128"><a id="__codelineno-0-1128" name="__codelineno-0-1128" href="#__codelineno-0-1128"></a>
</span><span id="__span-0-1129"><a id="__codelineno-0-1129" name="__codelineno-0-1129" href="#__codelineno-0-1129"></a>
</span><span id="__span-0-1130"><a id="__codelineno-0-1130" name="__codelineno-0-1130" href="#__codelineno-0-1130"></a>
</span><span id="__span-0-1131"><a id="__codelineno-0-1131" name="__codelineno-0-1131" href="#__codelineno-0-1131"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">DB_ID</span><span class="p">(</span><span class="o">@</span><span class="n">databaseName</span><span class="p">)</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-0-1132"><a id="__codelineno-0-1132" name="__codelineno-0-1132" href="#__codelineno-0-1132"></a>
</span><span id="__span-0-1133"><a id="__codelineno-0-1133" name="__codelineno-0-1133" href="#__codelineno-0-1133"></a><span class="w">    </span><span class="k">BEGIN</span>
</span><span id="__span-0-1134"><a id="__codelineno-0-1134" name="__codelineno-0-1134" href="#__codelineno-0-1134"></a>
</span><span id="__span-0-1135"><a id="__codelineno-0-1135" name="__codelineno-0-1135" href="#__codelineno-0-1135"></a><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Database '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">' is not exists.'</span><span class="p">;</span>
</span><span id="__span-0-1136"><a id="__codelineno-0-1136" name="__codelineno-0-1136" href="#__codelineno-0-1136"></a>
</span><span id="__span-0-1137"><a id="__codelineno-0-1137" name="__codelineno-0-1137" href="#__codelineno-0-1137"></a><span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="mi">51000</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-1138"><a id="__codelineno-0-1138" name="__codelineno-0-1138" href="#__codelineno-0-1138"></a>
</span><span id="__span-0-1139"><a id="__codelineno-0-1139" name="__codelineno-0-1139" href="#__codelineno-0-1139"></a><span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-1140"><a id="__codelineno-0-1140" name="__codelineno-0-1140" href="#__codelineno-0-1140"></a>
</span><span id="__span-0-1141"><a id="__codelineno-0-1141" name="__codelineno-0-1141" href="#__codelineno-0-1141"></a><span class="w">    </span><span class="k">END</span>
</span><span id="__span-0-1142"><a id="__codelineno-0-1142" name="__codelineno-0-1142" href="#__codelineno-0-1142"></a>
</span><span id="__span-0-1143"><a id="__codelineno-0-1143" name="__codelineno-0-1143" href="#__codelineno-0-1143"></a>
</span><span id="__span-0-1144"><a id="__codelineno-0-1144" name="__codelineno-0-1144" href="#__codelineno-0-1144"></a>
</span><span id="__span-0-1145"><a id="__codelineno-0-1145" name="__codelineno-0-1145" href="#__codelineno-0-1145"></a><span class="w">    </span><span class="c1">-- Информация о размере лога транзакций</span>
</span><span id="__span-0-1146"><a id="__codelineno-0-1146" name="__codelineno-0-1146" href="#__codelineno-0-1146"></a>
</span><span id="__span-0-1147"><a id="__codelineno-0-1147" name="__codelineno-0-1147" href="#__codelineno-0-1147"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">OBJECT_ID</span><span class="p">(</span><span class="s1">'tempdb..#tranLogInfo'</span><span class="p">)</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-0-1148"><a id="__codelineno-0-1148" name="__codelineno-0-1148" href="#__codelineno-0-1148"></a>
</span><span id="__span-0-1149"><a id="__codelineno-0-1149" name="__codelineno-0-1149" href="#__codelineno-0-1149"></a><span class="w">        </span><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">#</span><span class="n">tranLogInfo</span><span class="p">;</span>
</span><span id="__span-0-1150"><a id="__codelineno-0-1150" name="__codelineno-0-1150" href="#__codelineno-0-1150"></a>
</span><span id="__span-0-1151"><a id="__codelineno-0-1151" name="__codelineno-0-1151" href="#__codelineno-0-1151"></a><span class="w">    </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">#</span><span class="n">tranLogInfo</span>
</span><span id="__span-0-1152"><a id="__codelineno-0-1152" name="__codelineno-0-1152" href="#__codelineno-0-1152"></a>
</span><span id="__span-0-1153"><a id="__codelineno-0-1153" name="__codelineno-0-1153" href="#__codelineno-0-1153"></a><span class="w">    </span><span class="p">(</span>
</span><span id="__span-0-1154"><a id="__codelineno-0-1154" name="__codelineno-0-1154" href="#__codelineno-0-1154"></a>
</span><span id="__span-0-1155"><a id="__codelineno-0-1155" name="__codelineno-0-1155" href="#__codelineno-0-1155"></a><span class="w">        </span><span class="n">servername</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="o">@@</span><span class="n">servername</span><span class="p">,</span>
</span><span id="__span-0-1156"><a id="__codelineno-0-1156" name="__codelineno-0-1156" href="#__codelineno-0-1156"></a>
</span><span id="__span-0-1157"><a id="__codelineno-0-1157" name="__codelineno-0-1157" href="#__codelineno-0-1157"></a><span class="w">        </span><span class="n">dbname</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">250</span><span class="p">),</span>
</span><span id="__span-0-1158"><a id="__codelineno-0-1158" name="__codelineno-0-1158" href="#__codelineno-0-1158"></a>
</span><span id="__span-0-1159"><a id="__codelineno-0-1159" name="__codelineno-0-1159" href="#__codelineno-0-1159"></a><span class="w">        </span><span class="n">logsize</span><span class="w"> </span><span class="nb">real</span><span class="p">,</span>
</span><span id="__span-0-1160"><a id="__codelineno-0-1160" name="__codelineno-0-1160" href="#__codelineno-0-1160"></a>
</span><span id="__span-0-1161"><a id="__codelineno-0-1161" name="__codelineno-0-1161" href="#__codelineno-0-1161"></a><span class="w">        </span><span class="n">logspace</span><span class="w"> </span><span class="nb">real</span><span class="p">,</span>
</span><span id="__span-0-1162"><a id="__codelineno-0-1162" name="__codelineno-0-1162" href="#__codelineno-0-1162"></a>
</span><span id="__span-0-1163"><a id="__codelineno-0-1163" name="__codelineno-0-1163" href="#__codelineno-0-1163"></a><span class="w">        </span><span class="n">stat</span><span class="w"> </span><span class="nb">int</span>
</span><span id="__span-0-1164"><a id="__codelineno-0-1164" name="__codelineno-0-1164" href="#__codelineno-0-1164"></a>
</span><span id="__span-0-1165"><a id="__codelineno-0-1165" name="__codelineno-0-1165" href="#__codelineno-0-1165"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-0-1166"><a id="__codelineno-0-1166" name="__codelineno-0-1166" href="#__codelineno-0-1166"></a>
</span><span id="__span-0-1167"><a id="__codelineno-0-1167" name="__codelineno-0-1167" href="#__codelineno-0-1167"></a>
</span><span id="__span-0-1168"><a id="__codelineno-0-1168" name="__codelineno-0-1168" href="#__codelineno-0-1168"></a>
</span><span id="__span-0-1169"><a id="__codelineno-0-1169" name="__codelineno-0-1169" href="#__codelineno-0-1169"></a><span class="w">    </span><span class="c1">-- Проверка процента занятого места в логе транзакций</span>
</span><span id="__span-0-1170"><a id="__codelineno-0-1170" name="__codelineno-0-1170" href="#__codelineno-0-1170"></a>
</span><span id="__span-0-1171"><a id="__codelineno-0-1171" name="__codelineno-0-1171" href="#__codelineno-0-1171"></a><span class="w">    </span><span class="k">TRUNCATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">#</span><span class="n">tranLogInfo</span><span class="p">;</span>
</span><span id="__span-0-1172"><a id="__codelineno-0-1172" name="__codelineno-0-1172" href="#__codelineno-0-1172"></a>
</span><span id="__span-0-1173"><a id="__codelineno-0-1173" name="__codelineno-0-1173" href="#__codelineno-0-1173"></a><span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">#</span><span class="n">tranLogInfo</span><span class="w"> </span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span><span class="n">logsize</span><span class="p">,</span><span class="n">logspace</span><span class="p">,</span><span class="n">stat</span><span class="p">)</span><span class="w"> </span><span class="k">exec</span><span class="p">(</span><span class="s1">'dbcc sqlperf(logspace)'</span><span class="p">)</span>
</span><span id="__span-0-1174"><a id="__codelineno-0-1174" name="__codelineno-0-1174" href="#__codelineno-0-1174"></a>
</span><span id="__span-0-1175"><a id="__codelineno-0-1175" name="__codelineno-0-1175" href="#__codelineno-0-1175"></a><span class="w">    </span><span class="k">SELECT</span>
</span><span id="__span-0-1176"><a id="__codelineno-0-1176" name="__codelineno-0-1176" href="#__codelineno-0-1176"></a>
</span><span id="__span-0-1177"><a id="__codelineno-0-1177" name="__codelineno-0-1177" href="#__codelineno-0-1177"></a><span class="w">        </span><span class="o">@</span><span class="n">currentTransactionLogSizeUsagePercent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logspace</span><span class="p">,</span>
</span><span id="__span-0-1178"><a id="__codelineno-0-1178" name="__codelineno-0-1178" href="#__codelineno-0-1178"></a>
</span><span id="__span-0-1179"><a id="__codelineno-0-1179" name="__codelineno-0-1179" href="#__codelineno-0-1179"></a><span class="w">        </span><span class="o">@</span><span class="n">currentTransactionLogSizeMB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logsize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">logspace</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
</span><span id="__span-0-1180"><a id="__codelineno-0-1180" name="__codelineno-0-1180" href="#__codelineno-0-1180"></a>
</span><span id="__span-0-1181"><a id="__codelineno-0-1181" name="__codelineno-0-1181" href="#__codelineno-0-1181"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="o">#</span><span class="n">tranLogInfo</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">dbname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">databaseName</span>
</span><span id="__span-0-1182"><a id="__codelineno-0-1182" name="__codelineno-0-1182" href="#__codelineno-0-1182"></a>
</span><span id="__span-0-1183"><a id="__codelineno-0-1183" name="__codelineno-0-1183" href="#__codelineno-0-1183"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="o">@</span><span class="n">currentTransactionLogSizeUsagePercent</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">@</span><span class="n">maxTransactionLogSizeUsagePercent</span><span class="p">)</span>
</span><span id="__span-0-1184"><a id="__codelineno-0-1184" name="__codelineno-0-1184" href="#__codelineno-0-1184"></a>
</span><span id="__span-0-1185"><a id="__codelineno-0-1185" name="__codelineno-0-1185" href="#__codelineno-0-1185"></a><span class="w">    </span><span class="k">BEGIN</span>
</span><span id="__span-0-1186"><a id="__codelineno-0-1186" name="__codelineno-0-1186" href="#__codelineno-0-1186"></a>
</span><span id="__span-0-1187"><a id="__codelineno-0-1187" name="__codelineno-0-1187" href="#__codelineno-0-1187"></a><span class="w">        </span><span class="c1">-- Процент занятого места в файлах лога транзакций превышает указанный порог</span>
</span><span id="__span-0-1188"><a id="__codelineno-0-1188" name="__codelineno-0-1188" href="#__codelineno-0-1188"></a>
</span><span id="__span-0-1189"><a id="__codelineno-0-1189" name="__codelineno-0-1189" href="#__codelineno-0-1189"></a><span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-1190"><a id="__codelineno-0-1190" name="__codelineno-0-1190" href="#__codelineno-0-1190"></a>
</span><span id="__span-0-1191"><a id="__codelineno-0-1191" name="__codelineno-0-1191" href="#__codelineno-0-1191"></a><span class="w">    </span><span class="k">END</span>
</span><span id="__span-0-1192"><a id="__codelineno-0-1192" name="__codelineno-0-1192" href="#__codelineno-0-1192"></a>
</span><span id="__span-0-1193"><a id="__codelineno-0-1193" name="__codelineno-0-1193" href="#__codelineno-0-1193"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="o">@</span><span class="n">maxTransactionLogSizeMB</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">@</span><span class="n">currentTransactionLogSizeMB</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">maxTransactionLogSizeMB</span><span class="p">)</span>
</span><span id="__span-0-1194"><a id="__codelineno-0-1194" name="__codelineno-0-1194" href="#__codelineno-0-1194"></a>
</span><span id="__span-0-1195"><a id="__codelineno-0-1195" name="__codelineno-0-1195" href="#__codelineno-0-1195"></a><span class="w">    </span><span class="k">BEGIN</span>
</span><span id="__span-0-1196"><a id="__codelineno-0-1196" name="__codelineno-0-1196" href="#__codelineno-0-1196"></a>
</span><span id="__span-0-1197"><a id="__codelineno-0-1197" name="__codelineno-0-1197" href="#__codelineno-0-1197"></a><span class="w">        </span><span class="c1">-- Размер занятого места в файлах лога транзакций превышает указанный порог в МБ</span>
</span><span id="__span-0-1198"><a id="__codelineno-0-1198" name="__codelineno-0-1198" href="#__codelineno-0-1198"></a>
</span><span id="__span-0-1199"><a id="__codelineno-0-1199" name="__codelineno-0-1199" href="#__codelineno-0-1199"></a><span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-1200"><a id="__codelineno-0-1200" name="__codelineno-0-1200" href="#__codelineno-0-1200"></a>
</span><span id="__span-0-1201"><a id="__codelineno-0-1201" name="__codelineno-0-1201" href="#__codelineno-0-1201"></a><span class="w">    </span><span class="k">END</span>
</span><span id="__span-0-1202"><a id="__codelineno-0-1202" name="__codelineno-0-1202" href="#__codelineno-0-1202"></a>
</span><span id="__span-0-1203"><a id="__codelineno-0-1203" name="__codelineno-0-1203" href="#__codelineno-0-1203"></a>
</span><span id="__span-0-1204"><a id="__codelineno-0-1204" name="__codelineno-0-1204" href="#__codelineno-0-1204"></a>
</span><span id="__span-0-1205"><a id="__codelineno-0-1205" name="__codelineno-0-1205" href="#__codelineno-0-1205"></a><span class="w">    </span><span class="c1">-- Возобновляемое перестроение индексов</span>
</span><span id="__span-0-1206"><a id="__codelineno-0-1206" name="__codelineno-0-1206" href="#__codelineno-0-1206"></a>
</span><span id="__span-0-1207"><a id="__codelineno-0-1207" name="__codelineno-0-1207" href="#__codelineno-0-1207"></a><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">LOCAL_ResumableIndexRebuilds</span><span class="w"> </span><span class="k">TABLE</span>
</span><span id="__span-0-1208"><a id="__codelineno-0-1208" name="__codelineno-0-1208" href="#__codelineno-0-1208"></a>
</span><span id="__span-0-1209"><a id="__codelineno-0-1209" name="__codelineno-0-1209" href="#__codelineno-0-1209"></a><span class="w">    </span><span class="p">(</span>
</span><span id="__span-0-1210"><a id="__codelineno-0-1210" name="__codelineno-0-1210" href="#__codelineno-0-1210"></a>
</span><span id="__span-0-1211"><a id="__codelineno-0-1211" name="__codelineno-0-1211" href="#__codelineno-0-1211"></a><span class="w">        </span><span class="p">[</span><span class="n">object_id</span><span class="p">]</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-1212"><a id="__codelineno-0-1212" name="__codelineno-0-1212" href="#__codelineno-0-1212"></a>
</span><span id="__span-0-1213"><a id="__codelineno-0-1213" name="__codelineno-0-1213" href="#__codelineno-0-1213"></a><span class="w">        </span><span class="p">[</span><span class="n">object_name</span><span class="p">]</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-0-1214"><a id="__codelineno-0-1214" name="__codelineno-0-1214" href="#__codelineno-0-1214"></a>
</span><span id="__span-0-1215"><a id="__codelineno-0-1215" name="__codelineno-0-1215" href="#__codelineno-0-1215"></a><span class="w">        </span><span class="p">[</span><span class="n">index_id</span><span class="p">]</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-1216"><a id="__codelineno-0-1216" name="__codelineno-0-1216" href="#__codelineno-0-1216"></a>
</span><span id="__span-0-1217"><a id="__codelineno-0-1217" name="__codelineno-0-1217" href="#__codelineno-0-1217"></a><span class="w">        </span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="w"> </span><span class="n">sysname</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-1218"><a id="__codelineno-0-1218" name="__codelineno-0-1218" href="#__codelineno-0-1218"></a>
</span><span id="__span-0-1219"><a id="__codelineno-0-1219" name="__codelineno-0-1219" href="#__codelineno-0-1219"></a><span class="w">        </span><span class="p">[</span><span class="n">sql_text</span><span class="p">]</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-0-1220"><a id="__codelineno-0-1220" name="__codelineno-0-1220" href="#__codelineno-0-1220"></a>
</span><span id="__span-0-1221"><a id="__codelineno-0-1221" name="__codelineno-0-1221" href="#__codelineno-0-1221"></a><span class="w">        </span><span class="p">[</span><span class="n">partition_number</span><span class="p">]</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span>
</span><span id="__span-0-1222"><a id="__codelineno-0-1222" name="__codelineno-0-1222" href="#__codelineno-0-1222"></a>
</span><span id="__span-0-1223"><a id="__codelineno-0-1223" name="__codelineno-0-1223" href="#__codelineno-0-1223"></a><span class="w">        </span><span class="p">[</span><span class="k">state</span><span class="p">]</span><span class="w"> </span><span class="n">tinyint</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-1224"><a id="__codelineno-0-1224" name="__codelineno-0-1224" href="#__codelineno-0-1224"></a>
</span><span id="__span-0-1225"><a id="__codelineno-0-1225" name="__codelineno-0-1225" href="#__codelineno-0-1225"></a><span class="w">        </span><span class="p">[</span><span class="n">state_desc</span><span class="p">]</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">60</span><span class="p">),</span>
</span><span id="__span-0-1226"><a id="__codelineno-0-1226" name="__codelineno-0-1226" href="#__codelineno-0-1226"></a>
</span><span id="__span-0-1227"><a id="__codelineno-0-1227" name="__codelineno-0-1227" href="#__codelineno-0-1227"></a><span class="w">        </span><span class="p">[</span><span class="n">start_time</span><span class="p">]</span><span class="w"> </span><span class="n">datetime</span><span class="p">,</span>
</span><span id="__span-0-1228"><a id="__codelineno-0-1228" name="__codelineno-0-1228" href="#__codelineno-0-1228"></a>
</span><span id="__span-0-1229"><a id="__codelineno-0-1229" name="__codelineno-0-1229" href="#__codelineno-0-1229"></a><span class="w">        </span><span class="p">[</span><span class="n">last_pause_time</span><span class="p">]</span><span class="w"> </span><span class="n">datetime</span><span class="p">,</span>
</span><span id="__span-0-1230"><a id="__codelineno-0-1230" name="__codelineno-0-1230" href="#__codelineno-0-1230"></a>
</span><span id="__span-0-1231"><a id="__codelineno-0-1231" name="__codelineno-0-1231" href="#__codelineno-0-1231"></a><span class="w">        </span><span class="p">[</span><span class="n">total_execution_time</span><span class="p">]</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span>
</span><span id="__span-0-1232"><a id="__codelineno-0-1232" name="__codelineno-0-1232" href="#__codelineno-0-1232"></a>
</span><span id="__span-0-1233"><a id="__codelineno-0-1233" name="__codelineno-0-1233" href="#__codelineno-0-1233"></a><span class="w">        </span><span class="p">[</span><span class="n">percent_complete</span><span class="p">]</span><span class="w"> </span><span class="nb">real</span><span class="p">,</span>
</span><span id="__span-0-1234"><a id="__codelineno-0-1234" name="__codelineno-0-1234" href="#__codelineno-0-1234"></a>
</span><span id="__span-0-1235"><a id="__codelineno-0-1235" name="__codelineno-0-1235" href="#__codelineno-0-1235"></a><span class="w">        </span><span class="p">[</span><span class="n">page_count</span><span class="p">]</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
</span><span id="__span-0-1236"><a id="__codelineno-0-1236" name="__codelineno-0-1236" href="#__codelineno-0-1236"></a>
</span><span id="__span-0-1237"><a id="__codelineno-0-1237" name="__codelineno-0-1237" href="#__codelineno-0-1237"></a><span class="w">        </span><span class="p">[</span><span class="n">ResumeCmd</span><span class="p">]</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span>
</span><span id="__span-0-1238"><a id="__codelineno-0-1238" name="__codelineno-0-1238" href="#__codelineno-0-1238"></a>
</span><span id="__span-0-1239"><a id="__codelineno-0-1239" name="__codelineno-0-1239" href="#__codelineno-0-1239"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-0-1240"><a id="__codelineno-0-1240" name="__codelineno-0-1240" href="#__codelineno-0-1240"></a>
</span><span id="__span-0-1241"><a id="__codelineno-0-1241" name="__codelineno-0-1241" href="#__codelineno-0-1241"></a><span class="w">    </span><span class="c1">-- Флаг использования возобновляемого перестроения индексов</span>
</span><span id="__span-0-1242"><a id="__codelineno-0-1242" name="__codelineno-0-1242" href="#__codelineno-0-1242"></a>
</span><span id="__span-0-1243"><a id="__codelineno-0-1243" name="__codelineno-0-1243" href="#__codelineno-0-1243"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">useResumableIndexRebuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
</span><span id="__span-0-1244"><a id="__codelineno-0-1244" name="__codelineno-0-1244" href="#__codelineno-0-1244"></a>
</span><span id="__span-0-1245"><a id="__codelineno-0-1245" name="__codelineno-0-1245" href="#__codelineno-0-1245"></a><span class="w">        </span><span class="k">CASE</span>
</span><span id="__span-0-1246"><a id="__codelineno-0-1246" name="__codelineno-0-1246" href="#__codelineno-0-1246"></a>
</span><span id="__span-0-1247"><a id="__codelineno-0-1247" name="__codelineno-0-1247" href="#__codelineno-0-1247"></a><span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">useResumableIndexRebuildIfAvailable</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">-- Передан флаг использования возобновляемого перестроения</span>
</span><span id="__span-0-1248"><a id="__codelineno-0-1248" name="__codelineno-0-1248" href="#__codelineno-0-1248"></a>
</span><span id="__span-0-1249"><a id="__codelineno-0-1249" name="__codelineno-0-1249" href="#__codelineno-0-1249"></a><span class="w">            </span><span class="c1">-- Возобновляемое перестроение доступно для версии SQL Server</span>
</span><span id="__span-0-1250"><a id="__codelineno-0-1250" name="__codelineno-0-1250" href="#__codelineno-0-1250"></a>
</span><span id="__span-0-1251"><a id="__codelineno-0-1251" name="__codelineno-0-1251" href="#__codelineno-0-1251"></a><span class="w">            </span><span class="k">AND</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_ResumableIndexMaintenanceAvailiable</span><span class="p">]()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-1252"><a id="__codelineno-0-1252" name="__codelineno-0-1252" href="#__codelineno-0-1252"></a>
</span><span id="__span-0-1253"><a id="__codelineno-0-1253" name="__codelineno-0-1253" href="#__codelineno-0-1253"></a><span class="w">            </span><span class="c1">-- Включено использование онлайн-перестроения для скрипта</span>
</span><span id="__span-0-1254"><a id="__codelineno-0-1254" name="__codelineno-0-1254" href="#__codelineno-0-1254"></a>
</span><span id="__span-0-1255"><a id="__codelineno-0-1255" name="__codelineno-0-1255" href="#__codelineno-0-1255"></a><span class="w">            </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">useOnlineIndexRebuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">-- Только онлайн-перестроение</span>
</span><span id="__span-0-1256"><a id="__codelineno-0-1256" name="__codelineno-0-1256" href="#__codelineno-0-1256"></a>
</span><span id="__span-0-1257"><a id="__codelineno-0-1257" name="__codelineno-0-1257" href="#__codelineno-0-1257"></a><span class="w">                </span><span class="k">OR</span><span class="w"> </span><span class="o">@</span><span class="n">useOnlineIndexRebuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="c1">-- Для объектов где оно возможно</span>
</span><span id="__span-0-1258"><a id="__codelineno-0-1258" name="__codelineno-0-1258" href="#__codelineno-0-1258"></a>
</span><span id="__span-0-1259"><a id="__codelineno-0-1259" name="__codelineno-0-1259" href="#__codelineno-0-1259"></a><span class="w">            </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-0-1260"><a id="__codelineno-0-1260" name="__codelineno-0-1260" href="#__codelineno-0-1260"></a>
</span><span id="__span-0-1261"><a id="__codelineno-0-1261" name="__codelineno-0-1261" href="#__codelineno-0-1261"></a><span class="w">            </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-1262"><a id="__codelineno-0-1262" name="__codelineno-0-1262" href="#__codelineno-0-1262"></a>
</span><span id="__span-0-1263"><a id="__codelineno-0-1263" name="__codelineno-0-1263" href="#__codelineno-0-1263"></a><span class="w">        </span><span class="k">END</span><span class="p">;</span>
</span><span id="__span-0-1264"><a id="__codelineno-0-1264" name="__codelineno-0-1264" href="#__codelineno-0-1264"></a>
</span><span id="__span-0-1265"><a id="__codelineno-0-1265" name="__codelineno-0-1265" href="#__codelineno-0-1265"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="o">@</span><span class="n">useResumableIndexRebuild</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-0-1266"><a id="__codelineno-0-1266" name="__codelineno-0-1266" href="#__codelineno-0-1266"></a>
</span><span id="__span-0-1267"><a id="__codelineno-0-1267" name="__codelineno-0-1267" href="#__codelineno-0-1267"></a><span class="w">    </span><span class="k">BEGIN</span>
</span><span id="__span-0-1268"><a id="__codelineno-0-1268" name="__codelineno-0-1268" href="#__codelineno-0-1268"></a>
</span><span id="__span-0-1269"><a id="__codelineno-0-1269" name="__codelineno-0-1269" href="#__codelineno-0-1269"></a><span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">cmdResumableIndexRebuild</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
</span><span id="__span-0-1270"><a id="__codelineno-0-1270" name="__codelineno-0-1270" href="#__codelineno-0-1270"></a>
</span><span id="__span-0-1271"><a id="__codelineno-0-1271" name="__codelineno-0-1271" href="#__codelineno-0-1271"></a><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">cmdResumableIndexRebuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'</span>
</span><span id="__span-0-1272"><a id="__codelineno-0-1272" name="__codelineno-0-1272" href="#__codelineno-0-1272"></a>
</span><span id="__span-0-1273"><a id="__codelineno-0-1273" name="__codelineno-0-1273" href="#__codelineno-0-1273"></a><span class="s1">        USE ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">']</span>
</span><span id="__span-0-1274"><a id="__codelineno-0-1274" name="__codelineno-0-1274" href="#__codelineno-0-1274"></a>
</span><span id="__span-0-1275"><a id="__codelineno-0-1275" name="__codelineno-0-1275" href="#__codelineno-0-1275"></a><span class="s1">        SET NOCOUNT ON;</span>
</span><span id="__span-0-1276"><a id="__codelineno-0-1276" name="__codelineno-0-1276" href="#__codelineno-0-1276"></a>
</span><span id="__span-0-1277"><a id="__codelineno-0-1277" name="__codelineno-0-1277" href="#__codelineno-0-1277"></a><span class="s1">        SELECT</span>
</span><span id="__span-0-1278"><a id="__codelineno-0-1278" name="__codelineno-0-1278" href="#__codelineno-0-1278"></a>
</span><span id="__span-0-1279"><a id="__codelineno-0-1279" name="__codelineno-0-1279" href="#__codelineno-0-1279"></a><span class="s1">            [object_id],</span>
</span><span id="__span-0-1280"><a id="__codelineno-0-1280" name="__codelineno-0-1280" href="#__codelineno-0-1280"></a>
</span><span id="__span-0-1281"><a id="__codelineno-0-1281" name="__codelineno-0-1281" href="#__codelineno-0-1281"></a><span class="s1">            OBJECT_NAME([object_id]) AS [TableName],</span>
</span><span id="__span-0-1282"><a id="__codelineno-0-1282" name="__codelineno-0-1282" href="#__codelineno-0-1282"></a>
</span><span id="__span-0-1283"><a id="__codelineno-0-1283" name="__codelineno-0-1283" href="#__codelineno-0-1283"></a><span class="s1">            [index_id], </span>
</span><span id="__span-0-1284"><a id="__codelineno-0-1284" name="__codelineno-0-1284" href="#__codelineno-0-1284"></a>
</span><span id="__span-0-1285"><a id="__codelineno-0-1285" name="__codelineno-0-1285" href="#__codelineno-0-1285"></a><span class="s1">            [name], </span>
</span><span id="__span-0-1286"><a id="__codelineno-0-1286" name="__codelineno-0-1286" href="#__codelineno-0-1286"></a>
</span><span id="__span-0-1287"><a id="__codelineno-0-1287" name="__codelineno-0-1287" href="#__codelineno-0-1287"></a><span class="s1">            [sql_text], </span>
</span><span id="__span-0-1288"><a id="__codelineno-0-1288" name="__codelineno-0-1288" href="#__codelineno-0-1288"></a>
</span><span id="__span-0-1289"><a id="__codelineno-0-1289" name="__codelineno-0-1289" href="#__codelineno-0-1289"></a><span class="s1">            [partition_number],</span>
</span><span id="__span-0-1290"><a id="__codelineno-0-1290" name="__codelineno-0-1290" href="#__codelineno-0-1290"></a>
</span><span id="__span-0-1291"><a id="__codelineno-0-1291" name="__codelineno-0-1291" href="#__codelineno-0-1291"></a><span class="s1">            [state], </span>
</span><span id="__span-0-1292"><a id="__codelineno-0-1292" name="__codelineno-0-1292" href="#__codelineno-0-1292"></a>
</span><span id="__span-0-1293"><a id="__codelineno-0-1293" name="__codelineno-0-1293" href="#__codelineno-0-1293"></a><span class="s1">            [state_desc],</span>
</span><span id="__span-0-1294"><a id="__codelineno-0-1294" name="__codelineno-0-1294" href="#__codelineno-0-1294"></a>
</span><span id="__span-0-1295"><a id="__codelineno-0-1295" name="__codelineno-0-1295" href="#__codelineno-0-1295"></a><span class="s1">            [start_time],</span>
</span><span id="__span-0-1296"><a id="__codelineno-0-1296" name="__codelineno-0-1296" href="#__codelineno-0-1296"></a>
</span><span id="__span-0-1297"><a id="__codelineno-0-1297" name="__codelineno-0-1297" href="#__codelineno-0-1297"></a><span class="s1">            [last_pause_time],</span>
</span><span id="__span-0-1298"><a id="__codelineno-0-1298" name="__codelineno-0-1298" href="#__codelineno-0-1298"></a>
</span><span id="__span-0-1299"><a id="__codelineno-0-1299" name="__codelineno-0-1299" href="#__codelineno-0-1299"></a><span class="s1">            [total_execution_time],</span>
</span><span id="__span-0-1300"><a id="__codelineno-0-1300" name="__codelineno-0-1300" href="#__codelineno-0-1300"></a>
</span><span id="__span-0-1301"><a id="__codelineno-0-1301" name="__codelineno-0-1301" href="#__codelineno-0-1301"></a><span class="s1">            [percent_complete],</span>
</span><span id="__span-0-1302"><a id="__codelineno-0-1302" name="__codelineno-0-1302" href="#__codelineno-0-1302"></a>
</span><span id="__span-0-1303"><a id="__codelineno-0-1303" name="__codelineno-0-1303" href="#__codelineno-0-1303"></a><span class="s1">            [page_count],</span>
</span><span id="__span-0-1304"><a id="__codelineno-0-1304" name="__codelineno-0-1304" href="#__codelineno-0-1304"></a>
</span><span id="__span-0-1305"><a id="__codelineno-0-1305" name="__codelineno-0-1305" href="#__codelineno-0-1305"></a><span class="s1">            ''ALTER INDEX ['' + [name] + ''] ON ['' + OBJECT_SCHEMA_NAME([object_id]) + ''].['' + OBJECT_NAME([object_id]) + ''] RESUME'' AS [ResumeCmd]</span>
</span><span id="__span-0-1306"><a id="__codelineno-0-1306" name="__codelineno-0-1306" href="#__codelineno-0-1306"></a>
</span><span id="__span-0-1307"><a id="__codelineno-0-1307" name="__codelineno-0-1307" href="#__codelineno-0-1307"></a><span class="s1">        FROM sys.index_resumable_operations</span>
</span><span id="__span-0-1308"><a id="__codelineno-0-1308" name="__codelineno-0-1308" href="#__codelineno-0-1308"></a>
</span><span id="__span-0-1309"><a id="__codelineno-0-1309" name="__codelineno-0-1309" href="#__codelineno-0-1309"></a><span class="s1">        WHERE OBJECT_NAME([object_id]) '</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">ConditionTableName</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'</span>
</span><span id="__span-0-1310"><a id="__codelineno-0-1310" name="__codelineno-0-1310" href="#__codelineno-0-1310"></a>
</span><span id="__span-0-1311"><a id="__codelineno-0-1311" name="__codelineno-0-1311" href="#__codelineno-0-1311"></a><span class="s1">            AND [name] '</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">ConditionIndexName</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">';</span>
</span><span id="__span-0-1312"><a id="__codelineno-0-1312" name="__codelineno-0-1312" href="#__codelineno-0-1312"></a>
</span><span id="__span-0-1313"><a id="__codelineno-0-1313" name="__codelineno-0-1313" href="#__codelineno-0-1313"></a><span class="s1">        '</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">));</span>
</span><span id="__span-0-1314"><a id="__codelineno-0-1314" name="__codelineno-0-1314" href="#__codelineno-0-1314"></a>
</span><span id="__span-0-1315"><a id="__codelineno-0-1315" name="__codelineno-0-1315" href="#__codelineno-0-1315"></a><span class="w">        </span><span class="k">INSERT</span><span class="w"> </span><span class="o">@</span><span class="n">LOCAL_ResumableIndexRebuilds</span>
</span><span id="__span-0-1316"><a id="__codelineno-0-1316" name="__codelineno-0-1316" href="#__codelineno-0-1316"></a>
</span><span id="__span-0-1317"><a id="__codelineno-0-1317" name="__codelineno-0-1317" href="#__codelineno-0-1317"></a><span class="w">        </span><span class="k">EXECUTE</span><span class="w"> </span><span class="n">sp_executesql</span><span class="w"> </span><span class="o">@</span><span class="n">cmdResumableIndexRebuild</span><span class="p">;</span>
</span><span id="__span-0-1318"><a id="__codelineno-0-1318" name="__codelineno-0-1318" href="#__codelineno-0-1318"></a>
</span><span id="__span-0-1319"><a id="__codelineno-0-1319" name="__codelineno-0-1319" href="#__codelineno-0-1319"></a>
</span><span id="__span-0-1320"><a id="__codelineno-0-1320" name="__codelineno-0-1320" href="#__codelineno-0-1320"></a>
</span><span id="__span-0-1321"><a id="__codelineno-0-1321" name="__codelineno-0-1321" href="#__codelineno-0-1321"></a><span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span>
</span><span id="__span-0-1322"><a id="__codelineno-0-1322" name="__codelineno-0-1322" href="#__codelineno-0-1322"></a>
</span><span id="__span-0-1323"><a id="__codelineno-0-1323" name="__codelineno-0-1323" href="#__codelineno-0-1323"></a><span class="w">            </span><span class="o">@</span><span class="n">objectNameResumeRebuildForIndex</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-0-1324"><a id="__codelineno-0-1324" name="__codelineno-0-1324" href="#__codelineno-0-1324"></a>
</span><span id="__span-0-1325"><a id="__codelineno-0-1325" name="__codelineno-0-1325" href="#__codelineno-0-1325"></a><span class="w">            </span><span class="o">@</span><span class="n">indexNameResumeRebuildForIndex</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-0-1326"><a id="__codelineno-0-1326" name="__codelineno-0-1326" href="#__codelineno-0-1326"></a>
</span><span id="__span-0-1327"><a id="__codelineno-0-1327" name="__codelineno-0-1327" href="#__codelineno-0-1327"></a><span class="w">            </span><span class="o">@</span><span class="n">cmdResumeRebuildForIndex</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
</span><span id="__span-0-1328"><a id="__codelineno-0-1328" name="__codelineno-0-1328" href="#__codelineno-0-1328"></a>
</span><span id="__span-0-1329"><a id="__codelineno-0-1329" name="__codelineno-0-1329" href="#__codelineno-0-1329"></a><span class="w">        </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">resumableIndexRebuild_cursor</span><span class="w"> </span><span class="k">CURSOR</span><span class="w"> </span><span class="k">FOR</span><span class="w">             </span>
</span><span id="__span-0-1330"><a id="__codelineno-0-1330" name="__codelineno-0-1330" href="#__codelineno-0-1330"></a>
</span><span id="__span-0-1331"><a id="__codelineno-0-1331" name="__codelineno-0-1331" href="#__codelineno-0-1331"></a><span class="w">        </span><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-0-1332"><a id="__codelineno-0-1332" name="__codelineno-0-1332" href="#__codelineno-0-1332"></a>
</span><span id="__span-0-1333"><a id="__codelineno-0-1333" name="__codelineno-0-1333" href="#__codelineno-0-1333"></a><span class="w">            </span><span class="p">[</span><span class="n">object_name</span><span class="p">],</span>
</span><span id="__span-0-1334"><a id="__codelineno-0-1334" name="__codelineno-0-1334" href="#__codelineno-0-1334"></a>
</span><span id="__span-0-1335"><a id="__codelineno-0-1335" name="__codelineno-0-1335" href="#__codelineno-0-1335"></a><span class="w">            </span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
</span><span id="__span-0-1336"><a id="__codelineno-0-1336" name="__codelineno-0-1336" href="#__codelineno-0-1336"></a>
</span><span id="__span-0-1337"><a id="__codelineno-0-1337" name="__codelineno-0-1337" href="#__codelineno-0-1337"></a><span class="w">            </span><span class="p">[</span><span class="n">ResumeCmd</span><span class="p">]</span>
</span><span id="__span-0-1338"><a id="__codelineno-0-1338" name="__codelineno-0-1338" href="#__codelineno-0-1338"></a>
</span><span id="__span-0-1339"><a id="__codelineno-0-1339" name="__codelineno-0-1339" href="#__codelineno-0-1339"></a><span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">LOCAL_ResumableIndexRebuilds</span>
</span><span id="__span-0-1340"><a id="__codelineno-0-1340" name="__codelineno-0-1340" href="#__codelineno-0-1340"></a>
</span><span id="__span-0-1341"><a id="__codelineno-0-1341" name="__codelineno-0-1341" href="#__codelineno-0-1341"></a><span class="w">        </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">start_time</span><span class="p">;</span>
</span><span id="__span-0-1342"><a id="__codelineno-0-1342" name="__codelineno-0-1342" href="#__codelineno-0-1342"></a>
</span><span id="__span-0-1343"><a id="__codelineno-0-1343" name="__codelineno-0-1343" href="#__codelineno-0-1343"></a><span class="w">        </span><span class="k">OPEN</span><span class="w"> </span><span class="n">resumableIndexRebuild_cursor</span><span class="p">;</span><span class="w">      </span>
</span><span id="__span-0-1344"><a id="__codelineno-0-1344" name="__codelineno-0-1344" href="#__codelineno-0-1344"></a>
</span><span id="__span-0-1345"><a id="__codelineno-0-1345" name="__codelineno-0-1345" href="#__codelineno-0-1345"></a><span class="w">        </span><span class="k">FETCH</span><span class="w"> </span><span class="k">NEXT</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">resumableIndexRebuild_cursor</span><span class="w"> </span>
</span><span id="__span-0-1346"><a id="__codelineno-0-1346" name="__codelineno-0-1346" href="#__codelineno-0-1346"></a>
</span><span id="__span-0-1347"><a id="__codelineno-0-1347" name="__codelineno-0-1347" href="#__codelineno-0-1347"></a><span class="w">        </span><span class="k">INTO</span><span class="w"> </span><span class="o">@</span><span class="n">objectNameResumeRebuildForIndex</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">indexNameResumeRebuildForIndex</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">cmdResumeRebuildForIndex</span><span class="p">;</span>
</span><span id="__span-0-1348"><a id="__codelineno-0-1348" name="__codelineno-0-1348" href="#__codelineno-0-1348"></a>
</span><span id="__span-0-1349"><a id="__codelineno-0-1349" name="__codelineno-0-1349" href="#__codelineno-0-1349"></a><span class="w">        </span><span class="n">WHILE</span><span class="w"> </span><span class="o">@@</span><span class="n">FETCH_STATUS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span>
</span><span id="__span-0-1350"><a id="__codelineno-0-1350" name="__codelineno-0-1350" href="#__codelineno-0-1350"></a>
</span><span id="__span-0-1351"><a id="__codelineno-0-1351" name="__codelineno-0-1351" href="#__codelineno-0-1351"></a><span class="w">        </span><span class="k">BEGIN</span>
</span><span id="__span-0-1352"><a id="__codelineno-0-1352" name="__codelineno-0-1352" href="#__codelineno-0-1352"></a>
</span><span id="__span-0-1353"><a id="__codelineno-0-1353" name="__codelineno-0-1353" href="#__codelineno-0-1353"></a><span class="w">            </span><span class="c1">-- Проверка доступен ли запуск обслуживания в текущее время</span>
</span><span id="__span-0-1354"><a id="__codelineno-0-1354" name="__codelineno-0-1354" href="#__codelineno-0-1354"></a>
</span><span id="__span-0-1355"><a id="__codelineno-0-1355" name="__codelineno-0-1355" href="#__codelineno-0-1355"></a><span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">timeNow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">GETDATE</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">TIME</span><span class="p">);</span>
</span><span id="__span-0-1356"><a id="__codelineno-0-1356" name="__codelineno-0-1356" href="#__codelineno-0-1356"></a>
</span><span id="__span-0-1357"><a id="__codelineno-0-1357" name="__codelineno-0-1357" href="#__codelineno-0-1357"></a><span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">timeTo</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">@</span><span class="n">timeFrom</span><span class="p">)</span><span class="w"> </span><span class="k">BEGIN</span>
</span><span id="__span-0-1358"><a id="__codelineno-0-1358" name="__codelineno-0-1358" href="#__codelineno-0-1358"></a>
</span><span id="__span-0-1359"><a id="__codelineno-0-1359" name="__codelineno-0-1359" href="#__codelineno-0-1359"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="k">NOT</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">timeFrom</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">@</span><span class="n">timeNow</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">@</span><span class="n">timeTo</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">@</span><span class="n">timeNow</span><span class="p">))</span>
</span><span id="__span-0-1360"><a id="__codelineno-0-1360" name="__codelineno-0-1360" href="#__codelineno-0-1360"></a>
</span><span id="__span-0-1361"><a id="__codelineno-0-1361" name="__codelineno-0-1361" href="#__codelineno-0-1361"></a><span class="w">                    </span><span class="k">RETURN</span><span class="p">;</span>
</span><span id="__span-0-1362"><a id="__codelineno-0-1362" name="__codelineno-0-1362" href="#__codelineno-0-1362"></a>
</span><span id="__span-0-1363"><a id="__codelineno-0-1363" name="__codelineno-0-1363" href="#__codelineno-0-1363"></a><span class="w">                </span><span class="k">END</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="k">BEGIN</span>
</span><span id="__span-0-1364"><a id="__codelineno-0-1364" name="__codelineno-0-1364" href="#__codelineno-0-1364"></a>
</span><span id="__span-0-1365"><a id="__codelineno-0-1365" name="__codelineno-0-1365" href="#__codelineno-0-1365"></a><span class="w">                    </span><span class="k">IF</span><span class="p">(</span><span class="k">NOT</span><span class="w"> </span><span class="p">((</span><span class="o">@</span><span class="n">timeFrom</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">@</span><span class="n">timeNow</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="s1">'23:59:59'</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">@</span><span class="n">timeNow</span><span class="p">)</span>
</span><span id="__span-0-1366"><a id="__codelineno-0-1366" name="__codelineno-0-1366" href="#__codelineno-0-1366"></a>
</span><span id="__span-0-1367"><a id="__codelineno-0-1367" name="__codelineno-0-1367" href="#__codelineno-0-1367"></a><span class="w">                        </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">timeTo</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">@</span><span class="n">timeNow</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="s1">'00:00:00'</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">@</span><span class="n">timeNow</span><span class="p">)))</span><span class="w"> </span>
</span><span id="__span-0-1368"><a id="__codelineno-0-1368" name="__codelineno-0-1368" href="#__codelineno-0-1368"></a>
</span><span id="__span-0-1369"><a id="__codelineno-0-1369" name="__codelineno-0-1369" href="#__codelineno-0-1369"></a><span class="w">                            </span><span class="k">RETURN</span><span class="p">;</span>
</span><span id="__span-0-1370"><a id="__codelineno-0-1370" name="__codelineno-0-1370" href="#__codelineno-0-1370"></a>
</span><span id="__span-0-1371"><a id="__codelineno-0-1371" name="__codelineno-0-1371" href="#__codelineno-0-1371"></a><span class="w">            </span><span class="k">END</span>
</span><span id="__span-0-1372"><a id="__codelineno-0-1372" name="__codelineno-0-1372" href="#__codelineno-0-1372"></a>
</span><span id="__span-0-1373"><a id="__codelineno-0-1373" name="__codelineno-0-1373" href="#__codelineno-0-1373"></a>
</span><span id="__span-0-1374"><a id="__codelineno-0-1374" name="__codelineno-0-1374" href="#__codelineno-0-1374"></a>
</span><span id="__span-0-1375"><a id="__codelineno-0-1375" name="__codelineno-0-1375" href="#__codelineno-0-1375"></a><span class="w">            </span><span class="c1">-- Проверки использования лога транзакций</span>
</span><span id="__span-0-1376"><a id="__codelineno-0-1376" name="__codelineno-0-1376" href="#__codelineno-0-1376"></a>
</span><span id="__span-0-1377"><a id="__codelineno-0-1377" name="__codelineno-0-1377" href="#__codelineno-0-1377"></a><span class="w">            </span><span class="c1">-- Проверка процента занятого места в логе транзакций</span>
</span><span id="__span-0-1378"><a id="__codelineno-0-1378" name="__codelineno-0-1378" href="#__codelineno-0-1378"></a>
</span><span id="__span-0-1379"><a id="__codelineno-0-1379" name="__codelineno-0-1379" href="#__codelineno-0-1379"></a><span class="w">            </span><span class="k">TRUNCATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">#</span><span class="n">tranLogInfo</span><span class="p">;</span>
</span><span id="__span-0-1380"><a id="__codelineno-0-1380" name="__codelineno-0-1380" href="#__codelineno-0-1380"></a>
</span><span id="__span-0-1381"><a id="__codelineno-0-1381" name="__codelineno-0-1381" href="#__codelineno-0-1381"></a><span class="w">            </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">#</span><span class="n">tranLogInfo</span><span class="w"> </span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span><span class="n">logsize</span><span class="p">,</span><span class="n">logspace</span><span class="p">,</span><span class="n">stat</span><span class="p">)</span><span class="w"> </span><span class="k">exec</span><span class="p">(</span><span class="s1">'dbcc sqlperf(logspace)'</span><span class="p">)</span>
</span><span id="__span-0-1382"><a id="__codelineno-0-1382" name="__codelineno-0-1382" href="#__codelineno-0-1382"></a>
</span><span id="__span-0-1383"><a id="__codelineno-0-1383" name="__codelineno-0-1383" href="#__codelineno-0-1383"></a><span class="w">            </span><span class="k">SELECT</span>
</span><span id="__span-0-1384"><a id="__codelineno-0-1384" name="__codelineno-0-1384" href="#__codelineno-0-1384"></a>
</span><span id="__span-0-1385"><a id="__codelineno-0-1385" name="__codelineno-0-1385" href="#__codelineno-0-1385"></a><span class="w">                </span><span class="o">@</span><span class="n">currentTransactionLogSizeUsagePercent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logspace</span><span class="p">,</span>
</span><span id="__span-0-1386"><a id="__codelineno-0-1386" name="__codelineno-0-1386" href="#__codelineno-0-1386"></a>
</span><span id="__span-0-1387"><a id="__codelineno-0-1387" name="__codelineno-0-1387" href="#__codelineno-0-1387"></a><span class="w">                </span><span class="o">@</span><span class="n">currentTransactionLogSizeMB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logsize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">logspace</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
</span><span id="__span-0-1388"><a id="__codelineno-0-1388" name="__codelineno-0-1388" href="#__codelineno-0-1388"></a>
</span><span id="__span-0-1389"><a id="__codelineno-0-1389" name="__codelineno-0-1389" href="#__codelineno-0-1389"></a><span class="w">            </span><span class="k">FROM</span><span class="w"> </span><span class="o">#</span><span class="n">tranLogInfo</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">dbname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">databaseName</span>
</span><span id="__span-0-1390"><a id="__codelineno-0-1390" name="__codelineno-0-1390" href="#__codelineno-0-1390"></a>
</span><span id="__span-0-1391"><a id="__codelineno-0-1391" name="__codelineno-0-1391" href="#__codelineno-0-1391"></a><span class="w">            </span><span class="k">IF</span><span class="p">(</span><span class="o">@</span><span class="n">currentTransactionLogSizeUsagePercent</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">@</span><span class="n">maxTransactionLogSizeUsagePercent</span><span class="p">)</span>
</span><span id="__span-0-1392"><a id="__codelineno-0-1392" name="__codelineno-0-1392" href="#__codelineno-0-1392"></a>
</span><span id="__span-0-1393"><a id="__codelineno-0-1393" name="__codelineno-0-1393" href="#__codelineno-0-1393"></a><span class="w">            </span><span class="k">BEGIN</span>
</span><span id="__span-0-1394"><a id="__codelineno-0-1394" name="__codelineno-0-1394" href="#__codelineno-0-1394"></a>
</span><span id="__span-0-1395"><a id="__codelineno-0-1395" name="__codelineno-0-1395" href="#__codelineno-0-1395"></a><span class="w">                </span><span class="c1">-- Процент занятого места в файлах лога транзакций превышает указанный порог</span>
</span><span id="__span-0-1396"><a id="__codelineno-0-1396" name="__codelineno-0-1396" href="#__codelineno-0-1396"></a>
</span><span id="__span-0-1397"><a id="__codelineno-0-1397" name="__codelineno-0-1397" href="#__codelineno-0-1397"></a><span class="w">                </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-1398"><a id="__codelineno-0-1398" name="__codelineno-0-1398" href="#__codelineno-0-1398"></a>
</span><span id="__span-0-1399"><a id="__codelineno-0-1399" name="__codelineno-0-1399" href="#__codelineno-0-1399"></a><span class="w">            </span><span class="k">END</span>
</span><span id="__span-0-1400"><a id="__codelineno-0-1400" name="__codelineno-0-1400" href="#__codelineno-0-1400"></a>
</span><span id="__span-0-1401"><a id="__codelineno-0-1401" name="__codelineno-0-1401" href="#__codelineno-0-1401"></a><span class="w">            </span><span class="k">IF</span><span class="p">(</span><span class="o">@</span><span class="n">maxTransactionLogSizeMB</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">@</span><span class="n">currentTransactionLogSizeMB</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">maxTransactionLogSizeMB</span><span class="p">)</span>
</span><span id="__span-0-1402"><a id="__codelineno-0-1402" name="__codelineno-0-1402" href="#__codelineno-0-1402"></a>
</span><span id="__span-0-1403"><a id="__codelineno-0-1403" name="__codelineno-0-1403" href="#__codelineno-0-1403"></a><span class="w">            </span><span class="k">BEGIN</span>
</span><span id="__span-0-1404"><a id="__codelineno-0-1404" name="__codelineno-0-1404" href="#__codelineno-0-1404"></a>
</span><span id="__span-0-1405"><a id="__codelineno-0-1405" name="__codelineno-0-1405" href="#__codelineno-0-1405"></a><span class="w">                </span><span class="c1">-- Размер занятого места в файлах лога транзакций превышает указанный порог в МБ</span>
</span><span id="__span-0-1406"><a id="__codelineno-0-1406" name="__codelineno-0-1406" href="#__codelineno-0-1406"></a>
</span><span id="__span-0-1407"><a id="__codelineno-0-1407" name="__codelineno-0-1407" href="#__codelineno-0-1407"></a><span class="w">                </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-1408"><a id="__codelineno-0-1408" name="__codelineno-0-1408" href="#__codelineno-0-1408"></a>
</span><span id="__span-0-1409"><a id="__codelineno-0-1409" name="__codelineno-0-1409" href="#__codelineno-0-1409"></a><span class="w">            </span><span class="k">END</span>
</span><span id="__span-0-1410"><a id="__codelineno-0-1410" name="__codelineno-0-1410" href="#__codelineno-0-1410"></a>
</span><span id="__span-0-1411"><a id="__codelineno-0-1411" name="__codelineno-0-1411" href="#__codelineno-0-1411"></a>
</span><span id="__span-0-1412"><a id="__codelineno-0-1412" name="__codelineno-0-1412" href="#__codelineno-0-1412"></a>
</span><span id="__span-0-1413"><a id="__codelineno-0-1413" name="__codelineno-0-1413" href="#__codelineno-0-1413"></a><span class="w">            </span><span class="k">BEGIN</span><span class="w"> </span><span class="n">TRY</span>
</span><span id="__span-0-1414"><a id="__codelineno-0-1414" name="__codelineno-0-1414" href="#__codelineno-0-1414"></a>
</span><span id="__span-0-1415"><a id="__codelineno-0-1415" name="__codelineno-0-1415" href="#__codelineno-0-1415"></a><span class="w">                </span><span class="c1">-- Сохраняем предварительную информацию об операции обслуживания без даты завершения                </span>
</span><span id="__span-0-1416"><a id="__codelineno-0-1416" name="__codelineno-0-1416" href="#__codelineno-0-1416"></a>
</span><span id="__span-0-1417"><a id="__codelineno-0-1417" name="__codelineno-0-1417" href="#__codelineno-0-1417"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="o">@</span><span class="n">useMonitoringDatabase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-0-1418"><a id="__codelineno-0-1418" name="__codelineno-0-1418" href="#__codelineno-0-1418"></a>
</span><span id="__span-0-1419"><a id="__codelineno-0-1419" name="__codelineno-0-1419" href="#__codelineno-0-1419"></a><span class="w">                </span><span class="k">BEGIN</span>
</span><span id="__span-0-1420"><a id="__codelineno-0-1420" name="__codelineno-0-1420" href="#__codelineno-0-1420"></a>
</span><span id="__span-0-1421"><a id="__codelineno-0-1421" name="__codelineno-0-1421" href="#__codelineno-0-1421"></a><span class="w">                    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">StartDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">();</span>
</span><span id="__span-0-1422"><a id="__codelineno-0-1422" name="__codelineno-0-1422" href="#__codelineno-0-1422"></a>
</span><span id="__span-0-1423"><a id="__codelineno-0-1423" name="__codelineno-0-1423" href="#__codelineno-0-1423"></a><span class="w">                    </span><span class="k">EXECUTE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_add_maintenance_action_log</span><span class="p">]</span>
</span><span id="__span-0-1424"><a id="__codelineno-0-1424" name="__codelineno-0-1424" href="#__codelineno-0-1424"></a>
</span><span id="__span-0-1425"><a id="__codelineno-0-1425" name="__codelineno-0-1425" href="#__codelineno-0-1425"></a><span class="w">                        </span><span class="o">@</span><span class="n">objectNameResumeRebuildForIndex</span><span class="p">,</span>
</span><span id="__span-0-1426"><a id="__codelineno-0-1426" name="__codelineno-0-1426" href="#__codelineno-0-1426"></a>
</span><span id="__span-0-1427"><a id="__codelineno-0-1427" name="__codelineno-0-1427" href="#__codelineno-0-1427"></a><span class="w">                        </span><span class="o">@</span><span class="n">indexNameResumeRebuildForIndex</span><span class="p">,</span>
</span><span id="__span-0-1428"><a id="__codelineno-0-1428" name="__codelineno-0-1428" href="#__codelineno-0-1428"></a>
</span><span id="__span-0-1429"><a id="__codelineno-0-1429" name="__codelineno-0-1429" href="#__codelineno-0-1429"></a><span class="w">                        </span><span class="s1">'REBUILD INDEX RESUME'</span><span class="p">,</span>
</span><span id="__span-0-1430"><a id="__codelineno-0-1430" name="__codelineno-0-1430" href="#__codelineno-0-1430"></a>
</span><span id="__span-0-1431"><a id="__codelineno-0-1431" name="__codelineno-0-1431" href="#__codelineno-0-1431"></a><span class="w">                        </span><span class="o">@</span><span class="n">RunDate</span><span class="p">,</span>
</span><span id="__span-0-1432"><a id="__codelineno-0-1432" name="__codelineno-0-1432" href="#__codelineno-0-1432"></a>
</span><span id="__span-0-1433"><a id="__codelineno-0-1433" name="__codelineno-0-1433" href="#__codelineno-0-1433"></a><span class="w">                        </span><span class="o">@</span><span class="n">StartDate</span><span class="p">,</span>
</span><span id="__span-0-1434"><a id="__codelineno-0-1434" name="__codelineno-0-1434" href="#__codelineno-0-1434"></a>
</span><span id="__span-0-1435"><a id="__codelineno-0-1435" name="__codelineno-0-1435" href="#__codelineno-0-1435"></a><span class="w">                        </span><span class="k">null</span><span class="p">,</span>
</span><span id="__span-0-1436"><a id="__codelineno-0-1436" name="__codelineno-0-1436" href="#__codelineno-0-1436"></a>
</span><span id="__span-0-1437"><a id="__codelineno-0-1437" name="__codelineno-0-1437" href="#__codelineno-0-1437"></a><span class="w">                        </span><span class="o">@</span><span class="n">databaseName</span><span class="p">,</span>
</span><span id="__span-0-1438"><a id="__codelineno-0-1438" name="__codelineno-0-1438" href="#__codelineno-0-1438"></a>
</span><span id="__span-0-1439"><a id="__codelineno-0-1439" name="__codelineno-0-1439" href="#__codelineno-0-1439"></a><span class="w">                        </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="c1">-- @UseOnlineRebuild</span>
</span><span id="__span-0-1440"><a id="__codelineno-0-1440" name="__codelineno-0-1440" href="#__codelineno-0-1440"></a>
</span><span id="__span-0-1441"><a id="__codelineno-0-1441" name="__codelineno-0-1441" href="#__codelineno-0-1441"></a><span class="w">                        </span><span class="s1">''</span><span class="p">,</span>
</span><span id="__span-0-1442"><a id="__codelineno-0-1442" name="__codelineno-0-1442" href="#__codelineno-0-1442"></a>
</span><span id="__span-0-1443"><a id="__codelineno-0-1443" name="__codelineno-0-1443" href="#__codelineno-0-1443"></a><span class="w">                        </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="c1">-- @AvgFragmentationPercent</span>
</span><span id="__span-0-1444"><a id="__codelineno-0-1444" name="__codelineno-0-1444" href="#__codelineno-0-1444"></a>
</span><span id="__span-0-1445"><a id="__codelineno-0-1445" name="__codelineno-0-1445" href="#__codelineno-0-1445"></a><span class="w">                        </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="c1">-- @RowModCtr</span>
</span><span id="__span-0-1446"><a id="__codelineno-0-1446" name="__codelineno-0-1446" href="#__codelineno-0-1446"></a>
</span><span id="__span-0-1447"><a id="__codelineno-0-1447" name="__codelineno-0-1447" href="#__codelineno-0-1447"></a><span class="w">                        </span><span class="o">@</span><span class="n">cmdResumeRebuildForIndex</span><span class="p">,</span>
</span><span id="__span-0-1448"><a id="__codelineno-0-1448" name="__codelineno-0-1448" href="#__codelineno-0-1448"></a>
</span><span id="__span-0-1449"><a id="__codelineno-0-1449" name="__codelineno-0-1449" href="#__codelineno-0-1449"></a><span class="w">                        </span><span class="o">@</span><span class="n">MaintenanceActionLogId</span><span class="w"> </span><span class="k">OUTPUT</span><span class="p">;</span>
</span><span id="__span-0-1450"><a id="__codelineno-0-1450" name="__codelineno-0-1450" href="#__codelineno-0-1450"></a>
</span><span id="__span-0-1451"><a id="__codelineno-0-1451" name="__codelineno-0-1451" href="#__codelineno-0-1451"></a><span class="w">                </span><span class="k">END</span>
</span><span id="__span-0-1452"><a id="__codelineno-0-1452" name="__codelineno-0-1452" href="#__codelineno-0-1452"></a>
</span><span id="__span-0-1453"><a id="__codelineno-0-1453" name="__codelineno-0-1453" href="#__codelineno-0-1453"></a>
</span><span id="__span-0-1454"><a id="__codelineno-0-1454" name="__codelineno-0-1454" href="#__codelineno-0-1454"></a>
</span><span id="__span-0-1455"><a id="__codelineno-0-1455" name="__codelineno-0-1455" href="#__codelineno-0-1455"></a><span class="w">                </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">cmdResumeRebuildForIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'</span>
</span><span id="__span-0-1456"><a id="__codelineno-0-1456" name="__codelineno-0-1456" href="#__codelineno-0-1456"></a>
</span><span id="__span-0-1457"><a id="__codelineno-0-1457" name="__codelineno-0-1457" href="#__codelineno-0-1457"></a><span class="s1">                    USE ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">']</span>
</span><span id="__span-0-1458"><a id="__codelineno-0-1458" name="__codelineno-0-1458" href="#__codelineno-0-1458"></a>
</span><span id="__span-0-1459"><a id="__codelineno-0-1459" name="__codelineno-0-1459" href="#__codelineno-0-1459"></a><span class="s1">                    SET NOCOUNT ON;</span>
</span><span id="__span-0-1460"><a id="__codelineno-0-1460" name="__codelineno-0-1460" href="#__codelineno-0-1460"></a>
</span><span id="__span-0-1461"><a id="__codelineno-0-1461" name="__codelineno-0-1461" href="#__codelineno-0-1461"></a><span class="s1">                    '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">cmdResumeRebuildForIndex</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'</span>
</span><span id="__span-0-1462"><a id="__codelineno-0-1462" name="__codelineno-0-1462" href="#__codelineno-0-1462"></a>
</span><span id="__span-0-1463"><a id="__codelineno-0-1463" name="__codelineno-0-1463" href="#__codelineno-0-1463"></a><span class="s1">                '</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">));</span>
</span><span id="__span-0-1464"><a id="__codelineno-0-1464" name="__codelineno-0-1464" href="#__codelineno-0-1464"></a>
</span><span id="__span-0-1465"><a id="__codelineno-0-1465" name="__codelineno-0-1465" href="#__codelineno-0-1465"></a><span class="w">                </span><span class="k">EXECUTE</span><span class="w"> </span><span class="n">sp_executesql</span><span class="w"> </span><span class="o">@</span><span class="n">cmdResumeRebuildForIndex</span><span class="p">;</span>
</span><span id="__span-0-1466"><a id="__codelineno-0-1466" name="__codelineno-0-1466" href="#__codelineno-0-1466"></a>
</span><span id="__span-0-1467"><a id="__codelineno-0-1467" name="__codelineno-0-1467" href="#__codelineno-0-1467"></a><span class="w">                </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">FinishDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetDate</span><span class="p">();</span>
</span><span id="__span-0-1468"><a id="__codelineno-0-1468" name="__codelineno-0-1468" href="#__codelineno-0-1468"></a>
</span><span id="__span-0-1469"><a id="__codelineno-0-1469" name="__codelineno-0-1469" href="#__codelineno-0-1469"></a>
</span><span id="__span-0-1470"><a id="__codelineno-0-1470" name="__codelineno-0-1470" href="#__codelineno-0-1470"></a>
</span><span id="__span-0-1471"><a id="__codelineno-0-1471" name="__codelineno-0-1471" href="#__codelineno-0-1471"></a><span class="w">                </span><span class="c1">-- Устанавливаем фактическую дату завершения операции</span>
</span><span id="__span-0-1472"><a id="__codelineno-0-1472" name="__codelineno-0-1472" href="#__codelineno-0-1472"></a>
</span><span id="__span-0-1473"><a id="__codelineno-0-1473" name="__codelineno-0-1473" href="#__codelineno-0-1473"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="o">@</span><span class="n">useMonitoringDatabase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-0-1474"><a id="__codelineno-0-1474" name="__codelineno-0-1474" href="#__codelineno-0-1474"></a>
</span><span id="__span-0-1475"><a id="__codelineno-0-1475" name="__codelineno-0-1475" href="#__codelineno-0-1475"></a><span class="w">                </span><span class="k">BEGIN</span>
</span><span id="__span-0-1476"><a id="__codelineno-0-1476" name="__codelineno-0-1476" href="#__codelineno-0-1476"></a>
</span><span id="__span-0-1477"><a id="__codelineno-0-1477" name="__codelineno-0-1477" href="#__codelineno-0-1477"></a><span class="w">                    </span><span class="k">EXECUTE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_set_maintenance_action_log_finish_date</span><span class="p">]</span>
</span><span id="__span-0-1478"><a id="__codelineno-0-1478" name="__codelineno-0-1478" href="#__codelineno-0-1478"></a>
</span><span id="__span-0-1479"><a id="__codelineno-0-1479" name="__codelineno-0-1479" href="#__codelineno-0-1479"></a><span class="w">                        </span><span class="o">@</span><span class="n">MaintenanceActionLogId</span><span class="p">,</span>
</span><span id="__span-0-1480"><a id="__codelineno-0-1480" name="__codelineno-0-1480" href="#__codelineno-0-1480"></a>
</span><span id="__span-0-1481"><a id="__codelineno-0-1481" name="__codelineno-0-1481" href="#__codelineno-0-1481"></a><span class="w">                        </span><span class="o">@</span><span class="n">FinishDate</span><span class="p">;</span>
</span><span id="__span-0-1482"><a id="__codelineno-0-1482" name="__codelineno-0-1482" href="#__codelineno-0-1482"></a>
</span><span id="__span-0-1483"><a id="__codelineno-0-1483" name="__codelineno-0-1483" href="#__codelineno-0-1483"></a><span class="w">                </span><span class="k">END</span><span class="w">             </span>
</span><span id="__span-0-1484"><a id="__codelineno-0-1484" name="__codelineno-0-1484" href="#__codelineno-0-1484"></a>
</span><span id="__span-0-1485"><a id="__codelineno-0-1485" name="__codelineno-0-1485" href="#__codelineno-0-1485"></a><span class="w">            </span><span class="k">END</span><span class="w"> </span><span class="n">TRY</span>
</span><span id="__span-0-1486"><a id="__codelineno-0-1486" name="__codelineno-0-1486" href="#__codelineno-0-1486"></a>
</span><span id="__span-0-1487"><a id="__codelineno-0-1487" name="__codelineno-0-1487" href="#__codelineno-0-1487"></a><span class="w">            </span><span class="k">BEGIN</span><span class="w"> </span><span class="n">CATCH</span><span class="w">     </span>
</span><span id="__span-0-1488"><a id="__codelineno-0-1488" name="__codelineno-0-1488" href="#__codelineno-0-1488"></a>
</span><span id="__span-0-1489"><a id="__codelineno-0-1489" name="__codelineno-0-1489" href="#__codelineno-0-1489"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="o">@</span><span class="n">MaintenanceActionLogId</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-0-1490"><a id="__codelineno-0-1490" name="__codelineno-0-1490" href="#__codelineno-0-1490"></a>
</span><span id="__span-0-1491"><a id="__codelineno-0-1491" name="__codelineno-0-1491" href="#__codelineno-0-1491"></a><span class="w">                </span><span class="k">BEGIN</span>
</span><span id="__span-0-1492"><a id="__codelineno-0-1492" name="__codelineno-0-1492" href="#__codelineno-0-1492"></a>
</span><span id="__span-0-1493"><a id="__codelineno-0-1493" name="__codelineno-0-1493" href="#__codelineno-0-1493"></a><span class="w">                    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Error: '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">Error_message</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">', Code: '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">Error_Number</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">', Line: '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">Error_Line</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span>
</span><span id="__span-0-1494"><a id="__codelineno-0-1494" name="__codelineno-0-1494" href="#__codelineno-0-1494"></a>
</span><span id="__span-0-1495"><a id="__codelineno-0-1495" name="__codelineno-0-1495" href="#__codelineno-0-1495"></a><span class="w">                    </span><span class="c1">-- Устанавливаем текст ошибки при обслуживании индекса</span>
</span><span id="__span-0-1496"><a id="__codelineno-0-1496" name="__codelineno-0-1496" href="#__codelineno-0-1496"></a>
</span><span id="__span-0-1497"><a id="__codelineno-0-1497" name="__codelineno-0-1497" href="#__codelineno-0-1497"></a><span class="w">                    </span><span class="c1">-- Дата завершения при этом остается незаполненной</span>
</span><span id="__span-0-1498"><a id="__codelineno-0-1498" name="__codelineno-0-1498" href="#__codelineno-0-1498"></a>
</span><span id="__span-0-1499"><a id="__codelineno-0-1499" name="__codelineno-0-1499" href="#__codelineno-0-1499"></a><span class="w">                    </span><span class="k">EXECUTE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_set_maintenance_action_log_finish_date</span><span class="p">]</span>
</span><span id="__span-0-1500"><a id="__codelineno-0-1500" name="__codelineno-0-1500" href="#__codelineno-0-1500"></a>
</span><span id="__span-0-1501"><a id="__codelineno-0-1501" name="__codelineno-0-1501" href="#__codelineno-0-1501"></a><span class="w">                        </span><span class="o">@</span><span class="n">MaintenanceActionLogId</span><span class="p">,</span>
</span><span id="__span-0-1502"><a id="__codelineno-0-1502" name="__codelineno-0-1502" href="#__codelineno-0-1502"></a>
</span><span id="__span-0-1503"><a id="__codelineno-0-1503" name="__codelineno-0-1503" href="#__codelineno-0-1503"></a><span class="w">                        </span><span class="o">@</span><span class="n">FinishDate</span><span class="p">,</span>
</span><span id="__span-0-1504"><a id="__codelineno-0-1504" name="__codelineno-0-1504" href="#__codelineno-0-1504"></a>
</span><span id="__span-0-1505"><a id="__codelineno-0-1505" name="__codelineno-0-1505" href="#__codelineno-0-1505"></a><span class="w">                        </span><span class="o">@</span><span class="n">msg</span><span class="p">;</span><span class="w">          </span>
</span><span id="__span-0-1506"><a id="__codelineno-0-1506" name="__codelineno-0-1506" href="#__codelineno-0-1506"></a>
</span><span id="__span-0-1507"><a id="__codelineno-0-1507" name="__codelineno-0-1507" href="#__codelineno-0-1507"></a><span class="w">                </span><span class="k">END</span>
</span><span id="__span-0-1508"><a id="__codelineno-0-1508" name="__codelineno-0-1508" href="#__codelineno-0-1508"></a>
</span><span id="__span-0-1509"><a id="__codelineno-0-1509" name="__codelineno-0-1509" href="#__codelineno-0-1509"></a><span class="w">            </span><span class="k">END</span><span class="w"> </span><span class="n">CATCH</span>
</span><span id="__span-0-1510"><a id="__codelineno-0-1510" name="__codelineno-0-1510" href="#__codelineno-0-1510"></a>
</span><span id="__span-0-1511"><a id="__codelineno-0-1511" name="__codelineno-0-1511" href="#__codelineno-0-1511"></a>
</span><span id="__span-0-1512"><a id="__codelineno-0-1512" name="__codelineno-0-1512" href="#__codelineno-0-1512"></a>
</span><span id="__span-0-1513"><a id="__codelineno-0-1513" name="__codelineno-0-1513" href="#__codelineno-0-1513"></a><span class="w">            </span><span class="k">FETCH</span><span class="w"> </span><span class="k">NEXT</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">resumableIndexRebuild_cursor</span><span class="w"> </span>
</span><span id="__span-0-1514"><a id="__codelineno-0-1514" name="__codelineno-0-1514" href="#__codelineno-0-1514"></a>
</span><span id="__span-0-1515"><a id="__codelineno-0-1515" name="__codelineno-0-1515" href="#__codelineno-0-1515"></a><span class="w">            </span><span class="k">INTO</span><span class="w"> </span><span class="o">@</span><span class="n">objectNameResumeRebuildForIndex</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">indexNameResumeRebuildForIndex</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">cmdResumeRebuildForIndex</span><span class="p">;</span>
</span><span id="__span-0-1516"><a id="__codelineno-0-1516" name="__codelineno-0-1516" href="#__codelineno-0-1516"></a>
</span><span id="__span-0-1517"><a id="__codelineno-0-1517" name="__codelineno-0-1517" href="#__codelineno-0-1517"></a><span class="w">        </span><span class="k">END</span>
</span><span id="__span-0-1518"><a id="__codelineno-0-1518" name="__codelineno-0-1518" href="#__codelineno-0-1518"></a>
</span><span id="__span-0-1519"><a id="__codelineno-0-1519" name="__codelineno-0-1519" href="#__codelineno-0-1519"></a><span class="w">        </span><span class="k">CLOSE</span><span class="w"> </span><span class="n">resumableIndexRebuild_cursor</span><span class="p">;</span><span class="w">  </span>
</span><span id="__span-0-1520"><a id="__codelineno-0-1520" name="__codelineno-0-1520" href="#__codelineno-0-1520"></a>
</span><span id="__span-0-1521"><a id="__codelineno-0-1521" name="__codelineno-0-1521" href="#__codelineno-0-1521"></a><span class="w">        </span><span class="k">DEALLOCATE</span><span class="w"> </span><span class="n">resumableIndexRebuild_cursor</span><span class="p">;</span>
</span><span id="__span-0-1522"><a id="__codelineno-0-1522" name="__codelineno-0-1522" href="#__codelineno-0-1522"></a>
</span><span id="__span-0-1523"><a id="__codelineno-0-1523" name="__codelineno-0-1523" href="#__codelineno-0-1523"></a><span class="w">    </span><span class="k">END</span>
</span><span id="__span-0-1524"><a id="__codelineno-0-1524" name="__codelineno-0-1524" href="#__codelineno-0-1524"></a>
</span><span id="__span-0-1525"><a id="__codelineno-0-1525" name="__codelineno-0-1525" href="#__codelineno-0-1525"></a><span class="w">    </span><span class="c1">-- Сохраняем список индексов, для которых имеются ожидающие операции перестроения</span>
</span><span id="__span-0-1526"><a id="__codelineno-0-1526" name="__codelineno-0-1526" href="#__codelineno-0-1526"></a>
</span><span id="__span-0-1527"><a id="__codelineno-0-1527" name="__codelineno-0-1527" href="#__codelineno-0-1527"></a><span class="w">    </span><span class="c1">-- Они будут исключены из основного обслуживания</span>
</span><span id="__span-0-1528"><a id="__codelineno-0-1528" name="__codelineno-0-1528" href="#__codelineno-0-1528"></a>
</span><span id="__span-0-1529"><a id="__codelineno-0-1529" name="__codelineno-0-1529" href="#__codelineno-0-1529"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">excludeIndexes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span>
</span><span id="__span-0-1530"><a id="__codelineno-0-1530" name="__codelineno-0-1530" href="#__codelineno-0-1530"></a>
</span><span id="__span-0-1531"><a id="__codelineno-0-1531" name="__codelineno-0-1531" href="#__codelineno-0-1531"></a><span class="w">        </span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span id="__span-0-1532"><a id="__codelineno-0-1532" name="__codelineno-0-1532" href="#__codelineno-0-1532"></a>
</span><span id="__span-0-1533"><a id="__codelineno-0-1533" name="__codelineno-0-1533" href="#__codelineno-0-1533"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">LOCAL_ResumableIndexRebuilds</span>
</span><span id="__span-0-1534"><a id="__codelineno-0-1534" name="__codelineno-0-1534" href="#__codelineno-0-1534"></a>
</span><span id="__span-0-1535"><a id="__codelineno-0-1535" name="__codelineno-0-1535" href="#__codelineno-0-1535"></a><span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="n">XML</span><span class="w"> </span><span class="n">RAW</span><span class="p">,</span><span class="w"> </span><span class="n">ROOT</span><span class="p">(</span><span class="s1">'root'</span><span class="p">));</span>
</span><span id="__span-0-1536"><a id="__codelineno-0-1536" name="__codelineno-0-1536" href="#__codelineno-0-1536"></a>
</span><span id="__span-0-1537"><a id="__codelineno-0-1537" name="__codelineno-0-1537" href="#__codelineno-0-1537"></a>
</span><span id="__span-0-1538"><a id="__codelineno-0-1538" name="__codelineno-0-1538" href="#__codelineno-0-1538"></a>
</span><span id="__span-0-1539"><a id="__codelineno-0-1539" name="__codelineno-0-1539" href="#__codelineno-0-1539"></a><span class="w">    </span><span class="c1">--PRINT 'Прервано для отладки'</span>
</span><span id="__span-0-1540"><a id="__codelineno-0-1540" name="__codelineno-0-1540" href="#__codelineno-0-1540"></a>
</span><span id="__span-0-1541"><a id="__codelineno-0-1541" name="__codelineno-0-1541" href="#__codelineno-0-1541"></a><span class="w">    </span><span class="c1">--RETURN 0;</span>
</span><span id="__span-0-1542"><a id="__codelineno-0-1542" name="__codelineno-0-1542" href="#__codelineno-0-1542"></a>
</span><span id="__span-0-1543"><a id="__codelineno-0-1543" name="__codelineno-0-1543" href="#__codelineno-0-1543"></a>
</span><span id="__span-0-1544"><a id="__codelineno-0-1544" name="__codelineno-0-1544" href="#__codelineno-0-1544"></a>
</span><span id="__span-0-1545"><a id="__codelineno-0-1545" name="__codelineno-0-1545" href="#__codelineno-0-1545"></a><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
</span><span id="__span-0-1546"><a id="__codelineno-0-1546" name="__codelineno-0-1546" href="#__codelineno-0-1546"></a>
</span><span id="__span-0-1547"><a id="__codelineno-0-1547" name="__codelineno-0-1547" href="#__codelineno-0-1547"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-0-1548"><a id="__codelineno-0-1548" name="__codelineno-0-1548" href="#__codelineno-0-1548"></a>
</span><span id="__span-0-1549"><a id="__codelineno-0-1549" name="__codelineno-0-1549" href="#__codelineno-0-1549"></a><span class="k">CAST</span><span class="p">(</span><span class="s1">'USE ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">databasename</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">']</span>
</span><span id="__span-0-1550"><a id="__codelineno-0-1550" name="__codelineno-0-1550" href="#__codelineno-0-1550"></a>
</span><span id="__span-0-1551"><a id="__codelineno-0-1551" name="__codelineno-0-1551" href="#__codelineno-0-1551"></a><span class="s1">SET NOCOUNT ON;</span>
</span><span id="__span-0-1552"><a id="__codelineno-0-1552" name="__codelineno-0-1552" href="#__codelineno-0-1552"></a>
</span><span id="__span-0-1553"><a id="__codelineno-0-1553" name="__codelineno-0-1553" href="#__codelineno-0-1553"></a><span class="s1">DECLARE</span>
</span><span id="__span-0-1554"><a id="__codelineno-0-1554" name="__codelineno-0-1554" href="#__codelineno-0-1554"></a>
</span><span id="__span-0-1555"><a id="__codelineno-0-1555" name="__codelineno-0-1555" href="#__codelineno-0-1555"></a><span class="s1">    -- Текущее время</span>
</span><span id="__span-0-1556"><a id="__codelineno-0-1556" name="__codelineno-0-1556" href="#__codelineno-0-1556"></a>
</span><span id="__span-0-1557"><a id="__codelineno-0-1557" name="__codelineno-0-1557" href="#__codelineno-0-1557"></a><span class="s1">    @timeNow TIME = CAST(GETDATE() AS TIME),</span>
</span><span id="__span-0-1558"><a id="__codelineno-0-1558" name="__codelineno-0-1558" href="#__codelineno-0-1558"></a>
</span><span id="__span-0-1559"><a id="__codelineno-0-1559" name="__codelineno-0-1559" href="#__codelineno-0-1559"></a><span class="s1">    -- Текущий процент использования файла лога транзакций</span>
</span><span id="__span-0-1560"><a id="__codelineno-0-1560" name="__codelineno-0-1560" href="#__codelineno-0-1560"></a>
</span><span id="__span-0-1561"><a id="__codelineno-0-1561" name="__codelineno-0-1561" href="#__codelineno-0-1561"></a><span class="s1">    @currentTransactionLogSizeUsagePercent int,</span>
</span><span id="__span-0-1562"><a id="__codelineno-0-1562" name="__codelineno-0-1562" href="#__codelineno-0-1562"></a>
</span><span id="__span-0-1563"><a id="__codelineno-0-1563" name="__codelineno-0-1563" href="#__codelineno-0-1563"></a><span class="s1">    @currentTransactionLogSizeMB bigint;</span>
</span><span id="__span-0-1564"><a id="__codelineno-0-1564" name="__codelineno-0-1564" href="#__codelineno-0-1564"></a>
</span><span id="__span-0-1565"><a id="__codelineno-0-1565" name="__codelineno-0-1565" href="#__codelineno-0-1565"></a>
</span><span id="__span-0-1566"><a id="__codelineno-0-1566" name="__codelineno-0-1566" href="#__codelineno-0-1566"></a>
</span><span id="__span-0-1567"><a id="__codelineno-0-1567" name="__codelineno-0-1567" href="#__codelineno-0-1567"></a><span class="s1">-- Проверка доступен ли запуск обслуживания в текущее время</span>
</span><span id="__span-0-1568"><a id="__codelineno-0-1568" name="__codelineno-0-1568" href="#__codelineno-0-1568"></a>
</span><span id="__span-0-1569"><a id="__codelineno-0-1569" name="__codelineno-0-1569" href="#__codelineno-0-1569"></a><span class="s1">IF (@timeTo &gt;= @timeFrom) BEGIN</span>
</span><span id="__span-0-1570"><a id="__codelineno-0-1570" name="__codelineno-0-1570" href="#__codelineno-0-1570"></a>
</span><span id="__span-0-1571"><a id="__codelineno-0-1571" name="__codelineno-0-1571" href="#__codelineno-0-1571"></a><span class="s1">    IF(NOT (@timeFrom &lt;= @timeNow AND @timeTo &gt;= @timeNow))</span>
</span><span id="__span-0-1572"><a id="__codelineno-0-1572" name="__codelineno-0-1572" href="#__codelineno-0-1572"></a>
</span><span id="__span-0-1573"><a id="__codelineno-0-1573" name="__codelineno-0-1573" href="#__codelineno-0-1573"></a><span class="s1">        RETURN;</span>
</span><span id="__span-0-1574"><a id="__codelineno-0-1574" name="__codelineno-0-1574" href="#__codelineno-0-1574"></a>
</span><span id="__span-0-1575"><a id="__codelineno-0-1575" name="__codelineno-0-1575" href="#__codelineno-0-1575"></a><span class="s1">    END ELSE BEGIN</span>
</span><span id="__span-0-1576"><a id="__codelineno-0-1576" name="__codelineno-0-1576" href="#__codelineno-0-1576"></a>
</span><span id="__span-0-1577"><a id="__codelineno-0-1577" name="__codelineno-0-1577" href="#__codelineno-0-1577"></a><span class="s1">        IF(NOT ((@timeFrom &lt;= @timeNow AND ''23:59:59'' &gt;= @timeNow)</span>
</span><span id="__span-0-1578"><a id="__codelineno-0-1578" name="__codelineno-0-1578" href="#__codelineno-0-1578"></a>
</span><span id="__span-0-1579"><a id="__codelineno-0-1579" name="__codelineno-0-1579" href="#__codelineno-0-1579"></a><span class="s1">            OR (@timeTo &gt;= @timeNow AND ''00:00:00'' &lt;= @timeNow))) </span>
</span><span id="__span-0-1580"><a id="__codelineno-0-1580" name="__codelineno-0-1580" href="#__codelineno-0-1580"></a>
</span><span id="__span-0-1581"><a id="__codelineno-0-1581" name="__codelineno-0-1581" href="#__codelineno-0-1581"></a><span class="s1">                RETURN;</span>
</span><span id="__span-0-1582"><a id="__codelineno-0-1582" name="__codelineno-0-1582" href="#__codelineno-0-1582"></a>
</span><span id="__span-0-1583"><a id="__codelineno-0-1583" name="__codelineno-0-1583" href="#__codelineno-0-1583"></a><span class="s1">END</span>
</span><span id="__span-0-1584"><a id="__codelineno-0-1584" name="__codelineno-0-1584" href="#__codelineno-0-1584"></a>
</span><span id="__span-0-1585"><a id="__codelineno-0-1585" name="__codelineno-0-1585" href="#__codelineno-0-1585"></a>
</span><span id="__span-0-1586"><a id="__codelineno-0-1586" name="__codelineno-0-1586" href="#__codelineno-0-1586"></a>
</span><span id="__span-0-1587"><a id="__codelineno-0-1587" name="__codelineno-0-1587" href="#__codelineno-0-1587"></a><span class="s1">-- Служебные переменные</span>
</span><span id="__span-0-1588"><a id="__codelineno-0-1588" name="__codelineno-0-1588" href="#__codelineno-0-1588"></a>
</span><span id="__span-0-1589"><a id="__codelineno-0-1589" name="__codelineno-0-1589" href="#__codelineno-0-1589"></a><span class="s1">DECLARE</span>
</span><span id="__span-0-1590"><a id="__codelineno-0-1590" name="__codelineno-0-1590" href="#__codelineno-0-1590"></a>
</span><span id="__span-0-1591"><a id="__codelineno-0-1591" name="__codelineno-0-1591" href="#__codelineno-0-1591"></a><span class="s1">    @DBID SMALLINT = DB_ID()</span>
</span><span id="__span-0-1592"><a id="__codelineno-0-1592" name="__codelineno-0-1592" href="#__codelineno-0-1592"></a>
</span><span id="__span-0-1593"><a id="__codelineno-0-1593" name="__codelineno-0-1593" href="#__codelineno-0-1593"></a><span class="s1">    ,@DBNAME sysname = DB_NAME()</span>
</span><span id="__span-0-1594"><a id="__codelineno-0-1594" name="__codelineno-0-1594" href="#__codelineno-0-1594"></a>
</span><span id="__span-0-1595"><a id="__codelineno-0-1595" name="__codelineno-0-1595" href="#__codelineno-0-1595"></a><span class="s1">    ,@SchemaName SYSNAME</span>
</span><span id="__span-0-1596"><a id="__codelineno-0-1596" name="__codelineno-0-1596" href="#__codelineno-0-1596"></a>
</span><span id="__span-0-1597"><a id="__codelineno-0-1597" name="__codelineno-0-1597" href="#__codelineno-0-1597"></a><span class="s1">    ,@ObjectName SYSNAME</span>
</span><span id="__span-0-1598"><a id="__codelineno-0-1598" name="__codelineno-0-1598" href="#__codelineno-0-1598"></a>
</span><span id="__span-0-1599"><a id="__codelineno-0-1599" name="__codelineno-0-1599" href="#__codelineno-0-1599"></a><span class="s1">    ,@ObjectID INT</span>
</span><span id="__span-0-1600"><a id="__codelineno-0-1600" name="__codelineno-0-1600" href="#__codelineno-0-1600"></a>
</span><span id="__span-0-1601"><a id="__codelineno-0-1601" name="__codelineno-0-1601" href="#__codelineno-0-1601"></a><span class="s1">    ,@Priority INT</span>
</span><span id="__span-0-1602"><a id="__codelineno-0-1602" name="__codelineno-0-1602" href="#__codelineno-0-1602"></a>
</span><span id="__span-0-1603"><a id="__codelineno-0-1603" name="__codelineno-0-1603" href="#__codelineno-0-1603"></a><span class="s1">    ,@IndexID INT</span>
</span><span id="__span-0-1604"><a id="__codelineno-0-1604" name="__codelineno-0-1604" href="#__codelineno-0-1604"></a>
</span><span id="__span-0-1605"><a id="__codelineno-0-1605" name="__codelineno-0-1605" href="#__codelineno-0-1605"></a><span class="s1">    ,@IndexName SYSNAME</span>
</span><span id="__span-0-1606"><a id="__codelineno-0-1606" name="__codelineno-0-1606" href="#__codelineno-0-1606"></a>
</span><span id="__span-0-1607"><a id="__codelineno-0-1607" name="__codelineno-0-1607" href="#__codelineno-0-1607"></a><span class="s1">    ,@PartitionNum BIGINT</span>
</span><span id="__span-0-1608"><a id="__codelineno-0-1608" name="__codelineno-0-1608" href="#__codelineno-0-1608"></a>
</span><span id="__span-0-1609"><a id="__codelineno-0-1609" name="__codelineno-0-1609" href="#__codelineno-0-1609"></a><span class="s1">    ,@PartitionCount BIGINT</span>
</span><span id="__span-0-1610"><a id="__codelineno-0-1610" name="__codelineno-0-1610" href="#__codelineno-0-1610"></a>
</span><span id="__span-0-1611"><a id="__codelineno-0-1611" name="__codelineno-0-1611" href="#__codelineno-0-1611"></a><span class="s1">    ,@frag FLOAT</span>
</span><span id="__span-0-1612"><a id="__codelineno-0-1612" name="__codelineno-0-1612" href="#__codelineno-0-1612"></a>
</span><span id="__span-0-1613"><a id="__codelineno-0-1613" name="__codelineno-0-1613" href="#__codelineno-0-1613"></a><span class="s1">    ,@Command NVARCHAR(max)</span>
</span><span id="__span-0-1614"><a id="__codelineno-0-1614" name="__codelineno-0-1614" href="#__codelineno-0-1614"></a>
</span><span id="__span-0-1615"><a id="__codelineno-0-1615" name="__codelineno-0-1615" href="#__codelineno-0-1615"></a><span class="s1">    ,@CommandSpecial NVARCHAR(max)</span>
</span><span id="__span-0-1616"><a id="__codelineno-0-1616" name="__codelineno-0-1616" href="#__codelineno-0-1616"></a>
</span><span id="__span-0-1617"><a id="__codelineno-0-1617" name="__codelineno-0-1617" href="#__codelineno-0-1617"></a><span class="s1">    ,@Operation NVARCHAR(128)</span>
</span><span id="__span-0-1618"><a id="__codelineno-0-1618" name="__codelineno-0-1618" href="#__codelineno-0-1618"></a>
</span><span id="__span-0-1619"><a id="__codelineno-0-1619" name="__codelineno-0-1619" href="#__codelineno-0-1619"></a><span class="s1">    ,@RowModCtr BIGINT</span>
</span><span id="__span-0-1620"><a id="__codelineno-0-1620" name="__codelineno-0-1620" href="#__codelineno-0-1620"></a>
</span><span id="__span-0-1621"><a id="__codelineno-0-1621" name="__codelineno-0-1621" href="#__codelineno-0-1621"></a><span class="s1">    ,@AvgFragmentationPercent float</span>
</span><span id="__span-0-1622"><a id="__codelineno-0-1622" name="__codelineno-0-1622" href="#__codelineno-0-1622"></a>
</span><span id="__span-0-1623"><a id="__codelineno-0-1623" name="__codelineno-0-1623" href="#__codelineno-0-1623"></a><span class="s1">    ,@PageCount BIGINT</span>
</span><span id="__span-0-1624"><a id="__codelineno-0-1624" name="__codelineno-0-1624" href="#__codelineno-0-1624"></a>
</span><span id="__span-0-1625"><a id="__codelineno-0-1625" name="__codelineno-0-1625" href="#__codelineno-0-1625"></a><span class="s1">    ,@SQL nvarchar(max)</span>
</span><span id="__span-0-1626"><a id="__codelineno-0-1626" name="__codelineno-0-1626" href="#__codelineno-0-1626"></a>
</span><span id="__span-0-1627"><a id="__codelineno-0-1627" name="__codelineno-0-1627" href="#__codelineno-0-1627"></a><span class="s1">    ,@SQLSpecial nvarchar(max)</span>
</span><span id="__span-0-1628"><a id="__codelineno-0-1628" name="__codelineno-0-1628" href="#__codelineno-0-1628"></a>
</span><span id="__span-0-1629"><a id="__codelineno-0-1629" name="__codelineno-0-1629" href="#__codelineno-0-1629"></a><span class="s1">    ,@OnlineRebuildSupport int</span>
</span><span id="__span-0-1630"><a id="__codelineno-0-1630" name="__codelineno-0-1630" href="#__codelineno-0-1630"></a>
</span><span id="__span-0-1631"><a id="__codelineno-0-1631" name="__codelineno-0-1631" href="#__codelineno-0-1631"></a><span class="s1">    ,@UseOnlineRebuild int</span>
</span><span id="__span-0-1632"><a id="__codelineno-0-1632" name="__codelineno-0-1632" href="#__codelineno-0-1632"></a>
</span><span id="__span-0-1633"><a id="__codelineno-0-1633" name="__codelineno-0-1633" href="#__codelineno-0-1633"></a><span class="s1">    ,@StartDate datetime</span>
</span><span id="__span-0-1634"><a id="__codelineno-0-1634" name="__codelineno-0-1634" href="#__codelineno-0-1634"></a>
</span><span id="__span-0-1635"><a id="__codelineno-0-1635" name="__codelineno-0-1635" href="#__codelineno-0-1635"></a><span class="s1">    ,@FinishDate datetime</span>
</span><span id="__span-0-1636"><a id="__codelineno-0-1636" name="__codelineno-0-1636" href="#__codelineno-0-1636"></a>
</span><span id="__span-0-1637"><a id="__codelineno-0-1637" name="__codelineno-0-1637" href="#__codelineno-0-1637"></a><span class="s1">    ,@RunDate datetime = GETDATE()</span>
</span><span id="__span-0-1638"><a id="__codelineno-0-1638" name="__codelineno-0-1638" href="#__codelineno-0-1638"></a>
</span><span id="__span-0-1639"><a id="__codelineno-0-1639" name="__codelineno-0-1639" href="#__codelineno-0-1639"></a><span class="s1">    ,@MaintenanceActionLogId bigint;</span>
</span><span id="__span-0-1640"><a id="__codelineno-0-1640" name="__codelineno-0-1640" href="#__codelineno-0-1640"></a>
</span><span id="__span-0-1641"><a id="__codelineno-0-1641" name="__codelineno-0-1641" href="#__codelineno-0-1641"></a>
</span><span id="__span-0-1642"><a id="__codelineno-0-1642" name="__codelineno-0-1642" href="#__codelineno-0-1642"></a>
</span><span id="__span-0-1643"><a id="__codelineno-0-1643" name="__codelineno-0-1643" href="#__codelineno-0-1643"></a><span class="s1">IF OBJECT_ID(''tempdb..#MaintenanceCommands'') IS NOT NULL</span>
</span><span id="__span-0-1644"><a id="__codelineno-0-1644" name="__codelineno-0-1644" href="#__codelineno-0-1644"></a>
</span><span id="__span-0-1645"><a id="__codelineno-0-1645" name="__codelineno-0-1645" href="#__codelineno-0-1645"></a><span class="s1">    DROP TABLE #MaintenanceCommands;</span>
</span><span id="__span-0-1646"><a id="__codelineno-0-1646" name="__codelineno-0-1646" href="#__codelineno-0-1646"></a>
</span><span id="__span-0-1647"><a id="__codelineno-0-1647" name="__codelineno-0-1647" href="#__codelineno-0-1647"></a><span class="s1">IF OBJECT_ID(''tempdb..#MaintenanceCommandsTemp'') IS NOT NULL</span>
</span><span id="__span-0-1648"><a id="__codelineno-0-1648" name="__codelineno-0-1648" href="#__codelineno-0-1648"></a>
</span><span id="__span-0-1649"><a id="__codelineno-0-1649" name="__codelineno-0-1649" href="#__codelineno-0-1649"></a><span class="s1">    DROP TABLE #MaintenanceCommandsTemp;</span>
</span><span id="__span-0-1650"><a id="__codelineno-0-1650" name="__codelineno-0-1650" href="#__codelineno-0-1650"></a>
</span><span id="__span-0-1651"><a id="__codelineno-0-1651" name="__codelineno-0-1651" href="#__codelineno-0-1651"></a>
</span><span id="__span-0-1652"><a id="__codelineno-0-1652" name="__codelineno-0-1652" href="#__codelineno-0-1652"></a>
</span><span id="__span-0-1653"><a id="__codelineno-0-1653" name="__codelineno-0-1653" href="#__codelineno-0-1653"></a><span class="s1">CREATE TABLE #MaintenanceCommands</span>
</span><span id="__span-0-1654"><a id="__codelineno-0-1654" name="__codelineno-0-1654" href="#__codelineno-0-1654"></a>
</span><span id="__span-0-1655"><a id="__codelineno-0-1655" name="__codelineno-0-1655" href="#__codelineno-0-1655"></a><span class="s1">(</span>
</span><span id="__span-0-1656"><a id="__codelineno-0-1656" name="__codelineno-0-1656" href="#__codelineno-0-1656"></a>
</span><span id="__span-0-1657"><a id="__codelineno-0-1657" name="__codelineno-0-1657" href="#__codelineno-0-1657"></a><span class="s1">    [Command] nvarchar(max),</span>
</span><span id="__span-0-1658"><a id="__codelineno-0-1658" name="__codelineno-0-1658" href="#__codelineno-0-1658"></a>
</span><span id="__span-0-1659"><a id="__codelineno-0-1659" name="__codelineno-0-1659" href="#__codelineno-0-1659"></a><span class="s1">    [CommandSpecial] nvarchar(max),</span>
</span><span id="__span-0-1660"><a id="__codelineno-0-1660" name="__codelineno-0-1660" href="#__codelineno-0-1660"></a>
</span><span id="__span-0-1661"><a id="__codelineno-0-1661" name="__codelineno-0-1661" href="#__codelineno-0-1661"></a><span class="s1">    [Table] nvarchar(250),</span>
</span><span id="__span-0-1662"><a id="__codelineno-0-1662" name="__codelineno-0-1662" href="#__codelineno-0-1662"></a>
</span><span id="__span-0-1663"><a id="__codelineno-0-1663" name="__codelineno-0-1663" href="#__codelineno-0-1663"></a><span class="s1">    [Object] nvarchar(250),</span>
</span><span id="__span-0-1664"><a id="__codelineno-0-1664" name="__codelineno-0-1664" href="#__codelineno-0-1664"></a>
</span><span id="__span-0-1665"><a id="__codelineno-0-1665" name="__codelineno-0-1665" href="#__codelineno-0-1665"></a><span class="s1">    [page_count] BIGINT,</span>
</span><span id="__span-0-1666"><a id="__codelineno-0-1666" name="__codelineno-0-1666" href="#__codelineno-0-1666"></a>
</span><span id="__span-0-1667"><a id="__codelineno-0-1667" name="__codelineno-0-1667" href="#__codelineno-0-1667"></a><span class="s1">    [Rowmodctr] BIGINT,</span>
</span><span id="__span-0-1668"><a id="__codelineno-0-1668" name="__codelineno-0-1668" href="#__codelineno-0-1668"></a>
</span><span id="__span-0-1669"><a id="__codelineno-0-1669" name="__codelineno-0-1669" href="#__codelineno-0-1669"></a><span class="s1">    [Avg_fragmentation_in_percent] INT,</span>
</span><span id="__span-0-1670"><a id="__codelineno-0-1670" name="__codelineno-0-1670" href="#__codelineno-0-1670"></a>
</span><span id="__span-0-1671"><a id="__codelineno-0-1671" name="__codelineno-0-1671" href="#__codelineno-0-1671"></a><span class="s1">    [Operation] nvarchar(max),</span>
</span><span id="__span-0-1672"><a id="__codelineno-0-1672" name="__codelineno-0-1672" href="#__codelineno-0-1672"></a>
</span><span id="__span-0-1673"><a id="__codelineno-0-1673" name="__codelineno-0-1673" href="#__codelineno-0-1673"></a><span class="s1">    [Priority] INT,</span>
</span><span id="__span-0-1674"><a id="__codelineno-0-1674" name="__codelineno-0-1674" href="#__codelineno-0-1674"></a>
</span><span id="__span-0-1675"><a id="__codelineno-0-1675" name="__codelineno-0-1675" href="#__codelineno-0-1675"></a><span class="s1">    [OnlineRebuildSupport] INT,</span>
</span><span id="__span-0-1676"><a id="__codelineno-0-1676" name="__codelineno-0-1676" href="#__codelineno-0-1676"></a>
</span><span id="__span-0-1677"><a id="__codelineno-0-1677" name="__codelineno-0-1677" href="#__codelineno-0-1677"></a><span class="s1">    [UseOnlineRebuild] INT,</span>
</span><span id="__span-0-1678"><a id="__codelineno-0-1678" name="__codelineno-0-1678" href="#__codelineno-0-1678"></a>
</span><span id="__span-0-1679"><a id="__codelineno-0-1679" name="__codelineno-0-1679" href="#__codelineno-0-1679"></a><span class="s1">    [PartitionCount] BIGINT</span>
</span><span id="__span-0-1680"><a id="__codelineno-0-1680" name="__codelineno-0-1680" href="#__codelineno-0-1680"></a>
</span><span id="__span-0-1681"><a id="__codelineno-0-1681" name="__codelineno-0-1681" href="#__codelineno-0-1681"></a><span class="s1">)</span>
</span><span id="__span-0-1682"><a id="__codelineno-0-1682" name="__codelineno-0-1682" href="#__codelineno-0-1682"></a>
</span><span id="__span-0-1683"><a id="__codelineno-0-1683" name="__codelineno-0-1683" href="#__codelineno-0-1683"></a>
</span><span id="__span-0-1684"><a id="__codelineno-0-1684" name="__codelineno-0-1684" href="#__codelineno-0-1684"></a>
</span><span id="__span-0-1685"><a id="__codelineno-0-1685" name="__codelineno-0-1685" href="#__codelineno-0-1685"></a><span class="s1">IF OBJECT_ID(''tempdb..#tranLogInfo'') IS NOT NULL</span>
</span><span id="__span-0-1686"><a id="__codelineno-0-1686" name="__codelineno-0-1686" href="#__codelineno-0-1686"></a>
</span><span id="__span-0-1687"><a id="__codelineno-0-1687" name="__codelineno-0-1687" href="#__codelineno-0-1687"></a><span class="s1">    DROP TABLE #tranLogInfo;</span>
</span><span id="__span-0-1688"><a id="__codelineno-0-1688" name="__codelineno-0-1688" href="#__codelineno-0-1688"></a>
</span><span id="__span-0-1689"><a id="__codelineno-0-1689" name="__codelineno-0-1689" href="#__codelineno-0-1689"></a><span class="s1">CREATE TABLE #tranLogInfo</span>
</span><span id="__span-0-1690"><a id="__codelineno-0-1690" name="__codelineno-0-1690" href="#__codelineno-0-1690"></a>
</span><span id="__span-0-1691"><a id="__codelineno-0-1691" name="__codelineno-0-1691" href="#__codelineno-0-1691"></a><span class="s1">(</span>
</span><span id="__span-0-1692"><a id="__codelineno-0-1692" name="__codelineno-0-1692" href="#__codelineno-0-1692"></a>
</span><span id="__span-0-1693"><a id="__codelineno-0-1693" name="__codelineno-0-1693" href="#__codelineno-0-1693"></a><span class="s1">    servername varchar(250) not null default @@servername,</span>
</span><span id="__span-0-1694"><a id="__codelineno-0-1694" name="__codelineno-0-1694" href="#__codelineno-0-1694"></a>
</span><span id="__span-0-1695"><a id="__codelineno-0-1695" name="__codelineno-0-1695" href="#__codelineno-0-1695"></a><span class="s1">    dbname varchar(250),</span>
</span><span id="__span-0-1696"><a id="__codelineno-0-1696" name="__codelineno-0-1696" href="#__codelineno-0-1696"></a>
</span><span id="__span-0-1697"><a id="__codelineno-0-1697" name="__codelineno-0-1697" href="#__codelineno-0-1697"></a><span class="s1">    logsize real,</span>
</span><span id="__span-0-1698"><a id="__codelineno-0-1698" name="__codelineno-0-1698" href="#__codelineno-0-1698"></a>
</span><span id="__span-0-1699"><a id="__codelineno-0-1699" name="__codelineno-0-1699" href="#__codelineno-0-1699"></a><span class="s1">    logspace real,</span>
</span><span id="__span-0-1700"><a id="__codelineno-0-1700" name="__codelineno-0-1700" href="#__codelineno-0-1700"></a>
</span><span id="__span-0-1701"><a id="__codelineno-0-1701" name="__codelineno-0-1701" href="#__codelineno-0-1701"></a><span class="s1">    stat int</span>
</span><span id="__span-0-1702"><a id="__codelineno-0-1702" name="__codelineno-0-1702" href="#__codelineno-0-1702"></a>
</span><span id="__span-0-1703"><a id="__codelineno-0-1703" name="__codelineno-0-1703" href="#__codelineno-0-1703"></a><span class="s1">)</span>
</span><span id="__span-0-1704"><a id="__codelineno-0-1704" name="__codelineno-0-1704" href="#__codelineno-0-1704"></a>
</span><span id="__span-0-1705"><a id="__codelineno-0-1705" name="__codelineno-0-1705" href="#__codelineno-0-1705"></a>
</span><span id="__span-0-1706"><a id="__codelineno-0-1706" name="__codelineno-0-1706" href="#__codelineno-0-1706"></a>
</span><span id="__span-0-1707"><a id="__codelineno-0-1707" name="__codelineno-0-1707" href="#__codelineno-0-1707"></a><span class="s1">DECLARE @usedCacheAboutObjectsState bit = 0;</span>
</span><span id="__span-0-1708"><a id="__codelineno-0-1708" name="__codelineno-0-1708" href="#__codelineno-0-1708"></a>
</span><span id="__span-0-1709"><a id="__codelineno-0-1709" name="__codelineno-0-1709" href="#__codelineno-0-1709"></a>
</span><span id="__span-0-1710"><a id="__codelineno-0-1710" name="__codelineno-0-1710" href="#__codelineno-0-1710"></a>
</span><span id="__span-0-1711"><a id="__codelineno-0-1711" name="__codelineno-0-1711" href="#__codelineno-0-1711"></a><span class="s1">IF @usePreparedInformationAboutObjectsStateIfExists = 1</span>
</span><span id="__span-0-1712"><a id="__codelineno-0-1712" name="__codelineno-0-1712" href="#__codelineno-0-1712"></a>
</span><span id="__span-0-1713"><a id="__codelineno-0-1713" name="__codelineno-0-1713" href="#__codelineno-0-1713"></a><span class="s1">    AND EXISTS(SELECT *</span>
</span><span id="__span-0-1714"><a id="__codelineno-0-1714" name="__codelineno-0-1714" href="#__codelineno-0-1714"></a>
</span><span id="__span-0-1715"><a id="__codelineno-0-1715" name="__codelineno-0-1715" href="#__codelineno-0-1715"></a><span class="s1">        FROM ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'].[dbo].[DatabaseObjectsState]</span>
</span><span id="__span-0-1716"><a id="__codelineno-0-1716" name="__codelineno-0-1716" href="#__codelineno-0-1716"></a>
</span><span id="__span-0-1717"><a id="__codelineno-0-1717" name="__codelineno-0-1717" href="#__codelineno-0-1717"></a><span class="s1">        WHERE [DatabaseName] = @databaseName</span>
</span><span id="__span-0-1718"><a id="__codelineno-0-1718" name="__codelineno-0-1718" href="#__codelineno-0-1718"></a>
</span><span id="__span-0-1719"><a id="__codelineno-0-1719" name="__codelineno-0-1719" href="#__codelineno-0-1719"></a><span class="s1">            -- Информация должна быть собрана в рамках 12 часов от текущего запуска</span>
</span><span id="__span-0-1720"><a id="__codelineno-0-1720" name="__codelineno-0-1720" href="#__codelineno-0-1720"></a>
</span><span id="__span-0-1721"><a id="__codelineno-0-1721" name="__codelineno-0-1721" href="#__codelineno-0-1721"></a><span class="s1">            AND [Period] BETWEEN DATEADD(hour, -12, @RunDate) AND DATEADD(hour, 12, @RunDate))</span>
</span><span id="__span-0-1722"><a id="__codelineno-0-1722" name="__codelineno-0-1722" href="#__codelineno-0-1722"></a>
</span><span id="__span-0-1723"><a id="__codelineno-0-1723" name="__codelineno-0-1723" href="#__codelineno-0-1723"></a><span class="s1">BEGIN  </span>
</span><span id="__span-0-1724"><a id="__codelineno-0-1724" name="__codelineno-0-1724" href="#__codelineno-0-1724"></a>
</span><span id="__span-0-1725"><a id="__codelineno-0-1725" name="__codelineno-0-1725" href="#__codelineno-0-1725"></a><span class="s1">    -- Получаем информацию через подготовленный сбор</span>
</span><span id="__span-0-1726"><a id="__codelineno-0-1726" name="__codelineno-0-1726" href="#__codelineno-0-1726"></a>
</span><span id="__span-0-1727"><a id="__codelineno-0-1727" name="__codelineno-0-1727" href="#__codelineno-0-1727"></a><span class="s1">    SET @usedCacheAboutObjectsState = 1;</span>
</span><span id="__span-0-1728"><a id="__codelineno-0-1728" name="__codelineno-0-1728" href="#__codelineno-0-1728"></a>
</span><span id="__span-0-1729"><a id="__codelineno-0-1729" name="__codelineno-0-1729" href="#__codelineno-0-1729"></a>
</span><span id="__span-0-1730"><a id="__codelineno-0-1730" name="__codelineno-0-1730" href="#__codelineno-0-1730"></a>
</span><span id="__span-0-1731"><a id="__codelineno-0-1731" name="__codelineno-0-1731" href="#__codelineno-0-1731"></a><span class="s1">    SELECT</span>
</span><span id="__span-0-1732"><a id="__codelineno-0-1732" name="__codelineno-0-1732" href="#__codelineno-0-1732"></a>
</span><span id="__span-0-1733"><a id="__codelineno-0-1733" name="__codelineno-0-1733" href="#__codelineno-0-1733"></a><span class="s1">    OBJECT_ID(dt.[TableName]) AS [objectid]</span>
</span><span id="__span-0-1734"><a id="__codelineno-0-1734" name="__codelineno-0-1734" href="#__codelineno-0-1734"></a>
</span><span id="__span-0-1735"><a id="__codelineno-0-1735" name="__codelineno-0-1735" href="#__codelineno-0-1735"></a><span class="s1">    ,ind.index_id as [indexid]</span>
</span><span id="__span-0-1736"><a id="__codelineno-0-1736" name="__codelineno-0-1736" href="#__codelineno-0-1736"></a>
</span><span id="__span-0-1737"><a id="__codelineno-0-1737" name="__codelineno-0-1737" href="#__codelineno-0-1737"></a><span class="s1">    ,1 AS [partitionnum]</span>
</span><span id="__span-0-1738"><a id="__codelineno-0-1738" name="__codelineno-0-1738" href="#__codelineno-0-1738"></a>
</span><span id="__span-0-1739"><a id="__codelineno-0-1739" name="__codelineno-0-1739" href="#__codelineno-0-1739"></a><span class="s1">    ,[AvgFragmentationPercent] AS [frag]</span>
</span><span id="__span-0-1740"><a id="__codelineno-0-1740" name="__codelineno-0-1740" href="#__codelineno-0-1740"></a>
</span><span id="__span-0-1741"><a id="__codelineno-0-1741" name="__codelineno-0-1741" href="#__codelineno-0-1741"></a><span class="s1">    ,[PageCount] AS [page_count]</span>
</span><span id="__span-0-1742"><a id="__codelineno-0-1742" name="__codelineno-0-1742" href="#__codelineno-0-1742"></a>
</span><span id="__span-0-1743"><a id="__codelineno-0-1743" name="__codelineno-0-1743" href="#__codelineno-0-1743"></a><span class="s1">    ,[Rowmodctr] AS [rowmodctr]</span>
</span><span id="__span-0-1744"><a id="__codelineno-0-1744" name="__codelineno-0-1744" href="#__codelineno-0-1744"></a>
</span><span id="__span-0-1745"><a id="__codelineno-0-1745" name="__codelineno-0-1745" href="#__codelineno-0-1745"></a><span class="s1">    ,ISNULL(prt.[Priority], 999) AS [Priority]</span>
</span><span id="__span-0-1746"><a id="__codelineno-0-1746" name="__codelineno-0-1746" href="#__codelineno-0-1746"></a>
</span><span id="__span-0-1747"><a id="__codelineno-0-1747" name="__codelineno-0-1747" href="#__codelineno-0-1747"></a><span class="s1">    ,ISNULL(prt.[Exclude], 0) AS Exclude</span>
</span><span id="__span-0-1748"><a id="__codelineno-0-1748" name="__codelineno-0-1748" href="#__codelineno-0-1748"></a>
</span><span id="__span-0-1749"><a id="__codelineno-0-1749" name="__codelineno-0-1749" href="#__codelineno-0-1749"></a><span class="s1">    ,dt.[OnlineRebuildSupport] AS [OnlineRebuildSupport]</span>
</span><span id="__span-0-1750"><a id="__codelineno-0-1750" name="__codelineno-0-1750" href="#__codelineno-0-1750"></a>
</span><span id="__span-0-1751"><a id="__codelineno-0-1751" name="__codelineno-0-1751" href="#__codelineno-0-1751"></a><span class="s1">    ,dt.[PartitionCount] AS [PartitionCount]</span>
</span><span id="__span-0-1752"><a id="__codelineno-0-1752" name="__codelineno-0-1752" href="#__codelineno-0-1752"></a>
</span><span id="__span-0-1753"><a id="__codelineno-0-1753" name="__codelineno-0-1753" href="#__codelineno-0-1753"></a><span class="s1">    INTO #MaintenanceCommandsTempCached</span>
</span><span id="__span-0-1754"><a id="__codelineno-0-1754" name="__codelineno-0-1754" href="#__codelineno-0-1754"></a>
</span><span id="__span-0-1755"><a id="__codelineno-0-1755" name="__codelineno-0-1755" href="#__codelineno-0-1755"></a><span class="s1">    FROM ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'].[dbo].[DatabaseObjectsState] dt</span>
</span><span id="__span-0-1756"><a id="__codelineno-0-1756" name="__codelineno-0-1756" href="#__codelineno-0-1756"></a>
</span><span id="__span-0-1757"><a id="__codelineno-0-1757" name="__codelineno-0-1757" href="#__codelineno-0-1757"></a><span class="s1">        LEFT JOIN sys.indexes ind</span>
</span><span id="__span-0-1758"><a id="__codelineno-0-1758" name="__codelineno-0-1758" href="#__codelineno-0-1758"></a>
</span><span id="__span-0-1759"><a id="__codelineno-0-1759" name="__codelineno-0-1759" href="#__codelineno-0-1759"></a><span class="s1">            ON OBJECT_ID(dt.[TableName]) = ind.object_id</span>
</span><span id="__span-0-1760"><a id="__codelineno-0-1760" name="__codelineno-0-1760" href="#__codelineno-0-1760"></a>
</span><span id="__span-0-1761"><a id="__codelineno-0-1761" name="__codelineno-0-1761" href="#__codelineno-0-1761"></a><span class="s1">                AND dt.[Object] = ind.[name]</span>
</span><span id="__span-0-1762"><a id="__codelineno-0-1762" name="__codelineno-0-1762" href="#__codelineno-0-1762"></a>
</span><span id="__span-0-1763"><a id="__codelineno-0-1763" name="__codelineno-0-1763" href="#__codelineno-0-1763"></a><span class="s1">        LEFT JOIN ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'].[dbo].[MaintenanceIndexPriority] AS [prt]</span>
</span><span id="__span-0-1764"><a id="__codelineno-0-1764" name="__codelineno-0-1764" href="#__codelineno-0-1764"></a>
</span><span id="__span-0-1765"><a id="__codelineno-0-1765" name="__codelineno-0-1765" href="#__codelineno-0-1765"></a><span class="s1">            ON dt.DatabaseName = prt.[DatabaseName]</span>
</span><span id="__span-0-1766"><a id="__codelineno-0-1766" name="__codelineno-0-1766" href="#__codelineno-0-1766"></a>
</span><span id="__span-0-1767"><a id="__codelineno-0-1767" name="__codelineno-0-1767" href="#__codelineno-0-1767"></a><span class="s1">                AND dt.TableName = prt.TableName</span>
</span><span id="__span-0-1768"><a id="__codelineno-0-1768" name="__codelineno-0-1768" href="#__codelineno-0-1768"></a>
</span><span id="__span-0-1769"><a id="__codelineno-0-1769" name="__codelineno-0-1769" href="#__codelineno-0-1769"></a><span class="s1">                AND dt.[Object] = prt.Indexname</span>
</span><span id="__span-0-1770"><a id="__codelineno-0-1770" name="__codelineno-0-1770" href="#__codelineno-0-1770"></a>
</span><span id="__span-0-1771"><a id="__codelineno-0-1771" name="__codelineno-0-1771" href="#__codelineno-0-1771"></a><span class="s1">    WHERE dt.[DatabaseName] = @databaseName</span>
</span><span id="__span-0-1772"><a id="__codelineno-0-1772" name="__codelineno-0-1772" href="#__codelineno-0-1772"></a>
</span><span id="__span-0-1773"><a id="__codelineno-0-1773" name="__codelineno-0-1773" href="#__codelineno-0-1773"></a><span class="s1">        AND [Period] BETWEEN DATEADD(hour, -12, @RunDate) AND DATEADD(hour, 12, @RunDate)</span>
</span><span id="__span-0-1774"><a id="__codelineno-0-1774" name="__codelineno-0-1774" href="#__codelineno-0-1774"></a>
</span><span id="__span-0-1775"><a id="__codelineno-0-1775" name="__codelineno-0-1775" href="#__codelineno-0-1775"></a><span class="s1">        -- Записи от последнего получения данных за прошедшие 12 часов</span>
</span><span id="__span-0-1776"><a id="__codelineno-0-1776" name="__codelineno-0-1776" href="#__codelineno-0-1776"></a>
</span><span id="__span-0-1777"><a id="__codelineno-0-1777" name="__codelineno-0-1777" href="#__codelineno-0-1777"></a><span class="s1">        AND [Period] IN (</span>
</span><span id="__span-0-1778"><a id="__codelineno-0-1778" name="__codelineno-0-1778" href="#__codelineno-0-1778"></a>
</span><span id="__span-0-1779"><a id="__codelineno-0-1779" name="__codelineno-0-1779" href="#__codelineno-0-1779"></a><span class="s1">            SELECT MAX([Period])</span>
</span><span id="__span-0-1780"><a id="__codelineno-0-1780" name="__codelineno-0-1780" href="#__codelineno-0-1780"></a>
</span><span id="__span-0-1781"><a id="__codelineno-0-1781" name="__codelineno-0-1781" href="#__codelineno-0-1781"></a><span class="s1">            FROM ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'].[dbo].[DatabaseObjectsState]</span>
</span><span id="__span-0-1782"><a id="__codelineno-0-1782" name="__codelineno-0-1782" href="#__codelineno-0-1782"></a>
</span><span id="__span-0-1783"><a id="__codelineno-0-1783" name="__codelineno-0-1783" href="#__codelineno-0-1783"></a><span class="s1">            WHERE [DatabaseName] = @databaseName</span>
</span><span id="__span-0-1784"><a id="__codelineno-0-1784" name="__codelineno-0-1784" href="#__codelineno-0-1784"></a>
</span><span id="__span-0-1785"><a id="__codelineno-0-1785" name="__codelineno-0-1785" href="#__codelineno-0-1785"></a><span class="s1">                AND dt.[Period] BETWEEN DATEADD(hour, -12, @RunDate) AND DATEADD(hour, 12, @RunDate))</span>
</span><span id="__span-0-1786"><a id="__codelineno-0-1786" name="__codelineno-0-1786" href="#__codelineno-0-1786"></a>
</span><span id="__span-0-1787"><a id="__codelineno-0-1787" name="__codelineno-0-1787" href="#__codelineno-0-1787"></a><span class="s1">        AND [AvgFragmentationPercent] &gt; @fragmentationPercentMinForMaintenance</span>
</span><span id="__span-0-1788"><a id="__codelineno-0-1788" name="__codelineno-0-1788" href="#__codelineno-0-1788"></a>
</span><span id="__span-0-1789"><a id="__codelineno-0-1789" name="__codelineno-0-1789" href="#__codelineno-0-1789"></a><span class="s1">        AND [PageCount] &gt; 25 -- игнорируем небольшие таблицы</span>
</span><span id="__span-0-1790"><a id="__codelineno-0-1790" name="__codelineno-0-1790" href="#__codelineno-0-1790"></a>
</span><span id="__span-0-1791"><a id="__codelineno-0-1791" name="__codelineno-0-1791" href="#__codelineno-0-1791"></a><span class="s1">        -- Фильтр по мин. размеру индекса</span>
</span><span id="__span-0-1792"><a id="__codelineno-0-1792" name="__codelineno-0-1792" href="#__codelineno-0-1792"></a>
</span><span id="__span-0-1793"><a id="__codelineno-0-1793" name="__codelineno-0-1793" href="#__codelineno-0-1793"></a><span class="s1">        AND (@minIndexSizePages = 0 OR [PageCount] &gt;= @minIndexSizePages)</span>
</span><span id="__span-0-1794"><a id="__codelineno-0-1794" name="__codelineno-0-1794" href="#__codelineno-0-1794"></a>
</span><span id="__span-0-1795"><a id="__codelineno-0-1795" name="__codelineno-0-1795" href="#__codelineno-0-1795"></a><span class="s1">        -- Фильтр по макс. размеру индекса</span>
</span><span id="__span-0-1796"><a id="__codelineno-0-1796" name="__codelineno-0-1796" href="#__codelineno-0-1796"></a>
</span><span id="__span-0-1797"><a id="__codelineno-0-1797" name="__codelineno-0-1797" href="#__codelineno-0-1797"></a><span class="s1">        AND (@maxIndexSizePages = 0 OR [PageCount] &lt;= @maxIndexSizePages)</span>
</span><span id="__span-0-1798"><a id="__codelineno-0-1798" name="__codelineno-0-1798" href="#__codelineno-0-1798"></a>
</span><span id="__span-0-1799"><a id="__codelineno-0-1799" name="__codelineno-0-1799" href="#__codelineno-0-1799"></a><span class="s1">        -- Убираем обработку индексов, исключенных из обслуживания</span>
</span><span id="__span-0-1800"><a id="__codelineno-0-1800" name="__codelineno-0-1800" href="#__codelineno-0-1800"></a>
</span><span id="__span-0-1801"><a id="__codelineno-0-1801" name="__codelineno-0-1801" href="#__codelineno-0-1801"></a><span class="s1">        AND ISNULL(prt.[Exclude], 0) = 0</span>
</span><span id="__span-0-1802"><a id="__codelineno-0-1802" name="__codelineno-0-1802" href="#__codelineno-0-1802"></a>
</span><span id="__span-0-1803"><a id="__codelineno-0-1803" name="__codelineno-0-1803" href="#__codelineno-0-1803"></a><span class="s1">        -- Отбор по имени таблцы</span>
</span><span id="__span-0-1804"><a id="__codelineno-0-1804" name="__codelineno-0-1804" href="#__codelineno-0-1804"></a>
</span><span id="__span-0-1805"><a id="__codelineno-0-1805" name="__codelineno-0-1805" href="#__codelineno-0-1805"></a><span class="s1">        AND dt.[TableName] '</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">ConditionTableName</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'</span>
</span><span id="__span-0-1806"><a id="__codelineno-0-1806" name="__codelineno-0-1806" href="#__codelineno-0-1806"></a>
</span><span id="__span-0-1807"><a id="__codelineno-0-1807" name="__codelineno-0-1807" href="#__codelineno-0-1807"></a><span class="s1">        AND dt.[Object] '</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">ConditionIndexName</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'</span>
</span><span id="__span-0-1808"><a id="__codelineno-0-1808" name="__codelineno-0-1808" href="#__codelineno-0-1808"></a>
</span><span id="__span-0-1809"><a id="__codelineno-0-1809" name="__codelineno-0-1809" href="#__codelineno-0-1809"></a><span class="s1">        AND NOT dt.[Object] IN (</span>
</span><span id="__span-0-1810"><a id="__codelineno-0-1810" name="__codelineno-0-1810" href="#__codelineno-0-1810"></a>
</span><span id="__span-0-1811"><a id="__codelineno-0-1811" name="__codelineno-0-1811" href="#__codelineno-0-1811"></a><span class="s1">            SELECT </span>
</span><span id="__span-0-1812"><a id="__codelineno-0-1812" name="__codelineno-0-1812" href="#__codelineno-0-1812"></a>
</span><span id="__span-0-1813"><a id="__codelineno-0-1813" name="__codelineno-0-1813" href="#__codelineno-0-1813"></a><span class="s1">                XC.value(''@name'', ''nvarchar(255)'') AS [IndexName]</span>
</span><span id="__span-0-1814"><a id="__codelineno-0-1814" name="__codelineno-0-1814" href="#__codelineno-0-1814"></a>
</span><span id="__span-0-1815"><a id="__codelineno-0-1815" name="__codelineno-0-1815" href="#__codelineno-0-1815"></a><span class="s1">            FROM @excludeIndexes.nodes(''/root/row'') AS XT(XC)</span>
</span><span id="__span-0-1816"><a id="__codelineno-0-1816" name="__codelineno-0-1816" href="#__codelineno-0-1816"></a>
</span><span id="__span-0-1817"><a id="__codelineno-0-1817" name="__codelineno-0-1817" href="#__codelineno-0-1817"></a><span class="s1">        )</span>
</span><span id="__span-0-1818"><a id="__codelineno-0-1818" name="__codelineno-0-1818" href="#__codelineno-0-1818"></a>
</span><span id="__span-0-1819"><a id="__codelineno-0-1819" name="__codelineno-0-1819" href="#__codelineno-0-1819"></a><span class="s1">END ELSE</span>
</span><span id="__span-0-1820"><a id="__codelineno-0-1820" name="__codelineno-0-1820" href="#__codelineno-0-1820"></a>
</span><span id="__span-0-1821"><a id="__codelineno-0-1821" name="__codelineno-0-1821" href="#__codelineno-0-1821"></a><span class="s1">BEGIN</span>
</span><span id="__span-0-1822"><a id="__codelineno-0-1822" name="__codelineno-0-1822" href="#__codelineno-0-1822"></a>
</span><span id="__span-0-1823"><a id="__codelineno-0-1823" name="__codelineno-0-1823" href="#__codelineno-0-1823"></a><span class="s1">    -- Получаем информацию через анализ базы данных</span>
</span><span id="__span-0-1824"><a id="__codelineno-0-1824" name="__codelineno-0-1824" href="#__codelineno-0-1824"></a>
</span><span id="__span-0-1825"><a id="__codelineno-0-1825" name="__codelineno-0-1825" href="#__codelineno-0-1825"></a><span class="s1">    SELECT</span>
</span><span id="__span-0-1826"><a id="__codelineno-0-1826" name="__codelineno-0-1826" href="#__codelineno-0-1826"></a>
</span><span id="__span-0-1827"><a id="__codelineno-0-1827" name="__codelineno-0-1827" href="#__codelineno-0-1827"></a><span class="s1">        dt.[object_id] AS [objectid],</span>
</span><span id="__span-0-1828"><a id="__codelineno-0-1828" name="__codelineno-0-1828" href="#__codelineno-0-1828"></a>
</span><span id="__span-0-1829"><a id="__codelineno-0-1829" name="__codelineno-0-1829" href="#__codelineno-0-1829"></a><span class="s1">        dt.index_id AS [indexid],</span>
</span><span id="__span-0-1830"><a id="__codelineno-0-1830" name="__codelineno-0-1830" href="#__codelineno-0-1830"></a>
</span><span id="__span-0-1831"><a id="__codelineno-0-1831" name="__codelineno-0-1831" href="#__codelineno-0-1831"></a><span class="s1">        [partition_number] AS [partitionnum],</span>
</span><span id="__span-0-1832"><a id="__codelineno-0-1832" name="__codelineno-0-1832" href="#__codelineno-0-1832"></a>
</span><span id="__span-0-1833"><a id="__codelineno-0-1833" name="__codelineno-0-1833" href="#__codelineno-0-1833"></a><span class="s1">        MAX([avg_fragmentation_in_percent]) AS [frag],</span>
</span><span id="__span-0-1834"><a id="__codelineno-0-1834" name="__codelineno-0-1834" href="#__codelineno-0-1834"></a>
</span><span id="__span-0-1835"><a id="__codelineno-0-1835" name="__codelineno-0-1835" href="#__codelineno-0-1835"></a><span class="s1">        MAX(CAST([page_count] AS BIGINT)) AS [page_count],</span>
</span><span id="__span-0-1836"><a id="__codelineno-0-1836" name="__codelineno-0-1836" href="#__codelineno-0-1836"></a>
</span><span id="__span-0-1837"><a id="__codelineno-0-1837" name="__codelineno-0-1837" href="#__codelineno-0-1837"></a><span class="s1">        SUM(CAST([si].[rowmodctr] AS BIGINT)) AS [rowmodctr],</span>
</span><span id="__span-0-1838"><a id="__codelineno-0-1838" name="__codelineno-0-1838" href="#__codelineno-0-1838"></a>
</span><span id="__span-0-1839"><a id="__codelineno-0-1839" name="__codelineno-0-1839" href="#__codelineno-0-1839"></a><span class="s1">        MAX(</span>
</span><span id="__span-0-1840"><a id="__codelineno-0-1840" name="__codelineno-0-1840" href="#__codelineno-0-1840"></a>
</span><span id="__span-0-1841"><a id="__codelineno-0-1841" name="__codelineno-0-1841" href="#__codelineno-0-1841"></a><span class="s1">            ISNULL(prt.[Priority], 999)</span>
</span><span id="__span-0-1842"><a id="__codelineno-0-1842" name="__codelineno-0-1842" href="#__codelineno-0-1842"></a>
</span><span id="__span-0-1843"><a id="__codelineno-0-1843" name="__codelineno-0-1843" href="#__codelineno-0-1843"></a><span class="s1">        ) AS [Priority],</span>
</span><span id="__span-0-1844"><a id="__codelineno-0-1844" name="__codelineno-0-1844" href="#__codelineno-0-1844"></a>
</span><span id="__span-0-1845"><a id="__codelineno-0-1845" name="__codelineno-0-1845" href="#__codelineno-0-1845"></a><span class="s1">        MAX(</span>
</span><span id="__span-0-1846"><a id="__codelineno-0-1846" name="__codelineno-0-1846" href="#__codelineno-0-1846"></a>
</span><span id="__span-0-1847"><a id="__codelineno-0-1847" name="__codelineno-0-1847" href="#__codelineno-0-1847"></a><span class="s1">            CAST(ISNULL(prt.[Exclude], 0) AS INT)</span>
</span><span id="__span-0-1848"><a id="__codelineno-0-1848" name="__codelineno-0-1848" href="#__codelineno-0-1848"></a>
</span><span id="__span-0-1849"><a id="__codelineno-0-1849" name="__codelineno-0-1849" href="#__codelineno-0-1849"></a><span class="s1">        ) AS [Exclude],</span>
</span><span id="__span-0-1850"><a id="__codelineno-0-1850" name="__codelineno-0-1850" href="#__codelineno-0-1850"></a>
</span><span id="__span-0-1851"><a id="__codelineno-0-1851" name="__codelineno-0-1851" href="#__codelineno-0-1851"></a><span class="s1">        MIN(CASE WHEN objBadTypes.IndexObjectId IS NULL THEN 1 ELSE 0 END) AS [OnlineRebuildSupport],</span>
</span><span id="__span-0-1852"><a id="__codelineno-0-1852" name="__codelineno-0-1852" href="#__codelineno-0-1852"></a>
</span><span id="__span-0-1853"><a id="__codelineno-0-1853" name="__codelineno-0-1853" href="#__codelineno-0-1853"></a><span class="s1">        MAX(p_count.[PartitionCount]) AS [PartitionCount]</span>
</span><span id="__span-0-1854"><a id="__codelineno-0-1854" name="__codelineno-0-1854" href="#__codelineno-0-1854"></a>
</span><span id="__span-0-1855"><a id="__codelineno-0-1855" name="__codelineno-0-1855" href="#__codelineno-0-1855"></a><span class="s1">    INTO #MaintenanceCommandsTemp</span>
</span><span id="__span-0-1856"><a id="__codelineno-0-1856" name="__codelineno-0-1856" href="#__codelineno-0-1856"></a>
</span><span id="__span-0-1857"><a id="__codelineno-0-1857" name="__codelineno-0-1857" href="#__codelineno-0-1857"></a><span class="s1">    FROM</span>
</span><span id="__span-0-1858"><a id="__codelineno-0-1858" name="__codelineno-0-1858" href="#__codelineno-0-1858"></a>
</span><span id="__span-0-1859"><a id="__codelineno-0-1859" name="__codelineno-0-1859" href="#__codelineno-0-1859"></a><span class="s1">        sys.dm_db_index_physical_stats (</span>
</span><span id="__span-0-1860"><a id="__codelineno-0-1860" name="__codelineno-0-1860" href="#__codelineno-0-1860"></a>
</span><span id="__span-0-1861"><a id="__codelineno-0-1861" name="__codelineno-0-1861" href="#__codelineno-0-1861"></a><span class="s1">            DB_ID(),</span>
</span><span id="__span-0-1862"><a id="__codelineno-0-1862" name="__codelineno-0-1862" href="#__codelineno-0-1862"></a>
</span><span id="__span-0-1863"><a id="__codelineno-0-1863" name="__codelineno-0-1863" href="#__codelineno-0-1863"></a><span class="s1">            NULL,</span>
</span><span id="__span-0-1864"><a id="__codelineno-0-1864" name="__codelineno-0-1864" href="#__codelineno-0-1864"></a>
</span><span id="__span-0-1865"><a id="__codelineno-0-1865" name="__codelineno-0-1865" href="#__codelineno-0-1865"></a><span class="s1">            NULL,</span>
</span><span id="__span-0-1866"><a id="__codelineno-0-1866" name="__codelineno-0-1866" href="#__codelineno-0-1866"></a>
</span><span id="__span-0-1867"><a id="__codelineno-0-1867" name="__codelineno-0-1867" href="#__codelineno-0-1867"></a><span class="s1">            NULL,</span>
</span><span id="__span-0-1868"><a id="__codelineno-0-1868" name="__codelineno-0-1868" href="#__codelineno-0-1868"></a>
</span><span id="__span-0-1869"><a id="__codelineno-0-1869" name="__codelineno-0-1869" href="#__codelineno-0-1869"></a><span class="s1">            N''LIMITED''</span>
</span><span id="__span-0-1870"><a id="__codelineno-0-1870" name="__codelineno-0-1870" href="#__codelineno-0-1870"></a>
</span><span id="__span-0-1871"><a id="__codelineno-0-1871" name="__codelineno-0-1871" href="#__codelineno-0-1871"></a><span class="s1">        ) dt</span>
</span><span id="__span-0-1872"><a id="__codelineno-0-1872" name="__codelineno-0-1872" href="#__codelineno-0-1872"></a>
</span><span id="__span-0-1873"><a id="__codelineno-0-1873" name="__codelineno-0-1873" href="#__codelineno-0-1873"></a><span class="s1">        LEFT JOIN sys.sysindexes si ON dt.object_id = si.id</span>
</span><span id="__span-0-1874"><a id="__codelineno-0-1874" name="__codelineno-0-1874" href="#__codelineno-0-1874"></a>
</span><span id="__span-0-1875"><a id="__codelineno-0-1875" name="__codelineno-0-1875" href="#__codelineno-0-1875"></a><span class="s1">        LEFT JOIN (</span>
</span><span id="__span-0-1876"><a id="__codelineno-0-1876" name="__codelineno-0-1876" href="#__codelineno-0-1876"></a>
</span><span id="__span-0-1877"><a id="__codelineno-0-1877" name="__codelineno-0-1877" href="#__codelineno-0-1877"></a><span class="s1">            SELECT</span>
</span><span id="__span-0-1878"><a id="__codelineno-0-1878" name="__codelineno-0-1878" href="#__codelineno-0-1878"></a>
</span><span id="__span-0-1879"><a id="__codelineno-0-1879" name="__codelineno-0-1879" href="#__codelineno-0-1879"></a><span class="s1">            t.object_id AS [TableObjectId],</span>
</span><span id="__span-0-1880"><a id="__codelineno-0-1880" name="__codelineno-0-1880" href="#__codelineno-0-1880"></a>
</span><span id="__span-0-1881"><a id="__codelineno-0-1881" name="__codelineno-0-1881" href="#__codelineno-0-1881"></a><span class="s1">            ind.index_id AS [IndexObjectId]</span>
</span><span id="__span-0-1882"><a id="__codelineno-0-1882" name="__codelineno-0-1882" href="#__codelineno-0-1882"></a>
</span><span id="__span-0-1883"><a id="__codelineno-0-1883" name="__codelineno-0-1883" href="#__codelineno-0-1883"></a><span class="s1">            FROM</span>
</span><span id="__span-0-1884"><a id="__codelineno-0-1884" name="__codelineno-0-1884" href="#__codelineno-0-1884"></a>
</span><span id="__span-0-1885"><a id="__codelineno-0-1885" name="__codelineno-0-1885" href="#__codelineno-0-1885"></a><span class="s1">            sys.indexes ind</span>
</span><span id="__span-0-1886"><a id="__codelineno-0-1886" name="__codelineno-0-1886" href="#__codelineno-0-1886"></a>
</span><span id="__span-0-1887"><a id="__codelineno-0-1887" name="__codelineno-0-1887" href="#__codelineno-0-1887"></a><span class="s1">            INNER JOIN sys.index_columns ic ON ind.object_id = ic.object_id</span>
</span><span id="__span-0-1888"><a id="__codelineno-0-1888" name="__codelineno-0-1888" href="#__codelineno-0-1888"></a>
</span><span id="__span-0-1889"><a id="__codelineno-0-1889" name="__codelineno-0-1889" href="#__codelineno-0-1889"></a><span class="s1">            and ind.index_id = ic.index_id</span>
</span><span id="__span-0-1890"><a id="__codelineno-0-1890" name="__codelineno-0-1890" href="#__codelineno-0-1890"></a>
</span><span id="__span-0-1891"><a id="__codelineno-0-1891" name="__codelineno-0-1891" href="#__codelineno-0-1891"></a><span class="s1">            INNER JOIN sys.columns col ON ic.object_id = col.object_id</span>
</span><span id="__span-0-1892"><a id="__codelineno-0-1892" name="__codelineno-0-1892" href="#__codelineno-0-1892"></a>
</span><span id="__span-0-1893"><a id="__codelineno-0-1893" name="__codelineno-0-1893" href="#__codelineno-0-1893"></a><span class="s1">            and ic.column_id = col.column_id</span>
</span><span id="__span-0-1894"><a id="__codelineno-0-1894" name="__codelineno-0-1894" href="#__codelineno-0-1894"></a>
</span><span id="__span-0-1895"><a id="__codelineno-0-1895" name="__codelineno-0-1895" href="#__codelineno-0-1895"></a><span class="s1">            INNER JOIN sys.tables t ON ind.object_id = t.object_id</span>
</span><span id="__span-0-1896"><a id="__codelineno-0-1896" name="__codelineno-0-1896" href="#__codelineno-0-1896"></a>
</span><span id="__span-0-1897"><a id="__codelineno-0-1897" name="__codelineno-0-1897" href="#__codelineno-0-1897"></a><span class="s1">            LEFT JOIN INFORMATION_SCHEMA.COLUMNS tbsc ON t.schema_id = SCHEMA_ID(tbsc.TABLE_SCHEMA)</span>
</span><span id="__span-0-1898"><a id="__codelineno-0-1898" name="__codelineno-0-1898" href="#__codelineno-0-1898"></a>
</span><span id="__span-0-1899"><a id="__codelineno-0-1899" name="__codelineno-0-1899" href="#__codelineno-0-1899"></a><span class="s1">            AND t.name = tbsc.TABLE_NAME</span>
</span><span id="__span-0-1900"><a id="__codelineno-0-1900" name="__codelineno-0-1900" href="#__codelineno-0-1900"></a>
</span><span id="__span-0-1901"><a id="__codelineno-0-1901" name="__codelineno-0-1901" href="#__codelineno-0-1901"></a><span class="s1">            LEFT JOIN sys.types tps ON col.system_type_id = tps.system_type_id</span>
</span><span id="__span-0-1902"><a id="__codelineno-0-1902" name="__codelineno-0-1902" href="#__codelineno-0-1902"></a>
</span><span id="__span-0-1903"><a id="__codelineno-0-1903" name="__codelineno-0-1903" href="#__codelineno-0-1903"></a><span class="s1">            AND col.user_type_id = tps.user_type_id</span>
</span><span id="__span-0-1904"><a id="__codelineno-0-1904" name="__codelineno-0-1904" href="#__codelineno-0-1904"></a>
</span><span id="__span-0-1905"><a id="__codelineno-0-1905" name="__codelineno-0-1905" href="#__codelineno-0-1905"></a><span class="s1">            WHERE</span>
</span><span id="__span-0-1906"><a id="__codelineno-0-1906" name="__codelineno-0-1906" href="#__codelineno-0-1906"></a>
</span><span id="__span-0-1907"><a id="__codelineno-0-1907" name="__codelineno-0-1907" href="#__codelineno-0-1907"></a><span class="s1">            t.is_ms_shipped = 0</span>
</span><span id="__span-0-1908"><a id="__codelineno-0-1908" name="__codelineno-0-1908" href="#__codelineno-0-1908"></a>
</span><span id="__span-0-1909"><a id="__codelineno-0-1909" name="__codelineno-0-1909" href="#__codelineno-0-1909"></a><span class="s1">            AND CASE WHEN ind.type_desc = ''CLUSTERED'' THEN CASE WHEN tbsc.DATA_TYPE IN (</span>
</span><span id="__span-0-1910"><a id="__codelineno-0-1910" name="__codelineno-0-1910" href="#__codelineno-0-1910"></a>
</span><span id="__span-0-1911"><a id="__codelineno-0-1911" name="__codelineno-0-1911" href="#__codelineno-0-1911"></a><span class="s1">                ''text'', ''ntext'', ''image'', ''FILESTREAM''</span>
</span><span id="__span-0-1912"><a id="__codelineno-0-1912" name="__codelineno-0-1912" href="#__codelineno-0-1912"></a>
</span><span id="__span-0-1913"><a id="__codelineno-0-1913" name="__codelineno-0-1913" href="#__codelineno-0-1913"></a><span class="s1">            ) THEN 1 ELSE 0 END ELSE CASE WHEN tps.[name] IN (</span>
</span><span id="__span-0-1914"><a id="__codelineno-0-1914" name="__codelineno-0-1914" href="#__codelineno-0-1914"></a>
</span><span id="__span-0-1915"><a id="__codelineno-0-1915" name="__codelineno-0-1915" href="#__codelineno-0-1915"></a><span class="s1">                ''text'', ''ntext'', ''image'', ''FILESTREAM''</span>
</span><span id="__span-0-1916"><a id="__codelineno-0-1916" name="__codelineno-0-1916" href="#__codelineno-0-1916"></a>
</span><span id="__span-0-1917"><a id="__codelineno-0-1917" name="__codelineno-0-1917" href="#__codelineno-0-1917"></a><span class="s1">            ) THEN 1 ELSE 0 END END &gt; 0</span>
</span><span id="__span-0-1918"><a id="__codelineno-0-1918" name="__codelineno-0-1918" href="#__codelineno-0-1918"></a>
</span><span id="__span-0-1919"><a id="__codelineno-0-1919" name="__codelineno-0-1919" href="#__codelineno-0-1919"></a><span class="s1">            GROUP BY</span>
</span><span id="__span-0-1920"><a id="__codelineno-0-1920" name="__codelineno-0-1920" href="#__codelineno-0-1920"></a>
</span><span id="__span-0-1921"><a id="__codelineno-0-1921" name="__codelineno-0-1921" href="#__codelineno-0-1921"></a><span class="s1">            t.object_id,</span>
</span><span id="__span-0-1922"><a id="__codelineno-0-1922" name="__codelineno-0-1922" href="#__codelineno-0-1922"></a>
</span><span id="__span-0-1923"><a id="__codelineno-0-1923" name="__codelineno-0-1923" href="#__codelineno-0-1923"></a><span class="s1">            ind.index_id</span>
</span><span id="__span-0-1924"><a id="__codelineno-0-1924" name="__codelineno-0-1924" href="#__codelineno-0-1924"></a>
</span><span id="__span-0-1925"><a id="__codelineno-0-1925" name="__codelineno-0-1925" href="#__codelineno-0-1925"></a><span class="s1">        ) AS objBadTypes ON objBadTypes.TableObjectId = dt.object_id</span>
</span><span id="__span-0-1926"><a id="__codelineno-0-1926" name="__codelineno-0-1926" href="#__codelineno-0-1926"></a>
</span><span id="__span-0-1927"><a id="__codelineno-0-1927" name="__codelineno-0-1927" href="#__codelineno-0-1927"></a><span class="s1">        AND objBadTypes.IndexObjectId = dt.index_id</span>
</span><span id="__span-0-1928"><a id="__codelineno-0-1928" name="__codelineno-0-1928" href="#__codelineno-0-1928"></a>
</span><span id="__span-0-1929"><a id="__codelineno-0-1929" name="__codelineno-0-1929" href="#__codelineno-0-1929"></a><span class="s1">        LEFT JOIN (</span>
</span><span id="__span-0-1930"><a id="__codelineno-0-1930" name="__codelineno-0-1930" href="#__codelineno-0-1930"></a>
</span><span id="__span-0-1931"><a id="__codelineno-0-1931" name="__codelineno-0-1931" href="#__codelineno-0-1931"></a><span class="s1">            SELECT</span>
</span><span id="__span-0-1932"><a id="__codelineno-0-1932" name="__codelineno-0-1932" href="#__codelineno-0-1932"></a>
</span><span id="__span-0-1933"><a id="__codelineno-0-1933" name="__codelineno-0-1933" href="#__codelineno-0-1933"></a><span class="s1">            i.[object_id],</span>
</span><span id="__span-0-1934"><a id="__codelineno-0-1934" name="__codelineno-0-1934" href="#__codelineno-0-1934"></a>
</span><span id="__span-0-1935"><a id="__codelineno-0-1935" name="__codelineno-0-1935" href="#__codelineno-0-1935"></a><span class="s1">            i.[index_id],</span>
</span><span id="__span-0-1936"><a id="__codelineno-0-1936" name="__codelineno-0-1936" href="#__codelineno-0-1936"></a>
</span><span id="__span-0-1937"><a id="__codelineno-0-1937" name="__codelineno-0-1937" href="#__codelineno-0-1937"></a><span class="s1">            os.[Priority] AS [Priority],</span>
</span><span id="__span-0-1938"><a id="__codelineno-0-1938" name="__codelineno-0-1938" href="#__codelineno-0-1938"></a>
</span><span id="__span-0-1939"><a id="__codelineno-0-1939" name="__codelineno-0-1939" href="#__codelineno-0-1939"></a><span class="s1">            os.[Exclude] AS [Exclude]</span>
</span><span id="__span-0-1940"><a id="__codelineno-0-1940" name="__codelineno-0-1940" href="#__codelineno-0-1940"></a>
</span><span id="__span-0-1941"><a id="__codelineno-0-1941" name="__codelineno-0-1941" href="#__codelineno-0-1941"></a><span class="s1">            FROM sys.indexes i</span>
</span><span id="__span-0-1942"><a id="__codelineno-0-1942" name="__codelineno-0-1942" href="#__codelineno-0-1942"></a>
</span><span id="__span-0-1943"><a id="__codelineno-0-1943" name="__codelineno-0-1943" href="#__codelineno-0-1943"></a><span class="s1">                left join ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'].[dbo].[MaintenanceIndexPriority] os</span>
</span><span id="__span-0-1944"><a id="__codelineno-0-1944" name="__codelineno-0-1944" href="#__codelineno-0-1944"></a>
</span><span id="__span-0-1945"><a id="__codelineno-0-1945" name="__codelineno-0-1945" href="#__codelineno-0-1945"></a><span class="s1">                ON i.object_id = OBJECT_ID(os.TableName)</span>
</span><span id="__span-0-1946"><a id="__codelineno-0-1946" name="__codelineno-0-1946" href="#__codelineno-0-1946"></a>
</span><span id="__span-0-1947"><a id="__codelineno-0-1947" name="__codelineno-0-1947" href="#__codelineno-0-1947"></a><span class="s1">                    AND i.Name = os.IndexName</span>
</span><span id="__span-0-1948"><a id="__codelineno-0-1948" name="__codelineno-0-1948" href="#__codelineno-0-1948"></a>
</span><span id="__span-0-1949"><a id="__codelineno-0-1949" name="__codelineno-0-1949" href="#__codelineno-0-1949"></a><span class="s1">            WHERE os.Id IS NOT NULL</span>
</span><span id="__span-0-1950"><a id="__codelineno-0-1950" name="__codelineno-0-1950" href="#__codelineno-0-1950"></a>
</span><span id="__span-0-1951"><a id="__codelineno-0-1951" name="__codelineno-0-1951" href="#__codelineno-0-1951"></a><span class="s1">                and os.DatabaseName = '''</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'''</span>
</span><span id="__span-0-1952"><a id="__codelineno-0-1952" name="__codelineno-0-1952" href="#__codelineno-0-1952"></a>
</span><span id="__span-0-1953"><a id="__codelineno-0-1953" name="__codelineno-0-1953" href="#__codelineno-0-1953"></a><span class="s1">            ) prt ON si.id = prt.[object_id]</span>
</span><span id="__span-0-1954"><a id="__codelineno-0-1954" name="__codelineno-0-1954" href="#__codelineno-0-1954"></a>
</span><span id="__span-0-1955"><a id="__codelineno-0-1955" name="__codelineno-0-1955" href="#__codelineno-0-1955"></a><span class="s1">        AND dt.[index_id] = prt.[index_id]</span>
</span><span id="__span-0-1956"><a id="__codelineno-0-1956" name="__codelineno-0-1956" href="#__codelineno-0-1956"></a>
</span><span id="__span-0-1957"><a id="__codelineno-0-1957" name="__codelineno-0-1957" href="#__codelineno-0-1957"></a><span class="s1">        LEFT JOIN (</span>
</span><span id="__span-0-1958"><a id="__codelineno-0-1958" name="__codelineno-0-1958" href="#__codelineno-0-1958"></a>
</span><span id="__span-0-1959"><a id="__codelineno-0-1959" name="__codelineno-0-1959" href="#__codelineno-0-1959"></a><span class="s1">            SELECT</span>
</span><span id="__span-0-1960"><a id="__codelineno-0-1960" name="__codelineno-0-1960" href="#__codelineno-0-1960"></a>
</span><span id="__span-0-1961"><a id="__codelineno-0-1961" name="__codelineno-0-1961" href="#__codelineno-0-1961"></a><span class="s1">                object_id,</span>
</span><span id="__span-0-1962"><a id="__codelineno-0-1962" name="__codelineno-0-1962" href="#__codelineno-0-1962"></a>
</span><span id="__span-0-1963"><a id="__codelineno-0-1963" name="__codelineno-0-1963" href="#__codelineno-0-1963"></a><span class="s1">                index_id,</span>
</span><span id="__span-0-1964"><a id="__codelineno-0-1964" name="__codelineno-0-1964" href="#__codelineno-0-1964"></a>
</span><span id="__span-0-1965"><a id="__codelineno-0-1965" name="__codelineno-0-1965" href="#__codelineno-0-1965"></a><span class="s1">                COUNT(DISTINCT partition_number) AS [PartitionCount]</span>
</span><span id="__span-0-1966"><a id="__codelineno-0-1966" name="__codelineno-0-1966" href="#__codelineno-0-1966"></a>
</span><span id="__span-0-1967"><a id="__codelineno-0-1967" name="__codelineno-0-1967" href="#__codelineno-0-1967"></a><span class="s1">            FROM sys.partitions p</span>
</span><span id="__span-0-1968"><a id="__codelineno-0-1968" name="__codelineno-0-1968" href="#__codelineno-0-1968"></a>
</span><span id="__span-0-1969"><a id="__codelineno-0-1969" name="__codelineno-0-1969" href="#__codelineno-0-1969"></a><span class="s1">            GROUP BY object_id, index_id</span>
</span><span id="__span-0-1970"><a id="__codelineno-0-1970" name="__codelineno-0-1970" href="#__codelineno-0-1970"></a>
</span><span id="__span-0-1971"><a id="__codelineno-0-1971" name="__codelineno-0-1971" href="#__codelineno-0-1971"></a><span class="s1">        ) p_count</span>
</span><span id="__span-0-1972"><a id="__codelineno-0-1972" name="__codelineno-0-1972" href="#__codelineno-0-1972"></a>
</span><span id="__span-0-1973"><a id="__codelineno-0-1973" name="__codelineno-0-1973" href="#__codelineno-0-1973"></a><span class="s1">        ON dt.object_id = p_count.object_id AND dt.index_id = p_count.index_id</span>
</span><span id="__span-0-1974"><a id="__codelineno-0-1974" name="__codelineno-0-1974" href="#__codelineno-0-1974"></a>
</span><span id="__span-0-1975"><a id="__codelineno-0-1975" name="__codelineno-0-1975" href="#__codelineno-0-1975"></a><span class="s1">    WHERE</span>
</span><span id="__span-0-1976"><a id="__codelineno-0-1976" name="__codelineno-0-1976" href="#__codelineno-0-1976"></a>
</span><span id="__span-0-1977"><a id="__codelineno-0-1977" name="__codelineno-0-1977" href="#__codelineno-0-1977"></a><span class="s1">        [rowmodctr] IS NOT NULL -- Исключаем служебные объекты, по которым нет изменений</span>
</span><span id="__span-0-1978"><a id="__codelineno-0-1978" name="__codelineno-0-1978" href="#__codelineno-0-1978"></a>
</span><span id="__span-0-1979"><a id="__codelineno-0-1979" name="__codelineno-0-1979" href="#__codelineno-0-1979"></a><span class="s1">        AND [avg_fragmentation_in_percent] &gt; @fragmentationPercentMinForMaintenance</span>
</span><span id="__span-0-1980"><a id="__codelineno-0-1980" name="__codelineno-0-1980" href="#__codelineno-0-1980"></a>
</span><span id="__span-0-1981"><a id="__codelineno-0-1981" name="__codelineno-0-1981" href="#__codelineno-0-1981"></a><span class="s1">        AND dt.[index_id] &gt; 0 -- игнорируем кучи (heap)</span>
</span><span id="__span-0-1982"><a id="__codelineno-0-1982" name="__codelineno-0-1982" href="#__codelineno-0-1982"></a>
</span><span id="__span-0-1983"><a id="__codelineno-0-1983" name="__codelineno-0-1983" href="#__codelineno-0-1983"></a><span class="s1">        AND [page_count] &gt; 25 -- игнорируем небольшие таблицы</span>
</span><span id="__span-0-1984"><a id="__codelineno-0-1984" name="__codelineno-0-1984" href="#__codelineno-0-1984"></a>
</span><span id="__span-0-1985"><a id="__codelineno-0-1985" name="__codelineno-0-1985" href="#__codelineno-0-1985"></a><span class="s1">        -- Фильтр по мин. размеру индекса</span>
</span><span id="__span-0-1986"><a id="__codelineno-0-1986" name="__codelineno-0-1986" href="#__codelineno-0-1986"></a>
</span><span id="__span-0-1987"><a id="__codelineno-0-1987" name="__codelineno-0-1987" href="#__codelineno-0-1987"></a><span class="s1">        AND (@minIndexSizePages = 0 OR [page_count] &gt;= @minIndexSizePages)</span>
</span><span id="__span-0-1988"><a id="__codelineno-0-1988" name="__codelineno-0-1988" href="#__codelineno-0-1988"></a>
</span><span id="__span-0-1989"><a id="__codelineno-0-1989" name="__codelineno-0-1989" href="#__codelineno-0-1989"></a><span class="s1">        -- Фильтр по макс. размеру индекса</span>
</span><span id="__span-0-1990"><a id="__codelineno-0-1990" name="__codelineno-0-1990" href="#__codelineno-0-1990"></a>
</span><span id="__span-0-1991"><a id="__codelineno-0-1991" name="__codelineno-0-1991" href="#__codelineno-0-1991"></a><span class="s1">        AND (@maxIndexSizePages = 0 OR [page_count] &lt;= @maxIndexSizePages)</span>
</span><span id="__span-0-1992"><a id="__codelineno-0-1992" name="__codelineno-0-1992" href="#__codelineno-0-1992"></a>
</span><span id="__span-0-1993"><a id="__codelineno-0-1993" name="__codelineno-0-1993" href="#__codelineno-0-1993"></a><span class="s1">        -- Убираем обработку индексов, исключенных из обслуживания</span>
</span><span id="__span-0-1994"><a id="__codelineno-0-1994" name="__codelineno-0-1994" href="#__codelineno-0-1994"></a>
</span><span id="__span-0-1995"><a id="__codelineno-0-1995" name="__codelineno-0-1995" href="#__codelineno-0-1995"></a><span class="s1">        AND ISNULL(prt.[Exclude], 0) = 0</span>
</span><span id="__span-0-1996"><a id="__codelineno-0-1996" name="__codelineno-0-1996" href="#__codelineno-0-1996"></a>
</span><span id="__span-0-1997"><a id="__codelineno-0-1997" name="__codelineno-0-1997" href="#__codelineno-0-1997"></a><span class="s1">        -- Отбор по имени таблцы</span>
</span><span id="__span-0-1998"><a id="__codelineno-0-1998" name="__codelineno-0-1998" href="#__codelineno-0-1998"></a>
</span><span id="__span-0-1999"><a id="__codelineno-0-1999" name="__codelineno-0-1999" href="#__codelineno-0-1999"></a><span class="s1">        AND OBJECT_NAME(dt.[object_id]) '</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">ConditionTableName</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'</span>
</span><span id="__span-0-2000"><a id="__codelineno-0-2000" name="__codelineno-0-2000" href="#__codelineno-0-2000"></a>
</span><span id="__span-0-2001"><a id="__codelineno-0-2001" name="__codelineno-0-2001" href="#__codelineno-0-2001"></a><span class="s1">        AND si.[name] '</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">ConditionIndexName</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'</span>
</span><span id="__span-0-2002"><a id="__codelineno-0-2002" name="__codelineno-0-2002" href="#__codelineno-0-2002"></a>
</span><span id="__span-0-2003"><a id="__codelineno-0-2003" name="__codelineno-0-2003" href="#__codelineno-0-2003"></a><span class="s1">        AND NOT si.[name] IN (</span>
</span><span id="__span-0-2004"><a id="__codelineno-0-2004" name="__codelineno-0-2004" href="#__codelineno-0-2004"></a>
</span><span id="__span-0-2005"><a id="__codelineno-0-2005" name="__codelineno-0-2005" href="#__codelineno-0-2005"></a><span class="s1">            SELECT </span>
</span><span id="__span-0-2006"><a id="__codelineno-0-2006" name="__codelineno-0-2006" href="#__codelineno-0-2006"></a>
</span><span id="__span-0-2007"><a id="__codelineno-0-2007" name="__codelineno-0-2007" href="#__codelineno-0-2007"></a><span class="s1">                XC.value(''@name'', ''nvarchar(255)'') AS [IndexName]</span>
</span><span id="__span-0-2008"><a id="__codelineno-0-2008" name="__codelineno-0-2008" href="#__codelineno-0-2008"></a>
</span><span id="__span-0-2009"><a id="__codelineno-0-2009" name="__codelineno-0-2009" href="#__codelineno-0-2009"></a><span class="s1">            FROM @excludeIndexes.nodes(''/root/row'') AS XT(XC)</span>
</span><span id="__span-0-2010"><a id="__codelineno-0-2010" name="__codelineno-0-2010" href="#__codelineno-0-2010"></a>
</span><span id="__span-0-2011"><a id="__codelineno-0-2011" name="__codelineno-0-2011" href="#__codelineno-0-2011"></a><span class="s1">        )</span>
</span><span id="__span-0-2012"><a id="__codelineno-0-2012" name="__codelineno-0-2012" href="#__codelineno-0-2012"></a>
</span><span id="__span-0-2013"><a id="__codelineno-0-2013" name="__codelineno-0-2013" href="#__codelineno-0-2013"></a><span class="s1">    GROUP BY</span>
</span><span id="__span-0-2014"><a id="__codelineno-0-2014" name="__codelineno-0-2014" href="#__codelineno-0-2014"></a>
</span><span id="__span-0-2015"><a id="__codelineno-0-2015" name="__codelineno-0-2015" href="#__codelineno-0-2015"></a><span class="s1">        dt.[object_id],</span>
</span><span id="__span-0-2016"><a id="__codelineno-0-2016" name="__codelineno-0-2016" href="#__codelineno-0-2016"></a>
</span><span id="__span-0-2017"><a id="__codelineno-0-2017" name="__codelineno-0-2017" href="#__codelineno-0-2017"></a><span class="s1">        dt.[index_id],</span>
</span><span id="__span-0-2018"><a id="__codelineno-0-2018" name="__codelineno-0-2018" href="#__codelineno-0-2018"></a>
</span><span id="__span-0-2019"><a id="__codelineno-0-2019" name="__codelineno-0-2019" href="#__codelineno-0-2019"></a><span class="s1">        [partition_number];</span>
</span><span id="__span-0-2020"><a id="__codelineno-0-2020" name="__codelineno-0-2020" href="#__codelineno-0-2020"></a>
</span><span id="__span-0-2021"><a id="__codelineno-0-2021" name="__codelineno-0-2021" href="#__codelineno-0-2021"></a><span class="s1">END</span>
</span><span id="__span-0-2022"><a id="__codelineno-0-2022" name="__codelineno-0-2022" href="#__codelineno-0-2022"></a>
</span><span id="__span-0-2023"><a id="__codelineno-0-2023" name="__codelineno-0-2023" href="#__codelineno-0-2023"></a>
</span><span id="__span-0-2024"><a id="__codelineno-0-2024" name="__codelineno-0-2024" href="#__codelineno-0-2024"></a>
</span><span id="__span-0-2025"><a id="__codelineno-0-2025" name="__codelineno-0-2025" href="#__codelineno-0-2025"></a><span class="s1">IF(@usedCacheAboutObjectsState = 1)</span>
</span><span id="__span-0-2026"><a id="__codelineno-0-2026" name="__codelineno-0-2026" href="#__codelineno-0-2026"></a>
</span><span id="__span-0-2027"><a id="__codelineno-0-2027" name="__codelineno-0-2027" href="#__codelineno-0-2027"></a><span class="s1">BEGIN</span>
</span><span id="__span-0-2028"><a id="__codelineno-0-2028" name="__codelineno-0-2028" href="#__codelineno-0-2028"></a>
</span><span id="__span-0-2029"><a id="__codelineno-0-2029" name="__codelineno-0-2029" href="#__codelineno-0-2029"></a><span class="s1">    DECLARE partitions CURSOR FOR</span>
</span><span id="__span-0-2030"><a id="__codelineno-0-2030" name="__codelineno-0-2030" href="#__codelineno-0-2030"></a>
</span><span id="__span-0-2031"><a id="__codelineno-0-2031" name="__codelineno-0-2031" href="#__codelineno-0-2031"></a><span class="s1">    SELECT [objectid], [indexid], [partitionnum], [frag], [page_count], [rowmodctr], [Priority], [OnlineRebuildSupport], [PartitionCount]</span>
</span><span id="__span-0-2032"><a id="__codelineno-0-2032" name="__codelineno-0-2032" href="#__codelineno-0-2032"></a>
</span><span id="__span-0-2033"><a id="__codelineno-0-2033" name="__codelineno-0-2033" href="#__codelineno-0-2033"></a><span class="s1">    FROM #MaintenanceCommandsTempCached;</span>
</span><span id="__span-0-2034"><a id="__codelineno-0-2034" name="__codelineno-0-2034" href="#__codelineno-0-2034"></a>
</span><span id="__span-0-2035"><a id="__codelineno-0-2035" name="__codelineno-0-2035" href="#__codelineno-0-2035"></a><span class="s1">END ELSE</span>
</span><span id="__span-0-2036"><a id="__codelineno-0-2036" name="__codelineno-0-2036" href="#__codelineno-0-2036"></a>
</span><span id="__span-0-2037"><a id="__codelineno-0-2037" name="__codelineno-0-2037" href="#__codelineno-0-2037"></a><span class="s1">BEGIN</span>
</span><span id="__span-0-2038"><a id="__codelineno-0-2038" name="__codelineno-0-2038" href="#__codelineno-0-2038"></a>
</span><span id="__span-0-2039"><a id="__codelineno-0-2039" name="__codelineno-0-2039" href="#__codelineno-0-2039"></a><span class="s1">    DECLARE partitions CURSOR FOR</span>
</span><span id="__span-0-2040"><a id="__codelineno-0-2040" name="__codelineno-0-2040" href="#__codelineno-0-2040"></a>
</span><span id="__span-0-2041"><a id="__codelineno-0-2041" name="__codelineno-0-2041" href="#__codelineno-0-2041"></a><span class="s1">    SELECT [objectid], [indexid], [partitionnum], [frag], [page_count], [rowmodctr], [Priority], [OnlineRebuildSupport], [PartitionCount]</span>
</span><span id="__span-0-2042"><a id="__codelineno-0-2042" name="__codelineno-0-2042" href="#__codelineno-0-2042"></a>
</span><span id="__span-0-2043"><a id="__codelineno-0-2043" name="__codelineno-0-2043" href="#__codelineno-0-2043"></a><span class="s1">    FROM #MaintenanceCommandsTemp;</span>
</span><span id="__span-0-2044"><a id="__codelineno-0-2044" name="__codelineno-0-2044" href="#__codelineno-0-2044"></a>
</span><span id="__span-0-2045"><a id="__codelineno-0-2045" name="__codelineno-0-2045" href="#__codelineno-0-2045"></a><span class="s1">END</span>
</span><span id="__span-0-2046"><a id="__codelineno-0-2046" name="__codelineno-0-2046" href="#__codelineno-0-2046"></a>
</span><span id="__span-0-2047"><a id="__codelineno-0-2047" name="__codelineno-0-2047" href="#__codelineno-0-2047"></a>
</span><span id="__span-0-2048"><a id="__codelineno-0-2048" name="__codelineno-0-2048" href="#__codelineno-0-2048"></a>
</span><span id="__span-0-2049"><a id="__codelineno-0-2049" name="__codelineno-0-2049" href="#__codelineno-0-2049"></a><span class="s1">OPEN partitions;</span>
</span><span id="__span-0-2050"><a id="__codelineno-0-2050" name="__codelineno-0-2050" href="#__codelineno-0-2050"></a>
</span><span id="__span-0-2051"><a id="__codelineno-0-2051" name="__codelineno-0-2051" href="#__codelineno-0-2051"></a><span class="s1">WHILE (1=1)</span>
</span><span id="__span-0-2052"><a id="__codelineno-0-2052" name="__codelineno-0-2052" href="#__codelineno-0-2052"></a>
</span><span id="__span-0-2053"><a id="__codelineno-0-2053" name="__codelineno-0-2053" href="#__codelineno-0-2053"></a><span class="s1">BEGIN</span>
</span><span id="__span-0-2054"><a id="__codelineno-0-2054" name="__codelineno-0-2054" href="#__codelineno-0-2054"></a>
</span><span id="__span-0-2055"><a id="__codelineno-0-2055" name="__codelineno-0-2055" href="#__codelineno-0-2055"></a><span class="s1">    FETCH NEXT FROM partitions INTO @ObjectID, @IndexID, @PartitionNum, @frag, @PageCount, @RowModCtr, @Priority, @OnlineRebuildSupport, @PartitionCount;</span>
</span><span id="__span-0-2056"><a id="__codelineno-0-2056" name="__codelineno-0-2056" href="#__codelineno-0-2056"></a>
</span><span id="__span-0-2057"><a id="__codelineno-0-2057" name="__codelineno-0-2057" href="#__codelineno-0-2057"></a><span class="s1">    IF @@FETCH_STATUS &lt; 0 BREAK;</span>
</span><span id="__span-0-2058"><a id="__codelineno-0-2058" name="__codelineno-0-2058" href="#__codelineno-0-2058"></a>
</span><span id="__span-0-2059"><a id="__codelineno-0-2059" name="__codelineno-0-2059" href="#__codelineno-0-2059"></a>
</span><span id="__span-0-2060"><a id="__codelineno-0-2060" name="__codelineno-0-2060" href="#__codelineno-0-2060"></a>
</span><span id="__span-0-2061"><a id="__codelineno-0-2061" name="__codelineno-0-2061" href="#__codelineno-0-2061"></a><span class="s1">    SELECT @ObjectName = QUOTENAME([o].[name]), @SchemaName = QUOTENAME([s].[name])</span>
</span><span id="__span-0-2062"><a id="__codelineno-0-2062" name="__codelineno-0-2062" href="#__codelineno-0-2062"></a>
</span><span id="__span-0-2063"><a id="__codelineno-0-2063" name="__codelineno-0-2063" href="#__codelineno-0-2063"></a><span class="s1">    FROM sys.objects AS o</span>
</span><span id="__span-0-2064"><a id="__codelineno-0-2064" name="__codelineno-0-2064" href="#__codelineno-0-2064"></a>
</span><span id="__span-0-2065"><a id="__codelineno-0-2065" name="__codelineno-0-2065" href="#__codelineno-0-2065"></a><span class="s1">        JOIN sys.schemas AS s ON [s].[schema_id] = [o].[schema_id]</span>
</span><span id="__span-0-2066"><a id="__codelineno-0-2066" name="__codelineno-0-2066" href="#__codelineno-0-2066"></a>
</span><span id="__span-0-2067"><a id="__codelineno-0-2067" name="__codelineno-0-2067" href="#__codelineno-0-2067"></a><span class="s1">    WHERE [o].[object_id] = @ObjectID;</span>
</span><span id="__span-0-2068"><a id="__codelineno-0-2068" name="__codelineno-0-2068" href="#__codelineno-0-2068"></a>
</span><span id="__span-0-2069"><a id="__codelineno-0-2069" name="__codelineno-0-2069" href="#__codelineno-0-2069"></a><span class="s1">    SELECT @IndexName = QUOTENAME(name)</span>
</span><span id="__span-0-2070"><a id="__codelineno-0-2070" name="__codelineno-0-2070" href="#__codelineno-0-2070"></a>
</span><span id="__span-0-2071"><a id="__codelineno-0-2071" name="__codelineno-0-2071" href="#__codelineno-0-2071"></a><span class="s1">    FROM sys.indexes</span>
</span><span id="__span-0-2072"><a id="__codelineno-0-2072" name="__codelineno-0-2072" href="#__codelineno-0-2072"></a>
</span><span id="__span-0-2073"><a id="__codelineno-0-2073" name="__codelineno-0-2073" href="#__codelineno-0-2073"></a><span class="s1">    WHERE [object_id] = @ObjectID AND [index_id] = @IndexID;</span>
</span><span id="__span-0-2074"><a id="__codelineno-0-2074" name="__codelineno-0-2074" href="#__codelineno-0-2074"></a>
</span><span id="__span-0-2075"><a id="__codelineno-0-2075" name="__codelineno-0-2075" href="#__codelineno-0-2075"></a>
</span><span id="__span-0-2076"><a id="__codelineno-0-2076" name="__codelineno-0-2076" href="#__codelineno-0-2076"></a>
</span><span id="__span-0-2077"><a id="__codelineno-0-2077" name="__codelineno-0-2077" href="#__codelineno-0-2077"></a><span class="s1">    SET @CommandSpecial = '''';</span>
</span><span id="__span-0-2078"><a id="__codelineno-0-2078" name="__codelineno-0-2078" href="#__codelineno-0-2078"></a>
</span><span id="__span-0-2079"><a id="__codelineno-0-2079" name="__codelineno-0-2079" href="#__codelineno-0-2079"></a><span class="s1">    SET @Command = '''';</span>
</span><span id="__span-0-2080"><a id="__codelineno-0-2080" name="__codelineno-0-2080" href="#__codelineno-0-2080"></a>
</span><span id="__span-0-2081"><a id="__codelineno-0-2081" name="__codelineno-0-2081" href="#__codelineno-0-2081"></a><span class="s1">    -- Реорганизация индекса</span>
</span><span id="__span-0-2082"><a id="__codelineno-0-2082" name="__codelineno-0-2082" href="#__codelineno-0-2082"></a>
</span><span id="__span-0-2083"><a id="__codelineno-0-2083" name="__codelineno-0-2083" href="#__codelineno-0-2083"></a><span class="s1">    IF @Priority &gt; 10 -- Приоритет обслуживания не большой</span>
</span><span id="__span-0-2084"><a id="__codelineno-0-2084" name="__codelineno-0-2084" href="#__codelineno-0-2084"></a>
</span><span id="__span-0-2085"><a id="__codelineno-0-2085" name="__codelineno-0-2085" href="#__codelineno-0-2085"></a><span class="s1">        AND @frag &lt;= @fragmentationPercentForRebuild -- Процент фрагментации небольшой</span>
</span><span id="__span-0-2086"><a id="__codelineno-0-2086" name="__codelineno-0-2086" href="#__codelineno-0-2086"></a>
</span><span id="__span-0-2087"><a id="__codelineno-0-2087" name="__codelineno-0-2087" href="#__codelineno-0-2087"></a><span class="s1">        AND (@maxIndexSizeForReorganizingPages = 0 OR @PageCount &lt;= @maxIndexSizeForReorganizingPages) BEGIN -- Таблица меньше 50 ГБ</span>
</span><span id="__span-0-2088"><a id="__codelineno-0-2088" name="__codelineno-0-2088" href="#__codelineno-0-2088"></a>
</span><span id="__span-0-2089"><a id="__codelineno-0-2089" name="__codelineno-0-2089" href="#__codelineno-0-2089"></a><span class="s1">        SET @Command = N''ALTER INDEX '' + @IndexName + N'' ON '' + @SchemaName + N''.'' + @ObjectName + N'' REORGANIZE'';</span>
</span><span id="__span-0-2090"><a id="__codelineno-0-2090" name="__codelineno-0-2090" href="#__codelineno-0-2090"></a>
</span><span id="__span-0-2091"><a id="__codelineno-0-2091" name="__codelineno-0-2091" href="#__codelineno-0-2091"></a><span class="s1">        SET @Operation = ''REORGANIZE INDEX''</span>
</span><span id="__span-0-2092"><a id="__codelineno-0-2092" name="__codelineno-0-2092" href="#__codelineno-0-2092"></a>
</span><span id="__span-0-2093"><a id="__codelineno-0-2093" name="__codelineno-0-2093" href="#__codelineno-0-2093"></a><span class="s1">    END ELSE IF(@useOnlineIndexRebuild = 0) -- Не использовать онлайн-перестроение</span>
</span><span id="__span-0-2094"><a id="__codelineno-0-2094" name="__codelineno-0-2094" href="#__codelineno-0-2094"></a>
</span><span id="__span-0-2095"><a id="__codelineno-0-2095" name="__codelineno-0-2095" href="#__codelineno-0-2095"></a><span class="s1">    BEGIN</span>
</span><span id="__span-0-2096"><a id="__codelineno-0-2096" name="__codelineno-0-2096" href="#__codelineno-0-2096"></a>
</span><span id="__span-0-2097"><a id="__codelineno-0-2097" name="__codelineno-0-2097" href="#__codelineno-0-2097"></a><span class="s1">        SET @Command = N''ALTER INDEX '' + @IndexName + N'' ON '' + @SchemaName + N''.'' + @ObjectName</span>
</span><span id="__span-0-2098"><a id="__codelineno-0-2098" name="__codelineno-0-2098" href="#__codelineno-0-2098"></a>
</span><span id="__span-0-2099"><a id="__codelineno-0-2099" name="__codelineno-0-2099" href="#__codelineno-0-2099"></a><span class="s1">            + N'' REBUILD WITH (MAXDOP='' + CAST(@MaxDop AS nvarchar(10)) + '')'';</span>
</span><span id="__span-0-2100"><a id="__codelineno-0-2100" name="__codelineno-0-2100" href="#__codelineno-0-2100"></a>
</span><span id="__span-0-2101"><a id="__codelineno-0-2101" name="__codelineno-0-2101" href="#__codelineno-0-2101"></a><span class="s1">        SET @Operation = ''REBUILD INDEX''</span>
</span><span id="__span-0-2102"><a id="__codelineno-0-2102" name="__codelineno-0-2102" href="#__codelineno-0-2102"></a>
</span><span id="__span-0-2103"><a id="__codelineno-0-2103" name="__codelineno-0-2103" href="#__codelineno-0-2103"></a><span class="s1">    END ELSE IF (@useOnlineIndexRebuild = 1 AND @OnlineRebuildSupport = 1) -- Только с поддержкой онлайн перестроения</span>
</span><span id="__span-0-2104"><a id="__codelineno-0-2104" name="__codelineno-0-2104" href="#__codelineno-0-2104"></a>
</span><span id="__span-0-2105"><a id="__codelineno-0-2105" name="__codelineno-0-2105" href="#__codelineno-0-2105"></a><span class="s1">    BEGIN</span>
</span><span id="__span-0-2106"><a id="__codelineno-0-2106" name="__codelineno-0-2106" href="#__codelineno-0-2106"></a>
</span><span id="__span-0-2107"><a id="__codelineno-0-2107" name="__codelineno-0-2107" href="#__codelineno-0-2107"></a><span class="s1">        SET @CommandSpecial = N''ALTER INDEX '' + @IndexName + N'' ON '' + @SchemaName + N''.'' + @ObjectName</span>
</span><span id="__span-0-2108"><a id="__codelineno-0-2108" name="__codelineno-0-2108" href="#__codelineno-0-2108"></a>
</span><span id="__span-0-2109"><a id="__codelineno-0-2109" name="__codelineno-0-2109" href="#__codelineno-0-2109"></a><span class="s1">            + N'' REBUILD WITH (MAXDOP='' + CAST(@MaxDop AS nvarchar(10)) + '','' </span>
</span><span id="__span-0-2110"><a id="__codelineno-0-2110" name="__codelineno-0-2110" href="#__codelineno-0-2110"></a>
</span><span id="__span-0-2111"><a id="__codelineno-0-2111" name="__codelineno-0-2111" href="#__codelineno-0-2111"></a><span class="s1">            + (CASE WHEN @useResumableIndexRebuild &gt; 0 THEN '' RESUMABLE = ON, '' ELSE '''' END) </span>
</span><span id="__span-0-2112"><a id="__codelineno-0-2112" name="__codelineno-0-2112" href="#__codelineno-0-2112"></a>
</span><span id="__span-0-2113"><a id="__codelineno-0-2113" name="__codelineno-0-2113" href="#__codelineno-0-2113"></a><span class="s1">            + '' ONLINE = ON (WAIT_AT_LOW_PRIORITY ( MAX_DURATION = '</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">onlineRebuildWaitMinutes</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">' MINUTES, ABORT_AFTER_WAIT = '</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">abortAfterWaitOnlineRebuil</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">')))'';</span>
</span><span id="__span-0-2114"><a id="__codelineno-0-2114" name="__codelineno-0-2114" href="#__codelineno-0-2114"></a>
</span><span id="__span-0-2115"><a id="__codelineno-0-2115" name="__codelineno-0-2115" href="#__codelineno-0-2115"></a><span class="s1">        SET @Operation = ''REBUILD INDEX''</span>
</span><span id="__span-0-2116"><a id="__codelineno-0-2116" name="__codelineno-0-2116" href="#__codelineno-0-2116"></a>
</span><span id="__span-0-2117"><a id="__codelineno-0-2117" name="__codelineno-0-2117" href="#__codelineno-0-2117"></a><span class="s1">    END ELSE IF(@useOnlineIndexRebuild = 2 AND @OnlineRebuildSupport = 0) -- Только без поддержки</span>
</span><span id="__span-0-2118"><a id="__codelineno-0-2118" name="__codelineno-0-2118" href="#__codelineno-0-2118"></a>
</span><span id="__span-0-2119"><a id="__codelineno-0-2119" name="__codelineno-0-2119" href="#__codelineno-0-2119"></a><span class="s1">    BEGIN</span>
</span><span id="__span-0-2120"><a id="__codelineno-0-2120" name="__codelineno-0-2120" href="#__codelineno-0-2120"></a>
</span><span id="__span-0-2121"><a id="__codelineno-0-2121" name="__codelineno-0-2121" href="#__codelineno-0-2121"></a><span class="s1">        SET @Command = N''ALTER INDEX '' + @IndexName + N'' ON '' + @SchemaName + N''.'' + @ObjectName</span>
</span><span id="__span-0-2122"><a id="__codelineno-0-2122" name="__codelineno-0-2122" href="#__codelineno-0-2122"></a>
</span><span id="__span-0-2123"><a id="__codelineno-0-2123" name="__codelineno-0-2123" href="#__codelineno-0-2123"></a><span class="s1">            + N'' REBUILD WITH (MAXDOP='' + CAST(@MaxDop AS nvarchar(10)) + '')'';</span>
</span><span id="__span-0-2124"><a id="__codelineno-0-2124" name="__codelineno-0-2124" href="#__codelineno-0-2124"></a>
</span><span id="__span-0-2125"><a id="__codelineno-0-2125" name="__codelineno-0-2125" href="#__codelineno-0-2125"></a><span class="s1">        SET @Operation = ''REBUILD INDEX''</span>
</span><span id="__span-0-2126"><a id="__codelineno-0-2126" name="__codelineno-0-2126" href="#__codelineno-0-2126"></a>
</span><span id="__span-0-2127"><a id="__codelineno-0-2127" name="__codelineno-0-2127" href="#__codelineno-0-2127"></a><span class="s1">    END ELSE IF(@useOnlineIndexRebuild = 3) -- Использовать онлайн перестроение где возможно</span>
</span><span id="__span-0-2128"><a id="__codelineno-0-2128" name="__codelineno-0-2128" href="#__codelineno-0-2128"></a>
</span><span id="__span-0-2129"><a id="__codelineno-0-2129" name="__codelineno-0-2129" href="#__codelineno-0-2129"></a><span class="s1">    BEGIN</span>
</span><span id="__span-0-2130"><a id="__codelineno-0-2130" name="__codelineno-0-2130" href="#__codelineno-0-2130"></a>
</span><span id="__span-0-2131"><a id="__codelineno-0-2131" name="__codelineno-0-2131" href="#__codelineno-0-2131"></a><span class="s1">        if(@OnlineRebuildSupport = 1)</span>
</span><span id="__span-0-2132"><a id="__codelineno-0-2132" name="__codelineno-0-2132" href="#__codelineno-0-2132"></a>
</span><span id="__span-0-2133"><a id="__codelineno-0-2133" name="__codelineno-0-2133" href="#__codelineno-0-2133"></a><span class="s1">        BEGIN</span>
</span><span id="__span-0-2134"><a id="__codelineno-0-2134" name="__codelineno-0-2134" href="#__codelineno-0-2134"></a>
</span><span id="__span-0-2135"><a id="__codelineno-0-2135" name="__codelineno-0-2135" href="#__codelineno-0-2135"></a><span class="s1">            SET @CommandSpecial = N''ALTER INDEX '' + @IndexName + N'' ON '' + @SchemaName + N''.'' + @ObjectName</span>
</span><span id="__span-0-2136"><a id="__codelineno-0-2136" name="__codelineno-0-2136" href="#__codelineno-0-2136"></a>
</span><span id="__span-0-2137"><a id="__codelineno-0-2137" name="__codelineno-0-2137" href="#__codelineno-0-2137"></a><span class="s1">                + N'' REBUILD WITH (MAXDOP='' + CAST(@MaxDop AS nvarchar(10)) + '',ONLINE = ON (WAIT_AT_LOW_PRIORITY ( MAX_DURATION = '</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">onlineRebuildWaitMinutes</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">' MINUTES, ABORT_AFTER_WAIT = '</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">abortAfterWaitOnlineRebuil</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">')))'';        </span>
</span><span id="__span-0-2138"><a id="__codelineno-0-2138" name="__codelineno-0-2138" href="#__codelineno-0-2138"></a>
</span><span id="__span-0-2139"><a id="__codelineno-0-2139" name="__codelineno-0-2139" href="#__codelineno-0-2139"></a><span class="s1">        END ELSE</span>
</span><span id="__span-0-2140"><a id="__codelineno-0-2140" name="__codelineno-0-2140" href="#__codelineno-0-2140"></a>
</span><span id="__span-0-2141"><a id="__codelineno-0-2141" name="__codelineno-0-2141" href="#__codelineno-0-2141"></a><span class="s1">        BEGIN</span>
</span><span id="__span-0-2142"><a id="__codelineno-0-2142" name="__codelineno-0-2142" href="#__codelineno-0-2142"></a>
</span><span id="__span-0-2143"><a id="__codelineno-0-2143" name="__codelineno-0-2143" href="#__codelineno-0-2143"></a><span class="s1">            SET @Command = N''ALTER INDEX '' + @IndexName + N'' ON '' + @SchemaName + N''.'' + @ObjectName</span>
</span><span id="__span-0-2144"><a id="__codelineno-0-2144" name="__codelineno-0-2144" href="#__codelineno-0-2144"></a>
</span><span id="__span-0-2145"><a id="__codelineno-0-2145" name="__codelineno-0-2145" href="#__codelineno-0-2145"></a><span class="s1">                + N'' REBUILD WITH (MAXDOP='' + CAST(@MaxDop AS nvarchar(10)) + '')'';</span>
</span><span id="__span-0-2146"><a id="__codelineno-0-2146" name="__codelineno-0-2146" href="#__codelineno-0-2146"></a>
</span><span id="__span-0-2147"><a id="__codelineno-0-2147" name="__codelineno-0-2147" href="#__codelineno-0-2147"></a><span class="s1">        END</span>
</span><span id="__span-0-2148"><a id="__codelineno-0-2148" name="__codelineno-0-2148" href="#__codelineno-0-2148"></a>
</span><span id="__span-0-2149"><a id="__codelineno-0-2149" name="__codelineno-0-2149" href="#__codelineno-0-2149"></a><span class="s1">        SET @Operation = ''REBUILD INDEX''</span>
</span><span id="__span-0-2150"><a id="__codelineno-0-2150" name="__codelineno-0-2150" href="#__codelineno-0-2150"></a>
</span><span id="__span-0-2151"><a id="__codelineno-0-2151" name="__codelineno-0-2151" href="#__codelineno-0-2151"></a><span class="s1">    END</span>
</span><span id="__span-0-2152"><a id="__codelineno-0-2152" name="__codelineno-0-2152" href="#__codelineno-0-2152"></a>
</span><span id="__span-0-2153"><a id="__codelineno-0-2153" name="__codelineno-0-2153" href="#__codelineno-0-2153"></a><span class="s1">    IF (@PartitionCount &gt; 1 AND @Command &lt;&gt; '''')</span>
</span><span id="__span-0-2154"><a id="__codelineno-0-2154" name="__codelineno-0-2154" href="#__codelineno-0-2154"></a>
</span><span id="__span-0-2155"><a id="__codelineno-0-2155" name="__codelineno-0-2155" href="#__codelineno-0-2155"></a><span class="s1">        SET @Command = @Command + N'' PARTITION='' + CAST(@PartitionNum AS nvarchar(10));</span>
</span><span id="__span-0-2156"><a id="__codelineno-0-2156" name="__codelineno-0-2156" href="#__codelineno-0-2156"></a>
</span><span id="__span-0-2157"><a id="__codelineno-0-2157" name="__codelineno-0-2157" href="#__codelineno-0-2157"></a>
</span><span id="__span-0-2158"><a id="__codelineno-0-2158" name="__codelineno-0-2158" href="#__codelineno-0-2158"></a>
</span><span id="__span-0-2159"><a id="__codelineno-0-2159" name="__codelineno-0-2159" href="#__codelineno-0-2159"></a><span class="s1">    SET @Command = LTRIM(RTRIM(@Command));</span>
</span><span id="__span-0-2160"><a id="__codelineno-0-2160" name="__codelineno-0-2160" href="#__codelineno-0-2160"></a>
</span><span id="__span-0-2161"><a id="__codelineno-0-2161" name="__codelineno-0-2161" href="#__codelineno-0-2161"></a><span class="s1">    SET @CommandSpecial = LTRIM(RTRIM(@CommandSpecial));</span>
</span><span id="__span-0-2162"><a id="__codelineno-0-2162" name="__codelineno-0-2162" href="#__codelineno-0-2162"></a>
</span><span id="__span-0-2163"><a id="__codelineno-0-2163" name="__codelineno-0-2163" href="#__codelineno-0-2163"></a><span class="s1">    IF(LEN(@Command) &gt; 0 OR LEN(@CommandSpecial) &gt; 0)</span>
</span><span id="__span-0-2164"><a id="__codelineno-0-2164" name="__codelineno-0-2164" href="#__codelineno-0-2164"></a>
</span><span id="__span-0-2165"><a id="__codelineno-0-2165" name="__codelineno-0-2165" href="#__codelineno-0-2165"></a><span class="s1">    BEGIN      </span>
</span><span id="__span-0-2166"><a id="__codelineno-0-2166" name="__codelineno-0-2166" href="#__codelineno-0-2166"></a>
</span><span id="__span-0-2167"><a id="__codelineno-0-2167" name="__codelineno-0-2167" href="#__codelineno-0-2167"></a><span class="s1">        INSERT #MaintenanceCommands</span>
</span><span id="__span-0-2168"><a id="__codelineno-0-2168" name="__codelineno-0-2168" href="#__codelineno-0-2168"></a>
</span><span id="__span-0-2169"><a id="__codelineno-0-2169" name="__codelineno-0-2169" href="#__codelineno-0-2169"></a><span class="s1">            ([Command], [CommandSpecial], [Table], [Object], [Rowmodctr], [Avg_fragmentation_in_percent], [Operation], [Priority], [OnlineRebuildSupport])</span>
</span><span id="__span-0-2170"><a id="__codelineno-0-2170" name="__codelineno-0-2170" href="#__codelineno-0-2170"></a>
</span><span id="__span-0-2171"><a id="__codelineno-0-2171" name="__codelineno-0-2171" href="#__codelineno-0-2171"></a><span class="s1">        VALUES</span>
</span><span id="__span-0-2172"><a id="__codelineno-0-2172" name="__codelineno-0-2172" href="#__codelineno-0-2172"></a>
</span><span id="__span-0-2173"><a id="__codelineno-0-2173" name="__codelineno-0-2173" href="#__codelineno-0-2173"></a><span class="s1">            (@Command, @CommandSpecial, @ObjectName, @IndexName, @RowModCtr, @frag, @Operation, @Priority, @OnlineRebuildSupport);</span>
</span><span id="__span-0-2174"><a id="__codelineno-0-2174" name="__codelineno-0-2174" href="#__codelineno-0-2174"></a>
</span><span id="__span-0-2175"><a id="__codelineno-0-2175" name="__codelineno-0-2175" href="#__codelineno-0-2175"></a><span class="s1">    END</span>
</span><span id="__span-0-2176"><a id="__codelineno-0-2176" name="__codelineno-0-2176" href="#__codelineno-0-2176"></a>
</span><span id="__span-0-2177"><a id="__codelineno-0-2177" name="__codelineno-0-2177" href="#__codelineno-0-2177"></a><span class="s1">END</span>
</span><span id="__span-0-2178"><a id="__codelineno-0-2178" name="__codelineno-0-2178" href="#__codelineno-0-2178"></a>
</span><span id="__span-0-2179"><a id="__codelineno-0-2179" name="__codelineno-0-2179" href="#__codelineno-0-2179"></a><span class="s1">CLOSE partitions;</span>
</span><span id="__span-0-2180"><a id="__codelineno-0-2180" name="__codelineno-0-2180" href="#__codelineno-0-2180"></a>
</span><span id="__span-0-2181"><a id="__codelineno-0-2181" name="__codelineno-0-2181" href="#__codelineno-0-2181"></a><span class="s1">DEALLOCATE partitions;</span>
</span><span id="__span-0-2182"><a id="__codelineno-0-2182" name="__codelineno-0-2182" href="#__codelineno-0-2182"></a>
</span><span id="__span-0-2183"><a id="__codelineno-0-2183" name="__codelineno-0-2183" href="#__codelineno-0-2183"></a><span class="s1">DECLARE todo CURSOR FOR</span>
</span><span id="__span-0-2184"><a id="__codelineno-0-2184" name="__codelineno-0-2184" href="#__codelineno-0-2184"></a>
</span><span id="__span-0-2185"><a id="__codelineno-0-2185" name="__codelineno-0-2185" href="#__codelineno-0-2185"></a><span class="s1">SELECT</span>
</span><span id="__span-0-2186"><a id="__codelineno-0-2186" name="__codelineno-0-2186" href="#__codelineno-0-2186"></a>
</span><span id="__span-0-2187"><a id="__codelineno-0-2187" name="__codelineno-0-2187" href="#__codelineno-0-2187"></a><span class="s1">    [Command],</span>
</span><span id="__span-0-2188"><a id="__codelineno-0-2188" name="__codelineno-0-2188" href="#__codelineno-0-2188"></a>
</span><span id="__span-0-2189"><a id="__codelineno-0-2189" name="__codelineno-0-2189" href="#__codelineno-0-2189"></a><span class="s1">    [CommandSpecial],</span>
</span><span id="__span-0-2190"><a id="__codelineno-0-2190" name="__codelineno-0-2190" href="#__codelineno-0-2190"></a>
</span><span id="__span-0-2191"><a id="__codelineno-0-2191" name="__codelineno-0-2191" href="#__codelineno-0-2191"></a><span class="s1">    [Table],</span>
</span><span id="__span-0-2192"><a id="__codelineno-0-2192" name="__codelineno-0-2192" href="#__codelineno-0-2192"></a>
</span><span id="__span-0-2193"><a id="__codelineno-0-2193" name="__codelineno-0-2193" href="#__codelineno-0-2193"></a><span class="s1">    [Object],</span>
</span><span id="__span-0-2194"><a id="__codelineno-0-2194" name="__codelineno-0-2194" href="#__codelineno-0-2194"></a>
</span><span id="__span-0-2195"><a id="__codelineno-0-2195" name="__codelineno-0-2195" href="#__codelineno-0-2195"></a><span class="s1">    [Operation],</span>
</span><span id="__span-0-2196"><a id="__codelineno-0-2196" name="__codelineno-0-2196" href="#__codelineno-0-2196"></a>
</span><span id="__span-0-2197"><a id="__codelineno-0-2197" name="__codelineno-0-2197" href="#__codelineno-0-2197"></a><span class="s1">    [OnlineRebuildSupport],</span>
</span><span id="__span-0-2198"><a id="__codelineno-0-2198" name="__codelineno-0-2198" href="#__codelineno-0-2198"></a>
</span><span id="__span-0-2199"><a id="__codelineno-0-2199" name="__codelineno-0-2199" href="#__codelineno-0-2199"></a><span class="s1">    [Rowmodctr],</span>
</span><span id="__span-0-2200"><a id="__codelineno-0-2200" name="__codelineno-0-2200" href="#__codelineno-0-2200"></a>
</span><span id="__span-0-2201"><a id="__codelineno-0-2201" name="__codelineno-0-2201" href="#__codelineno-0-2201"></a><span class="s1">    [Avg_fragmentation_in_percent]</span>
</span><span id="__span-0-2202"><a id="__codelineno-0-2202" name="__codelineno-0-2202" href="#__codelineno-0-2202"></a>
</span><span id="__span-0-2203"><a id="__codelineno-0-2203" name="__codelineno-0-2203" href="#__codelineno-0-2203"></a><span class="s1">FROM #MaintenanceCommands</span>
</span><span id="__span-0-2204"><a id="__codelineno-0-2204" name="__codelineno-0-2204" href="#__codelineno-0-2204"></a>
</span><span id="__span-0-2205"><a id="__codelineno-0-2205" name="__codelineno-0-2205" href="#__codelineno-0-2205"></a><span class="s1">ORDER BY</span>
</span><span id="__span-0-2206"><a id="__codelineno-0-2206" name="__codelineno-0-2206" href="#__codelineno-0-2206"></a>
</span><span id="__span-0-2207"><a id="__codelineno-0-2207" name="__codelineno-0-2207" href="#__codelineno-0-2207"></a><span class="s1">    [Priority],</span>
</span><span id="__span-0-2208"><a id="__codelineno-0-2208" name="__codelineno-0-2208" href="#__codelineno-0-2208"></a>
</span><span id="__span-0-2209"><a id="__codelineno-0-2209" name="__codelineno-0-2209" href="#__codelineno-0-2209"></a><span class="s1">    [Rowmodctr] DESC,</span>
</span><span id="__span-0-2210"><a id="__codelineno-0-2210" name="__codelineno-0-2210" href="#__codelineno-0-2210"></a>
</span><span id="__span-0-2211"><a id="__codelineno-0-2211" name="__codelineno-0-2211" href="#__codelineno-0-2211"></a><span class="s1">    [Avg_fragmentation_in_percent] DESC</span>
</span><span id="__span-0-2212"><a id="__codelineno-0-2212" name="__codelineno-0-2212" href="#__codelineno-0-2212"></a>
</span><span id="__span-0-2213"><a id="__codelineno-0-2213" name="__codelineno-0-2213" href="#__codelineno-0-2213"></a><span class="s1">OPEN todo;</span>
</span><span id="__span-0-2214"><a id="__codelineno-0-2214" name="__codelineno-0-2214" href="#__codelineno-0-2214"></a>
</span><span id="__span-0-2215"><a id="__codelineno-0-2215" name="__codelineno-0-2215" href="#__codelineno-0-2215"></a><span class="s1">WHILE 1=1</span>
</span><span id="__span-0-2216"><a id="__codelineno-0-2216" name="__codelineno-0-2216" href="#__codelineno-0-2216"></a>
</span><span id="__span-0-2217"><a id="__codelineno-0-2217" name="__codelineno-0-2217" href="#__codelineno-0-2217"></a><span class="s1">BEGIN</span>
</span><span id="__span-0-2218"><a id="__codelineno-0-2218" name="__codelineno-0-2218" href="#__codelineno-0-2218"></a>
</span><span id="__span-0-2219"><a id="__codelineno-0-2219" name="__codelineno-0-2219" href="#__codelineno-0-2219"></a><span class="s1">    FETCH NEXT FROM todo INTO @SQL, @SQLSpecial, @ObjectName, @IndexName, @Operation, @OnlineRebuildSupport, @RowModCtr, @AvgFragmentationPercent;</span>
</span><span id="__span-0-2220"><a id="__codelineno-0-2220" name="__codelineno-0-2220" href="#__codelineno-0-2220"></a>
</span><span id="__span-0-2221"><a id="__codelineno-0-2221" name="__codelineno-0-2221" href="#__codelineno-0-2221"></a>
</span><span id="__span-0-2222"><a id="__codelineno-0-2222" name="__codelineno-0-2222" href="#__codelineno-0-2222"></a>
</span><span id="__span-0-2223"><a id="__codelineno-0-2223" name="__codelineno-0-2223" href="#__codelineno-0-2223"></a><span class="s1">    IF @@FETCH_STATUS != 0    </span>
</span><span id="__span-0-2224"><a id="__codelineno-0-2224" name="__codelineno-0-2224" href="#__codelineno-0-2224"></a>
</span><span id="__span-0-2225"><a id="__codelineno-0-2225" name="__codelineno-0-2225" href="#__codelineno-0-2225"></a><span class="s1">        BREAK;</span>
</span><span id="__span-0-2226"><a id="__codelineno-0-2226" name="__codelineno-0-2226" href="#__codelineno-0-2226"></a>
</span><span id="__span-0-2227"><a id="__codelineno-0-2227" name="__codelineno-0-2227" href="#__codelineno-0-2227"></a><span class="s1">    -- Проверка доступен ли запуск обслуживания в текущее время</span>
</span><span id="__span-0-2228"><a id="__codelineno-0-2228" name="__codelineno-0-2228" href="#__codelineno-0-2228"></a>
</span><span id="__span-0-2229"><a id="__codelineno-0-2229" name="__codelineno-0-2229" href="#__codelineno-0-2229"></a><span class="s1">    SET @timeNow = CAST(GETDATE() AS TIME);</span>
</span><span id="__span-0-2230"><a id="__codelineno-0-2230" name="__codelineno-0-2230" href="#__codelineno-0-2230"></a>
</span><span id="__span-0-2231"><a id="__codelineno-0-2231" name="__codelineno-0-2231" href="#__codelineno-0-2231"></a><span class="s1">    IF (@timeTo &gt;= @timeFrom) BEGIN</span>
</span><span id="__span-0-2232"><a id="__codelineno-0-2232" name="__codelineno-0-2232" href="#__codelineno-0-2232"></a>
</span><span id="__span-0-2233"><a id="__codelineno-0-2233" name="__codelineno-0-2233" href="#__codelineno-0-2233"></a><span class="s1">        IF(NOT (@timeFrom &lt;= @timeNow AND @timeTo &gt;= @timeNow))</span>
</span><span id="__span-0-2234"><a id="__codelineno-0-2234" name="__codelineno-0-2234" href="#__codelineno-0-2234"></a>
</span><span id="__span-0-2235"><a id="__codelineno-0-2235" name="__codelineno-0-2235" href="#__codelineno-0-2235"></a><span class="s1">            RETURN;</span>
</span><span id="__span-0-2236"><a id="__codelineno-0-2236" name="__codelineno-0-2236" href="#__codelineno-0-2236"></a>
</span><span id="__span-0-2237"><a id="__codelineno-0-2237" name="__codelineno-0-2237" href="#__codelineno-0-2237"></a><span class="s1">    END ELSE BEGIN</span>
</span><span id="__span-0-2238"><a id="__codelineno-0-2238" name="__codelineno-0-2238" href="#__codelineno-0-2238"></a>
</span><span id="__span-0-2239"><a id="__codelineno-0-2239" name="__codelineno-0-2239" href="#__codelineno-0-2239"></a><span class="s1">        IF(NOT ((@timeFrom &lt;= @timeNow AND ''23:59:59'' &gt;= @timeNow)</span>
</span><span id="__span-0-2240"><a id="__codelineno-0-2240" name="__codelineno-0-2240" href="#__codelineno-0-2240"></a>
</span><span id="__span-0-2241"><a id="__codelineno-0-2241" name="__codelineno-0-2241" href="#__codelineno-0-2241"></a><span class="s1">            OR (@timeTo &gt;= @timeNow AND ''00:00:00'' &lt;= @timeNow))) </span>
</span><span id="__span-0-2242"><a id="__codelineno-0-2242" name="__codelineno-0-2242" href="#__codelineno-0-2242"></a>
</span><span id="__span-0-2243"><a id="__codelineno-0-2243" name="__codelineno-0-2243" href="#__codelineno-0-2243"></a><span class="s1">        RETURN;</span>
</span><span id="__span-0-2244"><a id="__codelineno-0-2244" name="__codelineno-0-2244" href="#__codelineno-0-2244"></a>
</span><span id="__span-0-2245"><a id="__codelineno-0-2245" name="__codelineno-0-2245" href="#__codelineno-0-2245"></a><span class="s1">    END</span>
</span><span id="__span-0-2246"><a id="__codelineno-0-2246" name="__codelineno-0-2246" href="#__codelineno-0-2246"></a>
</span><span id="__span-0-2247"><a id="__codelineno-0-2247" name="__codelineno-0-2247" href="#__codelineno-0-2247"></a>
</span><span id="__span-0-2248"><a id="__codelineno-0-2248" name="__codelineno-0-2248" href="#__codelineno-0-2248"></a>
</span><span id="__span-0-2249"><a id="__codelineno-0-2249" name="__codelineno-0-2249" href="#__codelineno-0-2249"></a><span class="s1">    -- Проверка процента занятого места в логе транзакций</span>
</span><span id="__span-0-2250"><a id="__codelineno-0-2250" name="__codelineno-0-2250" href="#__codelineno-0-2250"></a>
</span><span id="__span-0-2251"><a id="__codelineno-0-2251" name="__codelineno-0-2251" href="#__codelineno-0-2251"></a><span class="s1">    TRUNCATE TABLE #tranLogInfo;</span>
</span><span id="__span-0-2252"><a id="__codelineno-0-2252" name="__codelineno-0-2252" href="#__codelineno-0-2252"></a>
</span><span id="__span-0-2253"><a id="__codelineno-0-2253" name="__codelineno-0-2253" href="#__codelineno-0-2253"></a><span class="s1">    INSERT INTO #tranLogInfo (dbname,logsize,logspace,stat) exec(''dbcc sqlperf(logspace)'');</span>
</span><span id="__span-0-2254"><a id="__codelineno-0-2254" name="__codelineno-0-2254" href="#__codelineno-0-2254"></a>
</span><span id="__span-0-2255"><a id="__codelineno-0-2255" name="__codelineno-0-2255" href="#__codelineno-0-2255"></a><span class="s1">    SELECT</span>
</span><span id="__span-0-2256"><a id="__codelineno-0-2256" name="__codelineno-0-2256" href="#__codelineno-0-2256"></a>
</span><span id="__span-0-2257"><a id="__codelineno-0-2257" name="__codelineno-0-2257" href="#__codelineno-0-2257"></a><span class="s1">        @currentTransactionLogSizeUsagePercent = logspace,</span>
</span><span id="__span-0-2258"><a id="__codelineno-0-2258" name="__codelineno-0-2258" href="#__codelineno-0-2258"></a>
</span><span id="__span-0-2259"><a id="__codelineno-0-2259" name="__codelineno-0-2259" href="#__codelineno-0-2259"></a><span class="s1">        @currentTransactionLogSizeMB = logsize * (logspace / 100)</span>
</span><span id="__span-0-2260"><a id="__codelineno-0-2260" name="__codelineno-0-2260" href="#__codelineno-0-2260"></a>
</span><span id="__span-0-2261"><a id="__codelineno-0-2261" name="__codelineno-0-2261" href="#__codelineno-0-2261"></a><span class="s1">    FROM #tranLogInfo WHERE dbname = @databaseName</span>
</span><span id="__span-0-2262"><a id="__codelineno-0-2262" name="__codelineno-0-2262" href="#__codelineno-0-2262"></a>
</span><span id="__span-0-2263"><a id="__codelineno-0-2263" name="__codelineno-0-2263" href="#__codelineno-0-2263"></a><span class="s1">    IF(@currentTransactionLogSizeUsagePercent &gt;= @maxTransactionLogSizeUsagePercent)</span>
</span><span id="__span-0-2264"><a id="__codelineno-0-2264" name="__codelineno-0-2264" href="#__codelineno-0-2264"></a>
</span><span id="__span-0-2265"><a id="__codelineno-0-2265" name="__codelineno-0-2265" href="#__codelineno-0-2265"></a><span class="s1">    BEGIN</span>
</span><span id="__span-0-2266"><a id="__codelineno-0-2266" name="__codelineno-0-2266" href="#__codelineno-0-2266"></a>
</span><span id="__span-0-2267"><a id="__codelineno-0-2267" name="__codelineno-0-2267" href="#__codelineno-0-2267"></a><span class="s1">        -- Процент занятого места в файлах лога транзакций превышает указанный порог</span>
</span><span id="__span-0-2268"><a id="__codelineno-0-2268" name="__codelineno-0-2268" href="#__codelineno-0-2268"></a>
</span><span id="__span-0-2269"><a id="__codelineno-0-2269" name="__codelineno-0-2269" href="#__codelineno-0-2269"></a><span class="s1">        RETURN;</span>
</span><span id="__span-0-2270"><a id="__codelineno-0-2270" name="__codelineno-0-2270" href="#__codelineno-0-2270"></a>
</span><span id="__span-0-2271"><a id="__codelineno-0-2271" name="__codelineno-0-2271" href="#__codelineno-0-2271"></a><span class="s1">    END</span>
</span><span id="__span-0-2272"><a id="__codelineno-0-2272" name="__codelineno-0-2272" href="#__codelineno-0-2272"></a>
</span><span id="__span-0-2273"><a id="__codelineno-0-2273" name="__codelineno-0-2273" href="#__codelineno-0-2273"></a><span class="s1">    IF(@maxTransactionLogSizeMB &gt; 0 AND @currentTransactionLogSizeMB &gt; @maxTransactionLogSizeMB)</span>
</span><span id="__span-0-2274"><a id="__codelineno-0-2274" name="__codelineno-0-2274" href="#__codelineno-0-2274"></a>
</span><span id="__span-0-2275"><a id="__codelineno-0-2275" name="__codelineno-0-2275" href="#__codelineno-0-2275"></a><span class="s1">    BEGIN</span>
</span><span id="__span-0-2276"><a id="__codelineno-0-2276" name="__codelineno-0-2276" href="#__codelineno-0-2276"></a>
</span><span id="__span-0-2277"><a id="__codelineno-0-2277" name="__codelineno-0-2277" href="#__codelineno-0-2277"></a><span class="s1">        -- Размер занятого места в файлах лога транзакций превышает указанный порог в МБ</span>
</span><span id="__span-0-2278"><a id="__codelineno-0-2278" name="__codelineno-0-2278" href="#__codelineno-0-2278"></a>
</span><span id="__span-0-2279"><a id="__codelineno-0-2279" name="__codelineno-0-2279" href="#__codelineno-0-2279"></a><span class="s1">        RETURN;</span>
</span><span id="__span-0-2280"><a id="__codelineno-0-2280" name="__codelineno-0-2280" href="#__codelineno-0-2280"></a>
</span><span id="__span-0-2281"><a id="__codelineno-0-2281" name="__codelineno-0-2281" href="#__codelineno-0-2281"></a><span class="s1">    END</span>
</span><span id="__span-0-2282"><a id="__codelineno-0-2282" name="__codelineno-0-2282" href="#__codelineno-0-2282"></a>
</span><span id="__span-0-2283"><a id="__codelineno-0-2283" name="__codelineno-0-2283" href="#__codelineno-0-2283"></a>
</span><span id="__span-0-2284"><a id="__codelineno-0-2284" name="__codelineno-0-2284" href="#__codelineno-0-2284"></a>
</span><span id="__span-0-2285"><a id="__codelineno-0-2285" name="__codelineno-0-2285" href="#__codelineno-0-2285"></a><span class="s1">    SET @StartDate = GetDate();</span>
</span><span id="__span-0-2286"><a id="__codelineno-0-2286" name="__codelineno-0-2286" href="#__codelineno-0-2286"></a>
</span><span id="__span-0-2287"><a id="__codelineno-0-2287" name="__codelineno-0-2287" href="#__codelineno-0-2287"></a><span class="s1">    BEGIN TRY</span>
</span><span id="__span-0-2288"><a id="__codelineno-0-2288" name="__codelineno-0-2288" href="#__codelineno-0-2288"></a>
</span><span id="__span-0-2289"><a id="__codelineno-0-2289" name="__codelineno-0-2289" href="#__codelineno-0-2289"></a><span class="s1">        DECLARE @currentSQL nvarchar(max) = ''''</span>
</span><span id="__span-0-2290"><a id="__codelineno-0-2290" name="__codelineno-0-2290" href="#__codelineno-0-2290"></a>
</span><span id="__span-0-2291"><a id="__codelineno-0-2291" name="__codelineno-0-2291" href="#__codelineno-0-2291"></a><span class="s1">        SET @MaintenanceActionLogId = 0</span>
</span><span id="__span-0-2292"><a id="__codelineno-0-2292" name="__codelineno-0-2292" href="#__codelineno-0-2292"></a>
</span><span id="__span-0-2293"><a id="__codelineno-0-2293" name="__codelineno-0-2293" href="#__codelineno-0-2293"></a><span class="s1">        IF(@SQLSpecial = '''')</span>
</span><span id="__span-0-2294"><a id="__codelineno-0-2294" name="__codelineno-0-2294" href="#__codelineno-0-2294"></a>
</span><span id="__span-0-2295"><a id="__codelineno-0-2295" name="__codelineno-0-2295" href="#__codelineno-0-2295"></a><span class="s1">        BEGIN</span>
</span><span id="__span-0-2296"><a id="__codelineno-0-2296" name="__codelineno-0-2296" href="#__codelineno-0-2296"></a>
</span><span id="__span-0-2297"><a id="__codelineno-0-2297" name="__codelineno-0-2297" href="#__codelineno-0-2297"></a><span class="s1">            SET @currentSQL = @SQL</span>
</span><span id="__span-0-2298"><a id="__codelineno-0-2298" name="__codelineno-0-2298" href="#__codelineno-0-2298"></a>
</span><span id="__span-0-2299"><a id="__codelineno-0-2299" name="__codelineno-0-2299" href="#__codelineno-0-2299"></a><span class="s1">            SET @UseOnlineRebuild = 0;</span>
</span><span id="__span-0-2300"><a id="__codelineno-0-2300" name="__codelineno-0-2300" href="#__codelineno-0-2300"></a>
</span><span id="__span-0-2301"><a id="__codelineno-0-2301" name="__codelineno-0-2301" href="#__codelineno-0-2301"></a><span class="s1">        END ELSE</span>
</span><span id="__span-0-2302"><a id="__codelineno-0-2302" name="__codelineno-0-2302" href="#__codelineno-0-2302"></a>
</span><span id="__span-0-2303"><a id="__codelineno-0-2303" name="__codelineno-0-2303" href="#__codelineno-0-2303"></a><span class="s1">        BEGIN</span>
</span><span id="__span-0-2304"><a id="__codelineno-0-2304" name="__codelineno-0-2304" href="#__codelineno-0-2304"></a>
</span><span id="__span-0-2305"><a id="__codelineno-0-2305" name="__codelineno-0-2305" href="#__codelineno-0-2305"></a><span class="s1">            SET @UseOnlineRebuild = 1;</span>
</span><span id="__span-0-2306"><a id="__codelineno-0-2306" name="__codelineno-0-2306" href="#__codelineno-0-2306"></a>
</span><span id="__span-0-2307"><a id="__codelineno-0-2307" name="__codelineno-0-2307" href="#__codelineno-0-2307"></a><span class="s1">            SET @currentSQL = @SQLSpecial</span>
</span><span id="__span-0-2308"><a id="__codelineno-0-2308" name="__codelineno-0-2308" href="#__codelineno-0-2308"></a>
</span><span id="__span-0-2309"><a id="__codelineno-0-2309" name="__codelineno-0-2309" href="#__codelineno-0-2309"></a><span class="s1">        END</span>
</span><span id="__span-0-2310"><a id="__codelineno-0-2310" name="__codelineno-0-2310" href="#__codelineno-0-2310"></a>
</span><span id="__span-0-2311"><a id="__codelineno-0-2311" name="__codelineno-0-2311" href="#__codelineno-0-2311"></a><span class="s1">        -- Сохраняем предварительную информацию об операции обслуживания без даты завершения</span>
</span><span id="__span-0-2312"><a id="__codelineno-0-2312" name="__codelineno-0-2312" href="#__codelineno-0-2312"></a>
</span><span id="__span-0-2313"><a id="__codelineno-0-2313" name="__codelineno-0-2313" href="#__codelineno-0-2313"></a><span class="s1">        IF(@useMonitoringDatabase = 1)</span>
</span><span id="__span-0-2314"><a id="__codelineno-0-2314" name="__codelineno-0-2314" href="#__codelineno-0-2314"></a>
</span><span id="__span-0-2315"><a id="__codelineno-0-2315" name="__codelineno-0-2315" href="#__codelineno-0-2315"></a><span class="s1">        BEGIN</span>
</span><span id="__span-0-2316"><a id="__codelineno-0-2316" name="__codelineno-0-2316" href="#__codelineno-0-2316"></a>
</span><span id="__span-0-2317"><a id="__codelineno-0-2317" name="__codelineno-0-2317" href="#__codelineno-0-2317"></a><span class="s1">            EXECUTE ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'].[dbo].[sp_add_maintenance_action_log]</span>
</span><span id="__span-0-2318"><a id="__codelineno-0-2318" name="__codelineno-0-2318" href="#__codelineno-0-2318"></a>
</span><span id="__span-0-2319"><a id="__codelineno-0-2319" name="__codelineno-0-2319" href="#__codelineno-0-2319"></a><span class="s1">            @ObjectName</span>
</span><span id="__span-0-2320"><a id="__codelineno-0-2320" name="__codelineno-0-2320" href="#__codelineno-0-2320"></a>
</span><span id="__span-0-2321"><a id="__codelineno-0-2321" name="__codelineno-0-2321" href="#__codelineno-0-2321"></a><span class="s1">            ,@IndexName</span>
</span><span id="__span-0-2322"><a id="__codelineno-0-2322" name="__codelineno-0-2322" href="#__codelineno-0-2322"></a>
</span><span id="__span-0-2323"><a id="__codelineno-0-2323" name="__codelineno-0-2323" href="#__codelineno-0-2323"></a><span class="s1">            ,@Operation</span>
</span><span id="__span-0-2324"><a id="__codelineno-0-2324" name="__codelineno-0-2324" href="#__codelineno-0-2324"></a>
</span><span id="__span-0-2325"><a id="__codelineno-0-2325" name="__codelineno-0-2325" href="#__codelineno-0-2325"></a><span class="s1">            ,@RunDate</span>
</span><span id="__span-0-2326"><a id="__codelineno-0-2326" name="__codelineno-0-2326" href="#__codelineno-0-2326"></a>
</span><span id="__span-0-2327"><a id="__codelineno-0-2327" name="__codelineno-0-2327" href="#__codelineno-0-2327"></a><span class="s1">            ,@StartDate</span>
</span><span id="__span-0-2328"><a id="__codelineno-0-2328" name="__codelineno-0-2328" href="#__codelineno-0-2328"></a>
</span><span id="__span-0-2329"><a id="__codelineno-0-2329" name="__codelineno-0-2329" href="#__codelineno-0-2329"></a><span class="s1">            ,null</span>
</span><span id="__span-0-2330"><a id="__codelineno-0-2330" name="__codelineno-0-2330" href="#__codelineno-0-2330"></a>
</span><span id="__span-0-2331"><a id="__codelineno-0-2331" name="__codelineno-0-2331" href="#__codelineno-0-2331"></a><span class="s1">            ,@DBNAME</span>
</span><span id="__span-0-2332"><a id="__codelineno-0-2332" name="__codelineno-0-2332" href="#__codelineno-0-2332"></a>
</span><span id="__span-0-2333"><a id="__codelineno-0-2333" name="__codelineno-0-2333" href="#__codelineno-0-2333"></a><span class="s1">            ,@UseOnlineRebuild</span>
</span><span id="__span-0-2334"><a id="__codelineno-0-2334" name="__codelineno-0-2334" href="#__codelineno-0-2334"></a>
</span><span id="__span-0-2335"><a id="__codelineno-0-2335" name="__codelineno-0-2335" href="#__codelineno-0-2335"></a><span class="s1">            ,''''</span>
</span><span id="__span-0-2336"><a id="__codelineno-0-2336" name="__codelineno-0-2336" href="#__codelineno-0-2336"></a>
</span><span id="__span-0-2337"><a id="__codelineno-0-2337" name="__codelineno-0-2337" href="#__codelineno-0-2337"></a><span class="s1">            ,@AvgFragmentationPercent</span>
</span><span id="__span-0-2338"><a id="__codelineno-0-2338" name="__codelineno-0-2338" href="#__codelineno-0-2338"></a>
</span><span id="__span-0-2339"><a id="__codelineno-0-2339" name="__codelineno-0-2339" href="#__codelineno-0-2339"></a><span class="s1">            ,@RowModCtr</span>
</span><span id="__span-0-2340"><a id="__codelineno-0-2340" name="__codelineno-0-2340" href="#__codelineno-0-2340"></a>
</span><span id="__span-0-2341"><a id="__codelineno-0-2341" name="__codelineno-0-2341" href="#__codelineno-0-2341"></a><span class="s1">            ,@currentSQL</span>
</span><span id="__span-0-2342"><a id="__codelineno-0-2342" name="__codelineno-0-2342" href="#__codelineno-0-2342"></a>
</span><span id="__span-0-2343"><a id="__codelineno-0-2343" name="__codelineno-0-2343" href="#__codelineno-0-2343"></a><span class="s1">            ,@MaintenanceActionLogId OUTPUT;</span>
</span><span id="__span-0-2344"><a id="__codelineno-0-2344" name="__codelineno-0-2344" href="#__codelineno-0-2344"></a>
</span><span id="__span-0-2345"><a id="__codelineno-0-2345" name="__codelineno-0-2345" href="#__codelineno-0-2345"></a><span class="s1">        END</span>
</span><span id="__span-0-2346"><a id="__codelineno-0-2346" name="__codelineno-0-2346" href="#__codelineno-0-2346"></a>
</span><span id="__span-0-2347"><a id="__codelineno-0-2347" name="__codelineno-0-2347" href="#__codelineno-0-2347"></a><span class="s1">        EXEC sp_executesql @currentSQL;</span>
</span><span id="__span-0-2348"><a id="__codelineno-0-2348" name="__codelineno-0-2348" href="#__codelineno-0-2348"></a>
</span><span id="__span-0-2349"><a id="__codelineno-0-2349" name="__codelineno-0-2349" href="#__codelineno-0-2349"></a><span class="s1">        SET @FinishDate = GetDate();</span>
</span><span id="__span-0-2350"><a id="__codelineno-0-2350" name="__codelineno-0-2350" href="#__codelineno-0-2350"></a>
</span><span id="__span-0-2351"><a id="__codelineno-0-2351" name="__codelineno-0-2351" href="#__codelineno-0-2351"></a>
</span><span id="__span-0-2352"><a id="__codelineno-0-2352" name="__codelineno-0-2352" href="#__codelineno-0-2352"></a>
</span><span id="__span-0-2353"><a id="__codelineno-0-2353" name="__codelineno-0-2353" href="#__codelineno-0-2353"></a><span class="s1">        -- Устанавливаем фактическую дату завершения операции</span>
</span><span id="__span-0-2354"><a id="__codelineno-0-2354" name="__codelineno-0-2354" href="#__codelineno-0-2354"></a>
</span><span id="__span-0-2355"><a id="__codelineno-0-2355" name="__codelineno-0-2355" href="#__codelineno-0-2355"></a><span class="s1">        IF(@useMonitoringDatabase = 1)</span>
</span><span id="__span-0-2356"><a id="__codelineno-0-2356" name="__codelineno-0-2356" href="#__codelineno-0-2356"></a>
</span><span id="__span-0-2357"><a id="__codelineno-0-2357" name="__codelineno-0-2357" href="#__codelineno-0-2357"></a><span class="s1">        BEGIN</span>
</span><span id="__span-0-2358"><a id="__codelineno-0-2358" name="__codelineno-0-2358" href="#__codelineno-0-2358"></a>
</span><span id="__span-0-2359"><a id="__codelineno-0-2359" name="__codelineno-0-2359" href="#__codelineno-0-2359"></a><span class="s1">            EXECUTE ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'].[dbo].[sp_set_maintenance_action_log_finish_date]</span>
</span><span id="__span-0-2360"><a id="__codelineno-0-2360" name="__codelineno-0-2360" href="#__codelineno-0-2360"></a>
</span><span id="__span-0-2361"><a id="__codelineno-0-2361" name="__codelineno-0-2361" href="#__codelineno-0-2361"></a><span class="s1">                @MaintenanceActionLogId,</span>
</span><span id="__span-0-2362"><a id="__codelineno-0-2362" name="__codelineno-0-2362" href="#__codelineno-0-2362"></a>
</span><span id="__span-0-2363"><a id="__codelineno-0-2363" name="__codelineno-0-2363" href="#__codelineno-0-2363"></a><span class="s1">                @FinishDate;</span>
</span><span id="__span-0-2364"><a id="__codelineno-0-2364" name="__codelineno-0-2364" href="#__codelineno-0-2364"></a>
</span><span id="__span-0-2365"><a id="__codelineno-0-2365" name="__codelineno-0-2365" href="#__codelineno-0-2365"></a><span class="s1">        END </span>
</span><span id="__span-0-2366"><a id="__codelineno-0-2366" name="__codelineno-0-2366" href="#__codelineno-0-2366"></a>
</span><span id="__span-0-2367"><a id="__codelineno-0-2367" name="__codelineno-0-2367" href="#__codelineno-0-2367"></a><span class="s1">    END  TRY   </span>
</span><span id="__span-0-2368"><a id="__codelineno-0-2368" name="__codelineno-0-2368" href="#__codelineno-0-2368"></a>
</span><span id="__span-0-2369"><a id="__codelineno-0-2369" name="__codelineno-0-2369" href="#__codelineno-0-2369"></a><span class="s1">    BEGIN CATCH</span>
</span><span id="__span-0-2370"><a id="__codelineno-0-2370" name="__codelineno-0-2370" href="#__codelineno-0-2370"></a>
</span><span id="__span-0-2371"><a id="__codelineno-0-2371" name="__codelineno-0-2371" href="#__codelineno-0-2371"></a><span class="s1">        IF(@MaintenanceActionLogId &lt;&gt; 0)</span>
</span><span id="__span-0-2372"><a id="__codelineno-0-2372" name="__codelineno-0-2372" href="#__codelineno-0-2372"></a>
</span><span id="__span-0-2373"><a id="__codelineno-0-2373" name="__codelineno-0-2373" href="#__codelineno-0-2373"></a><span class="s1">        BEGIN</span>
</span><span id="__span-0-2374"><a id="__codelineno-0-2374" name="__codelineno-0-2374" href="#__codelineno-0-2374"></a>
</span><span id="__span-0-2375"><a id="__codelineno-0-2375" name="__codelineno-0-2375" href="#__codelineno-0-2375"></a><span class="s1">            DECLARE @msg nvarchar(500) = ''Error: '' + CAST(Error_message() AS NVARCHAR(500)) + '', Code: '' + CAST(Error_Number() AS NVARCHAR(500)) + '', Line: '' + CAST(Error_Line() AS NVARCHAR(500))</span>
</span><span id="__span-0-2376"><a id="__codelineno-0-2376" name="__codelineno-0-2376" href="#__codelineno-0-2376"></a>
</span><span id="__span-0-2377"><a id="__codelineno-0-2377" name="__codelineno-0-2377" href="#__codelineno-0-2377"></a><span class="s1">            -- Устанавливаем текст ошибки при обслуживании индекса</span>
</span><span id="__span-0-2378"><a id="__codelineno-0-2378" name="__codelineno-0-2378" href="#__codelineno-0-2378"></a>
</span><span id="__span-0-2379"><a id="__codelineno-0-2379" name="__codelineno-0-2379" href="#__codelineno-0-2379"></a><span class="s1">            -- Дата завершения при этом остается незаполненной</span>
</span><span id="__span-0-2380"><a id="__codelineno-0-2380" name="__codelineno-0-2380" href="#__codelineno-0-2380"></a>
</span><span id="__span-0-2381"><a id="__codelineno-0-2381" name="__codelineno-0-2381" href="#__codelineno-0-2381"></a><span class="s1">            EXECUTE ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'].[dbo].[sp_set_maintenance_action_log_finish_date]</span>
</span><span id="__span-0-2382"><a id="__codelineno-0-2382" name="__codelineno-0-2382" href="#__codelineno-0-2382"></a>
</span><span id="__span-0-2383"><a id="__codelineno-0-2383" name="__codelineno-0-2383" href="#__codelineno-0-2383"></a><span class="s1">                @MaintenanceActionLogId,</span>
</span><span id="__span-0-2384"><a id="__codelineno-0-2384" name="__codelineno-0-2384" href="#__codelineno-0-2384"></a>
</span><span id="__span-0-2385"><a id="__codelineno-0-2385" name="__codelineno-0-2385" href="#__codelineno-0-2385"></a><span class="s1">                @FinishDate,</span>
</span><span id="__span-0-2386"><a id="__codelineno-0-2386" name="__codelineno-0-2386" href="#__codelineno-0-2386"></a>
</span><span id="__span-0-2387"><a id="__codelineno-0-2387" name="__codelineno-0-2387" href="#__codelineno-0-2387"></a><span class="s1">                @msg;          </span>
</span><span id="__span-0-2388"><a id="__codelineno-0-2388" name="__codelineno-0-2388" href="#__codelineno-0-2388"></a>
</span><span id="__span-0-2389"><a id="__codelineno-0-2389" name="__codelineno-0-2389" href="#__codelineno-0-2389"></a><span class="s1">        END            </span>
</span><span id="__span-0-2390"><a id="__codelineno-0-2390" name="__codelineno-0-2390" href="#__codelineno-0-2390"></a>
</span><span id="__span-0-2391"><a id="__codelineno-0-2391" name="__codelineno-0-2391" href="#__codelineno-0-2391"></a><span class="s1">    END CATCH</span>
</span><span id="__span-0-2392"><a id="__codelineno-0-2392" name="__codelineno-0-2392" href="#__codelineno-0-2392"></a>
</span><span id="__span-0-2393"><a id="__codelineno-0-2393" name="__codelineno-0-2393" href="#__codelineno-0-2393"></a><span class="s1">END</span>
</span><span id="__span-0-2394"><a id="__codelineno-0-2394" name="__codelineno-0-2394" href="#__codelineno-0-2394"></a>
</span><span id="__span-0-2395"><a id="__codelineno-0-2395" name="__codelineno-0-2395" href="#__codelineno-0-2395"></a>
</span><span id="__span-0-2396"><a id="__codelineno-0-2396" name="__codelineno-0-2396" href="#__codelineno-0-2396"></a>
</span><span id="__span-0-2397"><a id="__codelineno-0-2397" name="__codelineno-0-2397" href="#__codelineno-0-2397"></a><span class="s1">CLOSE todo;</span>
</span><span id="__span-0-2398"><a id="__codelineno-0-2398" name="__codelineno-0-2398" href="#__codelineno-0-2398"></a>
</span><span id="__span-0-2399"><a id="__codelineno-0-2399" name="__codelineno-0-2399" href="#__codelineno-0-2399"></a><span class="s1">DEALLOCATE todo;</span>
</span><span id="__span-0-2400"><a id="__codelineno-0-2400" name="__codelineno-0-2400" href="#__codelineno-0-2400"></a>
</span><span id="__span-0-2401"><a id="__codelineno-0-2401" name="__codelineno-0-2401" href="#__codelineno-0-2401"></a><span class="s1">IF OBJECT_ID(''tempdb..#MaintenanceCommands'') IS NOT NULL</span>
</span><span id="__span-0-2402"><a id="__codelineno-0-2402" name="__codelineno-0-2402" href="#__codelineno-0-2402"></a>
</span><span id="__span-0-2403"><a id="__codelineno-0-2403" name="__codelineno-0-2403" href="#__codelineno-0-2403"></a><span class="s1">    DROP TABLE #MaintenanceCommands;</span>
</span><span id="__span-0-2404"><a id="__codelineno-0-2404" name="__codelineno-0-2404" href="#__codelineno-0-2404"></a>
</span><span id="__span-0-2405"><a id="__codelineno-0-2405" name="__codelineno-0-2405" href="#__codelineno-0-2405"></a><span class="s1">IF OBJECT_ID(''tempdb..#MaintenanceCommandsTemp'') IS NOT NULL</span>
</span><span id="__span-0-2406"><a id="__codelineno-0-2406" name="__codelineno-0-2406" href="#__codelineno-0-2406"></a>
</span><span id="__span-0-2407"><a id="__codelineno-0-2407" name="__codelineno-0-2407" href="#__codelineno-0-2407"></a><span class="s1">    DROP TABLE #MaintenanceCommandsTemp;</span>
</span><span id="__span-0-2408"><a id="__codelineno-0-2408" name="__codelineno-0-2408" href="#__codelineno-0-2408"></a>
</span><span id="__span-0-2409"><a id="__codelineno-0-2409" name="__codelineno-0-2409" href="#__codelineno-0-2409"></a><span class="s1">'</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span>
</span><span id="__span-0-2410"><a id="__codelineno-0-2410" name="__codelineno-0-2410" href="#__codelineno-0-2410"></a>
</span><span id="__span-0-2411"><a id="__codelineno-0-2411" name="__codelineno-0-2411" href="#__codelineno-0-2411"></a>
</span><span id="__span-0-2412"><a id="__codelineno-0-2412" name="__codelineno-0-2412" href="#__codelineno-0-2412"></a>
</span><span id="__span-0-2413"><a id="__codelineno-0-2413" name="__codelineno-0-2413" href="#__codelineno-0-2413"></a><span class="w">    </span><span class="c1">-- Для отладки. Выводит в SSMS весь текст сформированной команды</span>
</span><span id="__span-0-2414"><a id="__codelineno-0-2414" name="__codelineno-0-2414" href="#__codelineno-0-2414"></a>
</span><span id="__span-0-2415"><a id="__codelineno-0-2415" name="__codelineno-0-2415" href="#__codelineno-0-2415"></a><span class="w">    </span><span class="c1">--exec [dbo].[sp_AdvancedPrint] @sql = @cmd</span>
</span><span id="__span-0-2416"><a id="__codelineno-0-2416" name="__codelineno-0-2416" href="#__codelineno-0-2416"></a>
</span><span id="__span-0-2417"><a id="__codelineno-0-2417" name="__codelineno-0-2417" href="#__codelineno-0-2417"></a>
</span><span id="__span-0-2418"><a id="__codelineno-0-2418" name="__codelineno-0-2418" href="#__codelineno-0-2418"></a>
</span><span id="__span-0-2419"><a id="__codelineno-0-2419" name="__codelineno-0-2419" href="#__codelineno-0-2419"></a><span class="w">    </span><span class="k">EXECUTE</span><span class="w"> </span><span class="n">sp_executesql</span>
</span><span id="__span-0-2420"><a id="__codelineno-0-2420" name="__codelineno-0-2420" href="#__codelineno-0-2420"></a>
</span><span id="__span-0-2421"><a id="__codelineno-0-2421" name="__codelineno-0-2421" href="#__codelineno-0-2421"></a><span class="w">        </span><span class="o">@</span><span class="n">cmd</span><span class="p">,</span>
</span><span id="__span-0-2422"><a id="__codelineno-0-2422" name="__codelineno-0-2422" href="#__codelineno-0-2422"></a>
</span><span id="__span-0-2423"><a id="__codelineno-0-2423" name="__codelineno-0-2423" href="#__codelineno-0-2423"></a><span class="w">        </span><span class="n">N</span><span class="s1">'@timeFrom TIME, @timeTo TIME, @fragmentationPercentForRebuild FLOAT,</span>
</span><span id="__span-0-2424"><a id="__codelineno-0-2424" name="__codelineno-0-2424" href="#__codelineno-0-2424"></a>
</span><span id="__span-0-2425"><a id="__codelineno-0-2425" name="__codelineno-0-2425" href="#__codelineno-0-2425"></a><span class="s1">        @fragmentationPercentMinForMaintenance FLOAT, @maxDop int,</span>
</span><span id="__span-0-2426"><a id="__codelineno-0-2426" name="__codelineno-0-2426" href="#__codelineno-0-2426"></a>
</span><span id="__span-0-2427"><a id="__codelineno-0-2427" name="__codelineno-0-2427" href="#__codelineno-0-2427"></a><span class="s1">        @minIndexSizePages int, @maxIndexSizePages int, @useOnlineIndexRebuild int,</span>
</span><span id="__span-0-2428"><a id="__codelineno-0-2428" name="__codelineno-0-2428" href="#__codelineno-0-2428"></a>
</span><span id="__span-0-2429"><a id="__codelineno-0-2429" name="__codelineno-0-2429" href="#__codelineno-0-2429"></a><span class="s1">        @maxIndexSizeForReorganizingPages int,</span>
</span><span id="__span-0-2430"><a id="__codelineno-0-2430" name="__codelineno-0-2430" href="#__codelineno-0-2430"></a>
</span><span id="__span-0-2431"><a id="__codelineno-0-2431" name="__codelineno-0-2431" href="#__codelineno-0-2431"></a><span class="s1">        @useMonitoringDatabase bit, @monitoringDatabaseName sysname, @usePreparedInformationAboutObjectsStateIfExists bit,</span>
</span><span id="__span-0-2432"><a id="__codelineno-0-2432" name="__codelineno-0-2432" href="#__codelineno-0-2432"></a>
</span><span id="__span-0-2433"><a id="__codelineno-0-2433" name="__codelineno-0-2433" href="#__codelineno-0-2433"></a><span class="s1">        @databaseName sysname, @maxTransactionLogSizeUsagePercent int, @maxTransactionLogSizeMB bigint, @useResumableIndexRebuild bit,</span>
</span><span id="__span-0-2434"><a id="__codelineno-0-2434" name="__codelineno-0-2434" href="#__codelineno-0-2434"></a>
</span><span id="__span-0-2435"><a id="__codelineno-0-2435" name="__codelineno-0-2435" href="#__codelineno-0-2435"></a><span class="s1">        @excludeIndexes XML'</span><span class="p">,</span>
</span><span id="__span-0-2436"><a id="__codelineno-0-2436" name="__codelineno-0-2436" href="#__codelineno-0-2436"></a>
</span><span id="__span-0-2437"><a id="__codelineno-0-2437" name="__codelineno-0-2437" href="#__codelineno-0-2437"></a><span class="w">        </span><span class="o">@</span><span class="n">timeFrom</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">timeTo</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">fragmentationPercentForRebuild</span><span class="p">,</span>
</span><span id="__span-0-2438"><a id="__codelineno-0-2438" name="__codelineno-0-2438" href="#__codelineno-0-2438"></a>
</span><span id="__span-0-2439"><a id="__codelineno-0-2439" name="__codelineno-0-2439" href="#__codelineno-0-2439"></a><span class="w">        </span><span class="o">@</span><span class="n">fragmentationPercentMinForMaintenance</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">maxDop</span><span class="p">,</span>
</span><span id="__span-0-2440"><a id="__codelineno-0-2440" name="__codelineno-0-2440" href="#__codelineno-0-2440"></a>
</span><span id="__span-0-2441"><a id="__codelineno-0-2441" name="__codelineno-0-2441" href="#__codelineno-0-2441"></a><span class="w">        </span><span class="o">@</span><span class="n">minIndexSizePages</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">maxIndexSizePages</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">useOnlineIndexRebuild</span><span class="p">,</span>
</span><span id="__span-0-2442"><a id="__codelineno-0-2442" name="__codelineno-0-2442" href="#__codelineno-0-2442"></a>
</span><span id="__span-0-2443"><a id="__codelineno-0-2443" name="__codelineno-0-2443" href="#__codelineno-0-2443"></a><span class="w">        </span><span class="o">@</span><span class="n">maxIndexSizeForReorganizingPages</span><span class="p">,</span>
</span><span id="__span-0-2444"><a id="__codelineno-0-2444" name="__codelineno-0-2444" href="#__codelineno-0-2444"></a>
</span><span id="__span-0-2445"><a id="__codelineno-0-2445" name="__codelineno-0-2445" href="#__codelineno-0-2445"></a><span class="w">        </span><span class="o">@</span><span class="n">useMonitoringDatabase</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">usePreparedInformationAboutObjectsStateIfExists</span><span class="p">,</span>
</span><span id="__span-0-2446"><a id="__codelineno-0-2446" name="__codelineno-0-2446" href="#__codelineno-0-2446"></a>
</span><span id="__span-0-2447"><a id="__codelineno-0-2447" name="__codelineno-0-2447" href="#__codelineno-0-2447"></a><span class="w">        </span><span class="o">@</span><span class="n">databaseName</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">maxTransactionLogSizeUsagePercent</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">maxTransactionLogSizeMB</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">useResumableIndexRebuild</span><span class="p">,</span>
</span><span id="__span-0-2448"><a id="__codelineno-0-2448" name="__codelineno-0-2448" href="#__codelineno-0-2448"></a>
</span><span id="__span-0-2449"><a id="__codelineno-0-2449" name="__codelineno-0-2449" href="#__codelineno-0-2449"></a><span class="w">        </span><span class="o">@</span><span class="n">excludeIndexes</span><span class="p">;</span>
</span><span id="__span-0-2450"><a id="__codelineno-0-2450" name="__codelineno-0-2450" href="#__codelineno-0-2450"></a>
</span><span id="__span-0-2451"><a id="__codelineno-0-2451" name="__codelineno-0-2451" href="#__codelineno-0-2451"></a>
</span><span id="__span-0-2452"><a id="__codelineno-0-2452" name="__codelineno-0-2452" href="#__codelineno-0-2452"></a>
</span><span id="__span-0-2453"><a id="__codelineno-0-2453" name="__codelineno-0-2453" href="#__codelineno-0-2453"></a><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-2454"><a id="__codelineno-0-2454" name="__codelineno-0-2454" href="#__codelineno-0-2454"></a>
</span><span id="__span-0-2455"><a id="__codelineno-0-2455" name="__codelineno-0-2455" href="#__codelineno-0-2455"></a><span class="k">END</span>
</span><span id="__span-0-2456"><a id="__codelineno-0-2456" name="__codelineno-0-2456" href="#__codelineno-0-2456"></a>
</span><span id="__span-0-2457"><a id="__codelineno-0-2457" name="__codelineno-0-2457" href="#__codelineno-0-2457"></a><span class="k">GO</span>
</span><span id="__span-0-2458"><a id="__codelineno-0-2458" name="__codelineno-0-2458" href="#__codelineno-0-2458"></a>
</span><span id="__span-0-2459"><a id="__codelineno-0-2459" name="__codelineno-0-2459" href="#__codelineno-0-2459"></a>
</span><span id="__span-0-2460"><a id="__codelineno-0-2460" name="__codelineno-0-2460" href="#__codelineno-0-2460"></a>
</span><span id="__span-0-2461"><a id="__codelineno-0-2461" name="__codelineno-0-2461" href="#__codelineno-0-2461"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_SaveDatabasesTablesStatistic</span><span class="p">]</span>
</span><span id="__span-0-2462"><a id="__codelineno-0-2462" name="__codelineno-0-2462" href="#__codelineno-0-2462"></a>
</span><span id="__span-0-2463"><a id="__codelineno-0-2463" name="__codelineno-0-2463" href="#__codelineno-0-2463"></a><span class="k">AS</span>
</span><span id="__span-0-2464"><a id="__codelineno-0-2464" name="__codelineno-0-2464" href="#__codelineno-0-2464"></a>
</span><span id="__span-0-2465"><a id="__codelineno-0-2465" name="__codelineno-0-2465" href="#__codelineno-0-2465"></a><span class="k">BEGIN</span>
</span><span id="__span-0-2466"><a id="__codelineno-0-2466" name="__codelineno-0-2466" href="#__codelineno-0-2466"></a>
</span><span id="__span-0-2467"><a id="__codelineno-0-2467" name="__codelineno-0-2467" href="#__codelineno-0-2467"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">NOCOUNT</span><span class="w"> </span><span class="k">ON</span><span class="p">;</span>
</span><span id="__span-0-2468"><a id="__codelineno-0-2468" name="__codelineno-0-2468" href="#__codelineno-0-2468"></a>
</span><span id="__span-0-2469"><a id="__codelineno-0-2469" name="__codelineno-0-2469" href="#__codelineno-0-2469"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">QUOTED_IDENTIFIER</span><span class="w"> </span><span class="k">ON</span><span class="p">;</span>
</span><span id="__span-0-2470"><a id="__codelineno-0-2470" name="__codelineno-0-2470" href="#__codelineno-0-2470"></a>
</span><span id="__span-0-2471"><a id="__codelineno-0-2471" name="__codelineno-0-2471" href="#__codelineno-0-2471"></a>
</span><span id="__span-0-2472"><a id="__codelineno-0-2472" name="__codelineno-0-2472" href="#__codelineno-0-2472"></a>
</span><span id="__span-0-2473"><a id="__codelineno-0-2473" name="__codelineno-0-2473" href="#__codelineno-0-2473"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">OBJECT_ID</span><span class="p">(</span><span class="s1">'tempdb..#tableSizeResult'</span><span class="p">)</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-0-2474"><a id="__codelineno-0-2474" name="__codelineno-0-2474" href="#__codelineno-0-2474"></a>
</span><span id="__span-0-2475"><a id="__codelineno-0-2475" name="__codelineno-0-2475" href="#__codelineno-0-2475"></a><span class="w">        </span><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">#</span><span class="n">tableSizeResult</span><span class="p">;</span>
</span><span id="__span-0-2476"><a id="__codelineno-0-2476" name="__codelineno-0-2476" href="#__codelineno-0-2476"></a>
</span><span id="__span-0-2477"><a id="__codelineno-0-2477" name="__codelineno-0-2477" href="#__codelineno-0-2477"></a>
</span><span id="__span-0-2478"><a id="__codelineno-0-2478" name="__codelineno-0-2478" href="#__codelineno-0-2478"></a>
</span><span id="__span-0-2479"><a id="__codelineno-0-2479" name="__codelineno-0-2479" href="#__codelineno-0-2479"></a><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="k">sql</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
</span><span id="__span-0-2480"><a id="__codelineno-0-2480" name="__codelineno-0-2480" href="#__codelineno-0-2480"></a>
</span><span id="__span-0-2481"><a id="__codelineno-0-2481" name="__codelineno-0-2481" href="#__codelineno-0-2481"></a>
</span><span id="__span-0-2482"><a id="__codelineno-0-2482" name="__codelineno-0-2482" href="#__codelineno-0-2482"></a>
</span><span id="__span-0-2483"><a id="__codelineno-0-2483" name="__codelineno-0-2483" href="#__codelineno-0-2483"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'</span>
</span><span id="__span-0-2484"><a id="__codelineno-0-2484" name="__codelineno-0-2484" href="#__codelineno-0-2484"></a>
</span><span id="__span-0-2485"><a id="__codelineno-0-2485" name="__codelineno-0-2485" href="#__codelineno-0-2485"></a><span class="s1">    SELECT</span>
</span><span id="__span-0-2486"><a id="__codelineno-0-2486" name="__codelineno-0-2486" href="#__codelineno-0-2486"></a>
</span><span id="__span-0-2487"><a id="__codelineno-0-2487" name="__codelineno-0-2487" href="#__codelineno-0-2487"></a><span class="s1">        DB_NAME() AS [databaseName],</span>
</span><span id="__span-0-2488"><a id="__codelineno-0-2488" name="__codelineno-0-2488" href="#__codelineno-0-2488"></a>
</span><span id="__span-0-2489"><a id="__codelineno-0-2489" name="__codelineno-0-2489" href="#__codelineno-0-2489"></a><span class="s1">        a3.name AS [schemaname],</span>
</span><span id="__span-0-2490"><a id="__codelineno-0-2490" name="__codelineno-0-2490" href="#__codelineno-0-2490"></a>
</span><span id="__span-0-2491"><a id="__codelineno-0-2491" name="__codelineno-0-2491" href="#__codelineno-0-2491"></a><span class="s1">        a2.name AS [tablename],</span>
</span><span id="__span-0-2492"><a id="__codelineno-0-2492" name="__codelineno-0-2492" href="#__codelineno-0-2492"></a>
</span><span id="__span-0-2493"><a id="__codelineno-0-2493" name="__codelineno-0-2493" href="#__codelineno-0-2493"></a><span class="s1">        a1.rows as row_count,</span>
</span><span id="__span-0-2494"><a id="__codelineno-0-2494" name="__codelineno-0-2494" href="#__codelineno-0-2494"></a>
</span><span id="__span-0-2495"><a id="__codelineno-0-2495" name="__codelineno-0-2495" href="#__codelineno-0-2495"></a><span class="s1">        (a1.reserved + ISNULL(a4.reserved,0))* 8 AS [reserved], </span>
</span><span id="__span-0-2496"><a id="__codelineno-0-2496" name="__codelineno-0-2496" href="#__codelineno-0-2496"></a>
</span><span id="__span-0-2497"><a id="__codelineno-0-2497" name="__codelineno-0-2497" href="#__codelineno-0-2497"></a><span class="s1">        a1.data * 8 AS [data],</span>
</span><span id="__span-0-2498"><a id="__codelineno-0-2498" name="__codelineno-0-2498" href="#__codelineno-0-2498"></a>
</span><span id="__span-0-2499"><a id="__codelineno-0-2499" name="__codelineno-0-2499" href="#__codelineno-0-2499"></a><span class="s1">        (CASE WHEN (a1.used + ISNULL(a4.used,0)) &gt; a1.data THEN (a1.used + ISNULL(a4.used,0)) - a1.data ELSE 0 END) * 8 AS [index_size],</span>
</span><span id="__span-0-2500"><a id="__codelineno-0-2500" name="__codelineno-0-2500" href="#__codelineno-0-2500"></a>
</span><span id="__span-0-2501"><a id="__codelineno-0-2501" name="__codelineno-0-2501" href="#__codelineno-0-2501"></a><span class="s1">        (CASE WHEN (a1.reserved + ISNULL(a4.reserved,0)) &gt; a1.used THEN (a1.reserved + ISNULL(a4.reserved,0)) - a1.used ELSE 0 END) * 8 AS [unused]</span>
</span><span id="__span-0-2502"><a id="__codelineno-0-2502" name="__codelineno-0-2502" href="#__codelineno-0-2502"></a>
</span><span id="__span-0-2503"><a id="__codelineno-0-2503" name="__codelineno-0-2503" href="#__codelineno-0-2503"></a><span class="s1">    FROM</span>
</span><span id="__span-0-2504"><a id="__codelineno-0-2504" name="__codelineno-0-2504" href="#__codelineno-0-2504"></a>
</span><span id="__span-0-2505"><a id="__codelineno-0-2505" name="__codelineno-0-2505" href="#__codelineno-0-2505"></a><span class="s1">        (SELECT </span>
</span><span id="__span-0-2506"><a id="__codelineno-0-2506" name="__codelineno-0-2506" href="#__codelineno-0-2506"></a>
</span><span id="__span-0-2507"><a id="__codelineno-0-2507" name="__codelineno-0-2507" href="#__codelineno-0-2507"></a><span class="s1">            ps.object_id,</span>
</span><span id="__span-0-2508"><a id="__codelineno-0-2508" name="__codelineno-0-2508" href="#__codelineno-0-2508"></a>
</span><span id="__span-0-2509"><a id="__codelineno-0-2509" name="__codelineno-0-2509" href="#__codelineno-0-2509"></a><span class="s1">            SUM (</span>
</span><span id="__span-0-2510"><a id="__codelineno-0-2510" name="__codelineno-0-2510" href="#__codelineno-0-2510"></a>
</span><span id="__span-0-2511"><a id="__codelineno-0-2511" name="__codelineno-0-2511" href="#__codelineno-0-2511"></a><span class="s1">                CASE</span>
</span><span id="__span-0-2512"><a id="__codelineno-0-2512" name="__codelineno-0-2512" href="#__codelineno-0-2512"></a>
</span><span id="__span-0-2513"><a id="__codelineno-0-2513" name="__codelineno-0-2513" href="#__codelineno-0-2513"></a><span class="s1">                    WHEN (ps.index_id &lt; 2) THEN row_count</span>
</span><span id="__span-0-2514"><a id="__codelineno-0-2514" name="__codelineno-0-2514" href="#__codelineno-0-2514"></a>
</span><span id="__span-0-2515"><a id="__codelineno-0-2515" name="__codelineno-0-2515" href="#__codelineno-0-2515"></a><span class="s1">                    ELSE 0</span>
</span><span id="__span-0-2516"><a id="__codelineno-0-2516" name="__codelineno-0-2516" href="#__codelineno-0-2516"></a>
</span><span id="__span-0-2517"><a id="__codelineno-0-2517" name="__codelineno-0-2517" href="#__codelineno-0-2517"></a><span class="s1">                END</span>
</span><span id="__span-0-2518"><a id="__codelineno-0-2518" name="__codelineno-0-2518" href="#__codelineno-0-2518"></a>
</span><span id="__span-0-2519"><a id="__codelineno-0-2519" name="__codelineno-0-2519" href="#__codelineno-0-2519"></a><span class="s1">                ) AS [rows],</span>
</span><span id="__span-0-2520"><a id="__codelineno-0-2520" name="__codelineno-0-2520" href="#__codelineno-0-2520"></a>
</span><span id="__span-0-2521"><a id="__codelineno-0-2521" name="__codelineno-0-2521" href="#__codelineno-0-2521"></a><span class="s1">            SUM (ps.reserved_page_count) AS reserved,</span>
</span><span id="__span-0-2522"><a id="__codelineno-0-2522" name="__codelineno-0-2522" href="#__codelineno-0-2522"></a>
</span><span id="__span-0-2523"><a id="__codelineno-0-2523" name="__codelineno-0-2523" href="#__codelineno-0-2523"></a><span class="s1">            SUM (</span>
</span><span id="__span-0-2524"><a id="__codelineno-0-2524" name="__codelineno-0-2524" href="#__codelineno-0-2524"></a>
</span><span id="__span-0-2525"><a id="__codelineno-0-2525" name="__codelineno-0-2525" href="#__codelineno-0-2525"></a><span class="s1">                CASE</span>
</span><span id="__span-0-2526"><a id="__codelineno-0-2526" name="__codelineno-0-2526" href="#__codelineno-0-2526"></a>
</span><span id="__span-0-2527"><a id="__codelineno-0-2527" name="__codelineno-0-2527" href="#__codelineno-0-2527"></a><span class="s1">                    WHEN (ps.index_id &lt; 2) THEN (ps.in_row_data_page_count + ps.lob_used_page_count + ps.row_overflow_used_page_count)</span>
</span><span id="__span-0-2528"><a id="__codelineno-0-2528" name="__codelineno-0-2528" href="#__codelineno-0-2528"></a>
</span><span id="__span-0-2529"><a id="__codelineno-0-2529" name="__codelineno-0-2529" href="#__codelineno-0-2529"></a><span class="s1">                    ELSE (ps.lob_used_page_count + ps.row_overflow_used_page_count)</span>
</span><span id="__span-0-2530"><a id="__codelineno-0-2530" name="__codelineno-0-2530" href="#__codelineno-0-2530"></a>
</span><span id="__span-0-2531"><a id="__codelineno-0-2531" name="__codelineno-0-2531" href="#__codelineno-0-2531"></a><span class="s1">                END</span>
</span><span id="__span-0-2532"><a id="__codelineno-0-2532" name="__codelineno-0-2532" href="#__codelineno-0-2532"></a>
</span><span id="__span-0-2533"><a id="__codelineno-0-2533" name="__codelineno-0-2533" href="#__codelineno-0-2533"></a><span class="s1">                ) AS data,</span>
</span><span id="__span-0-2534"><a id="__codelineno-0-2534" name="__codelineno-0-2534" href="#__codelineno-0-2534"></a>
</span><span id="__span-0-2535"><a id="__codelineno-0-2535" name="__codelineno-0-2535" href="#__codelineno-0-2535"></a><span class="s1">            SUM (ps.used_page_count) AS used</span>
</span><span id="__span-0-2536"><a id="__codelineno-0-2536" name="__codelineno-0-2536" href="#__codelineno-0-2536"></a>
</span><span id="__span-0-2537"><a id="__codelineno-0-2537" name="__codelineno-0-2537" href="#__codelineno-0-2537"></a><span class="s1">        FROM sys.dm_db_partition_stats ps</span>
</span><span id="__span-0-2538"><a id="__codelineno-0-2538" name="__codelineno-0-2538" href="#__codelineno-0-2538"></a>
</span><span id="__span-0-2539"><a id="__codelineno-0-2539" name="__codelineno-0-2539" href="#__codelineno-0-2539"></a><span class="s1">        GROUP BY ps.object_id) AS a1</span>
</span><span id="__span-0-2540"><a id="__codelineno-0-2540" name="__codelineno-0-2540" href="#__codelineno-0-2540"></a>
</span><span id="__span-0-2541"><a id="__codelineno-0-2541" name="__codelineno-0-2541" href="#__codelineno-0-2541"></a><span class="s1">    LEFT OUTER JOIN </span>
</span><span id="__span-0-2542"><a id="__codelineno-0-2542" name="__codelineno-0-2542" href="#__codelineno-0-2542"></a>
</span><span id="__span-0-2543"><a id="__codelineno-0-2543" name="__codelineno-0-2543" href="#__codelineno-0-2543"></a><span class="s1">        (SELECT </span>
</span><span id="__span-0-2544"><a id="__codelineno-0-2544" name="__codelineno-0-2544" href="#__codelineno-0-2544"></a>
</span><span id="__span-0-2545"><a id="__codelineno-0-2545" name="__codelineno-0-2545" href="#__codelineno-0-2545"></a><span class="s1">            it.parent_id,</span>
</span><span id="__span-0-2546"><a id="__codelineno-0-2546" name="__codelineno-0-2546" href="#__codelineno-0-2546"></a>
</span><span id="__span-0-2547"><a id="__codelineno-0-2547" name="__codelineno-0-2547" href="#__codelineno-0-2547"></a><span class="s1">            SUM(ps.reserved_page_count) AS reserved,</span>
</span><span id="__span-0-2548"><a id="__codelineno-0-2548" name="__codelineno-0-2548" href="#__codelineno-0-2548"></a>
</span><span id="__span-0-2549"><a id="__codelineno-0-2549" name="__codelineno-0-2549" href="#__codelineno-0-2549"></a><span class="s1">            SUM(ps.used_page_count) AS used</span>
</span><span id="__span-0-2550"><a id="__codelineno-0-2550" name="__codelineno-0-2550" href="#__codelineno-0-2550"></a>
</span><span id="__span-0-2551"><a id="__codelineno-0-2551" name="__codelineno-0-2551" href="#__codelineno-0-2551"></a><span class="s1">        FROM sys.dm_db_partition_stats ps</span>
</span><span id="__span-0-2552"><a id="__codelineno-0-2552" name="__codelineno-0-2552" href="#__codelineno-0-2552"></a>
</span><span id="__span-0-2553"><a id="__codelineno-0-2553" name="__codelineno-0-2553" href="#__codelineno-0-2553"></a><span class="s1">        INNER JOIN sys.internal_tables it ON (it.object_id = ps.object_id)</span>
</span><span id="__span-0-2554"><a id="__codelineno-0-2554" name="__codelineno-0-2554" href="#__codelineno-0-2554"></a>
</span><span id="__span-0-2555"><a id="__codelineno-0-2555" name="__codelineno-0-2555" href="#__codelineno-0-2555"></a><span class="s1">        WHERE it.internal_type IN (202,204)</span>
</span><span id="__span-0-2556"><a id="__codelineno-0-2556" name="__codelineno-0-2556" href="#__codelineno-0-2556"></a>
</span><span id="__span-0-2557"><a id="__codelineno-0-2557" name="__codelineno-0-2557" href="#__codelineno-0-2557"></a><span class="s1">        GROUP BY it.parent_id) AS a4 ON (a4.parent_id = a1.object_id)</span>
</span><span id="__span-0-2558"><a id="__codelineno-0-2558" name="__codelineno-0-2558" href="#__codelineno-0-2558"></a>
</span><span id="__span-0-2559"><a id="__codelineno-0-2559" name="__codelineno-0-2559" href="#__codelineno-0-2559"></a><span class="s1">    INNER JOIN sys.all_objects a2  ON ( a1.object_id = a2.object_id ) </span>
</span><span id="__span-0-2560"><a id="__codelineno-0-2560" name="__codelineno-0-2560" href="#__codelineno-0-2560"></a>
</span><span id="__span-0-2561"><a id="__codelineno-0-2561" name="__codelineno-0-2561" href="#__codelineno-0-2561"></a><span class="s1">    INNER JOIN sys.schemas a3 ON (a2.schema_id = a3.schema_id)</span>
</span><span id="__span-0-2562"><a id="__codelineno-0-2562" name="__codelineno-0-2562" href="#__codelineno-0-2562"></a>
</span><span id="__span-0-2563"><a id="__codelineno-0-2563" name="__codelineno-0-2563" href="#__codelineno-0-2563"></a><span class="s1">    WHERE a2.type &lt;&gt; N''S'' and a2.type &lt;&gt; N''IT''</span>
</span><span id="__span-0-2564"><a id="__codelineno-0-2564" name="__codelineno-0-2564" href="#__codelineno-0-2564"></a>
</span><span id="__span-0-2565"><a id="__codelineno-0-2565" name="__codelineno-0-2565" href="#__codelineno-0-2565"></a><span class="s1">    ORDER BY reserved DESC</span>
</span><span id="__span-0-2566"><a id="__codelineno-0-2566" name="__codelineno-0-2566" href="#__codelineno-0-2566"></a>
</span><span id="__span-0-2567"><a id="__codelineno-0-2567" name="__codelineno-0-2567" href="#__codelineno-0-2567"></a><span class="s1">    '</span><span class="p">;</span>
</span><span id="__span-0-2568"><a id="__codelineno-0-2568" name="__codelineno-0-2568" href="#__codelineno-0-2568"></a>
</span><span id="__span-0-2569"><a id="__codelineno-0-2569" name="__codelineno-0-2569" href="#__codelineno-0-2569"></a>
</span><span id="__span-0-2570"><a id="__codelineno-0-2570" name="__codelineno-0-2570" href="#__codelineno-0-2570"></a>
</span><span id="__span-0-2571"><a id="__codelineno-0-2571" name="__codelineno-0-2571" href="#__codelineno-0-2571"></a><span class="w">    </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">#</span><span class="n">tableSizeResult</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-2572"><a id="__codelineno-0-2572" name="__codelineno-0-2572" href="#__codelineno-0-2572"></a>
</span><span id="__span-0-2573"><a id="__codelineno-0-2573" name="__codelineno-0-2573" href="#__codelineno-0-2573"></a><span class="w">        </span><span class="p">[</span><span class="n">DatabaseName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">),</span>
</span><span id="__span-0-2574"><a id="__codelineno-0-2574" name="__codelineno-0-2574" href="#__codelineno-0-2574"></a>
</span><span id="__span-0-2575"><a id="__codelineno-0-2575" name="__codelineno-0-2575" href="#__codelineno-0-2575"></a><span class="w">        </span><span class="p">[</span><span class="n">SchemaName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">),</span>
</span><span id="__span-0-2576"><a id="__codelineno-0-2576" name="__codelineno-0-2576" href="#__codelineno-0-2576"></a>
</span><span id="__span-0-2577"><a id="__codelineno-0-2577" name="__codelineno-0-2577" href="#__codelineno-0-2577"></a><span class="w">        </span><span class="p">[</span><span class="n">TableName</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="mi">255</span><span class="p">),</span>
</span><span id="__span-0-2578"><a id="__codelineno-0-2578" name="__codelineno-0-2578" href="#__codelineno-0-2578"></a>
</span><span id="__span-0-2579"><a id="__codelineno-0-2579" name="__codelineno-0-2579" href="#__codelineno-0-2579"></a><span class="w">        </span><span class="p">[</span><span class="n">RowCnt</span><span class="p">]</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
</span><span id="__span-0-2580"><a id="__codelineno-0-2580" name="__codelineno-0-2580" href="#__codelineno-0-2580"></a>
</span><span id="__span-0-2581"><a id="__codelineno-0-2581" name="__codelineno-0-2581" href="#__codelineno-0-2581"></a><span class="w">        </span><span class="p">[</span><span class="n">Reserved</span><span class="p">]</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
</span><span id="__span-0-2582"><a id="__codelineno-0-2582" name="__codelineno-0-2582" href="#__codelineno-0-2582"></a>
</span><span id="__span-0-2583"><a id="__codelineno-0-2583" name="__codelineno-0-2583" href="#__codelineno-0-2583"></a><span class="w">        </span><span class="p">[</span><span class="k">Data</span><span class="p">]</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
</span><span id="__span-0-2584"><a id="__codelineno-0-2584" name="__codelineno-0-2584" href="#__codelineno-0-2584"></a>
</span><span id="__span-0-2585"><a id="__codelineno-0-2585" name="__codelineno-0-2585" href="#__codelineno-0-2585"></a><span class="w">        </span><span class="p">[</span><span class="n">IndexSize</span><span class="p">]</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
</span><span id="__span-0-2586"><a id="__codelineno-0-2586" name="__codelineno-0-2586" href="#__codelineno-0-2586"></a>
</span><span id="__span-0-2587"><a id="__codelineno-0-2587" name="__codelineno-0-2587" href="#__codelineno-0-2587"></a><span class="w">        </span><span class="p">[</span><span class="n">Unused</span><span class="p">]</span><span class="w"> </span><span class="nb">bigint</span>
</span><span id="__span-0-2588"><a id="__codelineno-0-2588" name="__codelineno-0-2588" href="#__codelineno-0-2588"></a>
</span><span id="__span-0-2589"><a id="__codelineno-0-2589" name="__codelineno-0-2589" href="#__codelineno-0-2589"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-0-2590"><a id="__codelineno-0-2590" name="__codelineno-0-2590" href="#__codelineno-0-2590"></a>
</span><span id="__span-0-2591"><a id="__codelineno-0-2591" name="__codelineno-0-2591" href="#__codelineno-0-2591"></a>
</span><span id="__span-0-2592"><a id="__codelineno-0-2592" name="__codelineno-0-2592" href="#__codelineno-0-2592"></a>
</span><span id="__span-0-2593"><a id="__codelineno-0-2593" name="__codelineno-0-2593" href="#__codelineno-0-2593"></a>
</span><span id="__span-0-2594"><a id="__codelineno-0-2594" name="__codelineno-0-2594" href="#__codelineno-0-2594"></a>
</span><span id="__span-0-2595"><a id="__codelineno-0-2595" name="__codelineno-0-2595" href="#__codelineno-0-2595"></a><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="k">statement</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
</span><span id="__span-0-2596"><a id="__codelineno-0-2596" name="__codelineno-0-2596" href="#__codelineno-0-2596"></a>
</span><span id="__span-0-2597"><a id="__codelineno-0-2597" name="__codelineno-0-2597" href="#__codelineno-0-2597"></a>
</span><span id="__span-0-2598"><a id="__codelineno-0-2598" name="__codelineno-0-2598" href="#__codelineno-0-2598"></a>
</span><span id="__span-0-2599"><a id="__codelineno-0-2599" name="__codelineno-0-2599" href="#__codelineno-0-2599"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="k">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-2600"><a id="__codelineno-0-2600" name="__codelineno-0-2600" href="#__codelineno-0-2600"></a>
</span><span id="__span-0-2601"><a id="__codelineno-0-2601" name="__codelineno-0-2601" href="#__codelineno-0-2601"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="s1">'EXEC '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">QUOTENAME</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'.sys.sp_executesql @sql; '</span>
</span><span id="__span-0-2602"><a id="__codelineno-0-2602" name="__codelineno-0-2602" href="#__codelineno-0-2602"></a>
</span><span id="__span-0-2603"><a id="__codelineno-0-2603" name="__codelineno-0-2603" href="#__codelineno-0-2603"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">databases</span>
</span><span id="__span-0-2604"><a id="__codelineno-0-2604" name="__codelineno-0-2604" href="#__codelineno-0-2604"></a>
</span><span id="__span-0-2605"><a id="__codelineno-0-2605" name="__codelineno-0-2605" href="#__codelineno-0-2605"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">DATABASEPROPERTYEX</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s1">'UserAccess'</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'SINGLE_USER'</span><span class="w"> </span>
</span><span id="__span-0-2606"><a id="__codelineno-0-2606" name="__codelineno-0-2606" href="#__codelineno-0-2606"></a>
</span><span id="__span-0-2607"><a id="__codelineno-0-2607" name="__codelineno-0-2607" href="#__codelineno-0-2607"></a><span class="w">        </span><span class="k">AND</span><span class="w"> </span><span class="n">HAS_DBACCESS</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-0-2608"><a id="__codelineno-0-2608" name="__codelineno-0-2608" href="#__codelineno-0-2608"></a>
</span><span id="__span-0-2609"><a id="__codelineno-0-2609" name="__codelineno-0-2609" href="#__codelineno-0-2609"></a><span class="w">        </span><span class="k">AND</span><span class="w"> </span><span class="n">state_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'ONLINE'</span>
</span><span id="__span-0-2610"><a id="__codelineno-0-2610" name="__codelineno-0-2610" href="#__codelineno-0-2610"></a>
</span><span id="__span-0-2611"><a id="__codelineno-0-2611" name="__codelineno-0-2611" href="#__codelineno-0-2611"></a><span class="w">        </span><span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">database_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-2612"><a id="__codelineno-0-2612" name="__codelineno-0-2612" href="#__codelineno-0-2612"></a>
</span><span id="__span-0-2613"><a id="__codelineno-0-2613" name="__codelineno-0-2613" href="#__codelineno-0-2613"></a><span class="w">            </span><span class="n">DB_ID</span><span class="p">(</span><span class="s1">'tempdb'</span><span class="p">),</span>
</span><span id="__span-0-2614"><a id="__codelineno-0-2614" name="__codelineno-0-2614" href="#__codelineno-0-2614"></a>
</span><span id="__span-0-2615"><a id="__codelineno-0-2615" name="__codelineno-0-2615" href="#__codelineno-0-2615"></a><span class="w">            </span><span class="n">DB_ID</span><span class="p">(</span><span class="s1">'master'</span><span class="p">),</span>
</span><span id="__span-0-2616"><a id="__codelineno-0-2616" name="__codelineno-0-2616" href="#__codelineno-0-2616"></a>
</span><span id="__span-0-2617"><a id="__codelineno-0-2617" name="__codelineno-0-2617" href="#__codelineno-0-2617"></a><span class="w">            </span><span class="n">DB_ID</span><span class="p">(</span><span class="s1">'model'</span><span class="p">),</span>
</span><span id="__span-0-2618"><a id="__codelineno-0-2618" name="__codelineno-0-2618" href="#__codelineno-0-2618"></a>
</span><span id="__span-0-2619"><a id="__codelineno-0-2619" name="__codelineno-0-2619" href="#__codelineno-0-2619"></a><span class="w">            </span><span class="n">DB_ID</span><span class="p">(</span><span class="s1">'msdb'</span><span class="p">)</span>
</span><span id="__span-0-2620"><a id="__codelineno-0-2620" name="__codelineno-0-2620" href="#__codelineno-0-2620"></a>
</span><span id="__span-0-2621"><a id="__codelineno-0-2621" name="__codelineno-0-2621" href="#__codelineno-0-2621"></a><span class="w">        </span><span class="p">)</span>
</span><span id="__span-0-2622"><a id="__codelineno-0-2622" name="__codelineno-0-2622" href="#__codelineno-0-2622"></a>
</span><span id="__span-0-2623"><a id="__codelineno-0-2623" name="__codelineno-0-2623" href="#__codelineno-0-2623"></a><span class="w">    </span><span class="k">FOR</span><span class="w"> </span><span class="n">XML</span><span class="w"> </span><span class="n">PATH</span><span class="p">(</span><span class="s1">''</span><span class="p">),</span><span class="w"> </span><span class="k">TYPE</span>
</span><span id="__span-0-2624"><a id="__codelineno-0-2624" name="__codelineno-0-2624" href="#__codelineno-0-2624"></a>
</span><span id="__span-0-2625"><a id="__codelineno-0-2625" name="__codelineno-0-2625" href="#__codelineno-0-2625"></a><span class="w">    </span><span class="p">).</span><span class="n">value</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span><span class="s1">'nvarchar(max)'</span><span class="p">);</span>
</span><span id="__span-0-2626"><a id="__codelineno-0-2626" name="__codelineno-0-2626" href="#__codelineno-0-2626"></a>
</span><span id="__span-0-2627"><a id="__codelineno-0-2627" name="__codelineno-0-2627" href="#__codelineno-0-2627"></a>
</span><span id="__span-0-2628"><a id="__codelineno-0-2628" name="__codelineno-0-2628" href="#__codelineno-0-2628"></a>
</span><span id="__span-0-2629"><a id="__codelineno-0-2629" name="__codelineno-0-2629" href="#__codelineno-0-2629"></a><span class="w">    </span><span class="n">PRINT</span><span class="w"> </span><span class="o">@</span><span class="k">statement</span>
</span><span id="__span-0-2630"><a id="__codelineno-0-2630" name="__codelineno-0-2630" href="#__codelineno-0-2630"></a>
</span><span id="__span-0-2631"><a id="__codelineno-0-2631" name="__codelineno-0-2631" href="#__codelineno-0-2631"></a>
</span><span id="__span-0-2632"><a id="__codelineno-0-2632" name="__codelineno-0-2632" href="#__codelineno-0-2632"></a>
</span><span id="__span-0-2633"><a id="__codelineno-0-2633" name="__codelineno-0-2633" href="#__codelineno-0-2633"></a><span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="o">#</span><span class="n">tableSizeResult</span>
</span><span id="__span-0-2634"><a id="__codelineno-0-2634" name="__codelineno-0-2634" href="#__codelineno-0-2634"></a>
</span><span id="__span-0-2635"><a id="__codelineno-0-2635" name="__codelineno-0-2635" href="#__codelineno-0-2635"></a><span class="w">    </span><span class="k">EXEC</span><span class="w"> </span><span class="n">sp_executesql</span><span class="w"> </span><span class="o">@</span><span class="k">statement</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="s1">'@sql nvarchar(max)'</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="k">sql</span><span class="p">;</span>
</span><span id="__span-0-2636"><a id="__codelineno-0-2636" name="__codelineno-0-2636" href="#__codelineno-0-2636"></a>
</span><span id="__span-0-2637"><a id="__codelineno-0-2637" name="__codelineno-0-2637" href="#__codelineno-0-2637"></a>
</span><span id="__span-0-2638"><a id="__codelineno-0-2638" name="__codelineno-0-2638" href="#__codelineno-0-2638"></a>
</span><span id="__span-0-2639"><a id="__codelineno-0-2639" name="__codelineno-0-2639" href="#__codelineno-0-2639"></a><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">todo</span><span class="w"> </span><span class="k">CURSOR</span><span class="w"> </span><span class="k">FOR</span>
</span><span id="__span-0-2640"><a id="__codelineno-0-2640" name="__codelineno-0-2640" href="#__codelineno-0-2640"></a>
</span><span id="__span-0-2641"><a id="__codelineno-0-2641" name="__codelineno-0-2641" href="#__codelineno-0-2641"></a><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-0-2642"><a id="__codelineno-0-2642" name="__codelineno-0-2642" href="#__codelineno-0-2642"></a>
</span><span id="__span-0-2643"><a id="__codelineno-0-2643" name="__codelineno-0-2643" href="#__codelineno-0-2643"></a><span class="w">        </span><span class="p">[</span><span class="n">DatabaseName</span><span class="p">],</span>
</span><span id="__span-0-2644"><a id="__codelineno-0-2644" name="__codelineno-0-2644" href="#__codelineno-0-2644"></a>
</span><span id="__span-0-2645"><a id="__codelineno-0-2645" name="__codelineno-0-2645" href="#__codelineno-0-2645"></a><span class="w">        </span><span class="p">[</span><span class="n">SchemaName</span><span class="p">],</span>
</span><span id="__span-0-2646"><a id="__codelineno-0-2646" name="__codelineno-0-2646" href="#__codelineno-0-2646"></a>
</span><span id="__span-0-2647"><a id="__codelineno-0-2647" name="__codelineno-0-2647" href="#__codelineno-0-2647"></a><span class="w">        </span><span class="p">[</span><span class="n">TableName</span><span class="p">],</span>
</span><span id="__span-0-2648"><a id="__codelineno-0-2648" name="__codelineno-0-2648" href="#__codelineno-0-2648"></a>
</span><span id="__span-0-2649"><a id="__codelineno-0-2649" name="__codelineno-0-2649" href="#__codelineno-0-2649"></a><span class="w">        </span><span class="p">[</span><span class="n">RowCnt</span><span class="p">],</span>
</span><span id="__span-0-2650"><a id="__codelineno-0-2650" name="__codelineno-0-2650" href="#__codelineno-0-2650"></a>
</span><span id="__span-0-2651"><a id="__codelineno-0-2651" name="__codelineno-0-2651" href="#__codelineno-0-2651"></a><span class="w">        </span><span class="p">[</span><span class="n">Reserved</span><span class="p">],</span>
</span><span id="__span-0-2652"><a id="__codelineno-0-2652" name="__codelineno-0-2652" href="#__codelineno-0-2652"></a>
</span><span id="__span-0-2653"><a id="__codelineno-0-2653" name="__codelineno-0-2653" href="#__codelineno-0-2653"></a><span class="w">        </span><span class="p">[</span><span class="k">Data</span><span class="p">],</span>
</span><span id="__span-0-2654"><a id="__codelineno-0-2654" name="__codelineno-0-2654" href="#__codelineno-0-2654"></a>
</span><span id="__span-0-2655"><a id="__codelineno-0-2655" name="__codelineno-0-2655" href="#__codelineno-0-2655"></a><span class="w">        </span><span class="p">[</span><span class="n">IndexSize</span><span class="p">],</span>
</span><span id="__span-0-2656"><a id="__codelineno-0-2656" name="__codelineno-0-2656" href="#__codelineno-0-2656"></a>
</span><span id="__span-0-2657"><a id="__codelineno-0-2657" name="__codelineno-0-2657" href="#__codelineno-0-2657"></a><span class="w">        </span><span class="p">[</span><span class="n">Unused</span><span class="p">]</span>
</span><span id="__span-0-2658"><a id="__codelineno-0-2658" name="__codelineno-0-2658" href="#__codelineno-0-2658"></a>
</span><span id="__span-0-2659"><a id="__codelineno-0-2659" name="__codelineno-0-2659" href="#__codelineno-0-2659"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="o">#</span><span class="n">tableSizeResult</span><span class="p">;</span>
</span><span id="__span-0-2660"><a id="__codelineno-0-2660" name="__codelineno-0-2660" href="#__codelineno-0-2660"></a>
</span><span id="__span-0-2661"><a id="__codelineno-0-2661" name="__codelineno-0-2661" href="#__codelineno-0-2661"></a>
</span><span id="__span-0-2662"><a id="__codelineno-0-2662" name="__codelineno-0-2662" href="#__codelineno-0-2662"></a>
</span><span id="__span-0-2663"><a id="__codelineno-0-2663" name="__codelineno-0-2663" href="#__codelineno-0-2663"></a><span class="w">    </span><span class="k">DECLARE</span>
</span><span id="__span-0-2664"><a id="__codelineno-0-2664" name="__codelineno-0-2664" href="#__codelineno-0-2664"></a>
</span><span id="__span-0-2665"><a id="__codelineno-0-2665" name="__codelineno-0-2665" href="#__codelineno-0-2665"></a><span class="w">        </span><span class="o">@</span><span class="n">DatabaseName</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
</span><span id="__span-0-2666"><a id="__codelineno-0-2666" name="__codelineno-0-2666" href="#__codelineno-0-2666"></a>
</span><span id="__span-0-2667"><a id="__codelineno-0-2667" name="__codelineno-0-2667" href="#__codelineno-0-2667"></a><span class="w">        </span><span class="o">@</span><span class="n">SchemaName</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
</span><span id="__span-0-2668"><a id="__codelineno-0-2668" name="__codelineno-0-2668" href="#__codelineno-0-2668"></a>
</span><span id="__span-0-2669"><a id="__codelineno-0-2669" name="__codelineno-0-2669" href="#__codelineno-0-2669"></a><span class="w">        </span><span class="o">@</span><span class="n">TableName</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
</span><span id="__span-0-2670"><a id="__codelineno-0-2670" name="__codelineno-0-2670" href="#__codelineno-0-2670"></a>
</span><span id="__span-0-2671"><a id="__codelineno-0-2671" name="__codelineno-0-2671" href="#__codelineno-0-2671"></a><span class="w">        </span><span class="o">@</span><span class="n">RowCnt</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
</span><span id="__span-0-2672"><a id="__codelineno-0-2672" name="__codelineno-0-2672" href="#__codelineno-0-2672"></a>
</span><span id="__span-0-2673"><a id="__codelineno-0-2673" name="__codelineno-0-2673" href="#__codelineno-0-2673"></a><span class="w">        </span><span class="o">@</span><span class="n">Reserved</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
</span><span id="__span-0-2674"><a id="__codelineno-0-2674" name="__codelineno-0-2674" href="#__codelineno-0-2674"></a>
</span><span id="__span-0-2675"><a id="__codelineno-0-2675" name="__codelineno-0-2675" href="#__codelineno-0-2675"></a><span class="w">        </span><span class="o">@</span><span class="k">Data</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
</span><span id="__span-0-2676"><a id="__codelineno-0-2676" name="__codelineno-0-2676" href="#__codelineno-0-2676"></a>
</span><span id="__span-0-2677"><a id="__codelineno-0-2677" name="__codelineno-0-2677" href="#__codelineno-0-2677"></a><span class="w">        </span><span class="o">@</span><span class="n">IndexSize</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
</span><span id="__span-0-2678"><a id="__codelineno-0-2678" name="__codelineno-0-2678" href="#__codelineno-0-2678"></a>
</span><span id="__span-0-2679"><a id="__codelineno-0-2679" name="__codelineno-0-2679" href="#__codelineno-0-2679"></a><span class="w">        </span><span class="o">@</span><span class="n">Unused</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
</span><span id="__span-0-2680"><a id="__codelineno-0-2680" name="__codelineno-0-2680" href="#__codelineno-0-2680"></a>
</span><span id="__span-0-2681"><a id="__codelineno-0-2681" name="__codelineno-0-2681" href="#__codelineno-0-2681"></a><span class="w">        </span><span class="o">@</span><span class="n">currentDate</span><span class="w"> </span><span class="n">datetime2</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
</span><span id="__span-0-2682"><a id="__codelineno-0-2682" name="__codelineno-0-2682" href="#__codelineno-0-2682"></a>
</span><span id="__span-0-2683"><a id="__codelineno-0-2683" name="__codelineno-0-2683" href="#__codelineno-0-2683"></a><span class="w">    </span><span class="k">OPEN</span><span class="w"> </span><span class="n">todo</span><span class="p">;</span>
</span><span id="__span-0-2684"><a id="__codelineno-0-2684" name="__codelineno-0-2684" href="#__codelineno-0-2684"></a>
</span><span id="__span-0-2685"><a id="__codelineno-0-2685" name="__codelineno-0-2685" href="#__codelineno-0-2685"></a>
</span><span id="__span-0-2686"><a id="__codelineno-0-2686" name="__codelineno-0-2686" href="#__codelineno-0-2686"></a>
</span><span id="__span-0-2687"><a id="__codelineno-0-2687" name="__codelineno-0-2687" href="#__codelineno-0-2687"></a><span class="w">    </span><span class="n">WHILE</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-0-2688"><a id="__codelineno-0-2688" name="__codelineno-0-2688" href="#__codelineno-0-2688"></a>
</span><span id="__span-0-2689"><a id="__codelineno-0-2689" name="__codelineno-0-2689" href="#__codelineno-0-2689"></a><span class="w">    </span><span class="k">BEGIN</span>
</span><span id="__span-0-2690"><a id="__codelineno-0-2690" name="__codelineno-0-2690" href="#__codelineno-0-2690"></a>
</span><span id="__span-0-2691"><a id="__codelineno-0-2691" name="__codelineno-0-2691" href="#__codelineno-0-2691"></a><span class="w">        </span><span class="k">FETCH</span><span class="w"> </span><span class="k">NEXT</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">todo</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">@</span><span class="n">DatabaseName</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">SchemaName</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">TableName</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">RowCnt</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">Reserved</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="k">Data</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">IndexSize</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">Unused</span><span class="p">;</span>
</span><span id="__span-0-2692"><a id="__codelineno-0-2692" name="__codelineno-0-2692" href="#__codelineno-0-2692"></a>
</span><span id="__span-0-2693"><a id="__codelineno-0-2693" name="__codelineno-0-2693" href="#__codelineno-0-2693"></a><span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="o">@@</span><span class="n">FETCH_STATUS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-2694"><a id="__codelineno-0-2694" name="__codelineno-0-2694" href="#__codelineno-0-2694"></a>
</span><span id="__span-0-2695"><a id="__codelineno-0-2695" name="__codelineno-0-2695" href="#__codelineno-0-2695"></a><span class="w">            </span><span class="n">BREAK</span><span class="p">;</span>
</span><span id="__span-0-2696"><a id="__codelineno-0-2696" name="__codelineno-0-2696" href="#__codelineno-0-2696"></a>
</span><span id="__span-0-2697"><a id="__codelineno-0-2697" name="__codelineno-0-2697" href="#__codelineno-0-2697"></a>
</span><span id="__span-0-2698"><a id="__codelineno-0-2698" name="__codelineno-0-2698" href="#__codelineno-0-2698"></a>
</span><span id="__span-0-2699"><a id="__codelineno-0-2699" name="__codelineno-0-2699" href="#__codelineno-0-2699"></a><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">currentDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">();</span>
</span><span id="__span-0-2700"><a id="__codelineno-0-2700" name="__codelineno-0-2700" href="#__codelineno-0-2700"></a>
</span><span id="__span-0-2701"><a id="__codelineno-0-2701" name="__codelineno-0-2701" href="#__codelineno-0-2701"></a>
</span><span id="__span-0-2702"><a id="__codelineno-0-2702" name="__codelineno-0-2702" href="#__codelineno-0-2702"></a>
</span><span id="__span-0-2703"><a id="__codelineno-0-2703" name="__codelineno-0-2703" href="#__codelineno-0-2703"></a><span class="w">        </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">DatabasesTablesStatistic</span><span class="p">]</span>
</span><span id="__span-0-2704"><a id="__codelineno-0-2704" name="__codelineno-0-2704" href="#__codelineno-0-2704"></a>
</span><span id="__span-0-2705"><a id="__codelineno-0-2705" name="__codelineno-0-2705" href="#__codelineno-0-2705"></a><span class="w">        </span><span class="p">(</span>
</span><span id="__span-0-2706"><a id="__codelineno-0-2706" name="__codelineno-0-2706" href="#__codelineno-0-2706"></a>
</span><span id="__span-0-2707"><a id="__codelineno-0-2707" name="__codelineno-0-2707" href="#__codelineno-0-2707"></a><span class="w">            </span><span class="p">[</span><span class="k">Period</span><span class="p">],</span>
</span><span id="__span-0-2708"><a id="__codelineno-0-2708" name="__codelineno-0-2708" href="#__codelineno-0-2708"></a>
</span><span id="__span-0-2709"><a id="__codelineno-0-2709" name="__codelineno-0-2709" href="#__codelineno-0-2709"></a><span class="w">            </span><span class="p">[</span><span class="n">DatabaseName</span><span class="p">],</span>
</span><span id="__span-0-2710"><a id="__codelineno-0-2710" name="__codelineno-0-2710" href="#__codelineno-0-2710"></a>
</span><span id="__span-0-2711"><a id="__codelineno-0-2711" name="__codelineno-0-2711" href="#__codelineno-0-2711"></a><span class="w">            </span><span class="p">[</span><span class="n">SchemaName</span><span class="p">],</span>
</span><span id="__span-0-2712"><a id="__codelineno-0-2712" name="__codelineno-0-2712" href="#__codelineno-0-2712"></a>
</span><span id="__span-0-2713"><a id="__codelineno-0-2713" name="__codelineno-0-2713" href="#__codelineno-0-2713"></a><span class="w">            </span><span class="p">[</span><span class="n">TableName</span><span class="p">],</span>
</span><span id="__span-0-2714"><a id="__codelineno-0-2714" name="__codelineno-0-2714" href="#__codelineno-0-2714"></a>
</span><span id="__span-0-2715"><a id="__codelineno-0-2715" name="__codelineno-0-2715" href="#__codelineno-0-2715"></a><span class="w">            </span><span class="p">[</span><span class="n">RowCnt</span><span class="p">],</span>
</span><span id="__span-0-2716"><a id="__codelineno-0-2716" name="__codelineno-0-2716" href="#__codelineno-0-2716"></a>
</span><span id="__span-0-2717"><a id="__codelineno-0-2717" name="__codelineno-0-2717" href="#__codelineno-0-2717"></a><span class="w">            </span><span class="p">[</span><span class="n">Reserved</span><span class="p">],</span>
</span><span id="__span-0-2718"><a id="__codelineno-0-2718" name="__codelineno-0-2718" href="#__codelineno-0-2718"></a>
</span><span id="__span-0-2719"><a id="__codelineno-0-2719" name="__codelineno-0-2719" href="#__codelineno-0-2719"></a><span class="w">            </span><span class="p">[</span><span class="k">Data</span><span class="p">],</span>
</span><span id="__span-0-2720"><a id="__codelineno-0-2720" name="__codelineno-0-2720" href="#__codelineno-0-2720"></a>
</span><span id="__span-0-2721"><a id="__codelineno-0-2721" name="__codelineno-0-2721" href="#__codelineno-0-2721"></a><span class="w">            </span><span class="p">[</span><span class="n">IndexSize</span><span class="p">],</span>
</span><span id="__span-0-2722"><a id="__codelineno-0-2722" name="__codelineno-0-2722" href="#__codelineno-0-2722"></a>
</span><span id="__span-0-2723"><a id="__codelineno-0-2723" name="__codelineno-0-2723" href="#__codelineno-0-2723"></a><span class="w">            </span><span class="p">[</span><span class="n">Unused</span><span class="p">]</span>
</span><span id="__span-0-2724"><a id="__codelineno-0-2724" name="__codelineno-0-2724" href="#__codelineno-0-2724"></a>
</span><span id="__span-0-2725"><a id="__codelineno-0-2725" name="__codelineno-0-2725" href="#__codelineno-0-2725"></a><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span>
</span><span id="__span-0-2726"><a id="__codelineno-0-2726" name="__codelineno-0-2726" href="#__codelineno-0-2726"></a>
</span><span id="__span-0-2727"><a id="__codelineno-0-2727" name="__codelineno-0-2727" href="#__codelineno-0-2727"></a><span class="w">        </span><span class="p">(</span>
</span><span id="__span-0-2728"><a id="__codelineno-0-2728" name="__codelineno-0-2728" href="#__codelineno-0-2728"></a>
</span><span id="__span-0-2729"><a id="__codelineno-0-2729" name="__codelineno-0-2729" href="#__codelineno-0-2729"></a><span class="w">            </span><span class="o">@</span><span class="n">currentDate</span><span class="p">,</span>
</span><span id="__span-0-2730"><a id="__codelineno-0-2730" name="__codelineno-0-2730" href="#__codelineno-0-2730"></a>
</span><span id="__span-0-2731"><a id="__codelineno-0-2731" name="__codelineno-0-2731" href="#__codelineno-0-2731"></a><span class="w">            </span><span class="o">@</span><span class="n">DatabaseName</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-2732"><a id="__codelineno-0-2732" name="__codelineno-0-2732" href="#__codelineno-0-2732"></a>
</span><span id="__span-0-2733"><a id="__codelineno-0-2733" name="__codelineno-0-2733" href="#__codelineno-0-2733"></a><span class="w">            </span><span class="o">@</span><span class="n">SchemaName</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-2734"><a id="__codelineno-0-2734" name="__codelineno-0-2734" href="#__codelineno-0-2734"></a>
</span><span id="__span-0-2735"><a id="__codelineno-0-2735" name="__codelineno-0-2735" href="#__codelineno-0-2735"></a><span class="w">            </span><span class="o">@</span><span class="n">TableName</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-2736"><a id="__codelineno-0-2736" name="__codelineno-0-2736" href="#__codelineno-0-2736"></a>
</span><span id="__span-0-2737"><a id="__codelineno-0-2737" name="__codelineno-0-2737" href="#__codelineno-0-2737"></a><span class="w">            </span><span class="o">@</span><span class="n">RowCnt</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-2738"><a id="__codelineno-0-2738" name="__codelineno-0-2738" href="#__codelineno-0-2738"></a>
</span><span id="__span-0-2739"><a id="__codelineno-0-2739" name="__codelineno-0-2739" href="#__codelineno-0-2739"></a><span class="w">            </span><span class="o">@</span><span class="n">Reserved</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-2740"><a id="__codelineno-0-2740" name="__codelineno-0-2740" href="#__codelineno-0-2740"></a>
</span><span id="__span-0-2741"><a id="__codelineno-0-2741" name="__codelineno-0-2741" href="#__codelineno-0-2741"></a><span class="w">            </span><span class="o">@</span><span class="k">Data</span><span class="p">,</span>
</span><span id="__span-0-2742"><a id="__codelineno-0-2742" name="__codelineno-0-2742" href="#__codelineno-0-2742"></a>
</span><span id="__span-0-2743"><a id="__codelineno-0-2743" name="__codelineno-0-2743" href="#__codelineno-0-2743"></a><span class="w">            </span><span class="o">@</span><span class="n">IndexSize</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-2744"><a id="__codelineno-0-2744" name="__codelineno-0-2744" href="#__codelineno-0-2744"></a>
</span><span id="__span-0-2745"><a id="__codelineno-0-2745" name="__codelineno-0-2745" href="#__codelineno-0-2745"></a><span class="w">            </span><span class="o">@</span><span class="n">Unused</span>
</span><span id="__span-0-2746"><a id="__codelineno-0-2746" name="__codelineno-0-2746" href="#__codelineno-0-2746"></a>
</span><span id="__span-0-2747"><a id="__codelineno-0-2747" name="__codelineno-0-2747" href="#__codelineno-0-2747"></a><span class="w">        </span><span class="p">);</span>
</span><span id="__span-0-2748"><a id="__codelineno-0-2748" name="__codelineno-0-2748" href="#__codelineno-0-2748"></a>
</span><span id="__span-0-2749"><a id="__codelineno-0-2749" name="__codelineno-0-2749" href="#__codelineno-0-2749"></a><span class="w">    </span><span class="k">END</span>
</span><span id="__span-0-2750"><a id="__codelineno-0-2750" name="__codelineno-0-2750" href="#__codelineno-0-2750"></a>
</span><span id="__span-0-2751"><a id="__codelineno-0-2751" name="__codelineno-0-2751" href="#__codelineno-0-2751"></a>
</span><span id="__span-0-2752"><a id="__codelineno-0-2752" name="__codelineno-0-2752" href="#__codelineno-0-2752"></a>
</span><span id="__span-0-2753"><a id="__codelineno-0-2753" name="__codelineno-0-2753" href="#__codelineno-0-2753"></a><span class="w">    </span><span class="k">CLOSE</span><span class="w"> </span><span class="n">todo</span><span class="p">;</span>
</span><span id="__span-0-2754"><a id="__codelineno-0-2754" name="__codelineno-0-2754" href="#__codelineno-0-2754"></a>
</span><span id="__span-0-2755"><a id="__codelineno-0-2755" name="__codelineno-0-2755" href="#__codelineno-0-2755"></a><span class="w">    </span><span class="k">DEALLOCATE</span><span class="w"> </span><span class="n">todo</span><span class="p">;</span>
</span><span id="__span-0-2756"><a id="__codelineno-0-2756" name="__codelineno-0-2756" href="#__codelineno-0-2756"></a>
</span><span id="__span-0-2757"><a id="__codelineno-0-2757" name="__codelineno-0-2757" href="#__codelineno-0-2757"></a>
</span><span id="__span-0-2758"><a id="__codelineno-0-2758" name="__codelineno-0-2758" href="#__codelineno-0-2758"></a>
</span><span id="__span-0-2759"><a id="__codelineno-0-2759" name="__codelineno-0-2759" href="#__codelineno-0-2759"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">OBJECT_ID</span><span class="p">(</span><span class="s1">'tempdb..#tableSizeResult'</span><span class="p">)</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-0-2760"><a id="__codelineno-0-2760" name="__codelineno-0-2760" href="#__codelineno-0-2760"></a>
</span><span id="__span-0-2761"><a id="__codelineno-0-2761" name="__codelineno-0-2761" href="#__codelineno-0-2761"></a><span class="w">        </span><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">#</span><span class="n">tableSizeResult</span><span class="p">;</span>
</span><span id="__span-0-2762"><a id="__codelineno-0-2762" name="__codelineno-0-2762" href="#__codelineno-0-2762"></a>
</span><span id="__span-0-2763"><a id="__codelineno-0-2763" name="__codelineno-0-2763" href="#__codelineno-0-2763"></a><span class="k">END</span>
</span><span id="__span-0-2764"><a id="__codelineno-0-2764" name="__codelineno-0-2764" href="#__codelineno-0-2764"></a>
</span><span id="__span-0-2765"><a id="__codelineno-0-2765" name="__codelineno-0-2765" href="#__codelineno-0-2765"></a><span class="k">GO</span>
</span><span id="__span-0-2766"><a id="__codelineno-0-2766" name="__codelineno-0-2766" href="#__codelineno-0-2766"></a>
</span><span id="__span-0-2767"><a id="__codelineno-0-2767" name="__codelineno-0-2767" href="#__codelineno-0-2767"></a>
</span><span id="__span-0-2768"><a id="__codelineno-0-2768" name="__codelineno-0-2768" href="#__codelineno-0-2768"></a>
</span><span id="__span-0-2769"><a id="__codelineno-0-2769" name="__codelineno-0-2769" href="#__codelineno-0-2769"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_set_maintenance_action_log_finish_date</span><span class="p">]</span>
</span><span id="__span-0-2770"><a id="__codelineno-0-2770" name="__codelineno-0-2770" href="#__codelineno-0-2770"></a>
</span><span id="__span-0-2771"><a id="__codelineno-0-2771" name="__codelineno-0-2771" href="#__codelineno-0-2771"></a><span class="w">    </span><span class="o">@</span><span class="n">MaintenanceActionLogId</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
</span><span id="__span-0-2772"><a id="__codelineno-0-2772" name="__codelineno-0-2772" href="#__codelineno-0-2772"></a>
</span><span id="__span-0-2773"><a id="__codelineno-0-2773" name="__codelineno-0-2773" href="#__codelineno-0-2773"></a><span class="w">    </span><span class="o">@</span><span class="n">FinishDate</span><span class="w"> </span><span class="n">datetime2</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span id="__span-0-2774"><a id="__codelineno-0-2774" name="__codelineno-0-2774" href="#__codelineno-0-2774"></a>
</span><span id="__span-0-2775"><a id="__codelineno-0-2775" name="__codelineno-0-2775" href="#__codelineno-0-2775"></a><span class="w">    </span><span class="o">@</span><span class="k">Comment</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span>
</span><span id="__span-0-2776"><a id="__codelineno-0-2776" name="__codelineno-0-2776" href="#__codelineno-0-2776"></a>
</span><span id="__span-0-2777"><a id="__codelineno-0-2777" name="__codelineno-0-2777" href="#__codelineno-0-2777"></a><span class="k">AS</span>
</span><span id="__span-0-2778"><a id="__codelineno-0-2778" name="__codelineno-0-2778" href="#__codelineno-0-2778"></a>
</span><span id="__span-0-2779"><a id="__codelineno-0-2779" name="__codelineno-0-2779" href="#__codelineno-0-2779"></a><span class="k">BEGIN</span>
</span><span id="__span-0-2780"><a id="__codelineno-0-2780" name="__codelineno-0-2780" href="#__codelineno-0-2780"></a>
</span><span id="__span-0-2781"><a id="__codelineno-0-2781" name="__codelineno-0-2781" href="#__codelineno-0-2781"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">NOCOUNT</span><span class="w"> </span><span class="k">ON</span><span class="p">;</span>
</span><span id="__span-0-2782"><a id="__codelineno-0-2782" name="__codelineno-0-2782" href="#__codelineno-0-2782"></a>
</span><span id="__span-0-2783"><a id="__codelineno-0-2783" name="__codelineno-0-2783" href="#__codelineno-0-2783"></a>
</span><span id="__span-0-2784"><a id="__codelineno-0-2784" name="__codelineno-0-2784" href="#__codelineno-0-2784"></a>
</span><span id="__span-0-2785"><a id="__codelineno-0-2785" name="__codelineno-0-2785" href="#__codelineno-0-2785"></a><span class="w">    </span><span class="k">UPDATE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">MaintenanceActionsLog</span><span class="p">]</span>
</span><span id="__span-0-2786"><a id="__codelineno-0-2786" name="__codelineno-0-2786" href="#__codelineno-0-2786"></a>
</span><span id="__span-0-2787"><a id="__codelineno-0-2787" name="__codelineno-0-2787" href="#__codelineno-0-2787"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">FinishDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">FinishDate</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-0-2788"><a id="__codelineno-0-2788" name="__codelineno-0-2788" href="#__codelineno-0-2788"></a>
</span><span id="__span-0-2789"><a id="__codelineno-0-2789" name="__codelineno-0-2789" href="#__codelineno-0-2789"></a><span class="w">        </span><span class="k">Comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="k">Comment</span>
</span><span id="__span-0-2790"><a id="__codelineno-0-2790" name="__codelineno-0-2790" href="#__codelineno-0-2790"></a>
</span><span id="__span-0-2791"><a id="__codelineno-0-2791" name="__codelineno-0-2791" href="#__codelineno-0-2791"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">MaintenanceActionLogId</span>
</span><span id="__span-0-2792"><a id="__codelineno-0-2792" name="__codelineno-0-2792" href="#__codelineno-0-2792"></a>
</span><span id="__span-0-2793"><a id="__codelineno-0-2793" name="__codelineno-0-2793" href="#__codelineno-0-2793"></a><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-2794"><a id="__codelineno-0-2794" name="__codelineno-0-2794" href="#__codelineno-0-2794"></a>
</span><span id="__span-0-2795"><a id="__codelineno-0-2795" name="__codelineno-0-2795" href="#__codelineno-0-2795"></a><span class="k">END</span>
</span><span id="__span-0-2796"><a id="__codelineno-0-2796" name="__codelineno-0-2796" href="#__codelineno-0-2796"></a>
</span><span id="__span-0-2797"><a id="__codelineno-0-2797" name="__codelineno-0-2797" href="#__codelineno-0-2797"></a><span class="k">GO</span>
</span><span id="__span-0-2798"><a id="__codelineno-0-2798" name="__codelineno-0-2798" href="#__codelineno-0-2798"></a>
</span><span id="__span-0-2799"><a id="__codelineno-0-2799" name="__codelineno-0-2799" href="#__codelineno-0-2799"></a>
</span><span id="__span-0-2800"><a id="__codelineno-0-2800" name="__codelineno-0-2800" href="#__codelineno-0-2800"></a>
</span><span id="__span-0-2801"><a id="__codelineno-0-2801" name="__codelineno-0-2801" href="#__codelineno-0-2801"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_StatisticMaintenance</span><span class="p">]</span>
</span><span id="__span-0-2802"><a id="__codelineno-0-2802" name="__codelineno-0-2802" href="#__codelineno-0-2802"></a>
</span><span id="__span-0-2803"><a id="__codelineno-0-2803" name="__codelineno-0-2803" href="#__codelineno-0-2803"></a><span class="w">    </span><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="n">sysname</span><span class="p">,</span>
</span><span id="__span-0-2804"><a id="__codelineno-0-2804" name="__codelineno-0-2804" href="#__codelineno-0-2804"></a>
</span><span id="__span-0-2805"><a id="__codelineno-0-2805" name="__codelineno-0-2805" href="#__codelineno-0-2805"></a><span class="w">    </span><span class="o">@</span><span class="n">timeFrom</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'00:00:00'</span><span class="p">,</span>
</span><span id="__span-0-2806"><a id="__codelineno-0-2806" name="__codelineno-0-2806" href="#__codelineno-0-2806"></a>
</span><span id="__span-0-2807"><a id="__codelineno-0-2807" name="__codelineno-0-2807" href="#__codelineno-0-2807"></a><span class="w">    </span><span class="o">@</span><span class="n">timeTo</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'23:59:59'</span><span class="p">,</span>
</span><span id="__span-0-2808"><a id="__codelineno-0-2808" name="__codelineno-0-2808" href="#__codelineno-0-2808"></a>
</span><span id="__span-0-2809"><a id="__codelineno-0-2809" name="__codelineno-0-2809" href="#__codelineno-0-2809"></a><span class="w">    </span><span class="o">@</span><span class="k">mode</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-0-2810"><a id="__codelineno-0-2810" name="__codelineno-0-2810" href="#__codelineno-0-2810"></a>
</span><span id="__span-0-2811"><a id="__codelineno-0-2811" name="__codelineno-0-2811" href="#__codelineno-0-2811"></a><span class="w">    </span><span class="o">@</span><span class="n">ConditionTableName</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'LIKE ''%'''</span><span class="p">,</span>
</span><span id="__span-0-2812"><a id="__codelineno-0-2812" name="__codelineno-0-2812" href="#__codelineno-0-2812"></a>
</span><span id="__span-0-2813"><a id="__codelineno-0-2813" name="__codelineno-0-2813" href="#__codelineno-0-2813"></a><span class="w">    </span><span class="o">@</span><span class="n">useMonitoringDatabase</span><span class="w"> </span><span class="nb">bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-0-2814"><a id="__codelineno-0-2814" name="__codelineno-0-2814" href="#__codelineno-0-2814"></a>
</span><span id="__span-0-2815"><a id="__codelineno-0-2815" name="__codelineno-0-2815" href="#__codelineno-0-2815"></a><span class="w">    </span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w"> </span><span class="n">sysname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'SQLServerMaintenance'</span>
</span><span id="__span-0-2816"><a id="__codelineno-0-2816" name="__codelineno-0-2816" href="#__codelineno-0-2816"></a>
</span><span id="__span-0-2817"><a id="__codelineno-0-2817" name="__codelineno-0-2817" href="#__codelineno-0-2817"></a><span class="k">AS</span>
</span><span id="__span-0-2818"><a id="__codelineno-0-2818" name="__codelineno-0-2818" href="#__codelineno-0-2818"></a>
</span><span id="__span-0-2819"><a id="__codelineno-0-2819" name="__codelineno-0-2819" href="#__codelineno-0-2819"></a><span class="k">BEGIN</span>
</span><span id="__span-0-2820"><a id="__codelineno-0-2820" name="__codelineno-0-2820" href="#__codelineno-0-2820"></a>
</span><span id="__span-0-2821"><a id="__codelineno-0-2821" name="__codelineno-0-2821" href="#__codelineno-0-2821"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">NOCOUNT</span><span class="w"> </span><span class="k">ON</span><span class="p">;</span>
</span><span id="__span-0-2822"><a id="__codelineno-0-2822" name="__codelineno-0-2822" href="#__codelineno-0-2822"></a>
</span><span id="__span-0-2823"><a id="__codelineno-0-2823" name="__codelineno-0-2823" href="#__codelineno-0-2823"></a>
</span><span id="__span-0-2824"><a id="__codelineno-0-2824" name="__codelineno-0-2824" href="#__codelineno-0-2824"></a>
</span><span id="__span-0-2825"><a id="__codelineno-0-2825" name="__codelineno-0-2825" href="#__codelineno-0-2825"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="o">@</span><span class="k">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-0-2826"><a id="__codelineno-0-2826" name="__codelineno-0-2826" href="#__codelineno-0-2826"></a>
</span><span id="__span-0-2827"><a id="__codelineno-0-2827" name="__codelineno-0-2827" href="#__codelineno-0-2827"></a><span class="w">    </span><span class="k">BEGIN</span>
</span><span id="__span-0-2828"><a id="__codelineno-0-2828" name="__codelineno-0-2828" href="#__codelineno-0-2828"></a>
</span><span id="__span-0-2829"><a id="__codelineno-0-2829" name="__codelineno-0-2829" href="#__codelineno-0-2829"></a><span class="w">        </span><span class="k">EXECUTE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_StatisticMaintenance_Sampled</span><span class="p">]</span><span class="w"> </span>
</span><span id="__span-0-2830"><a id="__codelineno-0-2830" name="__codelineno-0-2830" href="#__codelineno-0-2830"></a>
</span><span id="__span-0-2831"><a id="__codelineno-0-2831" name="__codelineno-0-2831" href="#__codelineno-0-2831"></a><span class="w">        </span><span class="o">@</span><span class="n">databaseName</span>
</span><span id="__span-0-2832"><a id="__codelineno-0-2832" name="__codelineno-0-2832" href="#__codelineno-0-2832"></a>
</span><span id="__span-0-2833"><a id="__codelineno-0-2833" name="__codelineno-0-2833" href="#__codelineno-0-2833"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">timeFrom</span>
</span><span id="__span-0-2834"><a id="__codelineno-0-2834" name="__codelineno-0-2834" href="#__codelineno-0-2834"></a>
</span><span id="__span-0-2835"><a id="__codelineno-0-2835" name="__codelineno-0-2835" href="#__codelineno-0-2835"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">timeTo</span>
</span><span id="__span-0-2836"><a id="__codelineno-0-2836" name="__codelineno-0-2836" href="#__codelineno-0-2836"></a>
</span><span id="__span-0-2837"><a id="__codelineno-0-2837" name="__codelineno-0-2837" href="#__codelineno-0-2837"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">ConditionTableName</span>
</span><span id="__span-0-2838"><a id="__codelineno-0-2838" name="__codelineno-0-2838" href="#__codelineno-0-2838"></a>
</span><span id="__span-0-2839"><a id="__codelineno-0-2839" name="__codelineno-0-2839" href="#__codelineno-0-2839"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">useMonitoringDatabase</span>
</span><span id="__span-0-2840"><a id="__codelineno-0-2840" name="__codelineno-0-2840" href="#__codelineno-0-2840"></a>
</span><span id="__span-0-2841"><a id="__codelineno-0-2841" name="__codelineno-0-2841" href="#__codelineno-0-2841"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">monitoringDatabaseName</span>
</span><span id="__span-0-2842"><a id="__codelineno-0-2842" name="__codelineno-0-2842" href="#__codelineno-0-2842"></a>
</span><span id="__span-0-2843"><a id="__codelineno-0-2843" name="__codelineno-0-2843" href="#__codelineno-0-2843"></a><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="k">IF</span><span class="p">(</span><span class="o">@</span><span class="k">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-0-2844"><a id="__codelineno-0-2844" name="__codelineno-0-2844" href="#__codelineno-0-2844"></a>
</span><span id="__span-0-2845"><a id="__codelineno-0-2845" name="__codelineno-0-2845" href="#__codelineno-0-2845"></a><span class="w">    </span><span class="k">BEGIN</span>
</span><span id="__span-0-2846"><a id="__codelineno-0-2846" name="__codelineno-0-2846" href="#__codelineno-0-2846"></a>
</span><span id="__span-0-2847"><a id="__codelineno-0-2847" name="__codelineno-0-2847" href="#__codelineno-0-2847"></a><span class="w">        </span><span class="k">EXECUTE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_StatisticMaintenance_Detailed</span><span class="p">]</span><span class="w"> </span>
</span><span id="__span-0-2848"><a id="__codelineno-0-2848" name="__codelineno-0-2848" href="#__codelineno-0-2848"></a>
</span><span id="__span-0-2849"><a id="__codelineno-0-2849" name="__codelineno-0-2849" href="#__codelineno-0-2849"></a><span class="w">        </span><span class="o">@</span><span class="n">databaseName</span>
</span><span id="__span-0-2850"><a id="__codelineno-0-2850" name="__codelineno-0-2850" href="#__codelineno-0-2850"></a>
</span><span id="__span-0-2851"><a id="__codelineno-0-2851" name="__codelineno-0-2851" href="#__codelineno-0-2851"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">timeFrom</span>
</span><span id="__span-0-2852"><a id="__codelineno-0-2852" name="__codelineno-0-2852" href="#__codelineno-0-2852"></a>
</span><span id="__span-0-2853"><a id="__codelineno-0-2853" name="__codelineno-0-2853" href="#__codelineno-0-2853"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">timeTo</span>
</span><span id="__span-0-2854"><a id="__codelineno-0-2854" name="__codelineno-0-2854" href="#__codelineno-0-2854"></a>
</span><span id="__span-0-2855"><a id="__codelineno-0-2855" name="__codelineno-0-2855" href="#__codelineno-0-2855"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">ConditionTableName</span>
</span><span id="__span-0-2856"><a id="__codelineno-0-2856" name="__codelineno-0-2856" href="#__codelineno-0-2856"></a>
</span><span id="__span-0-2857"><a id="__codelineno-0-2857" name="__codelineno-0-2857" href="#__codelineno-0-2857"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">useMonitoringDatabase</span>
</span><span id="__span-0-2858"><a id="__codelineno-0-2858" name="__codelineno-0-2858" href="#__codelineno-0-2858"></a>
</span><span id="__span-0-2859"><a id="__codelineno-0-2859" name="__codelineno-0-2859" href="#__codelineno-0-2859"></a><span class="w">        </span><span class="p">,</span><span class="o">@</span><span class="n">monitoringDatabaseName</span>
</span><span id="__span-0-2860"><a id="__codelineno-0-2860" name="__codelineno-0-2860" href="#__codelineno-0-2860"></a>
</span><span id="__span-0-2861"><a id="__codelineno-0-2861" name="__codelineno-0-2861" href="#__codelineno-0-2861"></a><span class="w">    </span><span class="k">END</span>
</span><span id="__span-0-2862"><a id="__codelineno-0-2862" name="__codelineno-0-2862" href="#__codelineno-0-2862"></a>
</span><span id="__span-0-2863"><a id="__codelineno-0-2863" name="__codelineno-0-2863" href="#__codelineno-0-2863"></a>
</span><span id="__span-0-2864"><a id="__codelineno-0-2864" name="__codelineno-0-2864" href="#__codelineno-0-2864"></a>
</span><span id="__span-0-2865"><a id="__codelineno-0-2865" name="__codelineno-0-2865" href="#__codelineno-0-2865"></a><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-2866"><a id="__codelineno-0-2866" name="__codelineno-0-2866" href="#__codelineno-0-2866"></a>
</span><span id="__span-0-2867"><a id="__codelineno-0-2867" name="__codelineno-0-2867" href="#__codelineno-0-2867"></a><span class="k">END</span>
</span><span id="__span-0-2868"><a id="__codelineno-0-2868" name="__codelineno-0-2868" href="#__codelineno-0-2868"></a>
</span><span id="__span-0-2869"><a id="__codelineno-0-2869" name="__codelineno-0-2869" href="#__codelineno-0-2869"></a><span class="k">GO</span>
</span><span id="__span-0-2870"><a id="__codelineno-0-2870" name="__codelineno-0-2870" href="#__codelineno-0-2870"></a>
</span><span id="__span-0-2871"><a id="__codelineno-0-2871" name="__codelineno-0-2871" href="#__codelineno-0-2871"></a>
</span><span id="__span-0-2872"><a id="__codelineno-0-2872" name="__codelineno-0-2872" href="#__codelineno-0-2872"></a>
</span><span id="__span-0-2873"><a id="__codelineno-0-2873" name="__codelineno-0-2873" href="#__codelineno-0-2873"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_StatisticMaintenance_Detailed</span><span class="p">]</span>
</span><span id="__span-0-2874"><a id="__codelineno-0-2874" name="__codelineno-0-2874" href="#__codelineno-0-2874"></a>
</span><span id="__span-0-2875"><a id="__codelineno-0-2875" name="__codelineno-0-2875" href="#__codelineno-0-2875"></a><span class="w">    </span><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="n">sysname</span><span class="p">,</span>
</span><span id="__span-0-2876"><a id="__codelineno-0-2876" name="__codelineno-0-2876" href="#__codelineno-0-2876"></a>
</span><span id="__span-0-2877"><a id="__codelineno-0-2877" name="__codelineno-0-2877" href="#__codelineno-0-2877"></a><span class="w">    </span><span class="o">@</span><span class="n">timeFrom</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'00:00:00'</span><span class="p">,</span>
</span><span id="__span-0-2878"><a id="__codelineno-0-2878" name="__codelineno-0-2878" href="#__codelineno-0-2878"></a>
</span><span id="__span-0-2879"><a id="__codelineno-0-2879" name="__codelineno-0-2879" href="#__codelineno-0-2879"></a><span class="w">    </span><span class="o">@</span><span class="n">timeTo</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'23:59:59'</span><span class="p">,</span><span class="w">  </span>
</span><span id="__span-0-2880"><a id="__codelineno-0-2880" name="__codelineno-0-2880" href="#__codelineno-0-2880"></a>
</span><span id="__span-0-2881"><a id="__codelineno-0-2881" name="__codelineno-0-2881" href="#__codelineno-0-2881"></a><span class="w">    </span><span class="o">@</span><span class="n">ConditionTableName</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'LIKE ''%'''</span><span class="p">,</span>
</span><span id="__span-0-2882"><a id="__codelineno-0-2882" name="__codelineno-0-2882" href="#__codelineno-0-2882"></a>
</span><span id="__span-0-2883"><a id="__codelineno-0-2883" name="__codelineno-0-2883" href="#__codelineno-0-2883"></a><span class="w">    </span><span class="o">@</span><span class="n">useMonitoringDatabase</span><span class="w"> </span><span class="nb">bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-0-2884"><a id="__codelineno-0-2884" name="__codelineno-0-2884" href="#__codelineno-0-2884"></a>
</span><span id="__span-0-2885"><a id="__codelineno-0-2885" name="__codelineno-0-2885" href="#__codelineno-0-2885"></a><span class="w">    </span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w"> </span><span class="n">sysname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'SQLServerMaintenance'</span>
</span><span id="__span-0-2886"><a id="__codelineno-0-2886" name="__codelineno-0-2886" href="#__codelineno-0-2886"></a>
</span><span id="__span-0-2887"><a id="__codelineno-0-2887" name="__codelineno-0-2887" href="#__codelineno-0-2887"></a><span class="k">AS</span>
</span><span id="__span-0-2888"><a id="__codelineno-0-2888" name="__codelineno-0-2888" href="#__codelineno-0-2888"></a>
</span><span id="__span-0-2889"><a id="__codelineno-0-2889" name="__codelineno-0-2889" href="#__codelineno-0-2889"></a><span class="k">BEGIN</span>
</span><span id="__span-0-2890"><a id="__codelineno-0-2890" name="__codelineno-0-2890" href="#__codelineno-0-2890"></a>
</span><span id="__span-0-2891"><a id="__codelineno-0-2891" name="__codelineno-0-2891" href="#__codelineno-0-2891"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">NOCOUNT</span><span class="w"> </span><span class="k">ON</span><span class="p">;</span>
</span><span id="__span-0-2892"><a id="__codelineno-0-2892" name="__codelineno-0-2892" href="#__codelineno-0-2892"></a>
</span><span id="__span-0-2893"><a id="__codelineno-0-2893" name="__codelineno-0-2893" href="#__codelineno-0-2893"></a>
</span><span id="__span-0-2894"><a id="__codelineno-0-2894" name="__codelineno-0-2894" href="#__codelineno-0-2894"></a>
</span><span id="__span-0-2895"><a id="__codelineno-0-2895" name="__codelineno-0-2895" href="#__codelineno-0-2895"></a><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">msg</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
</span><span id="__span-0-2896"><a id="__codelineno-0-2896" name="__codelineno-0-2896" href="#__codelineno-0-2896"></a>
</span><span id="__span-0-2897"><a id="__codelineno-0-2897" name="__codelineno-0-2897" href="#__codelineno-0-2897"></a>
</span><span id="__span-0-2898"><a id="__codelineno-0-2898" name="__codelineno-0-2898" href="#__codelineno-0-2898"></a>
</span><span id="__span-0-2899"><a id="__codelineno-0-2899" name="__codelineno-0-2899" href="#__codelineno-0-2899"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">DB_ID</span><span class="p">(</span><span class="o">@</span><span class="n">databaseName</span><span class="p">)</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-0-2900"><a id="__codelineno-0-2900" name="__codelineno-0-2900" href="#__codelineno-0-2900"></a>
</span><span id="__span-0-2901"><a id="__codelineno-0-2901" name="__codelineno-0-2901" href="#__codelineno-0-2901"></a><span class="w">    </span><span class="k">BEGIN</span>
</span><span id="__span-0-2902"><a id="__codelineno-0-2902" name="__codelineno-0-2902" href="#__codelineno-0-2902"></a>
</span><span id="__span-0-2903"><a id="__codelineno-0-2903" name="__codelineno-0-2903" href="#__codelineno-0-2903"></a><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Database '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">' is not exists.'</span><span class="p">;</span>
</span><span id="__span-0-2904"><a id="__codelineno-0-2904" name="__codelineno-0-2904" href="#__codelineno-0-2904"></a>
</span><span id="__span-0-2905"><a id="__codelineno-0-2905" name="__codelineno-0-2905" href="#__codelineno-0-2905"></a><span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="mi">51000</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-2906"><a id="__codelineno-0-2906" name="__codelineno-0-2906" href="#__codelineno-0-2906"></a>
</span><span id="__span-0-2907"><a id="__codelineno-0-2907" name="__codelineno-0-2907" href="#__codelineno-0-2907"></a><span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-2908"><a id="__codelineno-0-2908" name="__codelineno-0-2908" href="#__codelineno-0-2908"></a>
</span><span id="__span-0-2909"><a id="__codelineno-0-2909" name="__codelineno-0-2909" href="#__codelineno-0-2909"></a><span class="w">    </span><span class="k">END</span>
</span><span id="__span-0-2910"><a id="__codelineno-0-2910" name="__codelineno-0-2910" href="#__codelineno-0-2910"></a>
</span><span id="__span-0-2911"><a id="__codelineno-0-2911" name="__codelineno-0-2911" href="#__codelineno-0-2911"></a>
</span><span id="__span-0-2912"><a id="__codelineno-0-2912" name="__codelineno-0-2912" href="#__codelineno-0-2912"></a>
</span><span id="__span-0-2913"><a id="__codelineno-0-2913" name="__codelineno-0-2913" href="#__codelineno-0-2913"></a><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
</span><span id="__span-0-2914"><a id="__codelineno-0-2914" name="__codelineno-0-2914" href="#__codelineno-0-2914"></a>
</span><span id="__span-0-2915"><a id="__codelineno-0-2915" name="__codelineno-0-2915" href="#__codelineno-0-2915"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
</span><span id="__span-0-2916"><a id="__codelineno-0-2916" name="__codelineno-0-2916" href="#__codelineno-0-2916"></a>
</span><span id="__span-0-2917"><a id="__codelineno-0-2917" name="__codelineno-0-2917" href="#__codelineno-0-2917"></a><span class="k">CAST</span><span class="p">(</span><span class="s1">'USE ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">databasename</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">']</span>
</span><span id="__span-0-2918"><a id="__codelineno-0-2918" name="__codelineno-0-2918" href="#__codelineno-0-2918"></a>
</span><span id="__span-0-2919"><a id="__codelineno-0-2919" name="__codelineno-0-2919" href="#__codelineno-0-2919"></a><span class="s1">SET NOCOUNT ON;</span>
</span><span id="__span-0-2920"><a id="__codelineno-0-2920" name="__codelineno-0-2920" href="#__codelineno-0-2920"></a>
</span><span id="__span-0-2921"><a id="__codelineno-0-2921" name="__codelineno-0-2921" href="#__codelineno-0-2921"></a><span class="s1">DECLARE</span>
</span><span id="__span-0-2922"><a id="__codelineno-0-2922" name="__codelineno-0-2922" href="#__codelineno-0-2922"></a>
</span><span id="__span-0-2923"><a id="__codelineno-0-2923" name="__codelineno-0-2923" href="#__codelineno-0-2923"></a><span class="s1">    -- Текущее время</span>
</span><span id="__span-0-2924"><a id="__codelineno-0-2924" name="__codelineno-0-2924" href="#__codelineno-0-2924"></a>
</span><span id="__span-0-2925"><a id="__codelineno-0-2925" name="__codelineno-0-2925" href="#__codelineno-0-2925"></a><span class="s1">    @timeNow TIME = CAST(GETDATE() AS TIME)</span>
</span><span id="__span-0-2926"><a id="__codelineno-0-2926" name="__codelineno-0-2926" href="#__codelineno-0-2926"></a>
</span><span id="__span-0-2927"><a id="__codelineno-0-2927" name="__codelineno-0-2927" href="#__codelineno-0-2927"></a><span class="s1">    -- Начало доступного интервала времени обслуживания</span>
</span><span id="__span-0-2928"><a id="__codelineno-0-2928" name="__codelineno-0-2928" href="#__codelineno-0-2928"></a>
</span><span id="__span-0-2929"><a id="__codelineno-0-2929" name="__codelineno-0-2929" href="#__codelineno-0-2929"></a><span class="s1">    -- @timeFrom TIME</span>
</span><span id="__span-0-2930"><a id="__codelineno-0-2930" name="__codelineno-0-2930" href="#__codelineno-0-2930"></a>
</span><span id="__span-0-2931"><a id="__codelineno-0-2931" name="__codelineno-0-2931" href="#__codelineno-0-2931"></a><span class="s1">    -- Окончание доступного интервала времени обслуживания</span>
</span><span id="__span-0-2932"><a id="__codelineno-0-2932" name="__codelineno-0-2932" href="#__codelineno-0-2932"></a>
</span><span id="__span-0-2933"><a id="__codelineno-0-2933" name="__codelineno-0-2933" href="#__codelineno-0-2933"></a><span class="s1">    -- @timeTo TIME</span>
</span><span id="__span-0-2934"><a id="__codelineno-0-2934" name="__codelineno-0-2934" href="#__codelineno-0-2934"></a>
</span><span id="__span-0-2935"><a id="__codelineno-0-2935" name="__codelineno-0-2935" href="#__codelineno-0-2935"></a><span class="s1">-- Проверка доступен ли запуск обслуживания в текущее время</span>
</span><span id="__span-0-2936"><a id="__codelineno-0-2936" name="__codelineno-0-2936" href="#__codelineno-0-2936"></a>
</span><span id="__span-0-2937"><a id="__codelineno-0-2937" name="__codelineno-0-2937" href="#__codelineno-0-2937"></a><span class="s1">IF (@timeTo &gt;= @timeFrom) BEGIN</span>
</span><span id="__span-0-2938"><a id="__codelineno-0-2938" name="__codelineno-0-2938" href="#__codelineno-0-2938"></a>
</span><span id="__span-0-2939"><a id="__codelineno-0-2939" name="__codelineno-0-2939" href="#__codelineno-0-2939"></a><span class="s1">    IF(NOT (@timeFrom &lt;= @timeNow AND @timeTo &gt;= @timeNow))</span>
</span><span id="__span-0-2940"><a id="__codelineno-0-2940" name="__codelineno-0-2940" href="#__codelineno-0-2940"></a>
</span><span id="__span-0-2941"><a id="__codelineno-0-2941" name="__codelineno-0-2941" href="#__codelineno-0-2941"></a><span class="s1">        RETURN;</span>
</span><span id="__span-0-2942"><a id="__codelineno-0-2942" name="__codelineno-0-2942" href="#__codelineno-0-2942"></a>
</span><span id="__span-0-2943"><a id="__codelineno-0-2943" name="__codelineno-0-2943" href="#__codelineno-0-2943"></a><span class="s1">    END ELSE BEGIN</span>
</span><span id="__span-0-2944"><a id="__codelineno-0-2944" name="__codelineno-0-2944" href="#__codelineno-0-2944"></a>
</span><span id="__span-0-2945"><a id="__codelineno-0-2945" name="__codelineno-0-2945" href="#__codelineno-0-2945"></a><span class="s1">        IF(NOT ((@timeFrom &lt;= @timeNow AND ''23:59:59'' &gt;= @timeNow)</span>
</span><span id="__span-0-2946"><a id="__codelineno-0-2946" name="__codelineno-0-2946" href="#__codelineno-0-2946"></a>
</span><span id="__span-0-2947"><a id="__codelineno-0-2947" name="__codelineno-0-2947" href="#__codelineno-0-2947"></a><span class="s1">            OR (@timeTo &gt;= @timeNow AND ''00:00:00'' &lt;= @timeNow)))  </span>
</span><span id="__span-0-2948"><a id="__codelineno-0-2948" name="__codelineno-0-2948" href="#__codelineno-0-2948"></a>
</span><span id="__span-0-2949"><a id="__codelineno-0-2949" name="__codelineno-0-2949" href="#__codelineno-0-2949"></a><span class="s1">                RETURN;</span>
</span><span id="__span-0-2950"><a id="__codelineno-0-2950" name="__codelineno-0-2950" href="#__codelineno-0-2950"></a>
</span><span id="__span-0-2951"><a id="__codelineno-0-2951" name="__codelineno-0-2951" href="#__codelineno-0-2951"></a><span class="s1">END</span>
</span><span id="__span-0-2952"><a id="__codelineno-0-2952" name="__codelineno-0-2952" href="#__codelineno-0-2952"></a>
</span><span id="__span-0-2953"><a id="__codelineno-0-2953" name="__codelineno-0-2953" href="#__codelineno-0-2953"></a><span class="s1">-- Служебные переменные</span>
</span><span id="__span-0-2954"><a id="__codelineno-0-2954" name="__codelineno-0-2954" href="#__codelineno-0-2954"></a>
</span><span id="__span-0-2955"><a id="__codelineno-0-2955" name="__codelineno-0-2955" href="#__codelineno-0-2955"></a><span class="s1">DECLARE</span>
</span><span id="__span-0-2956"><a id="__codelineno-0-2956" name="__codelineno-0-2956" href="#__codelineno-0-2956"></a>
</span><span id="__span-0-2957"><a id="__codelineno-0-2957" name="__codelineno-0-2957" href="#__codelineno-0-2957"></a><span class="s1">    @DBID SMALLINT = DB_ID()</span>
</span><span id="__span-0-2958"><a id="__codelineno-0-2958" name="__codelineno-0-2958" href="#__codelineno-0-2958"></a>
</span><span id="__span-0-2959"><a id="__codelineno-0-2959" name="__codelineno-0-2959" href="#__codelineno-0-2959"></a><span class="s1">    ,@DBNAME sysname = DB_NAME()</span>
</span><span id="__span-0-2960"><a id="__codelineno-0-2960" name="__codelineno-0-2960" href="#__codelineno-0-2960"></a>
</span><span id="__span-0-2961"><a id="__codelineno-0-2961" name="__codelineno-0-2961" href="#__codelineno-0-2961"></a><span class="s1">    ,@TableName SYSNAME</span>
</span><span id="__span-0-2962"><a id="__codelineno-0-2962" name="__codelineno-0-2962" href="#__codelineno-0-2962"></a>
</span><span id="__span-0-2963"><a id="__codelineno-0-2963" name="__codelineno-0-2963" href="#__codelineno-0-2963"></a><span class="s1">    ,@IndexName SYSNAME</span>
</span><span id="__span-0-2964"><a id="__codelineno-0-2964" name="__codelineno-0-2964" href="#__codelineno-0-2964"></a>
</span><span id="__span-0-2965"><a id="__codelineno-0-2965" name="__codelineno-0-2965" href="#__codelineno-0-2965"></a><span class="s1">    ,@Operation NVARCHAR(128) = ''UPDATE STATISTICS''</span>
</span><span id="__span-0-2966"><a id="__codelineno-0-2966" name="__codelineno-0-2966" href="#__codelineno-0-2966"></a>
</span><span id="__span-0-2967"><a id="__codelineno-0-2967" name="__codelineno-0-2967" href="#__codelineno-0-2967"></a><span class="s1">    ,@RunDate DATETIME = GETDATE()</span>
</span><span id="__span-0-2968"><a id="__codelineno-0-2968" name="__codelineno-0-2968" href="#__codelineno-0-2968"></a>
</span><span id="__span-0-2969"><a id="__codelineno-0-2969" name="__codelineno-0-2969" href="#__codelineno-0-2969"></a><span class="s1">    ,@StartDate DATETIME</span>
</span><span id="__span-0-2970"><a id="__codelineno-0-2970" name="__codelineno-0-2970" href="#__codelineno-0-2970"></a>
</span><span id="__span-0-2971"><a id="__codelineno-0-2971" name="__codelineno-0-2971" href="#__codelineno-0-2971"></a><span class="s1">    ,@FinishDate DATETIME</span>
</span><span id="__span-0-2972"><a id="__codelineno-0-2972" name="__codelineno-0-2972" href="#__codelineno-0-2972"></a>
</span><span id="__span-0-2973"><a id="__codelineno-0-2973" name="__codelineno-0-2973" href="#__codelineno-0-2973"></a><span class="s1">    ,@SQL NVARCHAR(500) </span>
</span><span id="__span-0-2974"><a id="__codelineno-0-2974" name="__codelineno-0-2974" href="#__codelineno-0-2974"></a>
</span><span id="__span-0-2975"><a id="__codelineno-0-2975" name="__codelineno-0-2975" href="#__codelineno-0-2975"></a><span class="s1">    ,@RowModCtr BIGINT</span>
</span><span id="__span-0-2976"><a id="__codelineno-0-2976" name="__codelineno-0-2976" href="#__codelineno-0-2976"></a>
</span><span id="__span-0-2977"><a id="__codelineno-0-2977" name="__codelineno-0-2977" href="#__codelineno-0-2977"></a><span class="s1">    ,@MaintenanceActionLogId bigint;</span>
</span><span id="__span-0-2978"><a id="__codelineno-0-2978" name="__codelineno-0-2978" href="#__codelineno-0-2978"></a>
</span><span id="__span-0-2979"><a id="__codelineno-0-2979" name="__codelineno-0-2979" href="#__codelineno-0-2979"></a><span class="s1">DECLARE todo CURSOR FOR</span>
</span><span id="__span-0-2980"><a id="__codelineno-0-2980" name="__codelineno-0-2980" href="#__codelineno-0-2980"></a>
</span><span id="__span-0-2981"><a id="__codelineno-0-2981" name="__codelineno-0-2981" href="#__codelineno-0-2981"></a><span class="s1">SELECT</span>
</span><span id="__span-0-2982"><a id="__codelineno-0-2982" name="__codelineno-0-2982" href="#__codelineno-0-2982"></a>
</span><span id="__span-0-2983"><a id="__codelineno-0-2983" name="__codelineno-0-2983" href="#__codelineno-0-2983"></a><span class="s1">    ''</span>
</span><span id="__span-0-2984"><a id="__codelineno-0-2984" name="__codelineno-0-2984" href="#__codelineno-0-2984"></a>
</span><span id="__span-0-2985"><a id="__codelineno-0-2985" name="__codelineno-0-2985" href="#__codelineno-0-2985"></a><span class="s1">    UPDATE STATISTICS ['' + SCHEMA_NAME([o].[schema_id]) + ''].['' + [o].[name] + ''] ['' + [s].[name] + '']</span>
</span><span id="__span-0-2986"><a id="__codelineno-0-2986" name="__codelineno-0-2986" href="#__codelineno-0-2986"></a>
</span><span id="__span-0-2987"><a id="__codelineno-0-2987" name="__codelineno-0-2987" href="#__codelineno-0-2987"></a><span class="s1">        WITH FULLSCAN'' + CASE WHEN [s].[no_recompute] = 1 THEN '', NORECOMPUTE'' ELSE '''' END + '';''</span>
</span><span id="__span-0-2988"><a id="__codelineno-0-2988" name="__codelineno-0-2988" href="#__codelineno-0-2988"></a>
</span><span id="__span-0-2989"><a id="__codelineno-0-2989" name="__codelineno-0-2989" href="#__codelineno-0-2989"></a><span class="s1">    , [o].[name]</span>
</span><span id="__span-0-2990"><a id="__codelineno-0-2990" name="__codelineno-0-2990" href="#__codelineno-0-2990"></a>
</span><span id="__span-0-2991"><a id="__codelineno-0-2991" name="__codelineno-0-2991" href="#__codelineno-0-2991"></a><span class="s1">    , [s].[name] AS [stat_name],</span>
</span><span id="__span-0-2992"><a id="__codelineno-0-2992" name="__codelineno-0-2992" href="#__codelineno-0-2992"></a>
</span><span id="__span-0-2993"><a id="__codelineno-0-2993" name="__codelineno-0-2993" href="#__codelineno-0-2993"></a><span class="s1">    [rowmodctr]</span>
</span><span id="__span-0-2994"><a id="__codelineno-0-2994" name="__codelineno-0-2994" href="#__codelineno-0-2994"></a>
</span><span id="__span-0-2995"><a id="__codelineno-0-2995" name="__codelineno-0-2995" href="#__codelineno-0-2995"></a><span class="s1">FROM (</span>
</span><span id="__span-0-2996"><a id="__codelineno-0-2996" name="__codelineno-0-2996" href="#__codelineno-0-2996"></a>
</span><span id="__span-0-2997"><a id="__codelineno-0-2997" name="__codelineno-0-2997" href="#__codelineno-0-2997"></a><span class="s1">    SELECT</span>
</span><span id="__span-0-2998"><a id="__codelineno-0-2998" name="__codelineno-0-2998" href="#__codelineno-0-2998"></a>
</span><span id="__span-0-2999"><a id="__codelineno-0-2999" name="__codelineno-0-2999" href="#__codelineno-0-2999"></a><span class="s1">        [object_id]</span>
</span><span id="__span-0-3000"><a id="__codelineno-0-3000" name="__codelineno-0-3000" href="#__codelineno-0-3000"></a>
</span><span id="__span-0-3001"><a id="__codelineno-0-3001" name="__codelineno-0-3001" href="#__codelineno-0-3001"></a><span class="s1">        ,[name]</span>
</span><span id="__span-0-3002"><a id="__codelineno-0-3002" name="__codelineno-0-3002" href="#__codelineno-0-3002"></a>
</span><span id="__span-0-3003"><a id="__codelineno-0-3003" name="__codelineno-0-3003" href="#__codelineno-0-3003"></a><span class="s1">        ,[stats_id]</span>
</span><span id="__span-0-3004"><a id="__codelineno-0-3004" name="__codelineno-0-3004" href="#__codelineno-0-3004"></a>
</span><span id="__span-0-3005"><a id="__codelineno-0-3005" name="__codelineno-0-3005" href="#__codelineno-0-3005"></a><span class="s1">        ,[no_recompute]</span>
</span><span id="__span-0-3006"><a id="__codelineno-0-3006" name="__codelineno-0-3006" href="#__codelineno-0-3006"></a>
</span><span id="__span-0-3007"><a id="__codelineno-0-3007" name="__codelineno-0-3007" href="#__codelineno-0-3007"></a><span class="s1">        ,[last_update] = STATS_DATE([object_id], [stats_id])</span>
</span><span id="__span-0-3008"><a id="__codelineno-0-3008" name="__codelineno-0-3008" href="#__codelineno-0-3008"></a>
</span><span id="__span-0-3009"><a id="__codelineno-0-3009" name="__codelineno-0-3009" href="#__codelineno-0-3009"></a><span class="s1">        ,[auto_created]</span>
</span><span id="__span-0-3010"><a id="__codelineno-0-3010" name="__codelineno-0-3010" href="#__codelineno-0-3010"></a>
</span><span id="__span-0-3011"><a id="__codelineno-0-3011" name="__codelineno-0-3011" href="#__codelineno-0-3011"></a><span class="s1">    FROM sys.stats WITH(NOLOCK)</span>
</span><span id="__span-0-3012"><a id="__codelineno-0-3012" name="__codelineno-0-3012" href="#__codelineno-0-3012"></a>
</span><span id="__span-0-3013"><a id="__codelineno-0-3013" name="__codelineno-0-3013" href="#__codelineno-0-3013"></a><span class="s1">    WHERE [is_temporary] = 0) s</span>
</span><span id="__span-0-3014"><a id="__codelineno-0-3014" name="__codelineno-0-3014" href="#__codelineno-0-3014"></a>
</span><span id="__span-0-3015"><a id="__codelineno-0-3015" name="__codelineno-0-3015" href="#__codelineno-0-3015"></a><span class="s1">        LEFT JOIN sys.objects o WITH(NOLOCK) </span>
</span><span id="__span-0-3016"><a id="__codelineno-0-3016" name="__codelineno-0-3016" href="#__codelineno-0-3016"></a>
</span><span id="__span-0-3017"><a id="__codelineno-0-3017" name="__codelineno-0-3017" href="#__codelineno-0-3017"></a><span class="s1">            ON [s].[object_id] = [o].[object_id]</span>
</span><span id="__span-0-3018"><a id="__codelineno-0-3018" name="__codelineno-0-3018" href="#__codelineno-0-3018"></a>
</span><span id="__span-0-3019"><a id="__codelineno-0-3019" name="__codelineno-0-3019" href="#__codelineno-0-3019"></a><span class="s1">        LEFT JOIN (</span>
</span><span id="__span-0-3020"><a id="__codelineno-0-3020" name="__codelineno-0-3020" href="#__codelineno-0-3020"></a>
</span><span id="__span-0-3021"><a id="__codelineno-0-3021" name="__codelineno-0-3021" href="#__codelineno-0-3021"></a><span class="s1">            SELECT</span>
</span><span id="__span-0-3022"><a id="__codelineno-0-3022" name="__codelineno-0-3022" href="#__codelineno-0-3022"></a>
</span><span id="__span-0-3023"><a id="__codelineno-0-3023" name="__codelineno-0-3023" href="#__codelineno-0-3023"></a><span class="s1">                [p].[object_id]</span>
</span><span id="__span-0-3024"><a id="__codelineno-0-3024" name="__codelineno-0-3024" href="#__codelineno-0-3024"></a>
</span><span id="__span-0-3025"><a id="__codelineno-0-3025" name="__codelineno-0-3025" href="#__codelineno-0-3025"></a><span class="s1">                ,[p].[index_id]</span>
</span><span id="__span-0-3026"><a id="__codelineno-0-3026" name="__codelineno-0-3026" href="#__codelineno-0-3026"></a>
</span><span id="__span-0-3027"><a id="__codelineno-0-3027" name="__codelineno-0-3027" href="#__codelineno-0-3027"></a><span class="s1">                ,[total_pages] = SUM([a].[total_pages])</span>
</span><span id="__span-0-3028"><a id="__codelineno-0-3028" name="__codelineno-0-3028" href="#__codelineno-0-3028"></a>
</span><span id="__span-0-3029"><a id="__codelineno-0-3029" name="__codelineno-0-3029" href="#__codelineno-0-3029"></a><span class="s1">            FROM sys.partitions p WITH(NOLOCK)</span>
</span><span id="__span-0-3030"><a id="__codelineno-0-3030" name="__codelineno-0-3030" href="#__codelineno-0-3030"></a>
</span><span id="__span-0-3031"><a id="__codelineno-0-3031" name="__codelineno-0-3031" href="#__codelineno-0-3031"></a><span class="s1">                JOIN sys.allocation_units a WITH(NOLOCK) ON [p].[partition_id] = [a].[container_id]</span>
</span><span id="__span-0-3032"><a id="__codelineno-0-3032" name="__codelineno-0-3032" href="#__codelineno-0-3032"></a>
</span><span id="__span-0-3033"><a id="__codelineno-0-3033" name="__codelineno-0-3033" href="#__codelineno-0-3033"></a><span class="s1">            GROUP BY </span>
</span><span id="__span-0-3034"><a id="__codelineno-0-3034" name="__codelineno-0-3034" href="#__codelineno-0-3034"></a>
</span><span id="__span-0-3035"><a id="__codelineno-0-3035" name="__codelineno-0-3035" href="#__codelineno-0-3035"></a><span class="s1">                [p].[object_id]</span>
</span><span id="__span-0-3036"><a id="__codelineno-0-3036" name="__codelineno-0-3036" href="#__codelineno-0-3036"></a>
</span><span id="__span-0-3037"><a id="__codelineno-0-3037" name="__codelineno-0-3037" href="#__codelineno-0-3037"></a><span class="s1">                ,[p].[index_id]) p </span>
</span><span id="__span-0-3038"><a id="__codelineno-0-3038" name="__codelineno-0-3038" href="#__codelineno-0-3038"></a>
</span><span id="__span-0-3039"><a id="__codelineno-0-3039" name="__codelineno-0-3039" href="#__codelineno-0-3039"></a><span class="s1">            ON [o].[object_id] = [p].[object_id] AND [p].[index_id] = [s].[stats_id]</span>
</span><span id="__span-0-3040"><a id="__codelineno-0-3040" name="__codelineno-0-3040" href="#__codelineno-0-3040"></a>
</span><span id="__span-0-3041"><a id="__codelineno-0-3041" name="__codelineno-0-3041" href="#__codelineno-0-3041"></a><span class="s1">        LEFT JOIN sys.sysindexes si</span>
</span><span id="__span-0-3042"><a id="__codelineno-0-3042" name="__codelineno-0-3042" href="#__codelineno-0-3042"></a>
</span><span id="__span-0-3043"><a id="__codelineno-0-3043" name="__codelineno-0-3043" href="#__codelineno-0-3043"></a><span class="s1">    ON [si].[id] = [s].[object_id] AND [si].[indid] = [s].[stats_id]</span>
</span><span id="__span-0-3044"><a id="__codelineno-0-3044" name="__codelineno-0-3044" href="#__codelineno-0-3044"></a>
</span><span id="__span-0-3045"><a id="__codelineno-0-3045" name="__codelineno-0-3045" href="#__codelineno-0-3045"></a><span class="s1">WHERE [o].[type] IN (''U'', ''V'')</span>
</span><span id="__span-0-3046"><a id="__codelineno-0-3046" name="__codelineno-0-3046" href="#__codelineno-0-3046"></a>
</span><span id="__span-0-3047"><a id="__codelineno-0-3047" name="__codelineno-0-3047" href="#__codelineno-0-3047"></a><span class="s1">    AND [o].[is_ms_shipped] = 0</span>
</span><span id="__span-0-3048"><a id="__codelineno-0-3048" name="__codelineno-0-3048" href="#__codelineno-0-3048"></a>
</span><span id="__span-0-3049"><a id="__codelineno-0-3049" name="__codelineno-0-3049" href="#__codelineno-0-3049"></a><span class="s1">    AND [rowmodctr] &gt; 0</span>
</span><span id="__span-0-3050"><a id="__codelineno-0-3050" name="__codelineno-0-3050" href="#__codelineno-0-3050"></a>
</span><span id="__span-0-3051"><a id="__codelineno-0-3051" name="__codelineno-0-3051" href="#__codelineno-0-3051"></a><span class="s1">    AND [o].[name] '</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">ConditionTableName</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'</span>
</span><span id="__span-0-3052"><a id="__codelineno-0-3052" name="__codelineno-0-3052" href="#__codelineno-0-3052"></a>
</span><span id="__span-0-3053"><a id="__codelineno-0-3053" name="__codelineno-0-3053" href="#__codelineno-0-3053"></a><span class="s1">ORDER BY [rowmodctr] DESC;</span>
</span><span id="__span-0-3054"><a id="__codelineno-0-3054" name="__codelineno-0-3054" href="#__codelineno-0-3054"></a>
</span><span id="__span-0-3055"><a id="__codelineno-0-3055" name="__codelineno-0-3055" href="#__codelineno-0-3055"></a><span class="s1">OPEN todo;</span>
</span><span id="__span-0-3056"><a id="__codelineno-0-3056" name="__codelineno-0-3056" href="#__codelineno-0-3056"></a>
</span><span id="__span-0-3057"><a id="__codelineno-0-3057" name="__codelineno-0-3057" href="#__codelineno-0-3057"></a><span class="s1">WHILE 1=1</span>
</span><span id="__span-0-3058"><a id="__codelineno-0-3058" name="__codelineno-0-3058" href="#__codelineno-0-3058"></a>
</span><span id="__span-0-3059"><a id="__codelineno-0-3059" name="__codelineno-0-3059" href="#__codelineno-0-3059"></a><span class="s1">BEGIN</span>
</span><span id="__span-0-3060"><a id="__codelineno-0-3060" name="__codelineno-0-3060" href="#__codelineno-0-3060"></a>
</span><span id="__span-0-3061"><a id="__codelineno-0-3061" name="__codelineno-0-3061" href="#__codelineno-0-3061"></a><span class="s1">    FETCH NEXT FROM todo INTO @SQL, @TableName, @IndexName, @RowModCtr;</span>
</span><span id="__span-0-3062"><a id="__codelineno-0-3062" name="__codelineno-0-3062" href="#__codelineno-0-3062"></a>
</span><span id="__span-0-3063"><a id="__codelineno-0-3063" name="__codelineno-0-3063" href="#__codelineno-0-3063"></a><span class="s1">    IF @@FETCH_STATUS != 0</span>
</span><span id="__span-0-3064"><a id="__codelineno-0-3064" name="__codelineno-0-3064" href="#__codelineno-0-3064"></a>
</span><span id="__span-0-3065"><a id="__codelineno-0-3065" name="__codelineno-0-3065" href="#__codelineno-0-3065"></a><span class="s1">        BREAK;</span>
</span><span id="__span-0-3066"><a id="__codelineno-0-3066" name="__codelineno-0-3066" href="#__codelineno-0-3066"></a>
</span><span id="__span-0-3067"><a id="__codelineno-0-3067" name="__codelineno-0-3067" href="#__codelineno-0-3067"></a><span class="s1">    -- Проверка доступен ли запуск обслуживания в текущее время</span>
</span><span id="__span-0-3068"><a id="__codelineno-0-3068" name="__codelineno-0-3068" href="#__codelineno-0-3068"></a>
</span><span id="__span-0-3069"><a id="__codelineno-0-3069" name="__codelineno-0-3069" href="#__codelineno-0-3069"></a><span class="s1">    SET @timeNow = CAST(GETDATE() AS TIME);</span>
</span><span id="__span-0-3070"><a id="__codelineno-0-3070" name="__codelineno-0-3070" href="#__codelineno-0-3070"></a>
</span><span id="__span-0-3071"><a id="__codelineno-0-3071" name="__codelineno-0-3071" href="#__codelineno-0-3071"></a><span class="s1">    IF (@timeTo &gt;= @timeFrom) BEGIN</span>
</span><span id="__span-0-3072"><a id="__codelineno-0-3072" name="__codelineno-0-3072" href="#__codelineno-0-3072"></a>
</span><span id="__span-0-3073"><a id="__codelineno-0-3073" name="__codelineno-0-3073" href="#__codelineno-0-3073"></a><span class="s1">        IF(NOT (@timeFrom &lt;= @timeNow AND @timeTo &gt;= @timeNow))</span>
</span><span id="__span-0-3074"><a id="__codelineno-0-3074" name="__codelineno-0-3074" href="#__codelineno-0-3074"></a>
</span><span id="__span-0-3075"><a id="__codelineno-0-3075" name="__codelineno-0-3075" href="#__codelineno-0-3075"></a><span class="s1">            RETURN;</span>
</span><span id="__span-0-3076"><a id="__codelineno-0-3076" name="__codelineno-0-3076" href="#__codelineno-0-3076"></a>
</span><span id="__span-0-3077"><a id="__codelineno-0-3077" name="__codelineno-0-3077" href="#__codelineno-0-3077"></a><span class="s1">    END ELSE BEGIN</span>
</span><span id="__span-0-3078"><a id="__codelineno-0-3078" name="__codelineno-0-3078" href="#__codelineno-0-3078"></a>
</span><span id="__span-0-3079"><a id="__codelineno-0-3079" name="__codelineno-0-3079" href="#__codelineno-0-3079"></a><span class="s1">        IF(NOT ((@timeFrom &lt;= @timeNow AND ''23:59:59'' &gt;= @timeNow)</span>
</span><span id="__span-0-3080"><a id="__codelineno-0-3080" name="__codelineno-0-3080" href="#__codelineno-0-3080"></a>
</span><span id="__span-0-3081"><a id="__codelineno-0-3081" name="__codelineno-0-3081" href="#__codelineno-0-3081"></a><span class="s1">            OR (@timeTo &gt;= @timeNow AND ''00:00:00'' &lt;= @timeNow)))  </span>
</span><span id="__span-0-3082"><a id="__codelineno-0-3082" name="__codelineno-0-3082" href="#__codelineno-0-3082"></a>
</span><span id="__span-0-3083"><a id="__codelineno-0-3083" name="__codelineno-0-3083" href="#__codelineno-0-3083"></a><span class="s1">        RETURN;</span>
</span><span id="__span-0-3084"><a id="__codelineno-0-3084" name="__codelineno-0-3084" href="#__codelineno-0-3084"></a>
</span><span id="__span-0-3085"><a id="__codelineno-0-3085" name="__codelineno-0-3085" href="#__codelineno-0-3085"></a><span class="s1">    END</span>
</span><span id="__span-0-3086"><a id="__codelineno-0-3086" name="__codelineno-0-3086" href="#__codelineno-0-3086"></a>
</span><span id="__span-0-3087"><a id="__codelineno-0-3087" name="__codelineno-0-3087" href="#__codelineno-0-3087"></a><span class="s1">    SET @StartDate = GetDate();</span>
</span><span id="__span-0-3088"><a id="__codelineno-0-3088" name="__codelineno-0-3088" href="#__codelineno-0-3088"></a>
</span><span id="__span-0-3089"><a id="__codelineno-0-3089" name="__codelineno-0-3089" href="#__codelineno-0-3089"></a><span class="s1">    BEGIN TRY</span>
</span><span id="__span-0-3090"><a id="__codelineno-0-3090" name="__codelineno-0-3090" href="#__codelineno-0-3090"></a>
</span><span id="__span-0-3091"><a id="__codelineno-0-3091" name="__codelineno-0-3091" href="#__codelineno-0-3091"></a><span class="s1">        -- Сохраняем предварительную информацию об операции обслуживания без даты завершения</span>
</span><span id="__span-0-3092"><a id="__codelineno-0-3092" name="__codelineno-0-3092" href="#__codelineno-0-3092"></a>
</span><span id="__span-0-3093"><a id="__codelineno-0-3093" name="__codelineno-0-3093" href="#__codelineno-0-3093"></a><span class="s1">        IF(@useMonitoringDatabase = 1)</span>
</span><span id="__span-0-3094"><a id="__codelineno-0-3094" name="__codelineno-0-3094" href="#__codelineno-0-3094"></a>
</span><span id="__span-0-3095"><a id="__codelineno-0-3095" name="__codelineno-0-3095" href="#__codelineno-0-3095"></a><span class="s1">        BEGIN</span>
</span><span id="__span-0-3096"><a id="__codelineno-0-3096" name="__codelineno-0-3096" href="#__codelineno-0-3096"></a>
</span><span id="__span-0-3097"><a id="__codelineno-0-3097" name="__codelineno-0-3097" href="#__codelineno-0-3097"></a><span class="s1">            EXECUTE ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'].[dbo].[sp_add_maintenance_action_log] </span>
</span><span id="__span-0-3098"><a id="__codelineno-0-3098" name="__codelineno-0-3098" href="#__codelineno-0-3098"></a>
</span><span id="__span-0-3099"><a id="__codelineno-0-3099" name="__codelineno-0-3099" href="#__codelineno-0-3099"></a><span class="s1">            @TableName</span>
</span><span id="__span-0-3100"><a id="__codelineno-0-3100" name="__codelineno-0-3100" href="#__codelineno-0-3100"></a>
</span><span id="__span-0-3101"><a id="__codelineno-0-3101" name="__codelineno-0-3101" href="#__codelineno-0-3101"></a><span class="s1">            ,@IndexName</span>
</span><span id="__span-0-3102"><a id="__codelineno-0-3102" name="__codelineno-0-3102" href="#__codelineno-0-3102"></a>
</span><span id="__span-0-3103"><a id="__codelineno-0-3103" name="__codelineno-0-3103" href="#__codelineno-0-3103"></a><span class="s1">            ,@Operation</span>
</span><span id="__span-0-3104"><a id="__codelineno-0-3104" name="__codelineno-0-3104" href="#__codelineno-0-3104"></a>
</span><span id="__span-0-3105"><a id="__codelineno-0-3105" name="__codelineno-0-3105" href="#__codelineno-0-3105"></a><span class="s1">            ,@RunDate</span>
</span><span id="__span-0-3106"><a id="__codelineno-0-3106" name="__codelineno-0-3106" href="#__codelineno-0-3106"></a>
</span><span id="__span-0-3107"><a id="__codelineno-0-3107" name="__codelineno-0-3107" href="#__codelineno-0-3107"></a><span class="s1">            ,@StartDate</span>
</span><span id="__span-0-3108"><a id="__codelineno-0-3108" name="__codelineno-0-3108" href="#__codelineno-0-3108"></a>
</span><span id="__span-0-3109"><a id="__codelineno-0-3109" name="__codelineno-0-3109" href="#__codelineno-0-3109"></a><span class="s1">            ,null</span>
</span><span id="__span-0-3110"><a id="__codelineno-0-3110" name="__codelineno-0-3110" href="#__codelineno-0-3110"></a>
</span><span id="__span-0-3111"><a id="__codelineno-0-3111" name="__codelineno-0-3111" href="#__codelineno-0-3111"></a><span class="s1">            ,@DBNAME</span>
</span><span id="__span-0-3112"><a id="__codelineno-0-3112" name="__codelineno-0-3112" href="#__codelineno-0-3112"></a>
</span><span id="__span-0-3113"><a id="__codelineno-0-3113" name="__codelineno-0-3113" href="#__codelineno-0-3113"></a><span class="s1">            ,0</span>
</span><span id="__span-0-3114"><a id="__codelineno-0-3114" name="__codelineno-0-3114" href="#__codelineno-0-3114"></a>
</span><span id="__span-0-3115"><a id="__codelineno-0-3115" name="__codelineno-0-3115" href="#__codelineno-0-3115"></a><span class="s1">            ,''''</span>
</span><span id="__span-0-3116"><a id="__codelineno-0-3116" name="__codelineno-0-3116" href="#__codelineno-0-3116"></a>
</span><span id="__span-0-3117"><a id="__codelineno-0-3117" name="__codelineno-0-3117" href="#__codelineno-0-3117"></a><span class="s1">            ,0</span>
</span><span id="__span-0-3118"><a id="__codelineno-0-3118" name="__codelineno-0-3118" href="#__codelineno-0-3118"></a>
</span><span id="__span-0-3119"><a id="__codelineno-0-3119" name="__codelineno-0-3119" href="#__codelineno-0-3119"></a><span class="s1">            ,@RowModCtr</span>
</span><span id="__span-0-3120"><a id="__codelineno-0-3120" name="__codelineno-0-3120" href="#__codelineno-0-3120"></a>
</span><span id="__span-0-3121"><a id="__codelineno-0-3121" name="__codelineno-0-3121" href="#__codelineno-0-3121"></a><span class="s1">            ,@SQL</span>
</span><span id="__span-0-3122"><a id="__codelineno-0-3122" name="__codelineno-0-3122" href="#__codelineno-0-3122"></a>
</span><span id="__span-0-3123"><a id="__codelineno-0-3123" name="__codelineno-0-3123" href="#__codelineno-0-3123"></a><span class="s1">            ,@MaintenanceActionLogId OUTPUT;</span>
</span><span id="__span-0-3124"><a id="__codelineno-0-3124" name="__codelineno-0-3124" href="#__codelineno-0-3124"></a>
</span><span id="__span-0-3125"><a id="__codelineno-0-3125" name="__codelineno-0-3125" href="#__codelineno-0-3125"></a><span class="s1">        END</span>
</span><span id="__span-0-3126"><a id="__codelineno-0-3126" name="__codelineno-0-3126" href="#__codelineno-0-3126"></a>
</span><span id="__span-0-3127"><a id="__codelineno-0-3127" name="__codelineno-0-3127" href="#__codelineno-0-3127"></a><span class="s1">        EXEC sp_executesql @SQL;</span>
</span><span id="__span-0-3128"><a id="__codelineno-0-3128" name="__codelineno-0-3128" href="#__codelineno-0-3128"></a>
</span><span id="__span-0-3129"><a id="__codelineno-0-3129" name="__codelineno-0-3129" href="#__codelineno-0-3129"></a><span class="s1">        SET @FinishDate = GetDate();</span>
</span><span id="__span-0-3130"><a id="__codelineno-0-3130" name="__codelineno-0-3130" href="#__codelineno-0-3130"></a>
</span><span id="__span-0-3131"><a id="__codelineno-0-3131" name="__codelineno-0-3131" href="#__codelineno-0-3131"></a><span class="s1">        -- Устанавливаем фактическую дату завершения операции</span>
</span><span id="__span-0-3132"><a id="__codelineno-0-3132" name="__codelineno-0-3132" href="#__codelineno-0-3132"></a>
</span><span id="__span-0-3133"><a id="__codelineno-0-3133" name="__codelineno-0-3133" href="#__codelineno-0-3133"></a><span class="s1">        IF(@useMonitoringDatabase = 1)</span>
</span><span id="__span-0-3134"><a id="__codelineno-0-3134" name="__codelineno-0-3134" href="#__codelineno-0-3134"></a>
</span><span id="__span-0-3135"><a id="__codelineno-0-3135" name="__codelineno-0-3135" href="#__codelineno-0-3135"></a><span class="s1">        BEGIN</span>
</span><span id="__span-0-3136"><a id="__codelineno-0-3136" name="__codelineno-0-3136" href="#__codelineno-0-3136"></a>
</span><span id="__span-0-3137"><a id="__codelineno-0-3137" name="__codelineno-0-3137" href="#__codelineno-0-3137"></a><span class="s1">            EXECUTE ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'].[dbo].[sp_set_maintenance_action_log_finish_date]</span>
</span><span id="__span-0-3138"><a id="__codelineno-0-3138" name="__codelineno-0-3138" href="#__codelineno-0-3138"></a>
</span><span id="__span-0-3139"><a id="__codelineno-0-3139" name="__codelineno-0-3139" href="#__codelineno-0-3139"></a><span class="s1">                @MaintenanceActionLogId,</span>
</span><span id="__span-0-3140"><a id="__codelineno-0-3140" name="__codelineno-0-3140" href="#__codelineno-0-3140"></a>
</span><span id="__span-0-3141"><a id="__codelineno-0-3141" name="__codelineno-0-3141" href="#__codelineno-0-3141"></a><span class="s1">                @FinishDate;</span>
</span><span id="__span-0-3142"><a id="__codelineno-0-3142" name="__codelineno-0-3142" href="#__codelineno-0-3142"></a>
</span><span id="__span-0-3143"><a id="__codelineno-0-3143" name="__codelineno-0-3143" href="#__codelineno-0-3143"></a><span class="s1">        END</span>
</span><span id="__span-0-3144"><a id="__codelineno-0-3144" name="__codelineno-0-3144" href="#__codelineno-0-3144"></a>
</span><span id="__span-0-3145"><a id="__codelineno-0-3145" name="__codelineno-0-3145" href="#__codelineno-0-3145"></a><span class="s1">    END TRY</span>
</span><span id="__span-0-3146"><a id="__codelineno-0-3146" name="__codelineno-0-3146" href="#__codelineno-0-3146"></a>
</span><span id="__span-0-3147"><a id="__codelineno-0-3147" name="__codelineno-0-3147" href="#__codelineno-0-3147"></a><span class="s1">    BEGIN CATCH</span>
</span><span id="__span-0-3148"><a id="__codelineno-0-3148" name="__codelineno-0-3148" href="#__codelineno-0-3148"></a>
</span><span id="__span-0-3149"><a id="__codelineno-0-3149" name="__codelineno-0-3149" href="#__codelineno-0-3149"></a><span class="s1">        IF(@MaintenanceActionLogId &lt;&gt; 0)</span>
</span><span id="__span-0-3150"><a id="__codelineno-0-3150" name="__codelineno-0-3150" href="#__codelineno-0-3150"></a>
</span><span id="__span-0-3151"><a id="__codelineno-0-3151" name="__codelineno-0-3151" href="#__codelineno-0-3151"></a><span class="s1">        BEGIN</span>
</span><span id="__span-0-3152"><a id="__codelineno-0-3152" name="__codelineno-0-3152" href="#__codelineno-0-3152"></a>
</span><span id="__span-0-3153"><a id="__codelineno-0-3153" name="__codelineno-0-3153" href="#__codelineno-0-3153"></a><span class="s1">            DECLARE @msg nvarchar(500) = ''Error: '' + CAST(Error_message() AS NVARCHAR(500)) + '', Code: '' + CAST(Error_Number() AS NVARCHAR(500)) + '', Line: '' + CAST(Error_Line() AS NVARCHAR(500))</span>
</span><span id="__span-0-3154"><a id="__codelineno-0-3154" name="__codelineno-0-3154" href="#__codelineno-0-3154"></a>
</span><span id="__span-0-3155"><a id="__codelineno-0-3155" name="__codelineno-0-3155" href="#__codelineno-0-3155"></a><span class="s1">            -- Устанавливаем текст ошибки при обслуживании объекта статистики</span>
</span><span id="__span-0-3156"><a id="__codelineno-0-3156" name="__codelineno-0-3156" href="#__codelineno-0-3156"></a>
</span><span id="__span-0-3157"><a id="__codelineno-0-3157" name="__codelineno-0-3157" href="#__codelineno-0-3157"></a><span class="s1">            -- Дата завершения при этом остается незаполненной</span>
</span><span id="__span-0-3158"><a id="__codelineno-0-3158" name="__codelineno-0-3158" href="#__codelineno-0-3158"></a>
</span><span id="__span-0-3159"><a id="__codelineno-0-3159" name="__codelineno-0-3159" href="#__codelineno-0-3159"></a><span class="s1">            EXECUTE ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'].[dbo].[sp_set_maintenance_action_log_finish_date]</span>
</span><span id="__span-0-3160"><a id="__codelineno-0-3160" name="__codelineno-0-3160" href="#__codelineno-0-3160"></a>
</span><span id="__span-0-3161"><a id="__codelineno-0-3161" name="__codelineno-0-3161" href="#__codelineno-0-3161"></a><span class="s1">                @MaintenanceActionLogId,</span>
</span><span id="__span-0-3162"><a id="__codelineno-0-3162" name="__codelineno-0-3162" href="#__codelineno-0-3162"></a>
</span><span id="__span-0-3163"><a id="__codelineno-0-3163" name="__codelineno-0-3163" href="#__codelineno-0-3163"></a><span class="s1">                @FinishDate,</span>
</span><span id="__span-0-3164"><a id="__codelineno-0-3164" name="__codelineno-0-3164" href="#__codelineno-0-3164"></a>
</span><span id="__span-0-3165"><a id="__codelineno-0-3165" name="__codelineno-0-3165" href="#__codelineno-0-3165"></a><span class="s1">                @msg;           </span>
</span><span id="__span-0-3166"><a id="__codelineno-0-3166" name="__codelineno-0-3166" href="#__codelineno-0-3166"></a>
</span><span id="__span-0-3167"><a id="__codelineno-0-3167" name="__codelineno-0-3167" href="#__codelineno-0-3167"></a><span class="s1">        END</span>
</span><span id="__span-0-3168"><a id="__codelineno-0-3168" name="__codelineno-0-3168" href="#__codelineno-0-3168"></a>
</span><span id="__span-0-3169"><a id="__codelineno-0-3169" name="__codelineno-0-3169" href="#__codelineno-0-3169"></a><span class="s1">    END CATCH</span>
</span><span id="__span-0-3170"><a id="__codelineno-0-3170" name="__codelineno-0-3170" href="#__codelineno-0-3170"></a>
</span><span id="__span-0-3171"><a id="__codelineno-0-3171" name="__codelineno-0-3171" href="#__codelineno-0-3171"></a><span class="s1">END</span>
</span><span id="__span-0-3172"><a id="__codelineno-0-3172" name="__codelineno-0-3172" href="#__codelineno-0-3172"></a>
</span><span id="__span-0-3173"><a id="__codelineno-0-3173" name="__codelineno-0-3173" href="#__codelineno-0-3173"></a><span class="s1">CLOSE todo;</span>
</span><span id="__span-0-3174"><a id="__codelineno-0-3174" name="__codelineno-0-3174" href="#__codelineno-0-3174"></a>
</span><span id="__span-0-3175"><a id="__codelineno-0-3175" name="__codelineno-0-3175" href="#__codelineno-0-3175"></a><span class="s1">DEALLOCATE todo;</span>
</span><span id="__span-0-3176"><a id="__codelineno-0-3176" name="__codelineno-0-3176" href="#__codelineno-0-3176"></a>
</span><span id="__span-0-3177"><a id="__codelineno-0-3177" name="__codelineno-0-3177" href="#__codelineno-0-3177"></a><span class="s1">'</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span>
</span><span id="__span-0-3178"><a id="__codelineno-0-3178" name="__codelineno-0-3178" href="#__codelineno-0-3178"></a>
</span><span id="__span-0-3179"><a id="__codelineno-0-3179" name="__codelineno-0-3179" href="#__codelineno-0-3179"></a>
</span><span id="__span-0-3180"><a id="__codelineno-0-3180" name="__codelineno-0-3180" href="#__codelineno-0-3180"></a>
</span><span id="__span-0-3181"><a id="__codelineno-0-3181" name="__codelineno-0-3181" href="#__codelineno-0-3181"></a><span class="w">    </span><span class="k">EXECUTE</span><span class="w"> </span><span class="n">sp_executesql</span><span class="w"> </span>
</span><span id="__span-0-3182"><a id="__codelineno-0-3182" name="__codelineno-0-3182" href="#__codelineno-0-3182"></a>
</span><span id="__span-0-3183"><a id="__codelineno-0-3183" name="__codelineno-0-3183" href="#__codelineno-0-3183"></a><span class="w">        </span><span class="o">@</span><span class="n">cmd</span><span class="p">,</span>
</span><span id="__span-0-3184"><a id="__codelineno-0-3184" name="__codelineno-0-3184" href="#__codelineno-0-3184"></a>
</span><span id="__span-0-3185"><a id="__codelineno-0-3185" name="__codelineno-0-3185" href="#__codelineno-0-3185"></a><span class="w">        </span><span class="n">N</span><span class="s1">'@timeFrom TIME, @timeTo TIME,</span>
</span><span id="__span-0-3186"><a id="__codelineno-0-3186" name="__codelineno-0-3186" href="#__codelineno-0-3186"></a>
</span><span id="__span-0-3187"><a id="__codelineno-0-3187" name="__codelineno-0-3187" href="#__codelineno-0-3187"></a><span class="s1">        @useMonitoringDatabase bit, @monitoringDatabaseName sysname'</span><span class="p">,</span>
</span><span id="__span-0-3188"><a id="__codelineno-0-3188" name="__codelineno-0-3188" href="#__codelineno-0-3188"></a>
</span><span id="__span-0-3189"><a id="__codelineno-0-3189" name="__codelineno-0-3189" href="#__codelineno-0-3189"></a><span class="w">        </span><span class="o">@</span><span class="n">timeFrom</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">timeTo</span><span class="p">,</span>
</span><span id="__span-0-3190"><a id="__codelineno-0-3190" name="__codelineno-0-3190" href="#__codelineno-0-3190"></a>
</span><span id="__span-0-3191"><a id="__codelineno-0-3191" name="__codelineno-0-3191" href="#__codelineno-0-3191"></a><span class="w">        </span><span class="o">@</span><span class="n">useMonitoringDatabase</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="p">;</span>
</span><span id="__span-0-3192"><a id="__codelineno-0-3192" name="__codelineno-0-3192" href="#__codelineno-0-3192"></a>
</span><span id="__span-0-3193"><a id="__codelineno-0-3193" name="__codelineno-0-3193" href="#__codelineno-0-3193"></a>
</span><span id="__span-0-3194"><a id="__codelineno-0-3194" name="__codelineno-0-3194" href="#__codelineno-0-3194"></a>
</span><span id="__span-0-3195"><a id="__codelineno-0-3195" name="__codelineno-0-3195" href="#__codelineno-0-3195"></a><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-3196"><a id="__codelineno-0-3196" name="__codelineno-0-3196" href="#__codelineno-0-3196"></a>
</span><span id="__span-0-3197"><a id="__codelineno-0-3197" name="__codelineno-0-3197" href="#__codelineno-0-3197"></a><span class="k">END</span>
</span><span id="__span-0-3198"><a id="__codelineno-0-3198" name="__codelineno-0-3198" href="#__codelineno-0-3198"></a>
</span><span id="__span-0-3199"><a id="__codelineno-0-3199" name="__codelineno-0-3199" href="#__codelineno-0-3199"></a><span class="k">GO</span>
</span><span id="__span-0-3200"><a id="__codelineno-0-3200" name="__codelineno-0-3200" href="#__codelineno-0-3200"></a>
</span><span id="__span-0-3201"><a id="__codelineno-0-3201" name="__codelineno-0-3201" href="#__codelineno-0-3201"></a>
</span><span id="__span-0-3202"><a id="__codelineno-0-3202" name="__codelineno-0-3202" href="#__codelineno-0-3202"></a>
</span><span id="__span-0-3203"><a id="__codelineno-0-3203" name="__codelineno-0-3203" href="#__codelineno-0-3203"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_StatisticMaintenance_Sampled</span><span class="p">]</span>
</span><span id="__span-0-3204"><a id="__codelineno-0-3204" name="__codelineno-0-3204" href="#__codelineno-0-3204"></a>
</span><span id="__span-0-3205"><a id="__codelineno-0-3205" name="__codelineno-0-3205" href="#__codelineno-0-3205"></a><span class="w">    </span><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="n">sysname</span><span class="p">,</span>
</span><span id="__span-0-3206"><a id="__codelineno-0-3206" name="__codelineno-0-3206" href="#__codelineno-0-3206"></a>
</span><span id="__span-0-3207"><a id="__codelineno-0-3207" name="__codelineno-0-3207" href="#__codelineno-0-3207"></a><span class="w">    </span><span class="o">@</span><span class="n">timeFrom</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'00:00:00'</span><span class="p">,</span>
</span><span id="__span-0-3208"><a id="__codelineno-0-3208" name="__codelineno-0-3208" href="#__codelineno-0-3208"></a>
</span><span id="__span-0-3209"><a id="__codelineno-0-3209" name="__codelineno-0-3209" href="#__codelineno-0-3209"></a><span class="w">    </span><span class="o">@</span><span class="n">timeTo</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'23:59:59'</span><span class="p">,</span>
</span><span id="__span-0-3210"><a id="__codelineno-0-3210" name="__codelineno-0-3210" href="#__codelineno-0-3210"></a>
</span><span id="__span-0-3211"><a id="__codelineno-0-3211" name="__codelineno-0-3211" href="#__codelineno-0-3211"></a><span class="w">    </span><span class="o">@</span><span class="n">ConditionTableName</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'LIKE ''%'''</span><span class="p">,</span>
</span><span id="__span-0-3212"><a id="__codelineno-0-3212" name="__codelineno-0-3212" href="#__codelineno-0-3212"></a>
</span><span id="__span-0-3213"><a id="__codelineno-0-3213" name="__codelineno-0-3213" href="#__codelineno-0-3213"></a><span class="w">    </span><span class="o">@</span><span class="n">useMonitoringDatabase</span><span class="w"> </span><span class="nb">bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-0-3214"><a id="__codelineno-0-3214" name="__codelineno-0-3214" href="#__codelineno-0-3214"></a>
</span><span id="__span-0-3215"><a id="__codelineno-0-3215" name="__codelineno-0-3215" href="#__codelineno-0-3215"></a><span class="w">    </span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w"> </span><span class="n">sysname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'SQLServerMaintenance'</span>
</span><span id="__span-0-3216"><a id="__codelineno-0-3216" name="__codelineno-0-3216" href="#__codelineno-0-3216"></a>
</span><span id="__span-0-3217"><a id="__codelineno-0-3217" name="__codelineno-0-3217" href="#__codelineno-0-3217"></a><span class="k">AS</span>
</span><span id="__span-0-3218"><a id="__codelineno-0-3218" name="__codelineno-0-3218" href="#__codelineno-0-3218"></a>
</span><span id="__span-0-3219"><a id="__codelineno-0-3219" name="__codelineno-0-3219" href="#__codelineno-0-3219"></a><span class="k">BEGIN</span>
</span><span id="__span-0-3220"><a id="__codelineno-0-3220" name="__codelineno-0-3220" href="#__codelineno-0-3220"></a>
</span><span id="__span-0-3221"><a id="__codelineno-0-3221" name="__codelineno-0-3221" href="#__codelineno-0-3221"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">NOCOUNT</span><span class="w"> </span><span class="k">ON</span><span class="p">;</span>
</span><span id="__span-0-3222"><a id="__codelineno-0-3222" name="__codelineno-0-3222" href="#__codelineno-0-3222"></a>
</span><span id="__span-0-3223"><a id="__codelineno-0-3223" name="__codelineno-0-3223" href="#__codelineno-0-3223"></a>
</span><span id="__span-0-3224"><a id="__codelineno-0-3224" name="__codelineno-0-3224" href="#__codelineno-0-3224"></a>
</span><span id="__span-0-3225"><a id="__codelineno-0-3225" name="__codelineno-0-3225" href="#__codelineno-0-3225"></a><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">msg</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
</span><span id="__span-0-3226"><a id="__codelineno-0-3226" name="__codelineno-0-3226" href="#__codelineno-0-3226"></a>
</span><span id="__span-0-3227"><a id="__codelineno-0-3227" name="__codelineno-0-3227" href="#__codelineno-0-3227"></a>
</span><span id="__span-0-3228"><a id="__codelineno-0-3228" name="__codelineno-0-3228" href="#__codelineno-0-3228"></a>
</span><span id="__span-0-3229"><a id="__codelineno-0-3229" name="__codelineno-0-3229" href="#__codelineno-0-3229"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="n">DB_ID</span><span class="p">(</span><span class="o">@</span><span class="n">databaseName</span><span class="p">)</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-0-3230"><a id="__codelineno-0-3230" name="__codelineno-0-3230" href="#__codelineno-0-3230"></a>
</span><span id="__span-0-3231"><a id="__codelineno-0-3231" name="__codelineno-0-3231" href="#__codelineno-0-3231"></a><span class="w">    </span><span class="k">BEGIN</span>
</span><span id="__span-0-3232"><a id="__codelineno-0-3232" name="__codelineno-0-3232" href="#__codelineno-0-3232"></a>
</span><span id="__span-0-3233"><a id="__codelineno-0-3233" name="__codelineno-0-3233" href="#__codelineno-0-3233"></a><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Database '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">' is not exists.'</span><span class="p">;</span>
</span><span id="__span-0-3234"><a id="__codelineno-0-3234" name="__codelineno-0-3234" href="#__codelineno-0-3234"></a>
</span><span id="__span-0-3235"><a id="__codelineno-0-3235" name="__codelineno-0-3235" href="#__codelineno-0-3235"></a><span class="w">        </span><span class="n">THROW</span><span class="w"> </span><span class="mi">51000</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-3236"><a id="__codelineno-0-3236" name="__codelineno-0-3236" href="#__codelineno-0-3236"></a>
</span><span id="__span-0-3237"><a id="__codelineno-0-3237" name="__codelineno-0-3237" href="#__codelineno-0-3237"></a><span class="w">        </span><span class="k">RETURN</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-3238"><a id="__codelineno-0-3238" name="__codelineno-0-3238" href="#__codelineno-0-3238"></a>
</span><span id="__span-0-3239"><a id="__codelineno-0-3239" name="__codelineno-0-3239" href="#__codelineno-0-3239"></a><span class="w">    </span><span class="k">END</span>
</span><span id="__span-0-3240"><a id="__codelineno-0-3240" name="__codelineno-0-3240" href="#__codelineno-0-3240"></a>
</span><span id="__span-0-3241"><a id="__codelineno-0-3241" name="__codelineno-0-3241" href="#__codelineno-0-3241"></a>
</span><span id="__span-0-3242"><a id="__codelineno-0-3242" name="__codelineno-0-3242" href="#__codelineno-0-3242"></a>
</span><span id="__span-0-3243"><a id="__codelineno-0-3243" name="__codelineno-0-3243" href="#__codelineno-0-3243"></a><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">);</span>
</span><span id="__span-0-3244"><a id="__codelineno-0-3244" name="__codelineno-0-3244" href="#__codelineno-0-3244"></a>
</span><span id="__span-0-3245"><a id="__codelineno-0-3245" name="__codelineno-0-3245" href="#__codelineno-0-3245"></a><span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
</span><span id="__span-0-3246"><a id="__codelineno-0-3246" name="__codelineno-0-3246" href="#__codelineno-0-3246"></a>
</span><span id="__span-0-3247"><a id="__codelineno-0-3247" name="__codelineno-0-3247" href="#__codelineno-0-3247"></a><span class="k">CAST</span><span class="p">(</span><span class="s1">'USE ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">databasename</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">']</span>
</span><span id="__span-0-3248"><a id="__codelineno-0-3248" name="__codelineno-0-3248" href="#__codelineno-0-3248"></a>
</span><span id="__span-0-3249"><a id="__codelineno-0-3249" name="__codelineno-0-3249" href="#__codelineno-0-3249"></a><span class="s1">SET NOCOUNT ON;</span>
</span><span id="__span-0-3250"><a id="__codelineno-0-3250" name="__codelineno-0-3250" href="#__codelineno-0-3250"></a>
</span><span id="__span-0-3251"><a id="__codelineno-0-3251" name="__codelineno-0-3251" href="#__codelineno-0-3251"></a><span class="s1">DECLARE</span>
</span><span id="__span-0-3252"><a id="__codelineno-0-3252" name="__codelineno-0-3252" href="#__codelineno-0-3252"></a>
</span><span id="__span-0-3253"><a id="__codelineno-0-3253" name="__codelineno-0-3253" href="#__codelineno-0-3253"></a><span class="s1">    -- Текущее время</span>
</span><span id="__span-0-3254"><a id="__codelineno-0-3254" name="__codelineno-0-3254" href="#__codelineno-0-3254"></a>
</span><span id="__span-0-3255"><a id="__codelineno-0-3255" name="__codelineno-0-3255" href="#__codelineno-0-3255"></a><span class="s1">    @timeNow TIME = CAST(GETDATE() AS TIME)</span>
</span><span id="__span-0-3256"><a id="__codelineno-0-3256" name="__codelineno-0-3256" href="#__codelineno-0-3256"></a>
</span><span id="__span-0-3257"><a id="__codelineno-0-3257" name="__codelineno-0-3257" href="#__codelineno-0-3257"></a><span class="s1">    -- Начало доступного интервала времени обслуживания</span>
</span><span id="__span-0-3258"><a id="__codelineno-0-3258" name="__codelineno-0-3258" href="#__codelineno-0-3258"></a>
</span><span id="__span-0-3259"><a id="__codelineno-0-3259" name="__codelineno-0-3259" href="#__codelineno-0-3259"></a><span class="s1">    -- @timeFrom TIME</span>
</span><span id="__span-0-3260"><a id="__codelineno-0-3260" name="__codelineno-0-3260" href="#__codelineno-0-3260"></a>
</span><span id="__span-0-3261"><a id="__codelineno-0-3261" name="__codelineno-0-3261" href="#__codelineno-0-3261"></a><span class="s1">    -- Окончание доступного интервала времени обслуживания</span>
</span><span id="__span-0-3262"><a id="__codelineno-0-3262" name="__codelineno-0-3262" href="#__codelineno-0-3262"></a>
</span><span id="__span-0-3263"><a id="__codelineno-0-3263" name="__codelineno-0-3263" href="#__codelineno-0-3263"></a><span class="s1">    -- @timeTo TIME</span>
</span><span id="__span-0-3264"><a id="__codelineno-0-3264" name="__codelineno-0-3264" href="#__codelineno-0-3264"></a>
</span><span id="__span-0-3265"><a id="__codelineno-0-3265" name="__codelineno-0-3265" href="#__codelineno-0-3265"></a><span class="s1">-- Проверка доступен ли запуск обслуживания в текущее время</span>
</span><span id="__span-0-3266"><a id="__codelineno-0-3266" name="__codelineno-0-3266" href="#__codelineno-0-3266"></a>
</span><span id="__span-0-3267"><a id="__codelineno-0-3267" name="__codelineno-0-3267" href="#__codelineno-0-3267"></a><span class="s1">IF (@timeTo &gt;= @timeFrom) BEGIN</span>
</span><span id="__span-0-3268"><a id="__codelineno-0-3268" name="__codelineno-0-3268" href="#__codelineno-0-3268"></a>
</span><span id="__span-0-3269"><a id="__codelineno-0-3269" name="__codelineno-0-3269" href="#__codelineno-0-3269"></a><span class="s1">    IF(NOT (@timeFrom &lt;= @timeNow AND @timeTo &gt;= @timeNow))</span>
</span><span id="__span-0-3270"><a id="__codelineno-0-3270" name="__codelineno-0-3270" href="#__codelineno-0-3270"></a>
</span><span id="__span-0-3271"><a id="__codelineno-0-3271" name="__codelineno-0-3271" href="#__codelineno-0-3271"></a><span class="s1">        RETURN;</span>
</span><span id="__span-0-3272"><a id="__codelineno-0-3272" name="__codelineno-0-3272" href="#__codelineno-0-3272"></a>
</span><span id="__span-0-3273"><a id="__codelineno-0-3273" name="__codelineno-0-3273" href="#__codelineno-0-3273"></a><span class="s1">    END ELSE BEGIN</span>
</span><span id="__span-0-3274"><a id="__codelineno-0-3274" name="__codelineno-0-3274" href="#__codelineno-0-3274"></a>
</span><span id="__span-0-3275"><a id="__codelineno-0-3275" name="__codelineno-0-3275" href="#__codelineno-0-3275"></a><span class="s1">        IF(NOT ((@timeFrom &lt;= @timeNow AND ''23:59:59'' &gt;= @timeNow)</span>
</span><span id="__span-0-3276"><a id="__codelineno-0-3276" name="__codelineno-0-3276" href="#__codelineno-0-3276"></a>
</span><span id="__span-0-3277"><a id="__codelineno-0-3277" name="__codelineno-0-3277" href="#__codelineno-0-3277"></a><span class="s1">            OR (@timeTo &gt;= @timeNow AND ''00:00:00'' &lt;= @timeNow)))  </span>
</span><span id="__span-0-3278"><a id="__codelineno-0-3278" name="__codelineno-0-3278" href="#__codelineno-0-3278"></a>
</span><span id="__span-0-3279"><a id="__codelineno-0-3279" name="__codelineno-0-3279" href="#__codelineno-0-3279"></a><span class="s1">                RETURN;</span>
</span><span id="__span-0-3280"><a id="__codelineno-0-3280" name="__codelineno-0-3280" href="#__codelineno-0-3280"></a>
</span><span id="__span-0-3281"><a id="__codelineno-0-3281" name="__codelineno-0-3281" href="#__codelineno-0-3281"></a><span class="s1">END</span>
</span><span id="__span-0-3282"><a id="__codelineno-0-3282" name="__codelineno-0-3282" href="#__codelineno-0-3282"></a>
</span><span id="__span-0-3283"><a id="__codelineno-0-3283" name="__codelineno-0-3283" href="#__codelineno-0-3283"></a><span class="s1">-- Служебные переменные</span>
</span><span id="__span-0-3284"><a id="__codelineno-0-3284" name="__codelineno-0-3284" href="#__codelineno-0-3284"></a>
</span><span id="__span-0-3285"><a id="__codelineno-0-3285" name="__codelineno-0-3285" href="#__codelineno-0-3285"></a><span class="s1">DECLARE</span>
</span><span id="__span-0-3286"><a id="__codelineno-0-3286" name="__codelineno-0-3286" href="#__codelineno-0-3286"></a>
</span><span id="__span-0-3287"><a id="__codelineno-0-3287" name="__codelineno-0-3287" href="#__codelineno-0-3287"></a><span class="s1">    @DBID SMALLINT = DB_ID()</span>
</span><span id="__span-0-3288"><a id="__codelineno-0-3288" name="__codelineno-0-3288" href="#__codelineno-0-3288"></a>
</span><span id="__span-0-3289"><a id="__codelineno-0-3289" name="__codelineno-0-3289" href="#__codelineno-0-3289"></a><span class="s1">    ,@DBNAME sysname = DB_NAME()</span>
</span><span id="__span-0-3290"><a id="__codelineno-0-3290" name="__codelineno-0-3290" href="#__codelineno-0-3290"></a>
</span><span id="__span-0-3291"><a id="__codelineno-0-3291" name="__codelineno-0-3291" href="#__codelineno-0-3291"></a><span class="s1">    ,@TableName SYSNAME</span>
</span><span id="__span-0-3292"><a id="__codelineno-0-3292" name="__codelineno-0-3292" href="#__codelineno-0-3292"></a>
</span><span id="__span-0-3293"><a id="__codelineno-0-3293" name="__codelineno-0-3293" href="#__codelineno-0-3293"></a><span class="s1">    ,@IndexName SYSNAME</span>
</span><span id="__span-0-3294"><a id="__codelineno-0-3294" name="__codelineno-0-3294" href="#__codelineno-0-3294"></a>
</span><span id="__span-0-3295"><a id="__codelineno-0-3295" name="__codelineno-0-3295" href="#__codelineno-0-3295"></a><span class="s1">    ,@Operation NVARCHAR(128) = ''UPDATE STATISTICS''</span>
</span><span id="__span-0-3296"><a id="__codelineno-0-3296" name="__codelineno-0-3296" href="#__codelineno-0-3296"></a>
</span><span id="__span-0-3297"><a id="__codelineno-0-3297" name="__codelineno-0-3297" href="#__codelineno-0-3297"></a><span class="s1">    ,@RunDate DATETIME = GETDATE()</span>
</span><span id="__span-0-3298"><a id="__codelineno-0-3298" name="__codelineno-0-3298" href="#__codelineno-0-3298"></a>
</span><span id="__span-0-3299"><a id="__codelineno-0-3299" name="__codelineno-0-3299" href="#__codelineno-0-3299"></a><span class="s1">    ,@StartDate DATETIME</span>
</span><span id="__span-0-3300"><a id="__codelineno-0-3300" name="__codelineno-0-3300" href="#__codelineno-0-3300"></a>
</span><span id="__span-0-3301"><a id="__codelineno-0-3301" name="__codelineno-0-3301" href="#__codelineno-0-3301"></a><span class="s1">    ,@FinishDate DATETIME</span>
</span><span id="__span-0-3302"><a id="__codelineno-0-3302" name="__codelineno-0-3302" href="#__codelineno-0-3302"></a>
</span><span id="__span-0-3303"><a id="__codelineno-0-3303" name="__codelineno-0-3303" href="#__codelineno-0-3303"></a><span class="s1">    ,@SQL NVARCHAR(500) </span>
</span><span id="__span-0-3304"><a id="__codelineno-0-3304" name="__codelineno-0-3304" href="#__codelineno-0-3304"></a>
</span><span id="__span-0-3305"><a id="__codelineno-0-3305" name="__codelineno-0-3305" href="#__codelineno-0-3305"></a><span class="s1">    ,@RowModCtr BIGINT</span>
</span><span id="__span-0-3306"><a id="__codelineno-0-3306" name="__codelineno-0-3306" href="#__codelineno-0-3306"></a>
</span><span id="__span-0-3307"><a id="__codelineno-0-3307" name="__codelineno-0-3307" href="#__codelineno-0-3307"></a><span class="s1">    ,@MaintenanceActionLogId bigint;</span>
</span><span id="__span-0-3308"><a id="__codelineno-0-3308" name="__codelineno-0-3308" href="#__codelineno-0-3308"></a>
</span><span id="__span-0-3309"><a id="__codelineno-0-3309" name="__codelineno-0-3309" href="#__codelineno-0-3309"></a><span class="s1">DECLARE @resample CHAR(8)=''NO'' -- Для включения установить значение RESAMPLE</span>
</span><span id="__span-0-3310"><a id="__codelineno-0-3310" name="__codelineno-0-3310" href="#__codelineno-0-3310"></a>
</span><span id="__span-0-3311"><a id="__codelineno-0-3311" name="__codelineno-0-3311" href="#__codelineno-0-3311"></a><span class="s1">DECLARE @dbsid VARBINARY(85)</span>
</span><span id="__span-0-3312"><a id="__codelineno-0-3312" name="__codelineno-0-3312" href="#__codelineno-0-3312"></a>
</span><span id="__span-0-3313"><a id="__codelineno-0-3313" name="__codelineno-0-3313" href="#__codelineno-0-3313"></a><span class="s1">SELECT @dbsid = owner_sid</span>
</span><span id="__span-0-3314"><a id="__codelineno-0-3314" name="__codelineno-0-3314" href="#__codelineno-0-3314"></a>
</span><span id="__span-0-3315"><a id="__codelineno-0-3315" name="__codelineno-0-3315" href="#__codelineno-0-3315"></a><span class="s1">FROM sys.databases</span>
</span><span id="__span-0-3316"><a id="__codelineno-0-3316" name="__codelineno-0-3316" href="#__codelineno-0-3316"></a>
</span><span id="__span-0-3317"><a id="__codelineno-0-3317" name="__codelineno-0-3317" href="#__codelineno-0-3317"></a><span class="s1">WHERE name = db_name()</span>
</span><span id="__span-0-3318"><a id="__codelineno-0-3318" name="__codelineno-0-3318" href="#__codelineno-0-3318"></a>
</span><span id="__span-0-3319"><a id="__codelineno-0-3319" name="__codelineno-0-3319" href="#__codelineno-0-3319"></a><span class="s1">DECLARE @exec_stmt NVARCHAR(4000)</span>
</span><span id="__span-0-3320"><a id="__codelineno-0-3320" name="__codelineno-0-3320" href="#__codelineno-0-3320"></a>
</span><span id="__span-0-3321"><a id="__codelineno-0-3321" name="__codelineno-0-3321" href="#__codelineno-0-3321"></a><span class="s1">-- "UPDATE STATISTICS [SYSNAME].[SYSNAME] [SYSNAME] WITH RESAMPLE NORECOMPUTE"</span>
</span><span id="__span-0-3322"><a id="__codelineno-0-3322" name="__codelineno-0-3322" href="#__codelineno-0-3322"></a>
</span><span id="__span-0-3323"><a id="__codelineno-0-3323" name="__codelineno-0-3323" href="#__codelineno-0-3323"></a><span class="s1">DECLARE @exec_stmt_head NVARCHAR(4000)</span>
</span><span id="__span-0-3324"><a id="__codelineno-0-3324" name="__codelineno-0-3324" href="#__codelineno-0-3324"></a>
</span><span id="__span-0-3325"><a id="__codelineno-0-3325" name="__codelineno-0-3325" href="#__codelineno-0-3325"></a><span class="s1">-- "UPDATE STATISTICS [SYSNAME].[SYSNAME] "</span>
</span><span id="__span-0-3326"><a id="__codelineno-0-3326" name="__codelineno-0-3326" href="#__codelineno-0-3326"></a>
</span><span id="__span-0-3327"><a id="__codelineno-0-3327" name="__codelineno-0-3327" href="#__codelineno-0-3327"></a><span class="s1">DECLARE @options NVARCHAR(100)</span>
</span><span id="__span-0-3328"><a id="__codelineno-0-3328" name="__codelineno-0-3328" href="#__codelineno-0-3328"></a>
</span><span id="__span-0-3329"><a id="__codelineno-0-3329" name="__codelineno-0-3329" href="#__codelineno-0-3329"></a><span class="s1">-- "RESAMPLE NORECOMPUTE"</span>
</span><span id="__span-0-3330"><a id="__codelineno-0-3330" name="__codelineno-0-3330" href="#__codelineno-0-3330"></a>
</span><span id="__span-0-3331"><a id="__codelineno-0-3331" name="__codelineno-0-3331" href="#__codelineno-0-3331"></a><span class="s1">DECLARE @index_names CURSOR</span>
</span><span id="__span-0-3332"><a id="__codelineno-0-3332" name="__codelineno-0-3332" href="#__codelineno-0-3332"></a>
</span><span id="__span-0-3333"><a id="__codelineno-0-3333" name="__codelineno-0-3333" href="#__codelineno-0-3333"></a><span class="s1">DECLARE @ind_name SYSNAME</span>
</span><span id="__span-0-3334"><a id="__codelineno-0-3334" name="__codelineno-0-3334" href="#__codelineno-0-3334"></a>
</span><span id="__span-0-3335"><a id="__codelineno-0-3335" name="__codelineno-0-3335" href="#__codelineno-0-3335"></a><span class="s1">DECLARE @ind_id INT</span>
</span><span id="__span-0-3336"><a id="__codelineno-0-3336" name="__codelineno-0-3336" href="#__codelineno-0-3336"></a>
</span><span id="__span-0-3337"><a id="__codelineno-0-3337" name="__codelineno-0-3337" href="#__codelineno-0-3337"></a><span class="s1">DECLARE @ind_rowmodctr INT</span>
</span><span id="__span-0-3338"><a id="__codelineno-0-3338" name="__codelineno-0-3338" href="#__codelineno-0-3338"></a>
</span><span id="__span-0-3339"><a id="__codelineno-0-3339" name="__codelineno-0-3339" href="#__codelineno-0-3339"></a><span class="s1">DECLARE @updated_count INT</span>
</span><span id="__span-0-3340"><a id="__codelineno-0-3340" name="__codelineno-0-3340" href="#__codelineno-0-3340"></a>
</span><span id="__span-0-3341"><a id="__codelineno-0-3341" name="__codelineno-0-3341" href="#__codelineno-0-3341"></a><span class="s1">DECLARE @skipped_count INT</span>
</span><span id="__span-0-3342"><a id="__codelineno-0-3342" name="__codelineno-0-3342" href="#__codelineno-0-3342"></a>
</span><span id="__span-0-3343"><a id="__codelineno-0-3343" name="__codelineno-0-3343" href="#__codelineno-0-3343"></a><span class="s1">DECLARE @sch_id INT</span>
</span><span id="__span-0-3344"><a id="__codelineno-0-3344" name="__codelineno-0-3344" href="#__codelineno-0-3344"></a>
</span><span id="__span-0-3345"><a id="__codelineno-0-3345" name="__codelineno-0-3345" href="#__codelineno-0-3345"></a><span class="s1">DECLARE @schema_name SYSNAME</span>
</span><span id="__span-0-3346"><a id="__codelineno-0-3346" name="__codelineno-0-3346" href="#__codelineno-0-3346"></a>
</span><span id="__span-0-3347"><a id="__codelineno-0-3347" name="__codelineno-0-3347" href="#__codelineno-0-3347"></a><span class="s1">DECLARE @table_name SYSNAME</span>
</span><span id="__span-0-3348"><a id="__codelineno-0-3348" name="__codelineno-0-3348" href="#__codelineno-0-3348"></a>
</span><span id="__span-0-3349"><a id="__codelineno-0-3349" name="__codelineno-0-3349" href="#__codelineno-0-3349"></a><span class="s1">DECLARE @table_id INT</span>
</span><span id="__span-0-3350"><a id="__codelineno-0-3350" name="__codelineno-0-3350" href="#__codelineno-0-3350"></a>
</span><span id="__span-0-3351"><a id="__codelineno-0-3351" name="__codelineno-0-3351" href="#__codelineno-0-3351"></a><span class="s1">DECLARE @table_type CHAR(2)</span>
</span><span id="__span-0-3352"><a id="__codelineno-0-3352" name="__codelineno-0-3352" href="#__codelineno-0-3352"></a>
</span><span id="__span-0-3353"><a id="__codelineno-0-3353" name="__codelineno-0-3353" href="#__codelineno-0-3353"></a><span class="s1">DECLARE @schema_table_name NVARCHAR(640)</span>
</span><span id="__span-0-3354"><a id="__codelineno-0-3354" name="__codelineno-0-3354" href="#__codelineno-0-3354"></a>
</span><span id="__span-0-3355"><a id="__codelineno-0-3355" name="__codelineno-0-3355" href="#__codelineno-0-3355"></a><span class="s1">DECLARE @compatlvl tinyINT</span>
</span><span id="__span-0-3356"><a id="__codelineno-0-3356" name="__codelineno-0-3356" href="#__codelineno-0-3356"></a>
</span><span id="__span-0-3357"><a id="__codelineno-0-3357" name="__codelineno-0-3357" href="#__codelineno-0-3357"></a><span class="s1">-- Получаем список объектов, для которых нужно обслуживание статистики</span>
</span><span id="__span-0-3358"><a id="__codelineno-0-3358" name="__codelineno-0-3358" href="#__codelineno-0-3358"></a>
</span><span id="__span-0-3359"><a id="__codelineno-0-3359" name="__codelineno-0-3359" href="#__codelineno-0-3359"></a><span class="s1">DECLARE ms_crs_tnames CURSOR LOCAL FAST_FORWARD READ_ONLY for</span>
</span><span id="__span-0-3360"><a id="__codelineno-0-3360" name="__codelineno-0-3360" href="#__codelineno-0-3360"></a>
</span><span id="__span-0-3361"><a id="__codelineno-0-3361" name="__codelineno-0-3361" href="#__codelineno-0-3361"></a><span class="s1">SELECT</span>
</span><span id="__span-0-3362"><a id="__codelineno-0-3362" name="__codelineno-0-3362" href="#__codelineno-0-3362"></a>
</span><span id="__span-0-3363"><a id="__codelineno-0-3363" name="__codelineno-0-3363" href="#__codelineno-0-3363"></a><span class="s1">    name, -- Имя объекта</span>
</span><span id="__span-0-3364"><a id="__codelineno-0-3364" name="__codelineno-0-3364" href="#__codelineno-0-3364"></a>
</span><span id="__span-0-3365"><a id="__codelineno-0-3365" name="__codelineno-0-3365" href="#__codelineno-0-3365"></a><span class="s1">    object_id, -- Идентификатор объекта</span>
</span><span id="__span-0-3366"><a id="__codelineno-0-3366" name="__codelineno-0-3366" href="#__codelineno-0-3366"></a>
</span><span id="__span-0-3367"><a id="__codelineno-0-3367" name="__codelineno-0-3367" href="#__codelineno-0-3367"></a><span class="s1">    schema_id, -- Идентификатор схемы</span>
</span><span id="__span-0-3368"><a id="__codelineno-0-3368" name="__codelineno-0-3368" href="#__codelineno-0-3368"></a>
</span><span id="__span-0-3369"><a id="__codelineno-0-3369" name="__codelineno-0-3369" href="#__codelineno-0-3369"></a><span class="s1">    type</span>
</span><span id="__span-0-3370"><a id="__codelineno-0-3370" name="__codelineno-0-3370" href="#__codelineno-0-3370"></a>
</span><span id="__span-0-3371"><a id="__codelineno-0-3371" name="__codelineno-0-3371" href="#__codelineno-0-3371"></a><span class="s1">-- Тип объекта</span>
</span><span id="__span-0-3372"><a id="__codelineno-0-3372" name="__codelineno-0-3372" href="#__codelineno-0-3372"></a>
</span><span id="__span-0-3373"><a id="__codelineno-0-3373" name="__codelineno-0-3373" href="#__codelineno-0-3373"></a><span class="s1">FROM sys.objects o</span>
</span><span id="__span-0-3374"><a id="__codelineno-0-3374" name="__codelineno-0-3374" href="#__codelineno-0-3374"></a>
</span><span id="__span-0-3375"><a id="__codelineno-0-3375" name="__codelineno-0-3375" href="#__codelineno-0-3375"></a><span class="s1">WHERE (o.type = ''U'' OR o.type = ''IT'')</span>
</span><span id="__span-0-3376"><a id="__codelineno-0-3376" name="__codelineno-0-3376" href="#__codelineno-0-3376"></a>
</span><span id="__span-0-3377"><a id="__codelineno-0-3377" name="__codelineno-0-3377" href="#__codelineno-0-3377"></a><span class="s1">    AND [name] '</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">ConditionTableName</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'</span>
</span><span id="__span-0-3378"><a id="__codelineno-0-3378" name="__codelineno-0-3378" href="#__codelineno-0-3378"></a>
</span><span id="__span-0-3379"><a id="__codelineno-0-3379" name="__codelineno-0-3379" href="#__codelineno-0-3379"></a><span class="s1">-- внутренняя таблица</span>
</span><span id="__span-0-3380"><a id="__codelineno-0-3380" name="__codelineno-0-3380" href="#__codelineno-0-3380"></a>
</span><span id="__span-0-3381"><a id="__codelineno-0-3381" name="__codelineno-0-3381" href="#__codelineno-0-3381"></a><span class="s1">OPEN ms_crs_tnames</span>
</span><span id="__span-0-3382"><a id="__codelineno-0-3382" name="__codelineno-0-3382" href="#__codelineno-0-3382"></a>
</span><span id="__span-0-3383"><a id="__codelineno-0-3383" name="__codelineno-0-3383" href="#__codelineno-0-3383"></a><span class="s1">FETCH NEXT FROM ms_crs_tnames INTO @table_name, @table_id, @sch_id, @table_type</span>
</span><span id="__span-0-3384"><a id="__codelineno-0-3384" name="__codelineno-0-3384" href="#__codelineno-0-3384"></a>
</span><span id="__span-0-3385"><a id="__codelineno-0-3385" name="__codelineno-0-3385" href="#__codelineno-0-3385"></a><span class="s1">-- Определяем уровень совместимости для базы данных</span>
</span><span id="__span-0-3386"><a id="__codelineno-0-3386" name="__codelineno-0-3386" href="#__codelineno-0-3386"></a>
</span><span id="__span-0-3387"><a id="__codelineno-0-3387" name="__codelineno-0-3387" href="#__codelineno-0-3387"></a><span class="s1">SELECT @compatlvl = cmptlevel</span>
</span><span id="__span-0-3388"><a id="__codelineno-0-3388" name="__codelineno-0-3388" href="#__codelineno-0-3388"></a>
</span><span id="__span-0-3389"><a id="__codelineno-0-3389" name="__codelineno-0-3389" href="#__codelineno-0-3389"></a><span class="s1">FROM sys.sysdatabases</span>
</span><span id="__span-0-3390"><a id="__codelineno-0-3390" name="__codelineno-0-3390" href="#__codelineno-0-3390"></a>
</span><span id="__span-0-3391"><a id="__codelineno-0-3391" name="__codelineno-0-3391" href="#__codelineno-0-3391"></a><span class="s1">WHERE name = db_name()</span>
</span><span id="__span-0-3392"><a id="__codelineno-0-3392" name="__codelineno-0-3392" href="#__codelineno-0-3392"></a>
</span><span id="__span-0-3393"><a id="__codelineno-0-3393" name="__codelineno-0-3393" href="#__codelineno-0-3393"></a><span class="s1">WHILE (@@fetch_status &lt;&gt; -1)</span>
</span><span id="__span-0-3394"><a id="__codelineno-0-3394" name="__codelineno-0-3394" href="#__codelineno-0-3394"></a>
</span><span id="__span-0-3395"><a id="__codelineno-0-3395" name="__codelineno-0-3395" href="#__codelineno-0-3395"></a><span class="s1">BEGIN</span>
</span><span id="__span-0-3396"><a id="__codelineno-0-3396" name="__codelineno-0-3396" href="#__codelineno-0-3396"></a>
</span><span id="__span-0-3397"><a id="__codelineno-0-3397" name="__codelineno-0-3397" href="#__codelineno-0-3397"></a><span class="s1">    -- Формируем полное имя объекта (схема + имя)</span>
</span><span id="__span-0-3398"><a id="__codelineno-0-3398" name="__codelineno-0-3398" href="#__codelineno-0-3398"></a>
</span><span id="__span-0-3399"><a id="__codelineno-0-3399" name="__codelineno-0-3399" href="#__codelineno-0-3399"></a><span class="s1">    SELECT @schema_name = schema_name(@sch_id)</span>
</span><span id="__span-0-3400"><a id="__codelineno-0-3400" name="__codelineno-0-3400" href="#__codelineno-0-3400"></a>
</span><span id="__span-0-3401"><a id="__codelineno-0-3401" name="__codelineno-0-3401" href="#__codelineno-0-3401"></a><span class="s1">    SELECT @schema_table_name = quotename(@schema_name, ''['') +''.''+ quotename(rtrim(@table_name), ''['')</span>
</span><span id="__span-0-3402"><a id="__codelineno-0-3402" name="__codelineno-0-3402" href="#__codelineno-0-3402"></a>
</span><span id="__span-0-3403"><a id="__codelineno-0-3403" name="__codelineno-0-3403" href="#__codelineno-0-3403"></a><span class="s1">    -- Пропускаем таблицы, для которых отключен кластерный индекс</span>
</span><span id="__span-0-3404"><a id="__codelineno-0-3404" name="__codelineno-0-3404" href="#__codelineno-0-3404"></a>
</span><span id="__span-0-3405"><a id="__codelineno-0-3405" name="__codelineno-0-3405" href="#__codelineno-0-3405"></a><span class="s1">    IF (1 = isnull((SELECT is_disabled</span>
</span><span id="__span-0-3406"><a id="__codelineno-0-3406" name="__codelineno-0-3406" href="#__codelineno-0-3406"></a>
</span><span id="__span-0-3407"><a id="__codelineno-0-3407" name="__codelineno-0-3407" href="#__codelineno-0-3407"></a><span class="s1">        FROM sys.indexes</span>
</span><span id="__span-0-3408"><a id="__codelineno-0-3408" name="__codelineno-0-3408" href="#__codelineno-0-3408"></a>
</span><span id="__span-0-3409"><a id="__codelineno-0-3409" name="__codelineno-0-3409" href="#__codelineno-0-3409"></a><span class="s1">        WHERE object_id = @table_id AND index_id = 1), 0))</span>
</span><span id="__span-0-3410"><a id="__codelineno-0-3410" name="__codelineno-0-3410" href="#__codelineno-0-3410"></a>
</span><span id="__span-0-3411"><a id="__codelineno-0-3411" name="__codelineno-0-3411" href="#__codelineno-0-3411"></a><span class="s1">    BEGIN</span>
</span><span id="__span-0-3412"><a id="__codelineno-0-3412" name="__codelineno-0-3412" href="#__codelineno-0-3412"></a>
</span><span id="__span-0-3413"><a id="__codelineno-0-3413" name="__codelineno-0-3413" href="#__codelineno-0-3413"></a><span class="s1">        FETCH NEXT FROM ms_crs_tnames INTO @table_name, @table_id, @sch_id, @table_type</span>
</span><span id="__span-0-3414"><a id="__codelineno-0-3414" name="__codelineno-0-3414" href="#__codelineno-0-3414"></a>
</span><span id="__span-0-3415"><a id="__codelineno-0-3415" name="__codelineno-0-3415" href="#__codelineno-0-3415"></a><span class="s1">        CONTINUE;</span>
</span><span id="__span-0-3416"><a id="__codelineno-0-3416" name="__codelineno-0-3416" href="#__codelineno-0-3416"></a>
</span><span id="__span-0-3417"><a id="__codelineno-0-3417" name="__codelineno-0-3417" href="#__codelineno-0-3417"></a><span class="s1">    END</span>
</span><span id="__span-0-3418"><a id="__codelineno-0-3418" name="__codelineno-0-3418" href="#__codelineno-0-3418"></a>
</span><span id="__span-0-3419"><a id="__codelineno-0-3419" name="__codelineno-0-3419" href="#__codelineno-0-3419"></a><span class="s1">    ELSE BEGIN</span>
</span><span id="__span-0-3420"><a id="__codelineno-0-3420" name="__codelineno-0-3420" href="#__codelineno-0-3420"></a>
</span><span id="__span-0-3421"><a id="__codelineno-0-3421" name="__codelineno-0-3421" href="#__codelineno-0-3421"></a><span class="s1">        -- Пропускаем локальные временные таблицы</span>
</span><span id="__span-0-3422"><a id="__codelineno-0-3422" name="__codelineno-0-3422" href="#__codelineno-0-3422"></a>
</span><span id="__span-0-3423"><a id="__codelineno-0-3423" name="__codelineno-0-3423" href="#__codelineno-0-3423"></a><span class="s1">        IF ((@@fetch_status &lt;&gt; -2) AND (substring(@table_name, 1, 1) &lt;&gt; ''#''))</span>
</span><span id="__span-0-3424"><a id="__codelineno-0-3424" name="__codelineno-0-3424" href="#__codelineno-0-3424"></a>
</span><span id="__span-0-3425"><a id="__codelineno-0-3425" name="__codelineno-0-3425" href="#__codelineno-0-3425"></a><span class="s1">        BEGIN</span>
</span><span id="__span-0-3426"><a id="__codelineno-0-3426" name="__codelineno-0-3426" href="#__codelineno-0-3426"></a>
</span><span id="__span-0-3427"><a id="__codelineno-0-3427" name="__codelineno-0-3427" href="#__codelineno-0-3427"></a><span class="s1">            SELECT @updated_count = 0</span>
</span><span id="__span-0-3428"><a id="__codelineno-0-3428" name="__codelineno-0-3428" href="#__codelineno-0-3428"></a>
</span><span id="__span-0-3429"><a id="__codelineno-0-3429" name="__codelineno-0-3429" href="#__codelineno-0-3429"></a><span class="s1">            SELECT @skipped_count = 0</span>
</span><span id="__span-0-3430"><a id="__codelineno-0-3430" name="__codelineno-0-3430" href="#__codelineno-0-3430"></a>
</span><span id="__span-0-3431"><a id="__codelineno-0-3431" name="__codelineno-0-3431" href="#__codelineno-0-3431"></a><span class="s1">            -- Подготавливаем начало команды: UPDATE STATISTICS [schema].[name]</span>
</span><span id="__span-0-3432"><a id="__codelineno-0-3432" name="__codelineno-0-3432" href="#__codelineno-0-3432"></a>
</span><span id="__span-0-3433"><a id="__codelineno-0-3433" name="__codelineno-0-3433" href="#__codelineno-0-3433"></a><span class="s1">            SELECT @exec_stmt_head = ''UPDATE STATISTICS '' + @schema_table_name + '' ''</span>
</span><span id="__span-0-3434"><a id="__codelineno-0-3434" name="__codelineno-0-3434" href="#__codelineno-0-3434"></a>
</span><span id="__span-0-3435"><a id="__codelineno-0-3435" name="__codelineno-0-3435" href="#__codelineno-0-3435"></a><span class="s1">            -- Обходим индексы и объекты статистики для текущего объекта</span>
</span><span id="__span-0-3436"><a id="__codelineno-0-3436" name="__codelineno-0-3436" href="#__codelineno-0-3436"></a>
</span><span id="__span-0-3437"><a id="__codelineno-0-3437" name="__codelineno-0-3437" href="#__codelineno-0-3437"></a><span class="s1">            -- Объекты статистики как пользовательские, так и созданные автоматически.              </span>
</span><span id="__span-0-3438"><a id="__codelineno-0-3438" name="__codelineno-0-3438" href="#__codelineno-0-3438"></a>
</span><span id="__span-0-3439"><a id="__codelineno-0-3439" name="__codelineno-0-3439" href="#__codelineno-0-3439"></a><span class="s1">            IF ((@table_type = ''U'') AND (1 = OBJECTPROPERTY(@table_id, ''TableIsMemoryOptimized'')))  -- In-Memory OLTP</span>
</span><span id="__span-0-3440"><a id="__codelineno-0-3440" name="__codelineno-0-3440" href="#__codelineno-0-3440"></a>
</span><span id="__span-0-3441"><a id="__codelineno-0-3441" name="__codelineno-0-3441" href="#__codelineno-0-3441"></a><span class="s1">            BEGIN</span>
</span><span id="__span-0-3442"><a id="__codelineno-0-3442" name="__codelineno-0-3442" href="#__codelineno-0-3442"></a>
</span><span id="__span-0-3443"><a id="__codelineno-0-3443" name="__codelineno-0-3443" href="#__codelineno-0-3443"></a><span class="s1">                -- Hekaton-индексы (функциональность In-Memory OLTP) не отображаются в системном представлении sys.sysindexes,</span>
</span><span id="__span-0-3444"><a id="__codelineno-0-3444" name="__codelineno-0-3444" href="#__codelineno-0-3444"></a>
</span><span id="__span-0-3445"><a id="__codelineno-0-3445" name="__codelineno-0-3445" href="#__codelineno-0-3445"></a><span class="s1">                -- Поэтому нужно использовать sys.stats для их обработки.</span>
</span><span id="__span-0-3446"><a id="__codelineno-0-3446" name="__codelineno-0-3446" href="#__codelineno-0-3446"></a>
</span><span id="__span-0-3447"><a id="__codelineno-0-3447" name="__codelineno-0-3447" href="#__codelineno-0-3447"></a><span class="s1">                -- Примечание: OBJECTPROPERTY возвращает NULL для типа объекта "IT" (внутренние таблицы), </span>
</span><span id="__span-0-3448"><a id="__codelineno-0-3448" name="__codelineno-0-3448" href="#__codelineno-0-3448"></a>
</span><span id="__span-0-3449"><a id="__codelineno-0-3449" name="__codelineno-0-3449" href="#__codelineno-0-3449"></a><span class="s1">                -- поэтому можно использовать это только для типа ''U'' (пользовательские таблицы)</span>
</span><span id="__span-0-3450"><a id="__codelineno-0-3450" name="__codelineno-0-3450" href="#__codelineno-0-3450"></a>
</span><span id="__span-0-3451"><a id="__codelineno-0-3451" name="__codelineno-0-3451" href="#__codelineno-0-3451"></a><span class="s1">                -- Для Hekaton-индексов (функциональность In-Memory OLTP) </span>
</span><span id="__span-0-3452"><a id="__codelineno-0-3452" name="__codelineno-0-3452" href="#__codelineno-0-3452"></a>
</span><span id="__span-0-3453"><a id="__codelineno-0-3453" name="__codelineno-0-3453" href="#__codelineno-0-3453"></a><span class="s1">                SET @index_names = CURSOR LOCAL FAST_FORWARD READ_ONLY for</span>
</span><span id="__span-0-3454"><a id="__codelineno-0-3454" name="__codelineno-0-3454" href="#__codelineno-0-3454"></a>
</span><span id="__span-0-3455"><a id="__codelineno-0-3455" name="__codelineno-0-3455" href="#__codelineno-0-3455"></a><span class="s1">                        SELECT name, stat.stats_id, modification_counter AS rowmodctr</span>
</span><span id="__span-0-3456"><a id="__codelineno-0-3456" name="__codelineno-0-3456" href="#__codelineno-0-3456"></a>
</span><span id="__span-0-3457"><a id="__codelineno-0-3457" name="__codelineno-0-3457" href="#__codelineno-0-3457"></a><span class="s1">                FROM sys.stats AS stat</span>
</span><span id="__span-0-3458"><a id="__codelineno-0-3458" name="__codelineno-0-3458" href="#__codelineno-0-3458"></a>
</span><span id="__span-0-3459"><a id="__codelineno-0-3459" name="__codelineno-0-3459" href="#__codelineno-0-3459"></a><span class="s1">                        CROSS APPLY sys.dm_db_stats_properties(stat.object_id, stat.stats_id)</span>
</span><span id="__span-0-3460"><a id="__codelineno-0-3460" name="__codelineno-0-3460" href="#__codelineno-0-3460"></a>
</span><span id="__span-0-3461"><a id="__codelineno-0-3461" name="__codelineno-0-3461" href="#__codelineno-0-3461"></a><span class="s1">                WHERE stat.object_id = @table_id AND indexproperty(stat.object_id, name, ''ishypothetical'') = 0</span>
</span><span id="__span-0-3462"><a id="__codelineno-0-3462" name="__codelineno-0-3462" href="#__codelineno-0-3462"></a>
</span><span id="__span-0-3463"><a id="__codelineno-0-3463" name="__codelineno-0-3463" href="#__codelineno-0-3463"></a><span class="s1">                    AND indexproperty(stat.object_id, name, ''iscolumnstore'') = 0</span>
</span><span id="__span-0-3464"><a id="__codelineno-0-3464" name="__codelineno-0-3464" href="#__codelineno-0-3464"></a>
</span><span id="__span-0-3465"><a id="__codelineno-0-3465" name="__codelineno-0-3465" href="#__codelineno-0-3465"></a><span class="s1">                -- Для колоночных индексов статистика не обновляется</span>
</span><span id="__span-0-3466"><a id="__codelineno-0-3466" name="__codelineno-0-3466" href="#__codelineno-0-3466"></a>
</span><span id="__span-0-3467"><a id="__codelineno-0-3467" name="__codelineno-0-3467" href="#__codelineno-0-3467"></a><span class="s1">                ORDER BY stat.stats_id</span>
</span><span id="__span-0-3468"><a id="__codelineno-0-3468" name="__codelineno-0-3468" href="#__codelineno-0-3468"></a>
</span><span id="__span-0-3469"><a id="__codelineno-0-3469" name="__codelineno-0-3469" href="#__codelineno-0-3469"></a><span class="s1">            END ELSE </span>
</span><span id="__span-0-3470"><a id="__codelineno-0-3470" name="__codelineno-0-3470" href="#__codelineno-0-3470"></a>
</span><span id="__span-0-3471"><a id="__codelineno-0-3471" name="__codelineno-0-3471" href="#__codelineno-0-3471"></a><span class="s1">            BEGIN</span>
</span><span id="__span-0-3472"><a id="__codelineno-0-3472" name="__codelineno-0-3472" href="#__codelineno-0-3472"></a>
</span><span id="__span-0-3473"><a id="__codelineno-0-3473" name="__codelineno-0-3473" href="#__codelineno-0-3473"></a><span class="s1">                -- Для обычных таблиц</span>
</span><span id="__span-0-3474"><a id="__codelineno-0-3474" name="__codelineno-0-3474" href="#__codelineno-0-3474"></a>
</span><span id="__span-0-3475"><a id="__codelineno-0-3475" name="__codelineno-0-3475" href="#__codelineno-0-3475"></a><span class="s1">                SET @index_names = CURSOR LOCAL FAST_FORWARD READ_ONLY for</span>
</span><span id="__span-0-3476"><a id="__codelineno-0-3476" name="__codelineno-0-3476" href="#__codelineno-0-3476"></a>
</span><span id="__span-0-3477"><a id="__codelineno-0-3477" name="__codelineno-0-3477" href="#__codelineno-0-3477"></a><span class="s1">                        SELECT name, indid, rowmodctr</span>
</span><span id="__span-0-3478"><a id="__codelineno-0-3478" name="__codelineno-0-3478" href="#__codelineno-0-3478"></a>
</span><span id="__span-0-3479"><a id="__codelineno-0-3479" name="__codelineno-0-3479" href="#__codelineno-0-3479"></a><span class="s1">                FROM sys.sysindexes</span>
</span><span id="__span-0-3480"><a id="__codelineno-0-3480" name="__codelineno-0-3480" href="#__codelineno-0-3480"></a>
</span><span id="__span-0-3481"><a id="__codelineno-0-3481" name="__codelineno-0-3481" href="#__codelineno-0-3481"></a><span class="s1">                WHERE id = @table_id AND indid &gt; 0 AND indexproperty(id, name, ''ishypothetical'') = 0</span>
</span><span id="__span-0-3482"><a id="__codelineno-0-3482" name="__codelineno-0-3482" href="#__codelineno-0-3482"></a>
</span><span id="__span-0-3483"><a id="__codelineno-0-3483" name="__codelineno-0-3483" href="#__codelineno-0-3483"></a><span class="s1">                    AND indexproperty(id, name, ''iscolumnstore'') = 0</span>
</span><span id="__span-0-3484"><a id="__codelineno-0-3484" name="__codelineno-0-3484" href="#__codelineno-0-3484"></a>
</span><span id="__span-0-3485"><a id="__codelineno-0-3485" name="__codelineno-0-3485" href="#__codelineno-0-3485"></a><span class="s1">                ORDER BY indid</span>
</span><span id="__span-0-3486"><a id="__codelineno-0-3486" name="__codelineno-0-3486" href="#__codelineno-0-3486"></a>
</span><span id="__span-0-3487"><a id="__codelineno-0-3487" name="__codelineno-0-3487" href="#__codelineno-0-3487"></a><span class="s1">            END</span>
</span><span id="__span-0-3488"><a id="__codelineno-0-3488" name="__codelineno-0-3488" href="#__codelineno-0-3488"></a>
</span><span id="__span-0-3489"><a id="__codelineno-0-3489" name="__codelineno-0-3489" href="#__codelineno-0-3489"></a><span class="s1">            OPEN @index_names</span>
</span><span id="__span-0-3490"><a id="__codelineno-0-3490" name="__codelineno-0-3490" href="#__codelineno-0-3490"></a>
</span><span id="__span-0-3491"><a id="__codelineno-0-3491" name="__codelineno-0-3491" href="#__codelineno-0-3491"></a><span class="s1">            FETCH @index_names INTO @ind_name, @ind_id, @ind_rowmodctr</span>
</span><span id="__span-0-3492"><a id="__codelineno-0-3492" name="__codelineno-0-3492" href="#__codelineno-0-3492"></a>
</span><span id="__span-0-3493"><a id="__codelineno-0-3493" name="__codelineno-0-3493" href="#__codelineno-0-3493"></a><span class="s1">            -- Если объектов статистик нет, то пропускаем</span>
</span><span id="__span-0-3494"><a id="__codelineno-0-3494" name="__codelineno-0-3494" href="#__codelineno-0-3494"></a>
</span><span id="__span-0-3495"><a id="__codelineno-0-3495" name="__codelineno-0-3495" href="#__codelineno-0-3495"></a><span class="s1">            IF @@fetch_status &lt; 0</span>
</span><span id="__span-0-3496"><a id="__codelineno-0-3496" name="__codelineno-0-3496" href="#__codelineno-0-3496"></a>
</span><span id="__span-0-3497"><a id="__codelineno-0-3497" name="__codelineno-0-3497" href="#__codelineno-0-3497"></a><span class="s1">            BEGIN</span>
</span><span id="__span-0-3498"><a id="__codelineno-0-3498" name="__codelineno-0-3498" href="#__codelineno-0-3498"></a>
</span><span id="__span-0-3499"><a id="__codelineno-0-3499" name="__codelineno-0-3499" href="#__codelineno-0-3499"></a><span class="s1">                FETCH NEXT FROM ms_crs_tnames INTO @table_name, @table_id, @sch_id, @table_type</span>
</span><span id="__span-0-3500"><a id="__codelineno-0-3500" name="__codelineno-0-3500" href="#__codelineno-0-3500"></a>
</span><span id="__span-0-3501"><a id="__codelineno-0-3501" name="__codelineno-0-3501" href="#__codelineno-0-3501"></a><span class="s1">                CONTINUE;</span>
</span><span id="__span-0-3502"><a id="__codelineno-0-3502" name="__codelineno-0-3502" href="#__codelineno-0-3502"></a>
</span><span id="__span-0-3503"><a id="__codelineno-0-3503" name="__codelineno-0-3503" href="#__codelineno-0-3503"></a><span class="s1">            END ELSE </span>
</span><span id="__span-0-3504"><a id="__codelineno-0-3504" name="__codelineno-0-3504" href="#__codelineno-0-3504"></a>
</span><span id="__span-0-3505"><a id="__codelineno-0-3505" name="__codelineno-0-3505" href="#__codelineno-0-3505"></a><span class="s1">                BEGIN</span>
</span><span id="__span-0-3506"><a id="__codelineno-0-3506" name="__codelineno-0-3506" href="#__codelineno-0-3506"></a>
</span><span id="__span-0-3507"><a id="__codelineno-0-3507" name="__codelineno-0-3507" href="#__codelineno-0-3507"></a><span class="s1">                WHILE @@fetch_status &gt;= 0</span>
</span><span id="__span-0-3508"><a id="__codelineno-0-3508" name="__codelineno-0-3508" href="#__codelineno-0-3508"></a>
</span><span id="__span-0-3509"><a id="__codelineno-0-3509" name="__codelineno-0-3509" href="#__codelineno-0-3509"></a><span class="s1">                    BEGIN</span>
</span><span id="__span-0-3510"><a id="__codelineno-0-3510" name="__codelineno-0-3510" href="#__codelineno-0-3510"></a>
</span><span id="__span-0-3511"><a id="__codelineno-0-3511" name="__codelineno-0-3511" href="#__codelineno-0-3511"></a><span class="s1">                    -- Формируем имя индекса</span>
</span><span id="__span-0-3512"><a id="__codelineno-0-3512" name="__codelineno-0-3512" href="#__codelineno-0-3512"></a>
</span><span id="__span-0-3513"><a id="__codelineno-0-3513" name="__codelineno-0-3513" href="#__codelineno-0-3513"></a><span class="s1">                    DECLARE @ind_name_quoted NVARCHAR(258)</span>
</span><span id="__span-0-3514"><a id="__codelineno-0-3514" name="__codelineno-0-3514" href="#__codelineno-0-3514"></a>
</span><span id="__span-0-3515"><a id="__codelineno-0-3515" name="__codelineno-0-3515" href="#__codelineno-0-3515"></a><span class="s1">                    SELECT @ind_name_quoted = quotename(@ind_name, ''['')</span>
</span><span id="__span-0-3516"><a id="__codelineno-0-3516" name="__codelineno-0-3516" href="#__codelineno-0-3516"></a>
</span><span id="__span-0-3517"><a id="__codelineno-0-3517" name="__codelineno-0-3517" href="#__codelineno-0-3517"></a><span class="s1">                    SELECT @options = ''''</span>
</span><span id="__span-0-3518"><a id="__codelineno-0-3518" name="__codelineno-0-3518" href="#__codelineno-0-3518"></a>
</span><span id="__span-0-3519"><a id="__codelineno-0-3519" name="__codelineno-0-3519" href="#__codelineno-0-3519"></a><span class="s1">                    -- Если нет данных о накопленных изменениях или они больше 0 (количество измененных строк)</span>
</span><span id="__span-0-3520"><a id="__codelineno-0-3520" name="__codelineno-0-3520" href="#__codelineno-0-3520"></a>
</span><span id="__span-0-3521"><a id="__codelineno-0-3521" name="__codelineno-0-3521" href="#__codelineno-0-3521"></a><span class="s1">                    IF ((@ind_rowmodctr is null) OR (@ind_rowmodctr &lt;&gt; 0))</span>
</span><span id="__span-0-3522"><a id="__codelineno-0-3522" name="__codelineno-0-3522" href="#__codelineno-0-3522"></a>
</span><span id="__span-0-3523"><a id="__codelineno-0-3523" name="__codelineno-0-3523" href="#__codelineno-0-3523"></a><span class="s1">                        BEGIN</span>
</span><span id="__span-0-3524"><a id="__codelineno-0-3524" name="__codelineno-0-3524" href="#__codelineno-0-3524"></a>
</span><span id="__span-0-3525"><a id="__codelineno-0-3525" name="__codelineno-0-3525" href="#__codelineno-0-3525"></a><span class="s1">                        SELECT @exec_stmt = @exec_stmt_head + @ind_name_quoted</span>
</span><span id="__span-0-3526"><a id="__codelineno-0-3526" name="__codelineno-0-3526" href="#__codelineno-0-3526"></a>
</span><span id="__span-0-3527"><a id="__codelineno-0-3527" name="__codelineno-0-3527" href="#__codelineno-0-3527"></a><span class="s1">                        -- Добавляем полное сканирование (FULLSCAN) для оптимизированных в памяти таблиц, если уровень совместимости &lt; 130</span>
</span><span id="__span-0-3528"><a id="__codelineno-0-3528" name="__codelineno-0-3528" href="#__codelineno-0-3528"></a>
</span><span id="__span-0-3529"><a id="__codelineno-0-3529" name="__codelineno-0-3529" href="#__codelineno-0-3529"></a><span class="s1">                        IF ((@compatlvl &lt; 130) AND (@table_type = ''U'') AND (1 = OBJECTPROPERTY(@table_id, ''TableIsMemoryOptimized''))) -- In-Memory OLTP</span>
</span><span id="__span-0-3530"><a id="__codelineno-0-3530" name="__codelineno-0-3530" href="#__codelineno-0-3530"></a>
</span><span id="__span-0-3531"><a id="__codelineno-0-3531" name="__codelineno-0-3531" href="#__codelineno-0-3531"></a><span class="s1">                                SELECT @options = ''FULLSCAN''</span>
</span><span id="__span-0-3532"><a id="__codelineno-0-3532" name="__codelineno-0-3532" href="#__codelineno-0-3532"></a>
</span><span id="__span-0-3533"><a id="__codelineno-0-3533" name="__codelineno-0-3533" href="#__codelineno-0-3533"></a><span class="s1">                            -- add resample IF needed</span>
</span><span id="__span-0-3534"><a id="__codelineno-0-3534" name="__codelineno-0-3534" href="#__codelineno-0-3534"></a>
</span><span id="__span-0-3535"><a id="__codelineno-0-3535" name="__codelineno-0-3535" href="#__codelineno-0-3535"></a><span class="s1">                            ELSE IF (upper(@resample)=''RESAMPLE'')</span>
</span><span id="__span-0-3536"><a id="__codelineno-0-3536" name="__codelineno-0-3536" href="#__codelineno-0-3536"></a>
</span><span id="__span-0-3537"><a id="__codelineno-0-3537" name="__codelineno-0-3537" href="#__codelineno-0-3537"></a><span class="s1">                                SELECT @options = ''RESAMPLE ''</span>
</span><span id="__span-0-3538"><a id="__codelineno-0-3538" name="__codelineno-0-3538" href="#__codelineno-0-3538"></a>
</span><span id="__span-0-3539"><a id="__codelineno-0-3539" name="__codelineno-0-3539" href="#__codelineno-0-3539"></a><span class="s1">                        -- Для уровнея совместимости больше 90 определяем доп. параметры</span>
</span><span id="__span-0-3540"><a id="__codelineno-0-3540" name="__codelineno-0-3540" href="#__codelineno-0-3540"></a>
</span><span id="__span-0-3541"><a id="__codelineno-0-3541" name="__codelineno-0-3541" href="#__codelineno-0-3541"></a><span class="s1">                        IF (@compatlvl &gt;= 90)</span>
</span><span id="__span-0-3542"><a id="__codelineno-0-3542" name="__codelineno-0-3542" href="#__codelineno-0-3542"></a>
</span><span id="__span-0-3543"><a id="__codelineno-0-3543" name="__codelineno-0-3543" href="#__codelineno-0-3543"></a><span class="s1">                                -- Устанавливаем параметр NORECOMPUTE, если свойство AUTOSTATS для него было установлено в OFF</span>
</span><span id="__span-0-3544"><a id="__codelineno-0-3544" name="__codelineno-0-3544" href="#__codelineno-0-3544"></a>
</span><span id="__span-0-3545"><a id="__codelineno-0-3545" name="__codelineno-0-3545" href="#__codelineno-0-3545"></a><span class="s1">                                IF ((SELECT no_recompute</span>
</span><span id="__span-0-3546"><a id="__codelineno-0-3546" name="__codelineno-0-3546" href="#__codelineno-0-3546"></a>
</span><span id="__span-0-3547"><a id="__codelineno-0-3547" name="__codelineno-0-3547" href="#__codelineno-0-3547"></a><span class="s1">                        FROM sys.stats</span>
</span><span id="__span-0-3548"><a id="__codelineno-0-3548" name="__codelineno-0-3548" href="#__codelineno-0-3548"></a>
</span><span id="__span-0-3549"><a id="__codelineno-0-3549" name="__codelineno-0-3549" href="#__codelineno-0-3549"></a><span class="s1">                        WHERE object_id = @table_id AND name = @ind_name) = 1)</span>
</span><span id="__span-0-3550"><a id="__codelineno-0-3550" name="__codelineno-0-3550" href="#__codelineno-0-3550"></a>
</span><span id="__span-0-3551"><a id="__codelineno-0-3551" name="__codelineno-0-3551" href="#__codelineno-0-3551"></a><span class="s1">                                BEGIN</span>
</span><span id="__span-0-3552"><a id="__codelineno-0-3552" name="__codelineno-0-3552" href="#__codelineno-0-3552"></a>
</span><span id="__span-0-3553"><a id="__codelineno-0-3553" name="__codelineno-0-3553" href="#__codelineno-0-3553"></a><span class="s1">                            IF (len(@options) &gt; 0) SELECT @options = @options + '', NORECOMPUTE''</span>
</span><span id="__span-0-3554"><a id="__codelineno-0-3554" name="__codelineno-0-3554" href="#__codelineno-0-3554"></a>
</span><span id="__span-0-3555"><a id="__codelineno-0-3555" name="__codelineno-0-3555" href="#__codelineno-0-3555"></a><span class="s1">                                    ELSE SELECT @options = ''NORECOMPUTE''</span>
</span><span id="__span-0-3556"><a id="__codelineno-0-3556" name="__codelineno-0-3556" href="#__codelineno-0-3556"></a>
</span><span id="__span-0-3557"><a id="__codelineno-0-3557" name="__codelineno-0-3557" href="#__codelineno-0-3557"></a><span class="s1">                        END</span>
</span><span id="__span-0-3558"><a id="__codelineno-0-3558" name="__codelineno-0-3558" href="#__codelineno-0-3558"></a>
</span><span id="__span-0-3559"><a id="__codelineno-0-3559" name="__codelineno-0-3559" href="#__codelineno-0-3559"></a><span class="s1">                        -- Добавляем сформированные параметры в команду обновления статистики</span>
</span><span id="__span-0-3560"><a id="__codelineno-0-3560" name="__codelineno-0-3560" href="#__codelineno-0-3560"></a>
</span><span id="__span-0-3561"><a id="__codelineno-0-3561" name="__codelineno-0-3561" href="#__codelineno-0-3561"></a><span class="s1">                        IF (len(@options) &gt; 0)</span>
</span><span id="__span-0-3562"><a id="__codelineno-0-3562" name="__codelineno-0-3562" href="#__codelineno-0-3562"></a>
</span><span id="__span-0-3563"><a id="__codelineno-0-3563" name="__codelineno-0-3563" href="#__codelineno-0-3563"></a><span class="s1">                                SELECT @exec_stmt = @exec_stmt + '' WITH '' + @options</span>
</span><span id="__span-0-3564"><a id="__codelineno-0-3564" name="__codelineno-0-3564" href="#__codelineno-0-3564"></a>
</span><span id="__span-0-3565"><a id="__codelineno-0-3565" name="__codelineno-0-3565" href="#__codelineno-0-3565"></a>
</span><span id="__span-0-3566"><a id="__codelineno-0-3566" name="__codelineno-0-3566" href="#__codelineno-0-3566"></a>
</span><span id="__span-0-3567"><a id="__codelineno-0-3567" name="__codelineno-0-3567" href="#__codelineno-0-3567"></a><span class="s1">                        SET @StartDate = GetDate();</span>
</span><span id="__span-0-3568"><a id="__codelineno-0-3568" name="__codelineno-0-3568" href="#__codelineno-0-3568"></a>
</span><span id="__span-0-3569"><a id="__codelineno-0-3569" name="__codelineno-0-3569" href="#__codelineno-0-3569"></a>
</span><span id="__span-0-3570"><a id="__codelineno-0-3570" name="__codelineno-0-3570" href="#__codelineno-0-3570"></a>
</span><span id="__span-0-3571"><a id="__codelineno-0-3571" name="__codelineno-0-3571" href="#__codelineno-0-3571"></a><span class="s1">                        -- Проверка доступен ли запуск обслуживания в текущее время</span>
</span><span id="__span-0-3572"><a id="__codelineno-0-3572" name="__codelineno-0-3572" href="#__codelineno-0-3572"></a>
</span><span id="__span-0-3573"><a id="__codelineno-0-3573" name="__codelineno-0-3573" href="#__codelineno-0-3573"></a><span class="s1">                        SET @timeNow = CAST(GETDATE() AS TIME);</span>
</span><span id="__span-0-3574"><a id="__codelineno-0-3574" name="__codelineno-0-3574" href="#__codelineno-0-3574"></a>
</span><span id="__span-0-3575"><a id="__codelineno-0-3575" name="__codelineno-0-3575" href="#__codelineno-0-3575"></a><span class="s1">                        IF (@timeTo &gt;= @timeFrom) BEGIN</span>
</span><span id="__span-0-3576"><a id="__codelineno-0-3576" name="__codelineno-0-3576" href="#__codelineno-0-3576"></a>
</span><span id="__span-0-3577"><a id="__codelineno-0-3577" name="__codelineno-0-3577" href="#__codelineno-0-3577"></a><span class="s1">                            IF(NOT (@timeFrom &lt;= @timeNow AND @timeTo &gt;= @timeNow))</span>
</span><span id="__span-0-3578"><a id="__codelineno-0-3578" name="__codelineno-0-3578" href="#__codelineno-0-3578"></a>
</span><span id="__span-0-3579"><a id="__codelineno-0-3579" name="__codelineno-0-3579" href="#__codelineno-0-3579"></a><span class="s1">                                RETURN;</span>
</span><span id="__span-0-3580"><a id="__codelineno-0-3580" name="__codelineno-0-3580" href="#__codelineno-0-3580"></a>
</span><span id="__span-0-3581"><a id="__codelineno-0-3581" name="__codelineno-0-3581" href="#__codelineno-0-3581"></a><span class="s1">                        END ELSE BEGIN</span>
</span><span id="__span-0-3582"><a id="__codelineno-0-3582" name="__codelineno-0-3582" href="#__codelineno-0-3582"></a>
</span><span id="__span-0-3583"><a id="__codelineno-0-3583" name="__codelineno-0-3583" href="#__codelineno-0-3583"></a><span class="s1">                            IF(NOT ((@timeFrom &lt;= @timeNow AND ''23:59:59'' &gt;= @timeNow)</span>
</span><span id="__span-0-3584"><a id="__codelineno-0-3584" name="__codelineno-0-3584" href="#__codelineno-0-3584"></a>
</span><span id="__span-0-3585"><a id="__codelineno-0-3585" name="__codelineno-0-3585" href="#__codelineno-0-3585"></a><span class="s1">                                OR (@timeTo &gt;= @timeNow AND ''00:00:00'' &lt;= @timeNow)))     </span>
</span><span id="__span-0-3586"><a id="__codelineno-0-3586" name="__codelineno-0-3586" href="#__codelineno-0-3586"></a>
</span><span id="__span-0-3587"><a id="__codelineno-0-3587" name="__codelineno-0-3587" href="#__codelineno-0-3587"></a><span class="s1">                            RETURN;</span>
</span><span id="__span-0-3588"><a id="__codelineno-0-3588" name="__codelineno-0-3588" href="#__codelineno-0-3588"></a>
</span><span id="__span-0-3589"><a id="__codelineno-0-3589" name="__codelineno-0-3589" href="#__codelineno-0-3589"></a><span class="s1">                        END</span>
</span><span id="__span-0-3590"><a id="__codelineno-0-3590" name="__codelineno-0-3590" href="#__codelineno-0-3590"></a>
</span><span id="__span-0-3591"><a id="__codelineno-0-3591" name="__codelineno-0-3591" href="#__codelineno-0-3591"></a><span class="s1">                        BEGIN TRY                            </span>
</span><span id="__span-0-3592"><a id="__codelineno-0-3592" name="__codelineno-0-3592" href="#__codelineno-0-3592"></a>
</span><span id="__span-0-3593"><a id="__codelineno-0-3593" name="__codelineno-0-3593" href="#__codelineno-0-3593"></a><span class="s1">                            -- Сохраняем предварительную информацию об операции обслуживания без даты завершения</span>
</span><span id="__span-0-3594"><a id="__codelineno-0-3594" name="__codelineno-0-3594" href="#__codelineno-0-3594"></a>
</span><span id="__span-0-3595"><a id="__codelineno-0-3595" name="__codelineno-0-3595" href="#__codelineno-0-3595"></a><span class="s1">                            IF(@useMonitoringDatabase = 1)</span>
</span><span id="__span-0-3596"><a id="__codelineno-0-3596" name="__codelineno-0-3596" href="#__codelineno-0-3596"></a>
</span><span id="__span-0-3597"><a id="__codelineno-0-3597" name="__codelineno-0-3597" href="#__codelineno-0-3597"></a><span class="s1">                            BEGIN</span>
</span><span id="__span-0-3598"><a id="__codelineno-0-3598" name="__codelineno-0-3598" href="#__codelineno-0-3598"></a>
</span><span id="__span-0-3599"><a id="__codelineno-0-3599" name="__codelineno-0-3599" href="#__codelineno-0-3599"></a><span class="s1">                                EXECUTE ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'].[dbo].[sp_add_maintenance_action_log] </span>
</span><span id="__span-0-3600"><a id="__codelineno-0-3600" name="__codelineno-0-3600" href="#__codelineno-0-3600"></a>
</span><span id="__span-0-3601"><a id="__codelineno-0-3601" name="__codelineno-0-3601" href="#__codelineno-0-3601"></a><span class="s1">                                @table_name</span>
</span><span id="__span-0-3602"><a id="__codelineno-0-3602" name="__codelineno-0-3602" href="#__codelineno-0-3602"></a>
</span><span id="__span-0-3603"><a id="__codelineno-0-3603" name="__codelineno-0-3603" href="#__codelineno-0-3603"></a><span class="s1">                                ,@ind_name</span>
</span><span id="__span-0-3604"><a id="__codelineno-0-3604" name="__codelineno-0-3604" href="#__codelineno-0-3604"></a>
</span><span id="__span-0-3605"><a id="__codelineno-0-3605" name="__codelineno-0-3605" href="#__codelineno-0-3605"></a><span class="s1">                                ,@Operation</span>
</span><span id="__span-0-3606"><a id="__codelineno-0-3606" name="__codelineno-0-3606" href="#__codelineno-0-3606"></a>
</span><span id="__span-0-3607"><a id="__codelineno-0-3607" name="__codelineno-0-3607" href="#__codelineno-0-3607"></a><span class="s1">                                ,@RunDate</span>
</span><span id="__span-0-3608"><a id="__codelineno-0-3608" name="__codelineno-0-3608" href="#__codelineno-0-3608"></a>
</span><span id="__span-0-3609"><a id="__codelineno-0-3609" name="__codelineno-0-3609" href="#__codelineno-0-3609"></a><span class="s1">                                ,@StartDate</span>
</span><span id="__span-0-3610"><a id="__codelineno-0-3610" name="__codelineno-0-3610" href="#__codelineno-0-3610"></a>
</span><span id="__span-0-3611"><a id="__codelineno-0-3611" name="__codelineno-0-3611" href="#__codelineno-0-3611"></a><span class="s1">                                ,null</span>
</span><span id="__span-0-3612"><a id="__codelineno-0-3612" name="__codelineno-0-3612" href="#__codelineno-0-3612"></a>
</span><span id="__span-0-3613"><a id="__codelineno-0-3613" name="__codelineno-0-3613" href="#__codelineno-0-3613"></a><span class="s1">                                ,@DBNAME</span>
</span><span id="__span-0-3614"><a id="__codelineno-0-3614" name="__codelineno-0-3614" href="#__codelineno-0-3614"></a>
</span><span id="__span-0-3615"><a id="__codelineno-0-3615" name="__codelineno-0-3615" href="#__codelineno-0-3615"></a><span class="s1">                                ,0</span>
</span><span id="__span-0-3616"><a id="__codelineno-0-3616" name="__codelineno-0-3616" href="#__codelineno-0-3616"></a>
</span><span id="__span-0-3617"><a id="__codelineno-0-3617" name="__codelineno-0-3617" href="#__codelineno-0-3617"></a><span class="s1">                                ,''''</span>
</span><span id="__span-0-3618"><a id="__codelineno-0-3618" name="__codelineno-0-3618" href="#__codelineno-0-3618"></a>
</span><span id="__span-0-3619"><a id="__codelineno-0-3619" name="__codelineno-0-3619" href="#__codelineno-0-3619"></a><span class="s1">                                ,0</span>
</span><span id="__span-0-3620"><a id="__codelineno-0-3620" name="__codelineno-0-3620" href="#__codelineno-0-3620"></a>
</span><span id="__span-0-3621"><a id="__codelineno-0-3621" name="__codelineno-0-3621" href="#__codelineno-0-3621"></a><span class="s1">                                ,@ind_rowmodctr</span>
</span><span id="__span-0-3622"><a id="__codelineno-0-3622" name="__codelineno-0-3622" href="#__codelineno-0-3622"></a>
</span><span id="__span-0-3623"><a id="__codelineno-0-3623" name="__codelineno-0-3623" href="#__codelineno-0-3623"></a><span class="s1">                                ,@exec_stmt</span>
</span><span id="__span-0-3624"><a id="__codelineno-0-3624" name="__codelineno-0-3624" href="#__codelineno-0-3624"></a>
</span><span id="__span-0-3625"><a id="__codelineno-0-3625" name="__codelineno-0-3625" href="#__codelineno-0-3625"></a><span class="s1">                                ,@MaintenanceActionLogId OUTPUT;</span>
</span><span id="__span-0-3626"><a id="__codelineno-0-3626" name="__codelineno-0-3626" href="#__codelineno-0-3626"></a>
</span><span id="__span-0-3627"><a id="__codelineno-0-3627" name="__codelineno-0-3627" href="#__codelineno-0-3627"></a><span class="s1">                            END</span>
</span><span id="__span-0-3628"><a id="__codelineno-0-3628" name="__codelineno-0-3628" href="#__codelineno-0-3628"></a>
</span><span id="__span-0-3629"><a id="__codelineno-0-3629" name="__codelineno-0-3629" href="#__codelineno-0-3629"></a><span class="s1">                            EXEC sp_executesql @exec_stmt;</span>
</span><span id="__span-0-3630"><a id="__codelineno-0-3630" name="__codelineno-0-3630" href="#__codelineno-0-3630"></a>
</span><span id="__span-0-3631"><a id="__codelineno-0-3631" name="__codelineno-0-3631" href="#__codelineno-0-3631"></a><span class="s1">                            SET @FinishDate = GetDate();</span>
</span><span id="__span-0-3632"><a id="__codelineno-0-3632" name="__codelineno-0-3632" href="#__codelineno-0-3632"></a>
</span><span id="__span-0-3633"><a id="__codelineno-0-3633" name="__codelineno-0-3633" href="#__codelineno-0-3633"></a><span class="s1">                            -- Устанавливаем фактическую дату завершения операции</span>
</span><span id="__span-0-3634"><a id="__codelineno-0-3634" name="__codelineno-0-3634" href="#__codelineno-0-3634"></a>
</span><span id="__span-0-3635"><a id="__codelineno-0-3635" name="__codelineno-0-3635" href="#__codelineno-0-3635"></a><span class="s1">                            IF(@useMonitoringDatabase = 1)</span>
</span><span id="__span-0-3636"><a id="__codelineno-0-3636" name="__codelineno-0-3636" href="#__codelineno-0-3636"></a>
</span><span id="__span-0-3637"><a id="__codelineno-0-3637" name="__codelineno-0-3637" href="#__codelineno-0-3637"></a><span class="s1">                            BEGIN</span>
</span><span id="__span-0-3638"><a id="__codelineno-0-3638" name="__codelineno-0-3638" href="#__codelineno-0-3638"></a>
</span><span id="__span-0-3639"><a id="__codelineno-0-3639" name="__codelineno-0-3639" href="#__codelineno-0-3639"></a><span class="s1">                                EXECUTE ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'].[dbo].[sp_set_maintenance_action_log_finish_date]</span>
</span><span id="__span-0-3640"><a id="__codelineno-0-3640" name="__codelineno-0-3640" href="#__codelineno-0-3640"></a>
</span><span id="__span-0-3641"><a id="__codelineno-0-3641" name="__codelineno-0-3641" href="#__codelineno-0-3641"></a><span class="s1">                                    @MaintenanceActionLogId,</span>
</span><span id="__span-0-3642"><a id="__codelineno-0-3642" name="__codelineno-0-3642" href="#__codelineno-0-3642"></a>
</span><span id="__span-0-3643"><a id="__codelineno-0-3643" name="__codelineno-0-3643" href="#__codelineno-0-3643"></a><span class="s1">                                    @FinishDate;</span>
</span><span id="__span-0-3644"><a id="__codelineno-0-3644" name="__codelineno-0-3644" href="#__codelineno-0-3644"></a>
</span><span id="__span-0-3645"><a id="__codelineno-0-3645" name="__codelineno-0-3645" href="#__codelineno-0-3645"></a><span class="s1">                            END</span>
</span><span id="__span-0-3646"><a id="__codelineno-0-3646" name="__codelineno-0-3646" href="#__codelineno-0-3646"></a>
</span><span id="__span-0-3647"><a id="__codelineno-0-3647" name="__codelineno-0-3647" href="#__codelineno-0-3647"></a><span class="s1">                        END TRY</span>
</span><span id="__span-0-3648"><a id="__codelineno-0-3648" name="__codelineno-0-3648" href="#__codelineno-0-3648"></a>
</span><span id="__span-0-3649"><a id="__codelineno-0-3649" name="__codelineno-0-3649" href="#__codelineno-0-3649"></a><span class="s1">                        BEGIN CATCH</span>
</span><span id="__span-0-3650"><a id="__codelineno-0-3650" name="__codelineno-0-3650" href="#__codelineno-0-3650"></a>
</span><span id="__span-0-3651"><a id="__codelineno-0-3651" name="__codelineno-0-3651" href="#__codelineno-0-3651"></a><span class="s1">                            IF(@MaintenanceActionLogId &lt;&gt; 0)</span>
</span><span id="__span-0-3652"><a id="__codelineno-0-3652" name="__codelineno-0-3652" href="#__codelineno-0-3652"></a>
</span><span id="__span-0-3653"><a id="__codelineno-0-3653" name="__codelineno-0-3653" href="#__codelineno-0-3653"></a><span class="s1">                            BEGIN</span>
</span><span id="__span-0-3654"><a id="__codelineno-0-3654" name="__codelineno-0-3654" href="#__codelineno-0-3654"></a>
</span><span id="__span-0-3655"><a id="__codelineno-0-3655" name="__codelineno-0-3655" href="#__codelineno-0-3655"></a><span class="s1">                                DECLARE @msg nvarchar(500) = ''Error: '' + CAST(Error_message() AS NVARCHAR(500)) + '', Code: '' + CAST(Error_Number() AS NVARCHAR(500)) + '', Line: '' + CAST(Error_Line() AS NVARCHAR(500))</span>
</span><span id="__span-0-3656"><a id="__codelineno-0-3656" name="__codelineno-0-3656" href="#__codelineno-0-3656"></a>
</span><span id="__span-0-3657"><a id="__codelineno-0-3657" name="__codelineno-0-3657" href="#__codelineno-0-3657"></a><span class="s1">                                -- Устанавливаем текст ошибки при обслуживании объекта статистики</span>
</span><span id="__span-0-3658"><a id="__codelineno-0-3658" name="__codelineno-0-3658" href="#__codelineno-0-3658"></a>
</span><span id="__span-0-3659"><a id="__codelineno-0-3659" name="__codelineno-0-3659" href="#__codelineno-0-3659"></a><span class="s1">                                -- Дата завершения при этом остается незаполненной</span>
</span><span id="__span-0-3660"><a id="__codelineno-0-3660" name="__codelineno-0-3660" href="#__codelineno-0-3660"></a>
</span><span id="__span-0-3661"><a id="__codelineno-0-3661" name="__codelineno-0-3661" href="#__codelineno-0-3661"></a><span class="s1">                                EXECUTE ['</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'].[dbo].[sp_set_maintenance_action_log_finish_date]</span>
</span><span id="__span-0-3662"><a id="__codelineno-0-3662" name="__codelineno-0-3662" href="#__codelineno-0-3662"></a>
</span><span id="__span-0-3663"><a id="__codelineno-0-3663" name="__codelineno-0-3663" href="#__codelineno-0-3663"></a><span class="s1">                                    @MaintenanceActionLogId,</span>
</span><span id="__span-0-3664"><a id="__codelineno-0-3664" name="__codelineno-0-3664" href="#__codelineno-0-3664"></a>
</span><span id="__span-0-3665"><a id="__codelineno-0-3665" name="__codelineno-0-3665" href="#__codelineno-0-3665"></a><span class="s1">                                    @FinishDate,</span>
</span><span id="__span-0-3666"><a id="__codelineno-0-3666" name="__codelineno-0-3666" href="#__codelineno-0-3666"></a>
</span><span id="__span-0-3667"><a id="__codelineno-0-3667" name="__codelineno-0-3667" href="#__codelineno-0-3667"></a><span class="s1">                                    @msg;           </span>
</span><span id="__span-0-3668"><a id="__codelineno-0-3668" name="__codelineno-0-3668" href="#__codelineno-0-3668"></a>
</span><span id="__span-0-3669"><a id="__codelineno-0-3669" name="__codelineno-0-3669" href="#__codelineno-0-3669"></a><span class="s1">                            END</span>
</span><span id="__span-0-3670"><a id="__codelineno-0-3670" name="__codelineno-0-3670" href="#__codelineno-0-3670"></a>
</span><span id="__span-0-3671"><a id="__codelineno-0-3671" name="__codelineno-0-3671" href="#__codelineno-0-3671"></a><span class="s1">                        END CATCH</span>
</span><span id="__span-0-3672"><a id="__codelineno-0-3672" name="__codelineno-0-3672" href="#__codelineno-0-3672"></a>
</span><span id="__span-0-3673"><a id="__codelineno-0-3673" name="__codelineno-0-3673" href="#__codelineno-0-3673"></a>
</span><span id="__span-0-3674"><a id="__codelineno-0-3674" name="__codelineno-0-3674" href="#__codelineno-0-3674"></a>
</span><span id="__span-0-3675"><a id="__codelineno-0-3675" name="__codelineno-0-3675" href="#__codelineno-0-3675"></a><span class="s1">                        SELECT @updated_count = @updated_count + 1</span>
</span><span id="__span-0-3676"><a id="__codelineno-0-3676" name="__codelineno-0-3676" href="#__codelineno-0-3676"></a>
</span><span id="__span-0-3677"><a id="__codelineno-0-3677" name="__codelineno-0-3677" href="#__codelineno-0-3677"></a><span class="s1">                    END ELSE</span>
</span><span id="__span-0-3678"><a id="__codelineno-0-3678" name="__codelineno-0-3678" href="#__codelineno-0-3678"></a>
</span><span id="__span-0-3679"><a id="__codelineno-0-3679" name="__codelineno-0-3679" href="#__codelineno-0-3679"></a><span class="s1">                    BEGIN</span>
</span><span id="__span-0-3680"><a id="__codelineno-0-3680" name="__codelineno-0-3680" href="#__codelineno-0-3680"></a>
</span><span id="__span-0-3681"><a id="__codelineno-0-3681" name="__codelineno-0-3681" href="#__codelineno-0-3681"></a><span class="s1">                        SELECT @skipped_count = @skipped_count + 1</span>
</span><span id="__span-0-3682"><a id="__codelineno-0-3682" name="__codelineno-0-3682" href="#__codelineno-0-3682"></a>
</span><span id="__span-0-3683"><a id="__codelineno-0-3683" name="__codelineno-0-3683" href="#__codelineno-0-3683"></a><span class="s1">                    END</span>
</span><span id="__span-0-3684"><a id="__codelineno-0-3684" name="__codelineno-0-3684" href="#__codelineno-0-3684"></a>
</span><span id="__span-0-3685"><a id="__codelineno-0-3685" name="__codelineno-0-3685" href="#__codelineno-0-3685"></a><span class="s1">                    FETCH @index_names INTO @ind_name, @ind_id, @ind_rowmodctr</span>
</span><span id="__span-0-3686"><a id="__codelineno-0-3686" name="__codelineno-0-3686" href="#__codelineno-0-3686"></a>
</span><span id="__span-0-3687"><a id="__codelineno-0-3687" name="__codelineno-0-3687" href="#__codelineno-0-3687"></a><span class="s1">                END</span>
</span><span id="__span-0-3688"><a id="__codelineno-0-3688" name="__codelineno-0-3688" href="#__codelineno-0-3688"></a>
</span><span id="__span-0-3689"><a id="__codelineno-0-3689" name="__codelineno-0-3689" href="#__codelineno-0-3689"></a><span class="s1">            END</span>
</span><span id="__span-0-3690"><a id="__codelineno-0-3690" name="__codelineno-0-3690" href="#__codelineno-0-3690"></a>
</span><span id="__span-0-3691"><a id="__codelineno-0-3691" name="__codelineno-0-3691" href="#__codelineno-0-3691"></a><span class="s1">            DEALLOCATE @index_names</span>
</span><span id="__span-0-3692"><a id="__codelineno-0-3692" name="__codelineno-0-3692" href="#__codelineno-0-3692"></a>
</span><span id="__span-0-3693"><a id="__codelineno-0-3693" name="__codelineno-0-3693" href="#__codelineno-0-3693"></a><span class="s1">        END</span>
</span><span id="__span-0-3694"><a id="__codelineno-0-3694" name="__codelineno-0-3694" href="#__codelineno-0-3694"></a>
</span><span id="__span-0-3695"><a id="__codelineno-0-3695" name="__codelineno-0-3695" href="#__codelineno-0-3695"></a><span class="s1">    END</span>
</span><span id="__span-0-3696"><a id="__codelineno-0-3696" name="__codelineno-0-3696" href="#__codelineno-0-3696"></a>
</span><span id="__span-0-3697"><a id="__codelineno-0-3697" name="__codelineno-0-3697" href="#__codelineno-0-3697"></a><span class="s1">    FETCH NEXT FROM ms_crs_tnames INTO @table_name, @table_id, @sch_id, @table_type</span>
</span><span id="__span-0-3698"><a id="__codelineno-0-3698" name="__codelineno-0-3698" href="#__codelineno-0-3698"></a>
</span><span id="__span-0-3699"><a id="__codelineno-0-3699" name="__codelineno-0-3699" href="#__codelineno-0-3699"></a><span class="s1">END</span>
</span><span id="__span-0-3700"><a id="__codelineno-0-3700" name="__codelineno-0-3700" href="#__codelineno-0-3700"></a>
</span><span id="__span-0-3701"><a id="__codelineno-0-3701" name="__codelineno-0-3701" href="#__codelineno-0-3701"></a><span class="s1">DEALLOCATE ms_crs_tnames</span>
</span><span id="__span-0-3702"><a id="__codelineno-0-3702" name="__codelineno-0-3702" href="#__codelineno-0-3702"></a>
</span><span id="__span-0-3703"><a id="__codelineno-0-3703" name="__codelineno-0-3703" href="#__codelineno-0-3703"></a><span class="s1">'</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">))</span>
</span><span id="__span-0-3704"><a id="__codelineno-0-3704" name="__codelineno-0-3704" href="#__codelineno-0-3704"></a>
</span><span id="__span-0-3705"><a id="__codelineno-0-3705" name="__codelineno-0-3705" href="#__codelineno-0-3705"></a>
</span><span id="__span-0-3706"><a id="__codelineno-0-3706" name="__codelineno-0-3706" href="#__codelineno-0-3706"></a>
</span><span id="__span-0-3707"><a id="__codelineno-0-3707" name="__codelineno-0-3707" href="#__codelineno-0-3707"></a><span class="w">    </span><span class="k">EXECUTE</span><span class="w"> </span><span class="n">sp_executesql</span><span class="w"> </span>
</span><span id="__span-0-3708"><a id="__codelineno-0-3708" name="__codelineno-0-3708" href="#__codelineno-0-3708"></a>
</span><span id="__span-0-3709"><a id="__codelineno-0-3709" name="__codelineno-0-3709" href="#__codelineno-0-3709"></a><span class="w">        </span><span class="o">@</span><span class="n">cmd</span><span class="p">,</span>
</span><span id="__span-0-3710"><a id="__codelineno-0-3710" name="__codelineno-0-3710" href="#__codelineno-0-3710"></a>
</span><span id="__span-0-3711"><a id="__codelineno-0-3711" name="__codelineno-0-3711" href="#__codelineno-0-3711"></a><span class="w">        </span><span class="n">N</span><span class="s1">'@timeFrom TIME, @timeTo TIME,</span>
</span><span id="__span-0-3712"><a id="__codelineno-0-3712" name="__codelineno-0-3712" href="#__codelineno-0-3712"></a>
</span><span id="__span-0-3713"><a id="__codelineno-0-3713" name="__codelineno-0-3713" href="#__codelineno-0-3713"></a><span class="s1">        @useMonitoringDatabase bit, @monitoringDatabaseName sysname'</span><span class="p">,</span>
</span><span id="__span-0-3714"><a id="__codelineno-0-3714" name="__codelineno-0-3714" href="#__codelineno-0-3714"></a>
</span><span id="__span-0-3715"><a id="__codelineno-0-3715" name="__codelineno-0-3715" href="#__codelineno-0-3715"></a><span class="w">        </span><span class="o">@</span><span class="n">timeFrom</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">timeTo</span><span class="p">,</span>
</span><span id="__span-0-3716"><a id="__codelineno-0-3716" name="__codelineno-0-3716" href="#__codelineno-0-3716"></a>
</span><span id="__span-0-3717"><a id="__codelineno-0-3717" name="__codelineno-0-3717" href="#__codelineno-0-3717"></a><span class="w">        </span><span class="o">@</span><span class="n">useMonitoringDatabase</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">monitoringDatabaseName</span><span class="p">;</span>
</span><span id="__span-0-3718"><a id="__codelineno-0-3718" name="__codelineno-0-3718" href="#__codelineno-0-3718"></a>
</span><span id="__span-0-3719"><a id="__codelineno-0-3719" name="__codelineno-0-3719" href="#__codelineno-0-3719"></a>
</span><span id="__span-0-3720"><a id="__codelineno-0-3720" name="__codelineno-0-3720" href="#__codelineno-0-3720"></a>
</span><span id="__span-0-3721"><a id="__codelineno-0-3721" name="__codelineno-0-3721" href="#__codelineno-0-3721"></a><span class="w">    </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-0-3722"><a id="__codelineno-0-3722" name="__codelineno-0-3722" href="#__codelineno-0-3722"></a>
</span><span id="__span-0-3723"><a id="__codelineno-0-3723" name="__codelineno-0-3723" href="#__codelineno-0-3723"></a><span class="k">END</span>
</span><span id="__span-0-3724"><a id="__codelineno-0-3724" name="__codelineno-0-3724" href="#__codelineno-0-3724"></a>
</span><span id="__span-0-3725"><a id="__codelineno-0-3725" name="__codelineno-0-3725" href="#__codelineno-0-3725"></a><span class="k">GO</span>
</span></code></pre></div>
</details>
<p>Для актуальной версии следите за обновлениями. Также никто не мешает Вам дорабатывать эти скрипты для себя.</p>
<p>Инструмент готов, а теперь нужно заменить компоненты обслуживания на свои скрипты. И вот как это будет выглядеть.</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../img/ee8551c9c32f4d9292ee15deeb812265.png" data-desc-position="bottom"><img alt="" src="../img/ee8551c9c32f4d9292ee15deeb812265.png"></a>Вместо трех шагов теперь только 2, в каждом свои скрипты для выполнения операций.</p>
<p>Шаг обслуживания индексов</p>
<p>На первом шаге используется такой скрипт.</p>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">EXECUTE</span><span class="w"> </span><span class="p">[</span><span class="n">SQLServerMaintenance</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_IndexMaintenance</span><span class="p">]</span><span class="w"> </span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'BSL-ORIG'</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="c1">-- Разрешаем запуск скрипта с 21:00:00 до 22:30:00</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="p">,</span><span class="o">@</span><span class="n">timeFrom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'21:00:00'</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="p">,</span><span class="o">@</span><span class="n">timeTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'22:30:00'</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="c1">-- 1 - обслуживать только те объекты, которые поддерживают онлайн-перестроение</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="p">,</span><span class="o">@</span><span class="n">useOnlineIndexRebuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="c1">-- Процент фрагментации, с которого будет выполняться обслуживание</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="p">,</span><span class="o">@</span><span class="n">fragmentationPercentMinForMaintenance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="c1">-- Процент фрагментации с которого начинается полное перестроение.</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="c1">-- Все, что между 10 и 30 будет обслуживаться операцией реорганизации</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="p">,</span><span class="o">@</span><span class="n">fragmentationPercentForRebuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="c1">-- Степень параллелизма для операций перестроения оставляем равной 8</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="p">,</span><span class="o">@</span><span class="n">maxDop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="c1">-- Настраиваем поведение онлайн-перестроения в ситуациях, когда переключение индекса на новый блокируется</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="c1">-- другими запросами</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a><span class="c1">-- 1 - операция обслуживания завершит себя по истечении таймаута ожидания.</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a><span class="p">,</span><span class="o">@</span><span class="n">onlineRebuildAbortAfterWaitMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a><span class="c1">-- Время ожидания операции онлайн перестроения перед прерыванием работы. Ставим 15 минут</span>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a><span class="p">,</span><span class="o">@</span><span class="n">onlineRebuildWaitMinutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span>
</span></code></pre></div>
</details>
<p>В скрипте мы указываем имя базы, для которой устанавливаем обслуживание и диапазон времени, в который можно выполнять операции обслуживания.</p>
<p>Кроме этого указываем, что нужно обслуживать только те объекты, которые поддерживают онлайн перестроение (параметр @useOnlineIndexRebuild). Также устанавливаем, что обслуживание нужно начинать только с 10% фрагментацией (@fragmentationPercentMinForMaintenance), а полное перестроение только при 30% значении фрагментации индекса (@fragmentationPercentForRebuild). Таким образом, реорганизация индекса будет применяться, если фрагментация находится в диапазоне между 10%&nbsp;и 30%.</p>
<p>Дополнительно к этому установим особые параметры онлайн обслуживания:</p>
<ul>
<li>При блокировании обслуживания другими запросами отдаем приоритет именно им. То есть по истечении таймаута операция обслуживания завершит сама себя (@onlineRebuildAbortAfterWaitMode).</li>
<li>Время ожидания при этом установим в 15 минут (@onlineRebuildAbortAfterWaitMode).</li>
</ul>
<p>Это должно решить все перечисленные выше задачи.</p>
<p>Шаг обслуживания статистик</p>
<p>Для обслуживания статистики будем использовать следующий скрипт.</p>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">EXECUTE</span><span class="w"> </span><span class="p">[</span><span class="n">SQLServerMaintenance</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_StatisticMaintenance</span><span class="p">]</span><span class="w"> </span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'BSL-ORIG'</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="p">,</span><span class="o">@</span><span class="n">timeFrom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'21:00:00'</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="p">,</span><span class="o">@</span><span class="n">timeTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'22:30:00'</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="c1">-- 0 устанавливаем режим анализа выборки данных, </span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="c1">-- 1 - режим полного сканирования</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="p">,</span><span class="o">@</span><span class="k">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</span></code></pre></div>
</details>
<p>Также указываем время работы скрипта и режим полного сканирования.</p>
<p>На первом шаге мы обязательно установим таймаут выполнения операции в 2 часа. Это соотносится с указанным в настройках диапазоном времени с 21:00 до 22:30 (1.5 часа). Таймаут в 2 часа это последний рубеж защиты, чтобы процедуры обслуживания не вышли за 23:00. Такое может произойти, если индекс начал операцию перестроения или реорганизации в 22:20 и к 23:00 не завершился, то таймаут выполнения команды ее прервет "насильно".</p>
<p>При этом для операции обновления статистики таймаут выполнения мы не ставим, т.к. она не мешает работе других запросов. При этом если обслуживание индексов работало до 23:00 (с таймаутом или без), то обслуживание статистик не будет запущено. Считаем это проблемными ситуациями и они не должны возникать часто.</p>
<p>Также добавим дополнительный субплан для обслуживания индексов, которые не поддерживают онлайн перестроение. Считаем, что таких объектов не много и их можно обслуживать раз в неделю. Для этого добавим субплан с запуском раз в неделю, например в субботу в 23:00 и отдаем на работу скрипта 30 минут. Скрипт будет таким.</p>
<p>Еженедельное обслуживание индексов без поддержки онлайн перестроения</p>
<p>Заменяем параметр "@useOnlineIndexRebuild" и убираем настройки, связанные с онлайн перестроением.</p>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">EXECUTE</span><span class="w"> </span><span class="p">[</span><span class="n">SQLServerMaintenance</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_IndexMaintenance</span><span class="p">]</span><span class="w"> </span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'BSL-ORIG'</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="c1">-- Разрешаем запуск скрипта с 23:00:00 до 23:30:00</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="p">,</span><span class="o">@</span><span class="n">timeFrom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'23:00:00'</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="p">,</span><span class="o">@</span><span class="n">timeTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'23:30:00'</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="c1">-- (2) - обслуживание только тех объектов, в которых онлайн-перестроение не поддерживается.</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="p">,</span><span class="o">@</span><span class="n">useOnlineIndexRebuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="c1">-- Процент фрагментации, с корого будет выполняться обслуживание</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="p">,</span><span class="o">@</span><span class="n">fragmentationPercentMinForMaintenance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="c1">-- Процент фрагментации с которого начинается полное перестроение.</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="c1">-- Все, что между 10 и 30 будет обслуживаться операцией реорганизации</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="p">,</span><span class="o">@</span><span class="n">fragmentationPercentForRebuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="c1">-- Степень параллелизма для операций перестроения оставляем равной 8</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="p">,</span><span class="o">@</span><span class="n">maxDop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span>
</span></code></pre></div>
</details>
<p>Остальное все как обычно.</p>
<p>Таймаут для операции установим в 1 час, то есть в 00:00 операция будет завершена в любом случае.</p>
<p>И последнее изменение - это дополнительные шаги обслуживания статистики. Ранее мы запускали в дневное время отдельное обновление статистики, а теперь будем выполнять это 3 раза (не считая основного ночного обслуживания): в 06:00, 13:00 и в 18:00.</p>
<p>Регулярное обслуживание статистики</p>
<p>Отключаем ограничения времени выполнения и режим обновления теперь выполняем через выборку данных, а не полным сканированием.</p>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">EXECUTE</span><span class="w"> </span><span class="p">[</span><span class="n">SQLServerMaintenance</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_StatisticMaintenance</span><span class="p">]</span><span class="w"> </span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'BSL-ORIG'</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="c1">-- 0 устанавливаем режим анализа выборки данных, </span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="c1">-- 1 - режим полного сканирования</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="p">,</span><span class="o">@</span><span class="k">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
</span></code></pre></div>
</details>
<p>Так как полное сканирование не используется, то даже для многотеррабайтных баз эта операция будет выполняться за 5-30 минут. Поэтому ограничения выполнения или таймаутов выполнения устанавливать не будем.</p>
<p>Готово! Небольшие итоги:</p>
<p>Плюсы:</p>
<ol>
<li>Минимальное влияние на работу запросов во время обслуживания (как по блокировкам, так и по нагрузке на базу).</li>
<li>Максимально актуальная статистика во время всего рабочего дня.</li>
<li>Полный контроль над выполняемыми операциями. Приоритет отдается выполняемым запросам, а не обслуживанию. Работа информационной системы не будет нарушена.</li>
<li>Практически полное покрытие задач обслуживания баз данных в большинстве мелких, средних и крупных баз данных.</li>
</ol>
<p>Минусы:</p>
<ol>
<li>Более сложная схема настройки, требующая понимания работы процессов обслуживания и их сопровождения.</li>
<li>Необходимость прочитать инструкции и документацию по SQL Server в нештатных ситуациях.</li>
<li>Желательны навыки работы с TSQL.</li>
</ol>
<p>Может ли потребоваться изменять обслуживание еще как-то?</p>
<h3 id="_8">А вот и полная модель<a class="headerlink" href="#_8" title="Permanent link">¶</a></h3>
<p>Настает момент, когда для задач отказоустойчивости и надежности базу данных переключают в <a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/backup-restore/recovery-models-sql-server?view=sql-server-ver15"><strong>полную модель восстановления</strong></a>. Это позволяет восстановить базу данных из бэкапа на любой момент времен и не потерять данные в случае внезапного падения. Другие полезные возможности при полной модели:</p>
<ul>
<li><strong><a href="https://github.com/YPermitin/SQLServerTools/tree/master/SQL-Server-Replication-And-High-Availability">Использование доставки логов транзакций и создания копий баз данных</a></strong></li>
<li><strong><a href="https://github.com/YPermitin/SQLServerTools/tree/master/SQL-Server-AlwaysOn">Создание реплик неограниченного количества</a></strong>&nbsp;и сложной топологии</li>
<li><strong><a href="https://github.com/YPermitin/SQLServerTools/tree/master/SQL-Server-Track-Data-Changes">Применение механизма CDC для регистрации изменений</a></strong></li>
<li>И многие другие "плюшки".</li>
</ul>
<p>Рассматривать шаги для безопасного перевода баз в полную модель мы не будем. Основное что отметим - в таком режиме все изменения сохраняются в лог транзакций и остаются там до тех пор, пока он не будет бэкапирован. Важно заметить, что только бэкап лога транзакций помечает их готовыми к удалению из файла лога. Полный бэкап файл лога транзакций не очистит.</p>
<p>Но использование полной модели накладывает особенности в работе обслуживания. Может случиться так, что перестроение индексов может заполнить лог транзакций, что остановит все операции модификации данных в базе. Другими словами, информационная система перестанет работать.</p>
<p>Чтобы этого не случилось - установим ограничения на использование файла логов транзакций. Дополним предыдущий скрипт параметром ограничения.</p>
<p>Ограничиваем использование лога транзакций</p>
<p>Скрипт тот же, только добавили один параметр в конце.</p>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">EXECUTE</span><span class="w"> </span><span class="p">[</span><span class="n">SQLServerMaintenance</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_IndexMaintenance</span><span class="p">]</span><span class="w"> </span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'BSL-ORIG'</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="c1">-- Разрешаем запуск скрипта с 21:00:00 до 22:30:00</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="p">,</span><span class="o">@</span><span class="n">timeFrom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'21:00:00'</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="p">,</span><span class="o">@</span><span class="n">timeTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'22:30:00'</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="c1">-- 1 - обслуживать только те объекты, которые поддерживают онлайн-перестроение</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="p">,</span><span class="o">@</span><span class="n">useOnlineIndexRebuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="c1">-- Процент фрагментации, с которого будет выполняться обслуживание</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="p">,</span><span class="o">@</span><span class="n">fragmentationPercentMinForMaintenance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="c1">-- Процент фрагментации с которого начинается полное перестроение.</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="c1">-- Все, что между 10 и 30 будет обслуживаться операцией реорганизации</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a><span class="p">,</span><span class="o">@</span><span class="n">fragmentationPercentForRebuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a><span class="c1">-- Степень параллелизма для операций перестроения оставляем равной 8</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a><span class="p">,</span><span class="o">@</span><span class="n">maxDop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a><span class="c1">-- Настраиваем поведение онлайн-перестроения в ситуациях, когда переключение индекса на новый блокируется</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a><span class="c1">-- другими запросами</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a><span class="c1">-- 1 - операция обслуживания завершит себя по истечении таймаута ожидания.</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a><span class="p">,</span><span class="o">@</span><span class="n">onlineRebuildAbortAfterWaitMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a><span class="c1">-- Время ожидания операции онлайн перестроения перед прерываниеем работы. Ставим 15 минут</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a><span class="p">,</span><span class="o">@</span><span class="n">onlineRebuildWaitMinutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a><span class="c1">-- !!!</span>
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a><span class="c1">-- Разрешаем использование только 50% файла лога транзакций.</span>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>
</span><span id="__span-5-45"><a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a><span class="c1">-- Если лог транзакций заполнен на больший процент, то новые объекты обслуживаться не будут</span>
</span><span id="__span-5-46"><a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>
</span><span id="__span-5-47"><a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a><span class="p">,</span><span class="o">@</span><span class="n">maxTransactionLogSizeUsagePercent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span>
</span><span id="__span-5-48"><a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>
</span><span id="__span-5-49"><a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a><span class="c1">-- Можно также установить ограничение явно в мегабайтах</span>
</span><span id="__span-5-50"><a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>
</span><span id="__span-5-51"><a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a><span class="c1">--,@maxTransactionLogSizeMB bigint = 0</span>
</span><span id="__span-5-52"><a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>
</span><span id="__span-5-53"><a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a><span class="c1">-- !!!</span>
</span></code></pre></div>
</details>
<p>Параметры&nbsp;<em>@maxTransactionLogSizeUsagePercent</em> и&nbsp;<em>@maxTransactionLogSizeMB</em> как раз и решают эту задачу. Но нужно учитывать, что проверка выполняется перед началом выполнения операции обслуживания. Если индекс начал перестраиваться, то ограничение на текущий процесс уже не повлияет. Поэтому также рекомендуется спланировать резерв места на диске с файлом лога транзакций. А если, мало ли, размер логов при перестроении может превысить 2 ТБ, то нужно создать несколько файлов логов транзакций, чтобы обойти это ограничение. Да, максимальный размер одного файла лога транзакций равен 2 ТБ.</p>
<h3 id="_9">Разделяй и властвуй<a class="headerlink" href="#_9" title="Permanent link">¶</a></h3>
<p>В некоторых случаях есть смысл большие индексы обслуживать не ежедневно, а раз в неделю и, например, только полным перестроением. Для этого внесем следующие изменения:</p>
<ul>
<li>В ежедневном плане обслуживания индексов установим условие на максимальный размер обслуживаемых объектов. Расписание установим с понедельника по субботу.</li>
</ul>
<p>Ограничиваем размер обслуживаемых объектов</p>
<p>Можно установить нижнюю (@maxIndexSizePages) и верхнюю (@maxIndexSizePages) границу. В примере мы ставим условие только на макс. размер объекта.</p>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">EXECUTE</span><span class="w"> </span><span class="p">[</span><span class="n">SQLServerMaintenance</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_IndexMaintenance</span><span class="p">]</span><span class="w"> </span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'BSL-ORIG'</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="c1">-- Разрешаем запуск скрипта с 21:00:00 до 22:30:00</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="p">,</span><span class="o">@</span><span class="n">timeFrom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'21:00:00'</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="p">,</span><span class="o">@</span><span class="n">timeTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'22:30:00'</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="c1">-- 1 - обслуживать только те объекты, которые поддерживают онлайн-перестроение</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="p">,</span><span class="o">@</span><span class="n">useOnlineIndexRebuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="c1">-- Процент фрагментации, с которого будет выполняться обслуживание</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="p">,</span><span class="o">@</span><span class="n">fragmentationPercentMinForMaintenance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="c1">-- Процент фрагментации с которого начинается полное перестроение.</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="c1">-- Все, что между 10 и 30 будет обслуживаться операцией реорганизации</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="p">,</span><span class="o">@</span><span class="n">fragmentationPercentForRebuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="c1">-- Степень параллелизма для операций перестроения оставляем равной 8</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="p">,</span><span class="o">@</span><span class="n">maxDop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="c1">-- Настраиваем поведение онлайн-перестроения в ситуациях, когда переключение индекса на новый блокируется</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="c1">-- другими запросами</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a><span class="c1">-- 1 - операция обслуживания завершит себя по истечении таймаута ожидания.</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a><span class="p">,</span><span class="o">@</span><span class="n">onlineRebuildAbortAfterWaitMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a><span class="c1">-- Время ожидания операции онлайн перестроения перед прерыванием работы. Ставим 15 минут</span>
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a><span class="p">,</span><span class="o">@</span><span class="n">onlineRebuildWaitMinutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span>
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>
</span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a><span class="c1">-- !!!</span>
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a><span class="c1">-- Разрешаем использование только 50% файла лога транзакций.</span>
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>
</span><span id="__span-6-45"><a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a><span class="c1">-- Если лог транзакций заполнен на больший процент, то новые объекты обслуживаться не будут</span>
</span><span id="__span-6-46"><a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>
</span><span id="__span-6-47"><a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a><span class="p">,</span><span class="o">@</span><span class="n">maxTransactionLogSizeUsagePercent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span>
</span><span id="__span-6-48"><a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>
</span><span id="__span-6-49"><a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a><span class="c1">-- Макс. размер обслуживаемых объектов будет равен 50 ГБ.</span>
</span><span id="__span-6-50"><a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>
</span><span id="__span-6-51"><a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a><span class="c1">-- Размер устанавливается в количестве страниц по 8 КБ.</span>
</span><span id="__span-6-52"><a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>
</span><span id="__span-6-53"><a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a><span class="c1">-- 50 ГБ = 6553600 страниц</span>
</span><span id="__span-6-54"><a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>
</span><span id="__span-6-55"><a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a><span class="p">,</span><span class="o">@</span><span class="n">maxIndexSizePages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6553600</span>
</span></code></pre></div>
</details>
<p>Теперь объекты размером 100 ГБ обслуживаться не будут.</p>
<ul>
<li>Добавим еще один субплан обслуживания с теми же операциями, что и в ежедневном плане обслуживания, но в скрипте обслуживания индексов снимем ограничение на макс. размер индекса.</li>
</ul>
<p>Это позволит разделить обслуживание и избавится от массивных операций изменения в будние дни. Тут стоит отметить, что нужно понимать последствия таких решений. Предварительно нужно проанализировать что это за таблицы и как изменение стратегии обслуживания повлияет на работу информационной системы.</p>
<p>Есть и более точечный вариант настройки обслуживания, в котором ограничения будут опираться не на размер объектов, а на конкретные объекты. Например, можно добавить такое условие в процедуру обслуживания индексов:</p>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1">-- Отбор по конкретной таблице</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="p">,</span><span class="o">@</span><span class="n">ConditionTableName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'IN (''_AccumRg1265'',''_AccumRg505'')'</span>
</span></code></pre></div>
</details>
<p>или даже поставить отбор на конкретный индекс:</p>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">-- Отбор на конкретный индекс (отбор по таблице в этом случае не обязателен)</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="p">,</span><span class="o">@</span><span class="n">ConditionIndexName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'= ''_AccumRg505_1'''</span>
</span></code></pre></div>
</details>
<p>Для таких точечных операций обслуживания можно задать свое расписание, свои таймауты выполнения и так далее.</p>
<h3 id="_10">Слишком большие объекты<a class="headerlink" href="#_10" title="Permanent link">¶</a></h3>
<p>Следующая проблема, которая может появиться в больших базах - это обслуживание ооооооочень больших, огромных объектов в пределах окна обслуживания. Например, у нас есть 2 часа на обслуживание индексов. Но что, если для перестроения индекса, размер которого 1 ТБ, нужно 5 часов.</p>
<p>Конечно, в онлайн режиме блокировок это не создаст, но замедление работы с индексом или выделяемые ресурсы для такого перестроения могут косвенно влиять на другие запросы.&nbsp;Кроме этого, файл лога транзакций будет заполняться полностью и даже дополнительные файлы могут не спасти ситуацию.</p>
<p>Тут на помощь приходят возобновляемые операции перестроения индексов, <strong><a href="https://www.mssqltips.com/sqlservertip/4987/sql-server-2017-resumable-online-index-rebuilds">доступных со SQL Server 2017</a></strong>. Работает это так:</p>
<ul>
<li>Вы запускаете операцию перестроения индекса в онлайн режиме, указав параметр&nbsp;RESUMABLE = ON.</li>
</ul>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">PK_1</span><span class="w"> </span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">_Acc1</span><span class="p">]</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="n">REBUILD</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">ONLINE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">,</span><span class="w"> </span><span class="n">RESUMABLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">);</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="k">GO</span>
</span></code></pre></div>
</details>
<ul>
<li>Процесс перестроения выполняется, пока Вы не прервете его явно командой завершения сессии (например, если таймаут сработал) или не указав остановку явно.</li>
</ul>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">PK_1</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">_Acc1</span><span class="p">]</span><span class="w">  </span><span class="n">PAUSE</span>
</span></code></pre></div>
</details>
<ul>
<li>После остановки операции файл журнала транзакций может быть освобожден после выполнения бэкапа логов. Да, перестроение индекса еще не завершено, но освободить файл журнала транзакций можно.</li>
<li>Можно проверить список операций перестроения, доступных для продолжения, а также состояние прогресса перестроения</li>
</ul>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="n">total_execution_time</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="n">percent_complete</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="n">name</span><span class="p">,</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="n">state_desc</span><span class="p">,</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="n">last_pause_time</span><span class="p">,</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="n">page_count</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">index_resumable_operations</span><span class="p">;</span>
</span></code></pre></div>
</details>
<ul>
<li>Возобновляем операцию перестроения при необходимости. Например, в следующем технологическом окне обслуживания.</li>
</ul>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">PK_1</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">_Acc1</span><span class="p">]</span><span class="w">  </span><span class="n">RESUME</span>
</span></code></pre></div>
</details>
<ul>
<li>Или можно прервать операцию окончательно.</li>
</ul>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">PK_1</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">_Acc1</span><span class="p">]</span><span class="w">  </span><span class="k">ABORT</span>
</span></code></pre></div>
</details>
<p>Это позволит выполнять даже самые тяжелые операции в заданное окно обслуживания, хоть и за несколько дней. А&nbsp;также обезопасить себя от переполнения лога транзакций.</p>
<p>В контексте нашей служебной базы использование возобновляемого перестроения включается через параметр&nbsp;@useResumableIndexRebuildIfAvailable, который может быть задействован только при использовании операций онлайн перестроения индексов.</p>
<p>Возобновляемое перестроение индексов</p>
<p>В примере ниже мы поставим отбор для конкретного индекса, по которому нужно выполнять возобновляемое перестроение. Использовать подобное обслуживание для всех объектов в базе не имеет смысла.</p>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">EXECUTE</span><span class="w"> </span><span class="p">[</span><span class="n">SQLServerMaintenance</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_IndexMaintenance</span><span class="p">]</span><span class="w"> </span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'BSL-ORIG'</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="c1">-- Разрешаем запуск скрипта с 21:00:00 до 22:30:00</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="p">,</span><span class="o">@</span><span class="n">timeFrom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'21:00:00'</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="p">,</span><span class="o">@</span><span class="n">timeTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'22:30:00'</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="c1">-- (2) - обслуживание только тех объектов, в которых онлайн-перестроение не поддерживается.</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="p">,</span><span class="o">@</span><span class="n">useOnlineIndexRebuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="c1">-- Процент фрагментации, с которого будет выполняться обслуживание</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="p">,</span><span class="o">@</span><span class="n">fragmentationPercentMinForMaintenance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="c1">-- Процент фрагментации с которого начинается полное перестроение.</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="c1">-- Все, что между 10 и 30 будет обслуживаться операцией реорганизации</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="p">,</span><span class="o">@</span><span class="n">fragmentationPercentForRebuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="c1">-- Степень параллелизма для операций перестроения оставляем равной 8</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a><span class="p">,</span><span class="o">@</span><span class="n">maxDop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a><span class="c1">-- Включаем возобновляемое перестроение индексов</span>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a><span class="p">,</span><span class="o">@</span><span class="n">useResumableIndexRebuildIfAvailable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a><span class="c1">-- И только для конкретного индекса</span>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a>
</span><span id="__span-14-35"><a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a><span class="p">,</span><span class="o">@</span><span class="n">ConditionIndexName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'= ''_AccumRg505_1'''</span>
</span></code></pre></div>
</details>
<p>Последние два параметра тут основные для примера.</p>
<p>Но есть и подводный камень! Если индекс находится в списке операций возобновляемых операций перестроения, то его нельзя удалить или перестроить другими операциями. Нужно либо завершить перестроение, либо прервать его окончательно.</p>
<p>Если во время работы скрипта из примера операция будет прервана по таймауту (или вручную), то при следующем запуске этого же скрипта будет действовать такой алгоритм:</p>
<ol>
<li>Проверяются списки объектов, для которых нужно выполнить возобновление перестроения. При этом учитываются условия по таблицам и индексам.</li>
<li>Если такая операция есть в списке, то возобновляем ее работу. Если нет, то идем дальше.</li>
<li>Далее выполняем обычные операции обслуживания. При этом если на прошлом шаге было завершено возобновляемое перестроение индекса, то на следующих шагах обслуживания эти объекты будут пропущены. Это сделано для того, чтобы один и тот же объект не был перестроен дважды.</li>
</ol>
<p>Этот механизм является спасительным для многих больших баз данных. А некоторые люди еще говорят, что разницы между SQL Server 2012 и SQL Server 2019 нет, вот им пример.</p>
<h3 id="alwayson">Да здравствует AlwaysOn<a class="headerlink" href="#alwayson" title="Permanent link">¶</a></h3>
<p>При включении групп высокой доступности AlwaysOn появляется особый нюанс - если реплика становится недоступной для отправки изменений, то записи в файле лога транзакций не будут удалены даже после выполнения бэкапа лога транзакций. Это сделано для того, чтобы при возобновлении передачи данных не потерять транзакции, которые еще не ушли на копии баз, реплики.</p>
<p>Для обслуживания это может означать, что при каких-то авариях с передачей данных в AlwaysOn лучше повременить с обслуживанием, пока передача данных не будет восстановлена и файл лога транзакций не будет освобождён.</p>
<p>Подобная ситуация может возникнуть не только при сбое связи, а, например, если после перестроения 1 ТБ индекса эти изменения будут отправляться на копии. Пока все изменения после перестрое&nbsp;ния не "уйдут" на копии, то лог транзакций также не сможет быть освобожден.</p>
<p>Но на самом деле решение этой проблемы&nbsp;у нас уже есть. Выше мы уже говорили про параметры ограничения файла лога транзакций в полной модели восстановления, а также кратко прошлись по созданию резерва для логов. Этот же подход нужно использовать и в нашем случае.</p>
<p>Также нужно понимать, что операции обслуживания нужно выполнять только в первичном узле (основной базе), а на копиях баз настраивать обслуживание просто нет смысла. Это же копии в режиме "только для чтения". Перестроение индексов или обновление статистик там недоступно.</p>
<p>Информацию про <strong><a href="https://github.com/YPermitin/SQLServerTools/tree/master/SQL-Server-AlwaysOn">использование AlwaysOn</a></strong> Вы можете посмотреть здесь, в том числе описание некоторых нюансов и настроек.</p>
<h3 id="_11">Комбо!<a class="headerlink" href="#_11" title="Permanent link">¶</a></h3>
<p>И напоследок - комбо! Все вышеописанные подходы к настройке можно комбинировать как Вам угодно, главное не делать это вслепую! И лучше всего усложнять обслуживание только по необходимости, подтверждая свои шаги через анализ логов обслуживания.</p>
<p>Если Вы будете использовать служебную базу, о конторой идет речь в этой статье, то все операции перестроения индексов или обновления объектов статистики логируются. Например, в таблице "MaintenanceActionsLog" можно посмотреть&nbsp;когда, как и почему объект обслуживался.</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../img/32c012e488a177d45cc1ad6058d5758d.png" data-desc-position="bottom"><img alt="" src="../img/32c012e488a177d45cc1ad6058d5758d.png"></a>Вы будете знать обслуживался ли он онлайн, было это перестроение или реорганизация, какой процент фрагментации был на момент обслуживания, сколько записей изменилось с момента обновления статистики, какая SQL-команда использовалась, длительность операции и вообще завершилась ли операция. Операция обслуживания будет взята под полный контроль!</p>
<p>Также может возникнуть необходимость запускать скрипты перестроения индексов параллельно друг другу, для ускорения обслуживания, например. Но тут возникает нюанс! Если есть активная операция перестроения индекса, то&nbsp;DMV&nbsp;<a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/system-dynamic-management-views/sys-dm-db-index-physical-stats-transact-sql?view=sql-server-ver15"><strong>sys.dm_db_index_physical_stats</strong></a>&nbsp;не сможет получить текущее состояние индексов, пока перестроение не будет завершено. В итоге операции перестроения параллельно и не будут запущены.&nbsp;Но и тут есть выход!</p>
<p>Вы можете запустить сбор информации о состоянии объектов базы данных заранее через команду:</p>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">EXECUTE</span><span class="w"> </span><span class="p">[</span><span class="n">SQLServerMaintenance</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sp_FillDatabaseObjectsState</span><span class="p">]</span><span class="w"> </span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="o">@</span><span class="n">databaseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'BSL-ORIG'</span>
</span></code></pre></div>
</details>
<p>Команда вызовет&nbsp;<a href="https://learn.microsoft.com/ru-ru/sql/relational-databases/system-dynamic-management-views/sys-dm-db-index-physical-stats-transact-sql?view=sql-server-ver15"><strong>sys.dm_db_index_physical_stats</strong></a>&nbsp;и сохранит результаты в таблицу "DatabaseObjectsState". А в скриптах перестроения индексов можно указать параметр&nbsp;@usePreparedInformationAboutObjectsStateIfExists, тогда повторного анализа объектов выполнено не будет и обслуживание будет использовать информацию из таблицы "DatabaseObjectsState".</p>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1">-- Используем ранее сохраненную информацию о состоянии объектов базы данных</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="p">,</span><span class="o">@</span><span class="n">usePreparedInformationAboutObjectsStateIfExists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</span></code></pre></div>
</details>
<p>Но есть нюанс! Информация об объектах базы должна быть собрана в последние 12 часов на момент вызова обслуживания. Иначе информация будет считаться устаревшей и запустится обычный анализ объектов.</p>
<p>Таким образом, можно запускать 2 и более процессов обслуживания индексов, не опасаясь их блокировки друг другом на этапе анализа объектов базы.</p>
<h2 id="_12">Как отслеживать качество обслуживания<a class="headerlink" href="#_12" title="Permanent link">¶</a></h2>
<p>Это отдельная тема, но в самом простом виде можно действовать так:</p>
<ul>
<li>Следить, чтобы статистика была максимально актуальной. Например, таким скриптом. Так вы увидите есть ли объекты, по которым статистика давно не обновлялась, а также объекты, по которым изменения накапливаются очень быстро. Возможно, нужно делать обновление статистики для них чаще нескольких раз в день.</li>
</ul>
<p>Анализ состояния статистики</p>
<details class="- info">
<summary>скрипт</summary>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">select</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="n">o</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">TableName</span><span class="p">],</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">StatName</span><span class="p">],</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">rowmodctr</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">RowsChanged</span><span class="p">],</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">    </span><span class="n">STATS_DATE</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">object_id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">stats_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">[</span><span class="n">LastUpdate</span><span class="p">],</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">    </span><span class="n">o</span><span class="p">.</span><span class="n">is_ms_shipped</span><span class="p">,</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">is_temporary</span><span class="p">,</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="w">    </span><span class="n">p</span><span class="p">.</span><span class="o">*</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="k">from</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">sysindexes</span><span class="w"> </span><span class="n">a</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="w">    </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">objects</span><span class="w"> </span><span class="n">o</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a><span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">object_id</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a><span class="w">        </span><span class="k">and</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'U'</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a><span class="w">        </span><span class="k">and</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a><span class="w">        </span><span class="k">and</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">indid</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a><span class="w">    </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">stats</span><span class="w"> </span><span class="n">s</span>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a>
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a><span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">name</span>
</span><span id="__span-17-32"><a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a>
</span><span id="__span-17-33"><a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a><span class="w">    </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-17-34"><a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a>
</span><span id="__span-17-35"><a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a><span class="k">SELECT</span>
</span><span id="__span-17-36"><a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a>
</span><span id="__span-17-37"><a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a><span class="w">        </span><span class="n">p</span><span class="p">.[</span><span class="n">object_id</span><span class="p">]</span>
</span><span id="__span-17-38"><a id="__codelineno-17-38" name="__codelineno-17-38" href="#__codelineno-17-38"></a>
</span><span id="__span-17-39"><a id="__codelineno-17-39" name="__codelineno-17-39" href="#__codelineno-17-39"></a><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">index_id</span>
</span><span id="__span-17-40"><a id="__codelineno-17-40" name="__codelineno-17-40" href="#__codelineno-17-40"></a>
</span><span id="__span-17-41"><a id="__codelineno-17-41" name="__codelineno-17-41" href="#__codelineno-17-41"></a><span class="p">,</span><span class="w"> </span><span class="n">total_pages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">total_pages</span><span class="p">)</span>
</span><span id="__span-17-42"><a id="__codelineno-17-42" name="__codelineno-17-42" href="#__codelineno-17-42"></a>
</span><span id="__span-17-43"><a id="__codelineno-17-43" name="__codelineno-17-43" href="#__codelineno-17-43"></a><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">partitions</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">WITH</span><span class="p">(</span><span class="n">NOLOCK</span><span class="p">)</span>
</span><span id="__span-17-44"><a id="__codelineno-17-44" name="__codelineno-17-44" href="#__codelineno-17-44"></a>
</span><span id="__span-17-45"><a id="__codelineno-17-45" name="__codelineno-17-45" href="#__codelineno-17-45"></a><span class="w">        </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">allocation_units</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">WITH</span><span class="p">(</span><span class="n">NOLOCK</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.[</span><span class="n">partition_id</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">container_id</span>
</span><span id="__span-17-46"><a id="__codelineno-17-46" name="__codelineno-17-46" href="#__codelineno-17-46"></a>
</span><span id="__span-17-47"><a id="__codelineno-17-47" name="__codelineno-17-47" href="#__codelineno-17-47"></a><span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span>
</span><span id="__span-17-48"><a id="__codelineno-17-48" name="__codelineno-17-48" href="#__codelineno-17-48"></a>
</span><span id="__span-17-49"><a id="__codelineno-17-49" name="__codelineno-17-49" href="#__codelineno-17-49"></a><span class="n">p</span><span class="p">.[</span><span class="n">object_id</span><span class="p">]</span>
</span><span id="__span-17-50"><a id="__codelineno-17-50" name="__codelineno-17-50" href="#__codelineno-17-50"></a>
</span><span id="__span-17-51"><a id="__codelineno-17-51" name="__codelineno-17-51" href="#__codelineno-17-51"></a><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">index_id</span>
</span><span id="__span-17-52"><a id="__codelineno-17-52" name="__codelineno-17-52" href="#__codelineno-17-52"></a>
</span><span id="__span-17-53"><a id="__codelineno-17-53" name="__codelineno-17-53" href="#__codelineno-17-53"></a><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.[</span><span class="n">object_id</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.[</span><span class="n">object_id</span><span class="p">]</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">index_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">stats_id</span>
</span><span id="__span-17-54"><a id="__codelineno-17-54" name="__codelineno-17-54" href="#__codelineno-17-54"></a>
</span><span id="__span-17-55"><a id="__codelineno-17-55" name="__codelineno-17-55" href="#__codelineno-17-55"></a><span class="k">order</span><span class="w"> </span><span class="k">by</span>
</span><span id="__span-17-56"><a id="__codelineno-17-56" name="__codelineno-17-56" href="#__codelineno-17-56"></a>
</span><span id="__span-17-57"><a id="__codelineno-17-57" name="__codelineno-17-57" href="#__codelineno-17-57"></a><span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">rowmodctr</span><span class="w"> </span><span class="k">desc</span><span class="p">,</span>
</span><span id="__span-17-58"><a id="__codelineno-17-58" name="__codelineno-17-58" href="#__codelineno-17-58"></a>
</span><span id="__span-17-59"><a id="__codelineno-17-59" name="__codelineno-17-59" href="#__codelineno-17-59"></a><span class="w">    </span><span class="n">STATS_DATE</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">object_id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">stats_id</span><span class="p">)</span><span class="w"> </span><span class="k">ASC</span>
</span></code></pre></div>
<ul>
<li>Следить за фрагментацией индексов.</li>
</ul>
<p>Анализ состояния индексов</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">OBJECT_NAME</span><span class="p">(</span><span class="n">ips</span><span class="p">.</span><span class="n">OBJECT_ID</span><span class="p">)</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="p">,</span><span class="n">i</span><span class="p">.</span><span class="n">NAME</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="p">,</span><span class="n">ips</span><span class="p">.</span><span class="n">index_id</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="p">,</span><span class="n">index_type_desc</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="p">,</span><span class="n">avg_fragmentation_in_percent</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="p">,</span><span class="n">avg_page_space_used_in_percent</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="p">,</span><span class="n">page_count</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">dm_db_index_physical_stats</span><span class="p">(</span><span class="n">DB_ID</span><span class="p">(),</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="s1">'SAMPLED'</span><span class="p">)</span><span class="w"> </span><span class="n">ips</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">indexes</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">(</span><span class="n">ips</span><span class="p">.</span><span class="n">object_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">object_id</span><span class="p">)</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="n">ips</span><span class="p">.</span><span class="n">index_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">index_id</span><span class="p">)</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">avg_fragmentation_in_percent</span><span class="w"> </span><span class="k">DESC</span>
</span></code></pre></div>
</details>
<p>Можно использовать уровень детализации "DETAILED" для более точных данных.</p>
<p>Плюс тяжелые запросы с неоптимальными планами могут подсказать, какие таблицы являются проблемными. Скриптами выше проверьте их состояние.</p>
<p>Но в целом это отдельный разговор. Сегодня об этом речь не идет.</p>
<h2 id="_13">Это еще не конец<a class="headerlink" href="#_13" title="Permanent link">¶</a></h2>
<p>Мы прошли долгий путь и каждый шаг дался нам не просто:</p>
<ol>
<li>Сначала настроили базовое обслуживание с помощью поставляемых компонентов SQL Server.</li>
<li>Затем усложнили обслуживание для уменьшения влияния на информационную систему.</li>
<li>После вынужденно отказались от штатных компонентов и использовали свои скрипты и наработки, поставили ограничения на операции обслуживания, повысили надежность работы и пресекли выход за рамки технологического окна. А также улучшили онлайн обслуживание индексов.</li>
<li>Далее рассмотрели нюансы при работе в полной модели восстановления базы.</li>
<li>Разбили обслуживание на регулярное и еженедельное для оптимизации работы.</li>
<li>Изменили стратегию обслуживания для огромных объектов, внедрив возобновляемое перестроение индексов.</li>
<li>Рассмотрели особенности обслуживания при использовании AlwaysOn.</li>
<li>И напоследок обсудили логирование и контроль обслуживания.</li>
</ol>
<p>Но это не конец пути! Все это лишь показывает, что обслуживание баз данных может адаптироваться под любые требования, было бы желание, деньги и время. Ну и знания, конечно же. Надеюсь, в последнем эта статья поможет и даст старт для изучения вопроса.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Support Vadim, 2025
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["content.code.copy", "content.code.select", "navigation.instant"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "\u0421\u043a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u043d\u043e \u0432 \u0431\u0443\u0444\u0435\u0440", "clipboard.copy": "\u041a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0432 \u0431\u0443\u0444\u0435\u0440", "search.result.more.one": "\u0415\u0449\u0451 1 \u043d\u0430 \u044d\u0442\u043e\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0435", "search.result.more.other": "\u0415\u0449\u0451 # \u043d\u0430 \u044d\u0442\u043e\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0435", "search.result.none": "\u0421\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0439 \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d\u043e", "search.result.one": "\u041d\u0430\u0439\u0434\u0435\u043d\u043e 1 \u0441\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0435", "search.result.other": "\u041d\u0430\u0439\u0434\u0435\u043d\u043e \u0441\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0439: #", "search.result.placeholder": "\u041d\u0430\u0447\u043d\u0438\u0442\u0435 \u043f\u0435\u0447\u0430\u0442\u0430\u0442\u044c \u0434\u043b\u044f \u043f\u043e\u0438\u0441\u043a\u0430", "search.result.term.missing": "\u041e\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442", "select.version": "\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0435\u0440\u0441\u0438\u044e"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>